2025-06-17 09:54:07,299 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 09:54:07,299 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 09:54:07,303 - INFO -  * Restarting with stat
2025-06-17 09:54:07,905 - WARNING -  * Debugger is active!
2025-06-17 09:54:07,911 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:54:10,889 - INFO - Connected to database
2025-06-17 09:54:10,890 - INFO - Database connection closed
2025-06-17 09:54:10,900 - INFO - 127.0.0.1 - - [17/Jun/2025 09:54:10] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 09:54:11,036 - INFO - 127.0.0.1 - - [17/Jun/2025 09:54:11] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 09:54:11,042 - INFO - 127.0.0.1 - - [17/Jun/2025 09:54:11] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 09:54:11,121 - INFO - 127.0.0.1 - - [17/Jun/2025 09:54:11] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=BkeSqEZBWA4IlgiuRqs3 HTTP/1.1" 200 -
2025-06-17 09:54:11,214 - INFO - 127.0.0.1 - - [17/Jun/2025 09:54:11] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 09:54:33,683 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 09:54:33,771 - INFO -  * Restarting with stat
2025-06-17 09:54:36,603 - WARNING -  * Debugger is active!
2025-06-17 09:54:36,609 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:54:51,312 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:54:51,419 - INFO -  * Restarting with stat
2025-06-17 09:55:35,563 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 09:55:35,563 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 09:55:35,564 - INFO -  * Restarting with stat
2025-06-17 09:55:36,918 - WARNING -  * Debugger is active!
2025-06-17 09:55:36,921 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:55:42,298 - INFO - Connected to database
2025-06-17 09:55:42,299 - INFO - Database connection closed
2025-06-17 09:55:42,307 - INFO - 127.0.0.1 - - [17/Jun/2025 09:55:42] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 09:55:42,454 - INFO - 127.0.0.1 - - [17/Jun/2025 09:55:42] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 09:55:42,455 - INFO - 127.0.0.1 - - [17/Jun/2025 09:55:42] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 09:56:00,320 - INFO - Connected to database
2025-06-17 09:56:00,321 - INFO - Database connection closed
2025-06-17 09:56:00,328 - INFO - 127.0.0.1 - - [17/Jun/2025 09:56:00] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 09:56:00,358 - INFO - 127.0.0.1 - - [17/Jun/2025 09:56:00] "GET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1" 200 -
2025-06-17 09:56:00,360 - INFO - 127.0.0.1 - - [17/Jun/2025 09:56:00] "GET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1" 200 -
2025-06-17 09:56:00,457 - INFO - 127.0.0.1 - - [17/Jun/2025 09:56:00] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=cdITeD7agZ1aJiqjqBGT HTTP/1.1" 200 -
2025-06-17 09:56:00,515 - INFO - 127.0.0.1 - - [17/Jun/2025 09:56:00] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 09:57:42,479 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:57:42,615 - INFO -  * Restarting with stat
2025-06-17 09:57:43,955 - WARNING -  * Debugger is active!
2025-06-17 09:57:43,958 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:57:50,518 - INFO - Connected to database
2025-06-17 09:57:50,622 - INFO - Database connection closed
2025-06-17 09:57:50,622 - INFO - 127.0.0.1 - - [17/Jun/2025 09:57:50] "GET / HTTP/1.1" 200 -
2025-06-17 09:57:51,217 - INFO - 127.0.0.1 - - [17/Jun/2025 09:57:51] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 09:58:12,267 - INFO - Connected to database
2025-06-17 09:58:12,331 - ERROR - Error processing query 'give me coupons of wan chai': 'EnhancedRuleBasedExtractor' object has no attribute 'db'
2025-06-17 09:58:12,333 - INFO - Database connection closed
2025-06-17 09:58:12,334 - INFO - 127.0.0.1 - - [17/Jun/2025 09:58:12] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 09:58:12,358 - INFO - Connected to database
2025-06-17 09:58:12,362 - INFO - Database connection closed
2025-06-17 09:58:12,372 - INFO - 127.0.0.1 - - [17/Jun/2025 09:58:12] "GET / HTTP/1.1" 200 -
2025-06-17 09:58:12,528 - INFO - 127.0.0.1 - - [17/Jun/2025 09:58:12] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 09:58:38,619 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:58:38,780 - INFO -  * Restarting with stat
2025-06-17 09:58:40,059 - WARNING -  * Debugger is active!
2025-06-17 09:58:40,065 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:58:43,157 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:58:43,284 - INFO -  * Restarting with stat
2025-06-17 09:58:44,854 - WARNING -  * Debugger is active!
2025-06-17 09:58:44,860 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:58:46,942 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:58:47,074 - INFO -  * Restarting with stat
2025-06-17 09:58:48,332 - WARNING -  * Debugger is active!
2025-06-17 09:58:48,337 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:58:52,455 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:58:52,573 - INFO -  * Restarting with stat
2025-06-17 09:58:53,944 - WARNING -  * Debugger is active!
2025-06-17 09:58:53,947 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:58:55,056 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 09:58:55,187 - INFO -  * Restarting with stat
2025-06-17 09:58:56,613 - WARNING -  * Debugger is active!
2025-06-17 09:58:56,615 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:59:01,024 - INFO - Connected to database
2025-06-17 09:59:01,025 - INFO - Database connection closed
2025-06-17 09:59:01,030 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:01] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 09:59:01,128 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:01] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 09:59:01,129 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:01] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 09:59:01,157 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:01] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=GodYtoPHsAAvf4uDEKwL HTTP/1.1" 200 -
2025-06-17 09:59:01,203 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:01] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 09:59:33,850 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 09:59:34,049 - INFO -  * Restarting with stat
2025-06-17 09:59:36,746 - WARNING -  * Debugger is active!
2025-06-17 09:59:36,752 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:59:37,830 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 09:59:38,007 - INFO -  * Restarting with stat
2025-06-17 09:59:39,784 - WARNING -  * Debugger is active!
2025-06-17 09:59:39,788 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:59:41,888 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 09:59:42,094 - INFO -  * Restarting with stat
2025-06-17 09:59:44,493 - WARNING -  * Debugger is active!
2025-06-17 09:59:44,499 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 09:59:52,202 - INFO - Connected to database
2025-06-17 09:59:52,202 - INFO - Database connection closed
2025-06-17 09:59:52,209 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:52] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 09:59:52,307 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:52] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 09:59:52,313 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:52] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 09:59:52,343 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:52] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=BAUnOYqS8hXTebhd6MwQ HTTP/1.1" 200 -
2025-06-17 09:59:52,461 - INFO - 127.0.0.1 - - [17/Jun/2025 09:59:52] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:03,328 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 10:00:03,329 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 10:00:03,331 - INFO -  * Restarting with stat
2025-06-17 10:00:04,801 - WARNING -  * Debugger is active!
2025-06-17 10:00:04,806 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:00:06,759 - INFO - Connected to database
2025-06-17 10:00:06,760 - INFO - Database connection closed
2025-06-17 10:00:06,766 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:06] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:06,875 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:06] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:06,880 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:06] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:06,901 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:06] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=pwwm9xZbFk18WTjpz5rS HTTP/1.1" 200 -
2025-06-17 10:00:06,980 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:06] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:16,062 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:00:16,206 - INFO -  * Restarting with stat
2025-06-17 10:00:18,216 - WARNING -  * Debugger is active!
2025-06-17 10:00:18,220 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:00:22,258 - INFO - Connected to database
2025-06-17 10:00:22,259 - INFO - Database connection closed
2025-06-17 10:00:22,265 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:22] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:22,380 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:22] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:22,381 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:22] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:22,410 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:22] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=IurAbJSHUalQcN7zUPfK HTTP/1.1" 200 -
2025-06-17 10:00:22,459 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:22] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:23,799 - INFO - Connected to database
2025-06-17 10:00:23,803 - INFO - Database connection closed
2025-06-17 10:00:23,807 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:23] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:23,840 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:23] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:23,841 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:23] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:23,864 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:23] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png&s=IurAbJSHUalQcN7zUPfK HTTP/1.1[0m" 304 -
2025-06-17 10:00:23,926 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:23] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,073 - INFO - Connected to database
2025-06-17 10:00:24,073 - INFO - Database connection closed
2025-06-17 10:00:24,086 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:24,263 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,264 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,273 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png&s=IurAbJSHUalQcN7zUPfK HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,322 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,428 - INFO - Connected to database
2025-06-17 10:00:24,429 - INFO - Database connection closed
2025-06-17 10:00:24,439 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:24,484 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,485 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,507 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png&s=IurAbJSHUalQcN7zUPfK HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,526 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,614 - INFO - Connected to database
2025-06-17 10:00:24,616 - INFO - Database connection closed
2025-06-17 10:00:24,624 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:24,697 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,698 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,721 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png&s=IurAbJSHUalQcN7zUPfK HTTP/1.1[0m" 304 -
2025-06-17 10:00:24,763 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:24] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:42,912 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:00:43,065 - INFO -  * Restarting with stat
2025-06-17 10:00:44,431 - WARNING -  * Debugger is active!
2025-06-17 10:00:44,435 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:00:48,736 - INFO - Connected to database
2025-06-17 10:00:48,737 - INFO - Database connection closed
2025-06-17 10:00:48,741 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:48] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:48,832 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:48] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:48,835 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:48] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:48,869 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:48] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=2EBXVwK369GladMG8MHl HTTP/1.1" 200 -
2025-06-17 10:00:48,927 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:48] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:00:50,002 - INFO - Connected to database
2025-06-17 10:00:50,003 - INFO - Database connection closed
2025-06-17 10:00:50,008 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:50] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:00:50,041 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:50] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:00:50,042 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:50] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:00:50,064 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:50] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png&s=2EBXVwK369GladMG8MHl HTTP/1.1[0m" 304 -
2025-06-17 10:00:50,142 - INFO - 127.0.0.1 - - [17/Jun/2025 10:00:50] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:02:30,883 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:02:31,129 - INFO -  * Restarting with stat
2025-06-17 10:02:33,482 - WARNING -  * Debugger is active!
2025-06-17 10:02:33,486 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:02:40,198 - INFO - Connected to database
2025-06-17 10:02:40,199 - INFO - Database connection closed
2025-06-17 10:02:40,207 - INFO - 127.0.0.1 - - [17/Jun/2025 10:02:40] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:02:40,344 - INFO - 127.0.0.1 - - [17/Jun/2025 10:02:40] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:02:40,345 - INFO - 127.0.0.1 - - [17/Jun/2025 10:02:40] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:02:40,559 - INFO - 127.0.0.1 - - [17/Jun/2025 10:02:40] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=3EwqB9nR0YJhRNg1F9el HTTP/1.1" 200 -
2025-06-17 10:02:40,647 - INFO - 127.0.0.1 - - [17/Jun/2025 10:02:40] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 10:02:52,103 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:02:52,312 - INFO -  * Restarting with stat
2025-06-17 10:02:53,968 - WARNING -  * Debugger is active!
2025-06-17 10:02:53,973 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:02:57,090 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:02:57,273 - INFO -  * Restarting with stat
2025-06-17 10:02:58,745 - WARNING -  * Debugger is active!
2025-06-17 10:02:58,748 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:02:59,802 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:02:59,971 - INFO -  * Restarting with stat
2025-06-17 10:03:01,543 - WARNING -  * Debugger is active!
2025-06-17 10:03:01,546 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:03:09,725 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 10:03:09,865 - INFO -  * Restarting with stat
2025-06-17 10:03:11,123 - WARNING -  * Debugger is active!
2025-06-17 10:03:11,126 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:03:16,435 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 10:03:16,435 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 10:03:16,437 - INFO -  * Restarting with stat
2025-06-17 10:03:17,900 - WARNING -  * Debugger is active!
2025-06-17 10:03:17,906 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:03:24,950 - INFO - Connected to database
2025-06-17 10:03:24,951 - INFO - Database connection closed
2025-06-17 10:03:24,958 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:24] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 10:03:25,072 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:25] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 10:03:25,076 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:25] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 10:03:25,135 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:25] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=0VMvPSMUtiNYJqtrpqKZ HTTP/1.1" 200 -
2025-06-17 10:03:37,373 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 10:03:37,504 - INFO -  * Restarting with stat
2025-06-17 10:03:38,767 - WARNING -  * Debugger is active!
2025-06-17 10:03:38,770 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:03:42,618 - INFO - Connected to database
2025-06-17 10:03:43,674 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:03:43,700 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:03:43,701 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:03:43,911 - INFO - Connected to database
2025-06-17 10:03:44,410 - DEBUG - Loading model cost 0.709 seconds.
2025-06-17 10:03:44,410 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:03:44,476 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:03:44,487 - INFO - Database connection closed
2025-06-17 10:03:44,488 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:44] "GET / HTTP/1.1" 200 -
2025-06-17 10:03:44,675 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:03:44,697 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:03:44,701 - INFO - Database connection closed
2025-06-17 10:03:44,701 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:44] "GET / HTTP/1.1" 200 -
2025-06-17 10:03:45,009 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:45] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:03:53,042 - INFO - Connected to database
2025-06-17 10:03:54,879 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:03:54,933 - DEBUG - Extracting category from query: 'give me food coupons', words: ['give', 'me', 'food', 'coupons']
2025-06-17 10:03:54,933 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 10:03:54,958 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:03:55,026 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000019DC7997B60>
2025-06-17 10:03:55,027 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000019DC76D7140> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:03:55,068 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000019DC7A86210>
2025-06-17 10:03:55,069 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:03:55,074 - DEBUG - send_request_headers.complete
2025-06-17 10:03:55,074 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:03:55,076 - DEBUG - send_request_body.complete
2025-06-17 10:03:55,076 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:03:55,627 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:33:55 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'84'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499566'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998844325'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'85'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'006f7e02f371e322cc31be19e6227944'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=1R1iL6SXX_YgSAJfKJCa.Cm.gWPkTE_VYBqpR6M.zrw-1750134835-1.0.1.1-4AfeDlcJiwUYwE2TldLF6uMazpaOwxMtKy5cfWNd4SuIKO5LmNCsbWB7PG3tuDD3tcsvid1bMJF16vWMiFUVtsm9Zffpsd8dR0_In4rVhHA; path=/; expires=Tue, 17-Jun-25 05:03:55 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Qvi5dzL_QuRJYUE56LGZOKPsstFbHxbfuf89MEsHwNY-1750134835587-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fd4df1d1647ed-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:03:55,629 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:03:55,630 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:03:55,631 - DEBUG - receive_response_body.complete
2025-06-17 10:03:55,632 - DEBUG - response_closed.started
2025-06-17 10:03:55,632 - DEBUG - response_closed.complete
2025-06-17 10:03:55,637 - DEBUG - Mistral location analysis: None
2025-06-17 10:03:55,638 - DEBUG - Location candidates: ['give me food coupons', 'give me food', 'give me', 'me food coupons', 'me food', 'food coupons']
2025-06-17 10:03:55,648 - INFO - Fuzzy location matched: kowloon 'Mei Foo' with candidate 'me food'
2025-06-17 10:03:55,660 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:03:55,661 - DEBUG - send_request_headers.complete
2025-06-17 10:03:55,662 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:03:55,662 - DEBUG - send_request_body.complete
2025-06-17 10:03:55,663 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:03:55,927 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:33:55 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'92'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499468'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998844227'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'92'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'6df3f2368410eb6d0f39ce170b096874'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fd4e2c9ff47ed-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:03:55,929 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:03:55,930 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:03:55,930 - DEBUG - receive_response_body.complete
2025-06-17 10:03:55,931 - DEBUG - response_closed.started
2025-06-17 10:03:55,932 - DEBUG - response_closed.complete
2025-06-17 10:03:55,934 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:03:55,936 - DEBUG - Cleaned query: 'food coupons'
2025-06-17 10:03:55,943 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:03:55,956 - INFO - No coupon name matched for query: 'give me food coupons'
2025-06-17 10:03:55,958 - DEBUG - Query: give me food coupons, Category: Food, Location: {'name': 'Mei Foo', 'type': 'selected_area', 'id': '22', 'table': 'kowloon'}, Coupon Name: None, Discount: None
2025-06-17 10:03:55,982 - DEBUG - General query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20]
2025-06-17 10:03:55,991 - DEBUG - Found 20 rows for general query
2025-06-17 10:03:56,003 - DEBUG - Found 20 coupons for category 'Food' and location 'Mei Foo'
2025-06-17 10:03:56,014 - ERROR - Error processing query 'give me food coupons': name 'db_connection' is not defined
2025-06-17 10:03:56,015 - DEBUG - close.started
2025-06-17 10:03:56,016 - DEBUG - close.complete
2025-06-17 10:03:56,016 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:03:56,027 - INFO - Database connection closed
2025-06-17 10:03:56,027 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:56] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:03:56,051 - INFO - Connected to database
2025-06-17 10:03:57,982 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:03:58,031 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:03:58,037 - INFO - Database connection closed
2025-06-17 10:03:58,041 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:58] "GET / HTTP/1.1" 200 -
2025-06-17 10:03:58,196 - INFO - 127.0.0.1 - - [17/Jun/2025 10:03:58] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:06:14,857 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 10:06:15,593 - INFO -  * Restarting with stat
2025-06-17 10:06:17,522 - WARNING -  * Debugger is active!
2025-06-17 10:06:17,528 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:08:13,160 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:08:13,329 - INFO -  * Restarting with stat
2025-06-17 10:08:14,934 - WARNING -  * Debugger is active!
2025-06-17 10:08:14,940 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:08:18,985 - INFO - Connected to database
2025-06-17 10:08:19,765 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:19,793 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:08:19,795 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:08:20,295 - DEBUG - Loading model cost 0.501 seconds.
2025-06-17 10:08:20,295 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:08:20,303 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:20,311 - INFO - Database connection closed
2025-06-17 10:08:20,312 - INFO - 127.0.0.1 - - [17/Jun/2025 10:08:20] "GET / HTTP/1.1" 200 -
2025-06-17 10:08:20,543 - INFO - 127.0.0.1 - - [17/Jun/2025 10:08:20] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:08:27,035 - INFO - Connected to database
2025-06-17 10:08:29,055 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:29,208 - DEBUG - Extracting category from query: 'give me food coupons', words: ['give', 'me', 'food', 'coupons']
2025-06-17 10:08:29,208 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 10:08:29,221 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:08:29,254 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DD2FA10>
2025-06-17 10:08:29,255 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C09DA87140> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:08:29,288 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DAA7B10>
2025-06-17 10:08:29,289 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:08:29,290 - DEBUG - send_request_headers.complete
2025-06-17 10:08:29,290 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:08:29,290 - DEBUG - send_request_body.complete
2025-06-17 10:08:29,291 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:08:29,712 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:38:29 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'76'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499565'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842907'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'93c9ec775661f9288acb93416df2bc43'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=N8f0X0e7MAV6FyQWK251a682bpbbWDy8nHQb2Dh92J8-1750135109-1.0.1.1-McYszuMdVrFD.WurJCAdWH40zIskYLZ7hGa1pvd26FvEJ.oid8pUxCeLclKo2ueKQ167V71sJbgQQlV.LFWJlM3EIg3W0RBhtlmXPxGZkZA; path=/; expires=Tue, 17-Jun-25 05:08:29 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=DpksJnt5F.pQW4jK4l5nChwqAIP6Z8MZnNA6dxT8fXU-1750135109673-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fdb90ff004424-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:08:29,714 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:08:29,715 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:08:29,716 - DEBUG - receive_response_body.complete
2025-06-17 10:08:29,717 - DEBUG - response_closed.started
2025-06-17 10:08:29,717 - DEBUG - response_closed.complete
2025-06-17 10:08:29,726 - DEBUG - Mistral location analysis: None
2025-06-17 10:08:29,726 - DEBUG - Location candidates: ['give me food coupons', 'give me food', 'give me', 'me food coupons', 'me food', 'food coupons']
2025-06-17 10:08:29,739 - INFO - Fuzzy location matched: kowloon 'Mei Foo' with candidate 'me food'
2025-06-17 10:08:29,756 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:08:29,758 - DEBUG - send_request_headers.complete
2025-06-17 10:08:29,759 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:08:29,760 - DEBUG - send_request_body.complete
2025-06-17 10:08:29,761 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:08:30,324 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:38:30 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'102'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499467'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842809'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'103'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'b88be1546439875a05e60151e072c171'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fdb93db1a4424-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:08:30,325 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:08:30,326 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:08:30,326 - DEBUG - receive_response_body.complete
2025-06-17 10:08:30,327 - DEBUG - response_closed.started
2025-06-17 10:08:30,327 - DEBUG - response_closed.complete
2025-06-17 10:08:30,329 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:08:30,330 - DEBUG - Cleaned query: 'food coupons'
2025-06-17 10:08:30,338 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:08:30,359 - INFO - No coupon name matched for query: 'give me food coupons'
2025-06-17 10:08:30,360 - DEBUG - Query: give me food coupons, Category: Food, Location: {'name': 'Mei Foo', 'type': 'selected_area', 'id': '22', 'table': 'kowloon'}, Coupon Name: None, Discount: None
2025-06-17 10:08:30,365 - DEBUG - General query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20]
2025-06-17 10:08:30,369 - DEBUG - Found 20 rows for general query
2025-06-17 10:08:30,383 - DEBUG - Found 20 coupons for category 'Food' and location 'Mei Foo'
2025-06-17 10:08:32,463 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:32,518 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:32,519 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:32,520 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:34,620 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:34,670 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:08:34,671 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:36,630 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:36,688 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:08:36,689 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:38,752 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:38,798 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:08:38,799 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:40,661 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:40,700 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:08:40,700 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:42,718 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:42,763 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:08:42,788 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:44,419 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:44,461 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:44,463 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:44,464 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:45,837 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:45,873 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:45,873 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:45,874 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:47,597 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:47,634 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:47,635 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:47,635 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:49,526 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:49,631 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:49,635 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:49,637 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:51,338 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:51,398 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:51,398 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:51,399 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:53,127 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:53,215 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:53,215 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:53,217 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:54,847 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:54,905 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:54,905 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:54,908 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:56,484 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:56,530 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:56,530 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:56,531 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:58,140 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:58,205 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:58,209 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:58,210 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:08:59,944 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:08:59,992 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:08:59,993 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:08:59,994 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:01,690 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:02,269 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:09:02,269 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:02,275 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:03,927 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:03,979 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:03,980 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:05,627 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:05,670 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:09:05,675 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:05,677 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:07,372 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:07,428 - WARNING - Selected_area '33' found in kowloon, but coupon_area '1' expects hong_kong
2025-06-17 10:09:07,429 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:07,430 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:07,436 - DEBUG - close.started
2025-06-17 10:09:07,436 - DEBUG - close.complete
2025-06-17 10:09:07,438 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:07,447 - INFO - Database connection closed
2025-06-17 10:09:07,448 - INFO - 127.0.0.1 - - [17/Jun/2025 10:09:07] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:09:07,467 - INFO - Connected to database
2025-06-17 10:09:09,351 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:09,396 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:09,407 - INFO - Database connection closed
2025-06-17 10:09:09,408 - INFO - 127.0.0.1 - - [17/Jun/2025 10:09:09] "GET / HTTP/1.1" 200 -
2025-06-17 10:09:09,602 - INFO - 127.0.0.1 - - [17/Jun/2025 10:09:09] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:09:26,846 - INFO - Connected to database
2025-06-17 10:09:28,681 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:28,737 - DEBUG - Extracting category from query: 'coupons for wan chai', words: ['coupons', 'for', 'wan', 'chai']
2025-06-17 10:09:28,738 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,738 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,739 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,740 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,741 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,741 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,742 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,742 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,743 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,743 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,743 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,744 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,744 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,745 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,745 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,745 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,746 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,746 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,747 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,747 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,748 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,748 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,748 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,751 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,752 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,754 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,754 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,755 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:09:28,755 - INFO - No category matched for query: coupons for wan chai
2025-06-17 10:09:28,764 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:09:28,795 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DE179D0>
2025-06-17 10:09:28,796 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C09DE3CD40> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:09:28,841 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DE2C640>
2025-06-17 10:09:28,842 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:09:28,843 - DEBUG - send_request_headers.complete
2025-06-17 10:09:28,843 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:09:28,844 - DEBUG - send_request_body.complete
2025-06-17 10:09:28,845 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:09:29,409 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:39:29 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499854'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842368'), (b'x-ratelimit-tokens-query-cost', b'146'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'54c54d4a9cd91840b6edbf3dbfb14c77'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=s76_kXlPG27Gko.ZnE3LTG58kRT8T5Ra2BTz6yicMp0-1750135169-1.0.1.1-3KzdAtJoQx8NidK1JaGAXQptdWBLIjX4N2BZXLfrlzpuZtvuOM2JWTgu0VIzZnIYIDyNzR.Fzf1KZTPXaesz7jZMvXsFBiS.59c7Fljjkn0; path=/; expires=Tue, 17-Jun-25 05:09:29 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=CBBDid4.TEwpWT6Z4RRnQJkozA9dibbg7dSS.dC710w-1750135169364-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fdd0529374732-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:09:29,411 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:09:29,412 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:09:29,418 - DEBUG - receive_response_body.complete
2025-06-17 10:09:29,419 - DEBUG - response_closed.started
2025-06-17 10:09:29,420 - DEBUG - response_closed.complete
2025-06-17 10:09:29,422 - DEBUG - Mistral location analysis: Wan Chai
2025-06-17 10:09:29,422 - INFO - Mistral matched specific area: Wan Chai -> Wan Chai
2025-06-17 10:09:29,431 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:09:29,435 - DEBUG - send_request_headers.complete
2025-06-17 10:09:29,436 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:09:29,437 - DEBUG - send_request_body.complete
2025-06-17 10:09:29,437 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:09:29,700 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:39:29 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499755'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842269'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'85'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'c22fcb2737519e4985e29809a8c8862c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fdd08dda64732-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:09:29,702 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:09:29,702 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:09:29,703 - DEBUG - receive_response_body.complete
2025-06-17 10:09:29,704 - DEBUG - response_closed.started
2025-06-17 10:09:29,704 - DEBUG - response_closed.complete
2025-06-17 10:09:29,707 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:09:29,707 - DEBUG - Cleaned query: 'coupons wan chai'
2025-06-17 10:09:29,715 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:09:29,744 - INFO - No coupon name matched for query: 'coupons for wan chai'
2025-06-17 10:09:29,745 - DEBUG - Query: coupons for wan chai, Category: Food, Location: {'name': 'Wan Chai', 'type': 'selected_area', 'id': '9', 'table': 'hong_kong'}, Coupon Name: None, Discount: None
2025-06-17 10:09:29,747 - DEBUG - General query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20]
2025-06-17 10:09:29,753 - DEBUG - Found 20 rows for general query
2025-06-17 10:09:29,763 - DEBUG - Found 20 coupons for category 'Food' and location 'Wan Chai'
2025-06-17 10:09:31,375 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:31,415 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:31,416 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:33,214 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:33,262 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:09:33,262 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:33,263 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:34,916 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:34,971 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:09:34,971 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:34,972 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:36,607 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:37,122 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:09:37,123 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:37,123 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:38,731 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:38,774 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:09:38,819 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:38,820 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:40,493 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:40,538 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:09:40,538 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:09:40,539 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:42,212 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:42,352 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:42,354 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:44,372 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:44,413 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:44,414 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:46,075 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:46,125 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:46,126 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:47,801 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:47,850 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:47,851 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:49,528 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:49,569 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:49,569 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:51,220 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:51,269 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:51,270 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:53,197 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:53,262 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:53,263 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:54,836 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:54,883 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:54,884 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:56,725 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:56,772 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:56,772 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:09:58,903 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:09:58,962 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:09:58,965 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:00,656 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:10:00,716 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:10:00,716 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:02,310 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:10:02,351 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:10:02,351 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:10:02,352 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:03,990 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:10:04,036 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:10:04,036 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:05,666 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:10:05,711 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:10:05,713 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:05,718 - DEBUG - close.started
2025-06-17 10:10:05,718 - DEBUG - close.complete
2025-06-17 10:10:05,719 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:05,730 - INFO - Database connection closed
2025-06-17 10:10:05,730 - INFO - 127.0.0.1 - - [17/Jun/2025 10:10:05] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:10:05,748 - INFO - Connected to database
2025-06-17 10:10:07,509 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:10:07,561 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:10:07,567 - INFO - Database connection closed
2025-06-17 10:10:07,567 - INFO - 127.0.0.1 - - [17/Jun/2025 10:10:07] "GET / HTTP/1.1" 200 -
2025-06-17 10:10:07,730 - INFO - 127.0.0.1 - - [17/Jun/2025 10:10:07] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:12:35,459 - INFO - Connected to database
2025-06-17 10:12:37,263 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:12:37,307 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:12:37,315 - INFO - Database connection closed
2025-06-17 10:12:37,315 - INFO - 127.0.0.1 - - [17/Jun/2025 10:12:37] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:12:37,336 - INFO - Connected to database
2025-06-17 10:12:39,215 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:12:39,251 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:12:39,257 - INFO - Database connection closed
2025-06-17 10:12:39,257 - INFO - 127.0.0.1 - - [17/Jun/2025 10:12:39] "GET / HTTP/1.1" 200 -
2025-06-17 10:12:39,406 - INFO - 127.0.0.1 - - [17/Jun/2025 10:12:39] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:12:52,040 - INFO - Connected to database
2025-06-17 10:12:53,796 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:12:54,401 - DEBUG - Extracting category from query: 'give coupons for wn chai', words: ['give', 'coupons', 'for', 'wn', 'chai']
2025-06-17 10:12:54,402 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,403 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,403 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,404 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,405 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,411 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,413 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,413 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,414 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,414 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,415 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,415 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,416 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,417 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,417 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,418 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,418 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,419 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,419 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,421 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,422 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,423 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:12:54,425 - INFO - No category matched for query: give coupons for wn chai
2025-06-17 10:12:54,434 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:12:54,488 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DE2EFD0>
2025-06-17 10:12:54,490 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C09DF26720> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:12:54,531 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C09DF3C950>
2025-06-17 10:12:54,532 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:12:54,533 - DEBUG - send_request_headers.complete
2025-06-17 10:12:54,533 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:12:54,534 - DEBUG - send_request_body.complete
2025-06-17 10:12:54,535 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:12:54,819 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:42:54 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'87'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499852'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842121'), (b'x-ratelimit-tokens-query-cost', b'148'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'87'), (b'x-kong-proxy-latency', b'10'), (b'x-kong-request-id', b'79f29460fbd3fe2719f1677549466436'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=D8O63S4cNjH98uLtVG45_QJYy.yCr4Rj78dgK5ey6BA-1750135374-1.0.1.1-a41CX0dNdWTnK27o8ytlWUBD6MG0PQ4jk0Xs__flz6INatKHe09GMU3wzH7qSn.tx6ht2s0SpmaYSa7H8aBx.PoPYw5SwAbx.rhXvibGvtI; path=/; expires=Tue, 17-Jun-25 05:12:54 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=GQmUgculX.A.hbCg_Prjhv7VnsCQWuJYRIDxKa_uHJQ-1750135374776-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fe20ab80946b6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:12:54,821 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:12:54,822 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:12:54,823 - DEBUG - receive_response_body.complete
2025-06-17 10:12:54,824 - DEBUG - response_closed.started
2025-06-17 10:12:54,824 - DEBUG - response_closed.complete
2025-06-17 10:12:54,827 - DEBUG - Mistral location analysis: Wan Chai
2025-06-17 10:12:54,828 - INFO - Mistral matched specific area: Wan Chai -> Wan Chai
2025-06-17 10:12:54,836 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:12:54,837 - DEBUG - send_request_headers.complete
2025-06-17 10:12:54,838 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:12:54,843 - DEBUG - send_request_body.complete
2025-06-17 10:12:54,843 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:12:55,120 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:42:55 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'72'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499751'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998842020'), (b'x-ratelimit-tokens-query-cost', b'101'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'3b680e1a1ab9c61e8de3f35049b8336e'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fe20caaef46b6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:12:55,121 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:12:55,123 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:12:55,124 - DEBUG - receive_response_body.complete
2025-06-17 10:12:55,125 - DEBUG - response_closed.started
2025-06-17 10:12:55,125 - DEBUG - response_closed.complete
2025-06-17 10:12:55,127 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:12:55,128 - DEBUG - Cleaned query: 'coupons wn chai'
2025-06-17 10:12:55,135 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:12:55,161 - INFO - No coupon name matched for query: 'give coupons for wn chai'
2025-06-17 10:12:55,162 - DEBUG - Query: give coupons for wn chai, Category: None, Location: {'name': 'Wan Chai', 'type': 'selected_area', 'id': '9', 'table': 'hong_kong'}, Coupon Name: None, Discount: None
2025-06-17 10:12:55,163 - DEBUG - General query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             ORDER BY c.created_at DESC LIMIT %s with params: [20]
2025-06-17 10:12:55,167 - DEBUG - Found 20 rows for general query
2025-06-17 10:12:55,181 - DEBUG - Found 20 coupons for category 'None' and location 'Wan Chai'
2025-06-17 10:12:56,774 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:12:56,820 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:12:56,821 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:12:58,466 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:12:58,532 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:12:58,533 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:00,190 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:00,226 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:00,227 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:01,863 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:01,908 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:13:01,909 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:13:01,911 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:03,564 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:03,605 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:13:03,606 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:13:03,607 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:05,238 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:05,294 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:13:05,294 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:13:05,295 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:06,940 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:06,991 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:13:06,991 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:13:06,992 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:08,628 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:08,668 - WARNING - Selected_area '26' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:13:08,669 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:13:08,671 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:10,364 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:10,416 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:10,417 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:12,019 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:12,573 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:12,578 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:14,234 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:14,282 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:14,282 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:16,228 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:16,278 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:16,279 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:17,942 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:17,986 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:17,987 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:19,644 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:19,693 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:19,694 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:21,372 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:21,412 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:21,412 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:23,084 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:23,158 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:23,159 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:24,767 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:24,811 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:24,812 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:26,393 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:26,425 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:26,426 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:28,076 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:28,125 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:28,126 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:29,773 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:29,834 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:13:29,836 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:29,842 - DEBUG - close.started
2025-06-17 10:13:29,843 - DEBUG - close.complete
2025-06-17 10:13:29,843 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:29,856 - INFO - Database connection closed
2025-06-17 10:13:29,856 - INFO - 127.0.0.1 - - [17/Jun/2025 10:13:29] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:13:29,876 - INFO - Connected to database
2025-06-17 10:13:31,700 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:13:31,741 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:13:31,748 - INFO - Database connection closed
2025-06-17 10:13:31,749 - INFO - 127.0.0.1 - - [17/Jun/2025 10:13:31] "GET / HTTP/1.1" 200 -
2025-06-17 10:13:31,908 - INFO - 127.0.0.1 - - [17/Jun/2025 10:13:31] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:17:24,868 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:17:25,501 - INFO -  * Restarting with stat
2025-06-17 10:17:27,668 - WARNING -  * Debugger is active!
2025-06-17 10:17:27,672 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:17:31,637 - INFO - Connected to database
2025-06-17 10:17:32,373 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:32,399 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:17:32,400 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:17:32,956 - DEBUG - Loading model cost 0.557 seconds.
2025-06-17 10:17:32,956 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:17:32,962 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:32,973 - INFO - Database connection closed
2025-06-17 10:17:32,973 - INFO - 127.0.0.1 - - [17/Jun/2025 10:17:32] "GET / HTTP/1.1" 200 -
2025-06-17 10:17:33,195 - INFO - 127.0.0.1 - - [17/Jun/2025 10:17:33] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:17:40,935 - INFO - Connected to database
2025-06-17 10:17:42,719 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:42,772 - DEBUG - Extracting category from query: 'coupons for wan chai', words: ['coupons', 'for', 'wan', 'chai']
2025-06-17 10:17:42,773 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,774 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,775 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,775 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,776 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,776 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,777 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,777 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,779 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,784 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,784 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,785 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,785 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,786 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,786 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,787 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,787 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,788 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,788 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,788 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,790 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,790 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,791 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,791 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,792 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,792 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,793 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,793 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:17:42,793 - INFO - No category matched for query: coupons for wan chai
2025-06-17 10:17:42,807 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:17:42,854 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C9733EFA10>
2025-06-17 10:17:42,855 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C9730AB1D0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:17:42,899 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C9730C7B10>
2025-06-17 10:17:42,900 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:17:42,901 - DEBUG - send_request_headers.complete
2025-06-17 10:17:42,901 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:17:42,902 - DEBUG - send_request_body.complete
2025-06-17 10:17:42,902 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:17:43,456 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:47:43 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'87'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499092'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998840018'), (b'x-ratelimit-tokens-query-cost', b'146'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'87'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'c45ce8486568953cc610de71c0eabd07'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=izonhPvqJ9jlABTeqwBCflpHq.WnrZ_lZPtuS9dPJjE-1750135663-1.0.1.1-X9KHUbdgnXIg9JeCLvMFg1oTY1TY7j2gOgMBIH0_eYaFtzLnP18y9GXfA5mx6phmLua0.ztzCL2w8swmEeq5Ice1AufUAK7xC1bCuCrTZIs; path=/; expires=Tue, 17-Jun-25 05:17:43 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=0XDunzYX8s5V5tC4Sct6wJCxA7O1ayyaPuv5O77p_Jk-1750135663412-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fe9150f893b3a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:17:43,459 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:17:43,459 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:17:43,460 - DEBUG - receive_response_body.complete
2025-06-17 10:17:43,463 - DEBUG - response_closed.started
2025-06-17 10:17:43,465 - DEBUG - response_closed.complete
2025-06-17 10:17:43,469 - DEBUG - Mistral location analysis: Wan Chai
2025-06-17 10:17:43,469 - INFO - Mistral matched specific area: Wan Chai -> Wan Chai
2025-06-17 10:17:43,482 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:17:43,485 - DEBUG - send_request_headers.complete
2025-06-17 10:17:43,486 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:17:43,488 - DEBUG - send_request_body.complete
2025-06-17 10:17:43,489 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:17:43,759 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:47:43 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'84'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'498993'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998839919'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'85'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'6aa65d6ae7671c69d2029734b01d3371'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fe918abe63b3a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:17:43,760 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:17:43,762 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:17:43,763 - DEBUG - receive_response_body.complete
2025-06-17 10:17:43,764 - DEBUG - response_closed.started
2025-06-17 10:17:43,764 - DEBUG - response_closed.complete
2025-06-17 10:17:43,766 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:17:43,769 - DEBUG - Cleaned query: 'coupons wan chai'
2025-06-17 10:17:43,775 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:17:43,805 - INFO - No coupon name matched for query: 'coupons for wan chai'
2025-06-17 10:17:43,806 - DEBUG - Query: coupons for wan chai, Category: None, Location: {'name': 'Wan Chai', 'type': 'selected_area', 'id': '9', 'table': 'hong_kong'}, Coupon Name: None, Discount: None
2025-06-17 10:17:43,808 - DEBUG - Location IDs for Wan Chai in hong_kong: ['9']
2025-06-17 10:17:43,808 - DEBUG - Searching coupons with selected_area IN ['9'], area = None
2025-06-17 10:17:43,809 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.selected_area IN (%s) ORDER BY c.created_at DESC LIMIT %s with params: ['9', 20]
2025-06-17 10:17:43,813 - DEBUG - Found 12 rows
2025-06-17 10:17:43,820 - DEBUG - Returning 12 coupons for category 'None', location 'Wan Chai'
2025-06-17 10:17:43,821 - DEBUG - Coupon results: [{'id': 983, 'name_en': 'Coupon 831', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 982, 'name_en': 'Coupon 830', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 858, 'name_en': 'Coupon 713', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 857, 'name_en': 'Coupon 712', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 854, 'name_en': 'Coupon 709', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 626, 'name_en': 'Coupon 509', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 625, 'name_en': 'Coupon 508', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 624, 'name_en': 'Coupon 507', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 574, 'name_en': 'Coupon 457', 'selected_area': '9', 'territory': '', 'area': '2'}, {'id': 558, 'name_en': 'Coupon 441', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 557, 'name_en': 'Coupon 440', 'selected_area': '9', 'territory': '', 'area': '1'}, {'id': 556, 'name_en': 'Coupon 439', 'selected_area': '9', 'territory': '', 'area': '1'}]
2025-06-17 10:17:45,493 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:45,547 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:45,549 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:47,221 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:47,291 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:47,292 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:48,973 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:49,035 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:49,036 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:50,691 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:50,747 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:50,748 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:52,394 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:52,438 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:52,439 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:54,485 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:54,516 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:54,517 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:56,290 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:56,769 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:56,770 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:17:58,780 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:17:58,831 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:17:58,831 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:00,484 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:00,522 - WARNING - Selected_area '9' found in hong_kong, but coupon_area '2' expects kowloon
2025-06-17 10:18:00,522 - DEBUG - Found area name: To Kwa Wan for selected_area: 9, table: kowloon
2025-06-17 10:18:00,522 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:02,203 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:02,281 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:18:02,282 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:03,994 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:04,041 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:18:04,045 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:05,717 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:05,754 - DEBUG - Found area name: Wan Chai for selected_area: 9, table: hong_kong
2025-06-17 10:18:05,754 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:05,762 - DEBUG - close.started
2025-06-17 10:18:05,762 - DEBUG - close.complete
2025-06-17 10:18:05,763 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:05,768 - INFO - Database connection closed
2025-06-17 10:18:05,769 - INFO - 127.0.0.1 - - [17/Jun/2025 10:18:05] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:18:05,788 - INFO - Connected to database
2025-06-17 10:18:07,465 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:07,512 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:07,516 - INFO - Database connection closed
2025-06-17 10:18:07,516 - INFO - 127.0.0.1 - - [17/Jun/2025 10:18:07] "GET / HTTP/1.1" 200 -
2025-06-17 10:18:07,662 - INFO - 127.0.0.1 - - [17/Jun/2025 10:18:07] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:18:23,074 - INFO - Connected to database
2025-06-17 10:18:24,807 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:24,855 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 10:18:24,855 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,856 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,856 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,857 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,857 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,857 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,858 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,858 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,859 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,859 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,859 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,860 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,860 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,860 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,861 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,861 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,861 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,861 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,861 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,862 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,862 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,863 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,863 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,863 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,864 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,864 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,865 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,865 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:18:24,865 - INFO - No category matched for query: coupons for hong kong
2025-06-17 10:18:24,876 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:18:24,923 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C9734D79D0>
2025-06-17 10:18:24,927 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C9734F7DA0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:18:24,964 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C9734EC640>
2025-06-17 10:18:24,964 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:18:24,965 - DEBUG - send_request_headers.complete
2025-06-17 10:18:24,966 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:18:24,967 - DEBUG - send_request_body.complete
2025-06-17 10:18:24,968 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:18:25,244 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:48:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998839776'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'f0cf9027234db02aff42990022bd3d22'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=GCoMacg3bBkVjKyL6d4ixK.RxxdtK7AKg.guZRWau0E-1750135705-1.0.1.1-hW4WiNxI.cx4GZ8bjJ.tGBT3EzTYsbOG0qxVaMovdOW0F7JnAPHVluMBrf6ciZV8.4H0FvynnXxWVBaQbe.tKDSzt07n5dplVC4gEiibOag; path=/; expires=Tue, 17-Jun-25 05:18:25 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=0QpJCJyOPeZZD1U1KFvhWS4Mb_M_1BuJzDiwy.dj4z0-1750135705200-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fea1beb8aff6b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:18:25,246 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:18:25,246 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:18:25,247 - DEBUG - receive_response_body.complete
2025-06-17 10:18:25,248 - DEBUG - response_closed.started
2025-06-17 10:18:25,249 - DEBUG - response_closed.complete
2025-06-17 10:18:25,251 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 10:18:25,262 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:18:25,263 - DEBUG - send_request_headers.complete
2025-06-17 10:18:25,265 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:18:25,266 - DEBUG - send_request_body.complete
2025-06-17 10:18:25,266 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:18:25,551 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:48:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'68'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998839678'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'69'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'1718056bac1cfd507098432b0527f713'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950fea1dd9c4ff6b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:18:25,554 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:18:25,556 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:18:25,556 - DEBUG - receive_response_body.complete
2025-06-17 10:18:25,557 - DEBUG - response_closed.started
2025-06-17 10:18:25,558 - DEBUG - response_closed.complete
2025-06-17 10:18:25,559 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:18:25,560 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 10:18:25,567 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:18:25,596 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 10:18:25,597 - DEBUG - Query: coupons for hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 10:18:25,599 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:18:25,599 - DEBUG - Searching coupons with area: 1
2025-06-17 10:18:25,600 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s ORDER BY c.created_at DESC LIMIT %s with params: ['1', 20]
2025-06-17 10:18:25,606 - DEBUG - Found 20 rows
2025-06-17 10:18:25,621 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 10:18:27,313 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:27,366 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:27,366 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:29,050 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:29,101 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:29,118 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:31,137 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:31,182 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:31,183 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:32,854 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:32,911 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:32,912 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:34,546 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:34,585 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:34,587 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:36,222 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:36,264 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:36,264 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:37,874 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:37,926 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:37,927 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:39,587 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:39,640 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:39,640 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:41,321 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:41,361 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:41,361 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:43,229 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:43,274 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:43,274 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:44,965 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:45,058 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:45,059 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:46,744 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:46,792 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:46,792 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:48,490 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:48,523 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:48,524 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:50,283 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:50,545 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:50,545 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:52,506 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:52,568 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:52,570 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:54,226 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:54,271 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:54,272 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:55,918 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:55,959 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:55,960 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:57,627 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:57,705 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:57,706 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:18:59,374 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:18:59,452 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:18:59,453 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:19:01,536 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:19:01,587 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:19:01,588 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:19:01,597 - DEBUG - close.started
2025-06-17 10:19:01,598 - DEBUG - close.complete
2025-06-17 10:19:01,599 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:19:01,606 - INFO - Database connection closed
2025-06-17 10:19:01,606 - INFO - 127.0.0.1 - - [17/Jun/2025 10:19:01] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:19:01,627 - INFO - Connected to database
2025-06-17 10:19:03,393 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:19:03,434 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:19:03,440 - INFO - Database connection closed
2025-06-17 10:19:03,441 - INFO - 127.0.0.1 - - [17/Jun/2025 10:19:03] "GET / HTTP/1.1" 200 -
2025-06-17 10:19:03,615 - INFO - 127.0.0.1 - - [17/Jun/2025 10:19:03] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:24:16,585 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:24:18,148 - INFO -  * Restarting with stat
2025-06-17 10:24:20,481 - WARNING -  * Debugger is active!
2025-06-17 10:24:20,486 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:24:22,830 - INFO - Connected to database
2025-06-17 10:24:23,547 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:23,568 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:24:23,569 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:24:24,173 - DEBUG - Loading model cost 0.605 seconds.
2025-06-17 10:24:24,174 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:24:24,182 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:24,190 - INFO - Database connection closed
2025-06-17 10:24:24,191 - INFO - 127.0.0.1 - - [17/Jun/2025 10:24:24] "GET / HTTP/1.1" 200 -
2025-06-17 10:24:24,465 - INFO - 127.0.0.1 - - [17/Jun/2025 10:24:24] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:24:31,930 - INFO - Connected to database
2025-06-17 10:24:33,939 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:33,985 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 10:24:33,985 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,986 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,986 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,987 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,988 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,988 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,989 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,989 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,989 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,990 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,992 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,994 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,994 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,995 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,995 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,996 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,996 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,997 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,998 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,998 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,998 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,999 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:33,999 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,000 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,000 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,001 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,001 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,002 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:24:34,003 - INFO - No category matched for query: coupons for hong kong
2025-06-17 10:24:34,020 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:24:34,056 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD36FA10>
2025-06-17 10:24:34,058 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001ABDD0BACC0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:24:34,087 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD0D7B10>
2025-06-17 10:24:34,088 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:24:34,089 - DEBUG - send_request_headers.complete
2025-06-17 10:24:34,089 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:24:34,090 - DEBUG - send_request_body.complete
2025-06-17 10:24:34,092 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:24:34,642 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:54:34 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'82'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499062'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998838740'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'83'), (b'x-kong-proxy-latency', b'8'), (b'x-kong-request-id', b'774246343c1d7b592d117606b24a7a38'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=NZw_gqQJzGK34ZFgAvOJbCuN4c47f_MeK3VvtAfMLp8-1750136074-1.0.1.1-P.WWU1fSYc8ZFcoBuFG67.dE94fPYqpTbgQeHHvg8BK7HAKljduwO3_Upq8uFCaHhQ28leDFFn5yHGzb4ztqQZ5F8j63QpIe4RvAF.nFa5w; path=/; expires=Tue, 17-Jun-25 05:24:34 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=a21GZdb56IPXGffLPif6qaVNPc6N4mZ0KkJj7EFuQJI-1750136074598-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff31eed3aff6c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:24:34,646 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:24:34,647 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:24:34,648 - DEBUG - receive_response_body.complete
2025-06-17 10:24:34,649 - DEBUG - response_closed.started
2025-06-17 10:24:34,650 - DEBUG - response_closed.complete
2025-06-17 10:24:34,653 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 10:24:34,668 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:24:34,669 - DEBUG - send_request_headers.complete
2025-06-17 10:24:34,669 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:24:34,670 - DEBUG - send_request_body.complete
2025-06-17 10:24:34,671 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:24:34,941 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:54:34 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'498964'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998838642'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'53'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'6f17b4317fd38809821db50a845c0e5a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff3228a1bff6c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:24:34,942 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:24:34,943 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:24:34,944 - DEBUG - receive_response_body.complete
2025-06-17 10:24:34,944 - DEBUG - response_closed.started
2025-06-17 10:24:34,945 - DEBUG - response_closed.complete
2025-06-17 10:24:34,947 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:24:34,948 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 10:24:34,963 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:24:35,010 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 10:24:35,011 - DEBUG - Query: coupons for hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 10:24:35,013 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:24:35,013 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:24:35,014 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 10:24:35,019 - DEBUG - Found 20 rows
2025-06-17 10:24:35,052 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 10:24:37,236 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:37,362 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:37,364 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:39,096 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:39,165 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:39,166 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:40,820 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:40,867 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:40,868 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:42,560 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:42,616 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:42,616 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:44,569 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:44,609 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:44,610 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:46,320 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:46,369 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:46,369 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:48,303 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:48,344 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:48,344 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:49,991 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:50,045 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:50,046 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:51,691 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:52,177 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:52,178 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:53,854 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:53,894 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:53,895 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:55,689 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:55,745 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:55,746 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:57,678 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:57,716 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:57,716 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:24:59,334 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:24:59,392 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:24:59,393 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:01,070 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:01,116 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:01,117 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:03,245 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:03,309 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:03,309 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:05,310 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:05,374 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:05,375 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:07,054 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:07,093 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:07,095 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:08,785 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:08,826 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:08,827 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:10,512 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:10,559 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:10,560 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:12,217 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:12,256 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:25:12,257 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:12,262 - DEBUG - close.started
2025-06-17 10:25:12,263 - DEBUG - close.complete
2025-06-17 10:25:12,264 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:12,275 - INFO - Database connection closed
2025-06-17 10:25:12,275 - INFO - 127.0.0.1 - - [17/Jun/2025 10:25:12] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:25:12,296 - INFO - Connected to database
2025-06-17 10:25:14,140 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:25:14,178 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:25:14,195 - INFO - Database connection closed
2025-06-17 10:25:14,202 - INFO - 127.0.0.1 - - [17/Jun/2025 10:25:14] "GET / HTTP/1.1" 200 -
2025-06-17 10:25:14,481 - INFO - 127.0.0.1 - - [17/Jun/2025 10:25:14] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:27:28,527 - INFO - Connected to database
2025-06-17 10:27:30,441 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:30,481 - DEBUG - Extracting category from query: 'coupons for new territorees', words: ['coupons', 'for', 'new', 'territorees']
2025-06-17 10:27:30,482 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,482 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,483 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,484 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,484 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,485 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,485 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,486 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,490 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,491 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,491 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,491 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,492 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,492 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,493 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,493 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,494 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,494 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,495 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,495 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,496 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,496 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,497 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,498 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,498 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,498 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,499 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,499 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:27:30,500 - INFO - No category matched for query: coupons for new territorees
2025-06-17 10:27:30,515 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:27:30,550 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD4B79D0>
2025-06-17 10:27:30,551 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001ABDD4D4DD0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:27:30,582 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD4CC640>
2025-06-17 10:27:30,583 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:27:30,583 - DEBUG - send_request_headers.complete
2025-06-17 10:27:30,584 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:27:30,584 - DEBUG - send_request_body.complete
2025-06-17 10:27:30,584 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:27:31,275 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:57:31 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'214'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998837024'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'214'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'f33ddc681cee8753ad8b5b79e51da228'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=XGjqYhBHAQIjKhzYZgR6ICRz9zcMJdoJ3W4pSQju33A-1750136251-1.0.1.1-gLcbQtLbWSU1GWUqfoqq86GFu1yxDvjGPhFKuIvOXNR1fe8PdrHV3DiWrDKx656EMK6k22Hl6NL6kvqN0yt3gXA39gk1mOrN4FAnqz_Xg3Q; path=/; expires=Tue, 17-Jun-25 05:27:31 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=MuLegPsugKBLrAqNQ_0ypNglUPP0ifyZaGuZ.uZFrYs-1750136251235-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff76e093846f6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:27:31,276 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:27:31,277 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:27:31,278 - DEBUG - receive_response_body.complete
2025-06-17 10:27:31,282 - DEBUG - response_closed.started
2025-06-17 10:27:31,283 - DEBUG - response_closed.complete
2025-06-17 10:27:31,285 - DEBUG - Mistral location analysis: None
2025-06-17 10:27:31,287 - DEBUG - Location candidates: ['coupons for new territorees', 'coupons for new', 'coupons for', 'for new territorees', 'for new', 'new territorees', 'new', 'territorees']
2025-06-17 10:27:31,301 - INFO - No valid location matched for query: coupons for new territorees
2025-06-17 10:27:31,312 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:27:31,313 - DEBUG - send_request_headers.complete
2025-06-17 10:27:31,314 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:27:31,315 - DEBUG - send_request_body.complete
2025-06-17 10:27:31,316 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:27:31,568 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:57:31 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'72'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499756'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998836924'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'c14e310d70f3b404ae62c545f48b9948'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff7729ef146f6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:27:31,571 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:27:31,573 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:27:31,574 - DEBUG - receive_response_body.complete
2025-06-17 10:27:31,574 - DEBUG - response_closed.started
2025-06-17 10:27:31,575 - DEBUG - response_closed.complete
2025-06-17 10:27:31,581 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:27:31,582 - DEBUG - Cleaned query: 'coupons new territorees'
2025-06-17 10:27:31,590 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:27:31,625 - INFO - No coupon name matched for query: 'coupons for new territorees'
2025-06-17 10:27:31,625 - DEBUG - Query: coupons for new territorees, Category: None, Location: {'id': '1', 'name': 'Hong Kong', 'type': 'area'}, Coupon Name: None, Discount: None
2025-06-17 10:27:31,627 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:27:31,628 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:27:31,628 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 10:27:31,631 - DEBUG - Found 20 rows
2025-06-17 10:27:31,643 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 10:27:33,311 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:33,362 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:33,362 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:34,997 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:35,059 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:35,060 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:36,654 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:36,681 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:36,682 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:38,308 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:38,349 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:38,350 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:40,273 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:40,311 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:40,312 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:42,227 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:42,271 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:42,272 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:43,935 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:43,980 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:43,981 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:45,688 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:45,726 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:45,726 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:47,508 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:47,542 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:47,543 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:49,280 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:49,324 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:49,325 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:52,155 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:52,203 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:52,204 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:53,892 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:53,944 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:53,945 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:55,586 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:55,644 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:55,645 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:57,292 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:57,338 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:57,338 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:27:58,989 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:27:59,058 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:27:59,060 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:00,746 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:00,795 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:28:00,796 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:02,400 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:02,438 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:28:02,438 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:04,058 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:04,108 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:28:04,108 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:05,719 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:05,767 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:28:05,768 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:07,489 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:07,537 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:28:07,537 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:07,543 - DEBUG - close.started
2025-06-17 10:28:07,544 - DEBUG - close.complete
2025-06-17 10:28:07,545 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:07,555 - INFO - Database connection closed
2025-06-17 10:28:07,555 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:07] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:28:07,576 - INFO - Connected to database
2025-06-17 10:28:09,523 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:09,559 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:09,568 - INFO - Database connection closed
2025-06-17 10:28:09,569 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:09] "GET / HTTP/1.1" 200 -
2025-06-17 10:28:09,734 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:09] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:28:19,942 - INFO - Connected to database
2025-06-17 10:28:21,673 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:21,719 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:21,729 - INFO - Database connection closed
2025-06-17 10:28:21,729 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:21] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:28:21,749 - INFO - Connected to database
2025-06-17 10:28:23,631 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:23,701 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:23,708 - INFO - Database connection closed
2025-06-17 10:28:23,710 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:23] "GET / HTTP/1.1" 200 -
2025-06-17 10:28:23,838 - INFO - 127.0.0.1 - - [17/Jun/2025 10:28:23] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:28:33,510 - INFO - Connected to database
2025-06-17 10:28:35,467 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:35,517 - DEBUG - Extracting category from query: 'coupons for new territories', words: ['coupons', 'for', 'new', 'territories']
2025-06-17 10:28:35,518 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,518 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,519 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,519 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,519 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,520 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,520 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,521 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,521 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,522 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,522 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,523 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,524 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,527 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,527 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,528 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,528 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,529 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,529 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,530 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,530 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,531 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,531 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,532 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,532 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,532 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,532 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,533 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:28:35,533 - INFO - No category matched for query: coupons for new territories
2025-06-17 10:28:35,544 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:28:35,573 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD4CEFD0>
2025-06-17 10:28:35,573 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001ABDD5FE330> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:28:35,605 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001ABDD5D8950>
2025-06-17 10:28:35,605 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:28:35,609 - DEBUG - send_request_headers.complete
2025-06-17 10:28:35,610 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:28:35,610 - DEBUG - send_request_body.complete
2025-06-17 10:28:35,611 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:28:36,213 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:58:36 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'88'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499858'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998836782'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'89'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'cb02bc423bd4cb25a50d1328e8f11859'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=du6epluvvjL2lQEjDhXCH8dC4XJwukmk06f8PFCEjNk-1750136316-1.0.1.1-SPWvf1XyV66oLeJKh0u55YSRRFcWrS2EsrO5DqUb758sjYde0h2xKmYALqLFhg5Y2Z7Eop3ZPxvWTE4ZzdhERiK1HNlmTQDeYI0WncdNi18; path=/; expires=Tue, 17-Jun-25 05:28:36 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=PZIk34koXv1LE2zKa2tCKneK3GmkAwRQBPoHPu7okRk-1750136316169-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff9047bfc46fc-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:28:36,215 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:28:36,215 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:28:36,216 - DEBUG - receive_response_body.complete
2025-06-17 10:28:36,217 - DEBUG - response_closed.started
2025-06-17 10:28:36,217 - DEBUG - response_closed.complete
2025-06-17 10:28:36,219 - DEBUG - Mistral location analysis: None
2025-06-17 10:28:36,220 - DEBUG - Location candidates: ['coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 10:28:36,230 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 10:28:36,238 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:28:36,243 - DEBUG - send_request_headers.complete
2025-06-17 10:28:36,243 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:28:36,244 - DEBUG - send_request_body.complete
2025-06-17 10:28:36,244 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:28:36,508 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 04:58:36 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499760'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998836684'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'6da3ee2f327d2b01f8deb85726cfea1a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'950ff908686946fc-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:28:36,510 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:28:36,511 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:28:36,512 - DEBUG - receive_response_body.complete
2025-06-17 10:28:36,513 - DEBUG - response_closed.started
2025-06-17 10:28:36,513 - DEBUG - response_closed.complete
2025-06-17 10:28:36,516 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:28:36,516 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 10:28:36,526 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:28:36,561 - INFO - No coupon name matched for query: 'coupons for new territories'
2025-06-17 10:28:36,562 - DEBUG - Query: coupons for new territories, Category: None, Location: {'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name: None, Discount: None
2025-06-17 10:28:36,564 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:28:36,565 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:28:36,565 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 10:28:36,569 - DEBUG - Found 20 rows
2025-06-17 10:28:36,582 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 10:28:36,583 - DEBUG - Coupon results: [{'id': 1243, 'name_en': 'Test again here', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 1242, 'name_en': 'Testing Here', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 1221, 'name_en': 'Created by branch', 'selected_area': '25', 'territory': '', 'area': '3'}, {'id': 1034, 'name_en': 'Coupon 855', 'selected_area': '26', 'territory': '', 'area': '3'}, {'id': 1019, 'name_en': 'Coupon 848', 'selected_area': '26', 'territory': '', 'area': '3'}, {'id': 943, 'name_en': 'Coupon 794', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 942, 'name_en': 'Coupon 793', 'selected_area': '7', 'territory': '', 'area': '3'}, {'id': 941, 'name_en': 'Coupon 792', 'selected_area': '7', 'territory': '', 'area': '3'}, {'id': 936, 'name_en': 'Coupon 787', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 921, 'name_en': 'Coupon 772', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 918, 'name_en': 'Coupon 769', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 917, 'name_en': 'Coupon 768', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 916, 'name_en': 'Coupon 767', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 914, 'name_en': 'Coupon 765', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 911, 'name_en': 'Coupon 762', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 908, 'name_en': 'Coupon 759', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 905, 'name_en': 'Coupon 757', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 904, 'name_en': 'Coupon 756', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 902, 'name_en': 'Coupon 755', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 901, 'name_en': 'Coupon 754', 'selected_area': '4', 'territory': '', 'area': '3'}]
2025-06-17 10:28:38,215 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:38,282 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:28:38,282 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:39,900 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:39,937 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:28:39,938 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:41,538 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:41,578 - DEBUG - Found area name: Lai King for selected_area: 25, table: new_territories
2025-06-17 10:28:41,579 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:43,216 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:43,263 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 10:28:43,264 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:44,901 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:44,942 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 10:28:44,944 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:46,662 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:46,701 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:28:46,701 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:48,643 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:48,834 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 10:28:48,835 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:50,782 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:50,825 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 10:28:50,825 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:53,675 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:53,767 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:28:53,767 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:55,706 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:55,833 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:28:55,834 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:57,864 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:57,912 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:28:57,913 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:28:59,689 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:28:59,725 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:28:59,726 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:01,430 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:01,465 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:29:01,465 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:03,413 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:03,463 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:29:03,464 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:05,511 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:05,557 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:29:05,558 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:07,281 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:07,327 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:29:07,328 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:09,078 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:09,111 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:29:09,111 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:10,791 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:10,838 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:29:10,839 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:12,659 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:12,696 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:29:12,697 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:14,435 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:14,476 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:29:14,476 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:14,485 - DEBUG - close.started
2025-06-17 10:29:14,486 - DEBUG - close.complete
2025-06-17 10:29:14,487 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:14,492 - INFO - Database connection closed
2025-06-17 10:29:14,493 - INFO - 127.0.0.1 - - [17/Jun/2025 10:29:14] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:29:14,512 - INFO - Connected to database
2025-06-17 10:29:16,178 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:29:16,837 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:29:16,845 - INFO - Database connection closed
2025-06-17 10:29:16,845 - INFO - 127.0.0.1 - - [17/Jun/2025 10:29:16] "GET / HTTP/1.1" 200 -
2025-06-17 10:29:16,991 - INFO - 127.0.0.1 - - [17/Jun/2025 10:29:16] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:32:52,519 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:32:52,732 - INFO -  * Restarting with stat
2025-06-17 10:32:54,265 - WARNING -  * Debugger is active!
2025-06-17 10:32:54,272 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:32:58,012 - INFO - Connected to database
2025-06-17 10:32:58,742 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:32:58,762 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:32:58,763 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:32:59,245 - DEBUG - Loading model cost 0.483 seconds.
2025-06-17 10:32:59,245 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:32:59,251 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:32:59,261 - INFO - Database connection closed
2025-06-17 10:32:59,261 - INFO - 127.0.0.1 - - [17/Jun/2025 10:32:59] "GET / HTTP/1.1" 200 -
2025-06-17 10:32:59,526 - INFO - 127.0.0.1 - - [17/Jun/2025 10:32:59] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:35:41,465 - INFO - Connected to database
2025-06-17 10:35:43,456 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:43,506 - DEBUG - Extracting category from query: 'give me coupons of hong kong', words: ['give', 'me', 'coupons', 'of', 'hong', 'kong']
2025-06-17 10:35:43,507 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,508 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,508 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,509 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,509 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,510 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,510 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,510 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,511 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,511 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,511 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,512 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,512 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,512 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,513 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,514 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,514 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,516 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,522 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,523 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,523 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,524 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,524 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,524 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,525 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,525 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,526 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,526 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:35:43,526 - INFO - No category matched for query: give me coupons of hong kong
2025-06-17 10:35:43,540 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:35:43,569 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002891892FA10>
2025-06-17 10:35:43,570 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000289185FB1D0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:35:43,601 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028918617B10>
2025-06-17 10:35:43,602 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:35:43,604 - DEBUG - send_request_headers.complete
2025-06-17 10:35:43,604 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:35:43,605 - DEBUG - send_request_body.complete
2025-06-17 10:35:43,605 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:35:43,884 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:05:43 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'84'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499855'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998834192'), (b'x-ratelimit-tokens-query-cost', b'145'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'4e91be02b8ba047432723f659c52df0e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=yjcQbZEbWmLVIrCzQoq1xwpXUOalh_rOfGN2yaX2Ogg-1750136743-1.0.1.1-.fWAsFLx1.oHO.gjUek78p43QIDGS6LtaHOz3lZGuqh33GPB0SP1xdtLA2lc4eUsm4Ez2IMRQDn9QH2mGZVd_XU8El4eFOWZryuhRjIGwTw; path=/; expires=Tue, 17-Jun-25 05:35:43 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=rLyyzXjD8J3aQ4jd8rrF9H0TaPOIpnckkegjU5Fo6DQ-1750136743843-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951003776d836eb9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:35:43,886 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:35:43,887 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:35:43,888 - DEBUG - receive_response_body.complete
2025-06-17 10:35:43,889 - DEBUG - response_closed.started
2025-06-17 10:35:43,889 - DEBUG - response_closed.complete
2025-06-17 10:35:43,893 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 10:35:43,906 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:35:43,907 - DEBUG - send_request_headers.complete
2025-06-17 10:35:43,907 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:35:43,908 - DEBUG - send_request_body.complete
2025-06-17 10:35:43,909 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:35:44,167 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:05:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499755'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998834092'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'4807f316e5d8755a2e0f03644e24fa77'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951003794f5c6eb9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:35:44,168 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:35:44,169 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:35:44,170 - DEBUG - receive_response_body.complete
2025-06-17 10:35:44,170 - DEBUG - response_closed.started
2025-06-17 10:35:44,171 - DEBUG - response_closed.complete
2025-06-17 10:35:44,174 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:35:44,176 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 10:35:44,185 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:35:44,214 - INFO - No coupon name matched for query: 'give me coupons of hong kong'
2025-06-17 10:35:44,219 - DEBUG - Query: give me coupons of hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 10:35:44,222 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,222 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 10:35:44,225 - DEBUG - Found 20 rows
2025-06-17 10:35:44,226 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,227 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,228 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,229 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,231 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,232 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,234 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,235 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,237 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,238 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,238 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,239 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,240 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,241 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,242 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,243 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,244 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,245 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,246 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,247 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:35:44,248 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 10:35:45,880 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:45,947 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:45,950 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:47,841 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:47,888 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:47,889 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:49,536 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:49,579 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:49,580 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:51,246 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:51,288 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:51,289 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:53,112 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:53,159 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:53,160 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:54,805 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:54,854 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:54,855 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:56,511 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:56,562 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:56,564 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:35:58,217 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:35:58,259 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:35:58,260 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:00,141 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:00,203 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:00,204 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:01,853 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:01,920 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:01,921 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:03,556 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:03,603 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:03,603 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:05,216 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:05,252 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:05,253 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:06,822 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:06,859 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:06,860 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:08,550 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:08,607 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:08,608 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:10,242 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:10,467 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:10,467 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:12,125 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:12,169 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:12,169 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:13,787 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:13,837 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:13,837 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:15,489 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:15,536 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:15,538 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:17,199 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:17,239 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:17,240 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:19,073 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:19,134 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:36:19,134 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:19,139 - DEBUG - close.started
2025-06-17 10:36:19,143 - DEBUG - close.complete
2025-06-17 10:36:19,144 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:19,152 - INFO - Database connection closed
2025-06-17 10:36:19,152 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:19] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:36:19,175 - INFO - Connected to database
2025-06-17 10:36:20,807 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:20,844 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:20,850 - INFO - Database connection closed
2025-06-17 10:36:20,851 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:20] "GET / HTTP/1.1" 200 -
2025-06-17 10:36:21,013 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:21] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:36:51,373 - INFO - Connected to database
2025-06-17 10:36:53,293 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:53,340 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:53,346 - INFO - Database connection closed
2025-06-17 10:36:53,346 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:53] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:36:53,361 - INFO - Connected to database
2025-06-17 10:36:55,029 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:36:55,070 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:36:55,077 - INFO - Database connection closed
2025-06-17 10:36:55,077 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:55] "GET / HTTP/1.1" 200 -
2025-06-17 10:36:55,214 - INFO - 127.0.0.1 - - [17/Jun/2025 10:36:55] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:37:09,382 - INFO - Connected to database
2025-06-17 10:37:11,132 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:11,178 - DEBUG - Extracting category from query: 'give coupons of new territories', words: ['give', 'coupons', 'of', 'new', 'territories']
2025-06-17 10:37:11,178 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,179 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,179 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,184 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,185 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,185 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,186 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,187 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,187 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,187 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,188 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,188 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,189 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,189 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,190 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,190 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,191 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,191 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,192 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,192 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,193 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,193 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,194 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,194 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,195 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,195 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,195 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:37:11,196 - INFO - No category matched for query: give coupons of new territories
2025-06-17 10:37:11,211 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:37:11,250 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028918A179D0>
2025-06-17 10:37:11,252 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000028918A34DD0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:37:11,292 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028918A2C3E0>
2025-06-17 10:37:11,293 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:37:11,293 - DEBUG - send_request_headers.complete
2025-06-17 10:37:11,294 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:37:11,295 - DEBUG - send_request_body.complete
2025-06-17 10:37:11,295 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:37:11,616 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:07:11 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'108'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998833949'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'109'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'61e8b028236b033d8e69b04187be0f7f'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=QHnkOlhuKYH72xYw730WHjVp7fOWH_DHkY3vdfH6.RQ-1750136831-1.0.1.1-rMQ.4ESTKZ9AI_fq25l3fP5zGK7E91s.FXIRRGEPlx_Ha9U58IGash51C25vcgXIVn6hqOTdbOEKeF.rEWRCtz4je9ihshxWejYSLN15d_I; path=/; expires=Tue, 17-Jun-25 05:37:11 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=eciRTntAq1gjjjQpccdZUS3h5Ymo6LcKSzNOXNfT4Xs-1750136831567-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510059b7ce4c29a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:37:11,619 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:37:11,620 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:37:11,621 - DEBUG - receive_response_body.complete
2025-06-17 10:37:11,621 - DEBUG - response_closed.started
2025-06-17 10:37:11,622 - DEBUG - response_closed.complete
2025-06-17 10:37:11,624 - DEBUG - Mistral location analysis: None
2025-06-17 10:37:11,675 - DEBUG - Location candidates: ['give coupons of new', 'give coupons of', 'give coupons', 'coupons of new territories', 'coupons of new', 'coupons of', 'of new territories', 'of new', 'new territories', 'new', 'territories']
2025-06-17 10:37:11,689 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 10:37:11,698 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:37:11,701 - DEBUG - send_request_headers.complete
2025-06-17 10:37:11,702 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:37:11,703 - DEBUG - send_request_body.complete
2025-06-17 10:37:11,704 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:37:12,099 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:07:12 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998833850'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'83'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'02c4433428261e7b852c22402acef25e'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510059e0fe8c29a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:37:12,101 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:37:12,101 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:37:12,102 - DEBUG - receive_response_body.complete
2025-06-17 10:37:12,103 - DEBUG - response_closed.started
2025-06-17 10:37:12,104 - DEBUG - response_closed.complete
2025-06-17 10:37:12,105 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:37:12,106 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 10:37:12,119 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:37:12,160 - INFO - No coupon name matched for query: 'give coupons of new territories'
2025-06-17 10:37:12,160 - DEBUG - Query: give coupons of new territories, Category: None, Location: {'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name: None, Discount: None
2025-06-17 10:37:12,162 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,162 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 10:37:12,169 - DEBUG - Found 20 rows
2025-06-17 10:37:12,170 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,171 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,172 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,173 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,174 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,175 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,176 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,177 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,178 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,181 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,183 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,185 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,186 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,187 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,188 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,190 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,191 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,192 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,193 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,194 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:37:12,194 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 10:37:12,194 - DEBUG - Coupon results: [{'id': 1243, 'name_en': 'Test again here', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 1242, 'name_en': 'Testing Here', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 1221, 'name_en': 'Created by branch', 'selected_area': '25', 'territory': '', 'area': '3'}, {'id': 1034, 'name_en': 'Coupon 855', 'selected_area': '26', 'territory': '', 'area': '3'}, {'id': 1019, 'name_en': 'Coupon 848', 'selected_area': '26', 'territory': '', 'area': '3'}, {'id': 943, 'name_en': 'Coupon 794', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 942, 'name_en': 'Coupon 793', 'selected_area': '7', 'territory': '', 'area': '3'}, {'id': 941, 'name_en': 'Coupon 792', 'selected_area': '7', 'territory': '', 'area': '3'}, {'id': 936, 'name_en': 'Coupon 787', 'selected_area': '22', 'territory': '', 'area': '3'}, {'id': 921, 'name_en': 'Coupon 772', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 918, 'name_en': 'Coupon 769', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 917, 'name_en': 'Coupon 768', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 916, 'name_en': 'Coupon 767', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 914, 'name_en': 'Coupon 765', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 911, 'name_en': 'Coupon 762', 'selected_area': '17', 'territory': '', 'area': '3'}, {'id': 908, 'name_en': 'Coupon 759', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 905, 'name_en': 'Coupon 757', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 904, 'name_en': 'Coupon 756', 'selected_area': '4', 'territory': '', 'area': '3'}, {'id': 902, 'name_en': 'Coupon 755', 'selected_area': '29', 'territory': '', 'area': '3'}, {'id': 901, 'name_en': 'Coupon 754', 'selected_area': '4', 'territory': '', 'area': '3'}]
2025-06-17 10:37:13,814 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:13,872 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:37:13,873 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:15,520 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:15,594 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:37:15,595 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:17,210 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:17,253 - DEBUG - Found area name: Lai King for selected_area: 25, table: new_territories
2025-06-17 10:37:17,254 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:19,290 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:19,340 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 10:37:19,341 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:21,039 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:21,081 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 10:37:21,082 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:22,759 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:22,808 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:37:22,809 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:24,470 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:24,524 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 10:37:24,524 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:26,202 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:26,243 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 10:37:26,245 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:27,930 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:27,976 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 10:37:27,977 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:29,612 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:29,652 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:37:29,652 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:31,315 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:31,349 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:37:31,350 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:32,971 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:33,042 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:37:33,043 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:34,665 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:34,713 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:37:34,715 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:36,422 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:36,477 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:37:36,480 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:38,216 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:38,261 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 10:37:38,262 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:40,996 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:41,038 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:37:41,038 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:43,056 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:43,102 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:37:43,103 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:44,657 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:44,697 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:37:44,698 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:46,336 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:46,388 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 10:37:46,389 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:48,063 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:48,113 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 10:37:48,114 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:48,126 - DEBUG - close.started
2025-06-17 10:37:48,129 - DEBUG - close.complete
2025-06-17 10:37:48,130 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:48,136 - INFO - Database connection closed
2025-06-17 10:37:48,137 - INFO - 127.0.0.1 - - [17/Jun/2025 10:37:48] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:37:48,160 - INFO - Connected to database
2025-06-17 10:37:49,830 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:37:49,873 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:37:49,882 - INFO - Database connection closed
2025-06-17 10:37:49,883 - INFO - 127.0.0.1 - - [17/Jun/2025 10:37:49] "GET / HTTP/1.1" 200 -
2025-06-17 10:37:50,043 - INFO - 127.0.0.1 - - [17/Jun/2025 10:37:50] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:39:07,007 - INFO - Connected to database
2025-06-17 10:39:08,742 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:08,791 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:08,799 - INFO - Database connection closed
2025-06-17 10:39:08,800 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:08] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:39:08,821 - INFO - Connected to database
2025-06-17 10:39:10,470 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:10,504 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:10,515 - INFO - Database connection closed
2025-06-17 10:39:10,515 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:10] "GET / HTTP/1.1" 200 -
2025-06-17 10:39:10,654 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:10] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:39:18,531 - INFO - Connected to database
2025-06-17 10:39:20,344 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:20,394 - DEBUG - Extracting category from query: 'coupons for kowloon', words: ['coupons', 'for', 'kowloon']
2025-06-17 10:39:20,394 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,395 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,395 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,396 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,396 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,397 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,397 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,399 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,399 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,400 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,400 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,401 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,401 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,402 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,404 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,406 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:39:20,411 - INFO - No category matched for query: coupons for kowloon
2025-06-17 10:39:20,420 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:39:20,472 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028918A2F230>
2025-06-17 10:39:20,473 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000028918B5E0F0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:39:20,505 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002891C3C84D0>
2025-06-17 10:39:20,506 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:39:20,507 - DEBUG - send_request_headers.complete
2025-06-17 10:39:20,507 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:39:20,508 - DEBUG - send_request_body.complete
2025-06-17 10:39:20,508 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:39:20,802 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:09:20 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998833706'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'b2843d0478053f70f4e2030dd022bf6f'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=oQuvxWz4Lj35nyhrLWRqGTuh0orb9zmtm4rDatxJVYw-1750136960-1.0.1.1-rTfxxyhbIVszai5CO65rsRJpONFU8xGUNri23BSvIh9GsJHGJE6NJ46hDqf4K4zHZ0qBIPAjPp8PXF3H08Rb2OlB_Ehq5Lyvqf4s3aBm1FM; path=/; expires=Tue, 17-Jun-25 05:39:20 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=OdSnyQ4_j8BldtMMdSyZaM4zECMUvW4yJ3Vs1C8UoVY-1750136960745-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951008c30bde3fe6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:39:20,807 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:39:20,808 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:39:20,809 - DEBUG - receive_response_body.complete
2025-06-17 10:39:20,809 - DEBUG - response_closed.started
2025-06-17 10:39:20,810 - DEBUG - response_closed.complete
2025-06-17 10:39:20,812 - DEBUG - Mistral location analysis: None
2025-06-17 10:39:20,812 - DEBUG - Location candidates: ['coupons for kowloon', 'coupons for', 'for kowloon', 'kowloon']
2025-06-17 10:39:20,819 - INFO - Normalized area match: 'kowloon' -> 'Kowloon'
2025-06-17 10:39:20,832 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:39:20,833 - DEBUG - send_request_headers.complete
2025-06-17 10:39:20,834 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:39:20,835 - DEBUG - send_request_body.complete
2025-06-17 10:39:20,835 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:39:21,128 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:09:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'91'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499756'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998833606'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'92'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'388f013b6fd06a7e8a206e5385e3e878'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951008c51e5f3fe6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:39:21,130 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:39:21,131 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:39:21,132 - DEBUG - receive_response_body.complete
2025-06-17 10:39:21,132 - DEBUG - response_closed.started
2025-06-17 10:39:21,133 - DEBUG - response_closed.complete
2025-06-17 10:39:21,135 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:39:21,137 - DEBUG - Cleaned query: 'coupons kowloon'
2025-06-17 10:39:21,145 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:39:21,162 - INFO - No coupon name matched for query: 'coupons for kowloon'
2025-06-17 10:39:21,163 - DEBUG - Query: coupons for kowloon, Category: None, Location: {'name': 'Kowloon', 'type': 'area', 'id': '2'}, Coupon Name: None, Discount: None
2025-06-17 10:39:21,165 - DEBUG - Valid selected_area IDs for area 2: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,166 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['2', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', 20]
2025-06-17 10:39:21,171 - DEBUG - Found 20 rows
2025-06-17 10:39:21,201 - DEBUG - Valid area IDs for coupon ID 1265 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,210 - DEBUG - Valid area IDs for coupon ID 1261 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,218 - DEBUG - Valid area IDs for coupon ID 1260 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,228 - DEBUG - Valid area IDs for coupon ID 1259 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,342 - DEBUG - Valid area IDs for coupon ID 1258 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,355 - DEBUG - Valid area IDs for coupon ID 1245 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,365 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,378 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,404 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,414 - DEBUG - Valid area IDs for coupon ID 1226 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,422 - DEBUG - Valid area IDs for coupon ID 1223 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,475 - DEBUG - Valid area IDs for coupon ID 1200 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,484 - DEBUG - Valid area IDs for coupon ID 1190 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,489 - DEBUG - Valid area IDs for coupon ID 1169 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,495 - DEBUG - Valid area IDs for coupon ID 1166 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,503 - DEBUG - Valid area IDs for coupon ID 1162 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,537 - DEBUG - Valid area IDs for coupon ID 1161 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,554 - DEBUG - Valid area IDs for coupon ID 1159 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,586 - DEBUG - Valid area IDs for coupon ID 1158 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,591 - DEBUG - Valid area IDs for coupon ID 1157 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:39:21,593 - DEBUG - Returning 20 coupons for category 'None', location 'Kowloon'
2025-06-17 10:39:21,593 - DEBUG - Coupon results: [{'id': 1265, 'name_en': 'KC Test Coupon', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1261, 'name_en': 'KFC Free Gift', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1260, 'name_en': 'Commission Test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1259, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1258, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1245, 'name_en': 'test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1239, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1235, 'name_en': 'KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1227, 'name_en': 'Created by branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1226, 'name_en': 'Kingsman Mens Style', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1223, 'name_en': 'Kings Man Coupon Test', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1200, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1190, 'name_en': 'main 100', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1169, 'name_en': 'KFCVoucher$10', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1166, 'name_en': 'Branch 2 coupon', 'selected_area': '29', 'territory': '', 'area': '2'}, {'id': 1162, 'name_en': '111', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1161, 'name_en': 'Testing coupon name', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1159, 'name_en': 'XYZ', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1158, 'name_en': '12312', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1157, 'name_en': '1112', 'selected_area': '4', 'territory': '', 'area': '2'}]
2025-06-17 10:39:23,214 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:23,262 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:23,263 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:24,877 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:24,916 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:24,916 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:26,542 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:26,588 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:26,628 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:28,291 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:28,333 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:28,338 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:30,003 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:30,050 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:30,054 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:31,693 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:31,741 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:31,741 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:33,403 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:33,456 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:39:33,457 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:35,093 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:35,171 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:35,172 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:36,823 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:36,863 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:39:36,863 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:38,507 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:38,563 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:39:38,563 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:40,371 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:40,431 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:39:40,436 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:42,096 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:42,146 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:39:42,147 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:43,809 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:43,858 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:39:43,859 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:45,480 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:45,528 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:39:45,530 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:47,172 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:47,225 - DEBUG - Found area name: Yau Ma Tei for selected_area: 29, table: kowloon
2025-06-17 10:39:47,226 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:48,875 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:48,925 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:39:48,926 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:50,707 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:50,887 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:39:50,888 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:52,611 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:52,650 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:39:52,651 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:54,308 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:54,353 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:39:54,354 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:56,019 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:56,056 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:39:56,056 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:56,067 - DEBUG - close.started
2025-06-17 10:39:56,068 - DEBUG - close.complete
2025-06-17 10:39:56,068 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:56,075 - INFO - Database connection closed
2025-06-17 10:39:56,075 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:56] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:39:56,097 - INFO - Connected to database
2025-06-17 10:39:57,839 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:39:57,883 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:39:57,889 - INFO - Database connection closed
2025-06-17 10:39:57,890 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:57] "GET / HTTP/1.1" 200 -
2025-06-17 10:39:58,036 - INFO - 127.0.0.1 - - [17/Jun/2025 10:39:58] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:45:29,185 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 10:45:29,401 - INFO -  * Restarting with stat
2025-06-17 10:45:31,404 - WARNING -  * Debugger is active!
2025-06-17 10:45:31,407 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 10:45:33,011 - INFO - Connected to database
2025-06-17 10:45:33,749 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:33,771 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 10:45:33,773 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 10:45:34,263 - DEBUG - Loading model cost 0.492 seconds.
2025-06-17 10:45:34,264 - DEBUG - Prefix dict has been built successfully.
2025-06-17 10:45:34,269 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:34,283 - INFO - Database connection closed
2025-06-17 10:45:34,283 - INFO - 127.0.0.1 - - [17/Jun/2025 10:45:34] "GET / HTTP/1.1" 200 -
2025-06-17 10:45:34,568 - INFO - 127.0.0.1 - - [17/Jun/2025 10:45:34] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:45:45,716 - INFO - Connected to database
2025-06-17 10:45:47,414 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:47,462 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 10:45:47,463 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,469 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,471 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,472 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,472 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,474 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,475 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,475 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,476 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,476 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,476 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,477 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,477 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,478 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,478 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,478 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,479 - DEBUG - Ignoring word: 'coupons'
2025-06-17 10:45:47,479 - INFO - No category matched for query: coupons for hong kong
2025-06-17 10:45:47,490 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:45:47,535 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D718FA10>
2025-06-17 10:45:47,535 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000217D6E7AE70> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:45:47,571 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D6E97B10>
2025-06-17 10:45:47,573 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:45:47,575 - DEBUG - send_request_headers.complete
2025-06-17 10:45:47,576 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:45:47,576 - DEBUG - send_request_body.complete
2025-06-17 10:45:47,577 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:45:47,882 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:15:47 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'93'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499370'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998830437'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'94'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'27326d1ecdc85a06f48c557b84eae340'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=uhCyw0Ym4aetAbnuDZn2XvcGJEwWRYkw7xZqOFv_K0I-1750137347-1.0.1.1-kc0WDO1XGJRV1.W3l2QBeIG0TJNODE2fP.YUktVemZRycR4FB3Ps73Uv5rZlNCHhw2yztPJESUNaefDIAa_JlBSr77TR8BjOXuzWaajIh4Q; path=/; expires=Tue, 17-Jun-25 05:45:47 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=CYfZtmjYztEYJMXxZn1q3Juls5f.UE71EzWkO.KTkEU-1750137347837-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951012363c4b345a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:45:47,884 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:45:47,885 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:45:47,886 - DEBUG - receive_response_body.complete
2025-06-17 10:45:47,886 - DEBUG - response_closed.started
2025-06-17 10:45:47,886 - DEBUG - response_closed.complete
2025-06-17 10:45:47,895 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 10:45:47,905 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:45:47,908 - DEBUG - send_request_headers.complete
2025-06-17 10:45:47,908 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:45:47,909 - DEBUG - send_request_body.complete
2025-06-17 10:45:47,909 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:45:48,226 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:15:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'111'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499272'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998830339'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'113'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'd9400600630c501366076741d99e3514'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951012384e9f345a-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:45:48,229 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:45:48,230 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:45:48,231 - DEBUG - receive_response_body.complete
2025-06-17 10:45:48,231 - DEBUG - response_closed.started
2025-06-17 10:45:48,232 - DEBUG - response_closed.complete
2025-06-17 10:45:48,234 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:45:48,236 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 10:45:48,243 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:45:48,274 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 10:45:48,275 - DEBUG - Query: coupons for hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 10:45:48,277 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,277 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,278 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 10:45:48,281 - DEBUG - Found 20 rows
2025-06-17 10:45:48,283 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,284 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,285 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,285 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,287 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,292 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,293 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,295 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,295 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,296 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,297 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,299 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,300 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,301 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,302 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,303 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,308 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,309 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,311 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,312 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:45:48,312 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 10:45:49,916 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:49,949 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:49,949 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:51,633 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:51,680 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:51,681 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:53,343 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:53,394 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:53,395 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:55,050 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:55,440 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:55,441 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:57,128 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:57,177 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:57,178 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:45:58,860 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:45:58,907 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:45:58,908 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:00,520 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:00,562 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:00,562 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:02,161 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:02,198 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:02,199 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:03,816 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:03,858 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:03,859 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:05,543 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:05,599 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:05,599 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:07,261 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:07,313 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:07,313 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:08,962 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:09,002 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:09,003 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:10,643 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:10,685 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:10,687 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:12,363 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:12,406 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:12,406 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:14,029 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:14,070 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:14,071 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:15,723 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:15,767 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:15,768 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:17,441 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:17,483 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:17,486 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:19,429 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:19,475 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:19,477 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:21,097 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:21,140 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:21,141 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:22,799 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:22,841 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 10:46:22,842 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:22,851 - DEBUG - close.started
2025-06-17 10:46:22,852 - DEBUG - close.complete
2025-06-17 10:46:22,853 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:22,860 - INFO - Database connection closed
2025-06-17 10:46:22,860 - INFO - 127.0.0.1 - - [17/Jun/2025 10:46:22] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:46:22,882 - INFO - Connected to database
2025-06-17 10:46:24,643 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:24,710 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:24,719 - INFO - Database connection closed
2025-06-17 10:46:24,719 - INFO - 127.0.0.1 - - [17/Jun/2025 10:46:24] "GET / HTTP/1.1" 200 -
2025-06-17 10:46:24,892 - INFO - 127.0.0.1 - - [17/Jun/2025 10:46:24] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:46:37,201 - INFO - Connected to database
2025-06-17 10:46:39,035 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:39,082 - DEBUG - Extracting category from query: 'chai wan', words: ['chai', 'wan']
2025-06-17 10:46:39,084 - INFO - No category matched for query: chai wan
2025-06-17 10:46:39,091 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:46:39,132 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D72779D0>
2025-06-17 10:46:39,133 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000217D7294DD0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:46:39,164 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D728C640>
2025-06-17 10:46:39,164 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:46:39,165 - DEBUG - send_request_headers.complete
2025-06-17 10:46:39,166 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:46:39,166 - DEBUG - send_request_body.complete
2025-06-17 10:46:39,167 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:46:39,416 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:16:39 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'70'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'498962'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998829108'), (b'x-ratelimit-tokens-query-cost', b'139'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'51'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'71'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'e8baea5d93e7c70bba723b552bfb4272'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=n_xyiq9Y5uS.jdgBi4s7del9lyQFY07BdMr_OrX8dnw-1750137399-1.0.1.1-.W.SHHfV2qzEupGRGPDKYFjYm5Jh_1581aosUmLSO4OLBOwCDuyHTd0CuLTAo63d0frIt5ivkb4vgQmA_VBPHhT4ksCOv9l4A4wzM1s0VWE; path=/; expires=Tue, 17-Jun-25 05:46:39 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=RHGpq4Lx9kQP.cwFk._zuaq9V6NLOShvtHlBgXnkPE0-1750137399374-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95101378afc6ffa2-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:46:39,417 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:46:39,418 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:46:39,419 - DEBUG - receive_response_body.complete
2025-06-17 10:46:39,419 - DEBUG - response_closed.started
2025-06-17 10:46:39,420 - DEBUG - response_closed.complete
2025-06-17 10:46:39,422 - DEBUG - Mistral location analysis: None
2025-06-17 10:46:39,422 - DEBUG - Location candidates: ['chai wan', 'chai', 'wan']
2025-06-17 10:46:39,423 - INFO - Exact location matched: hong_kong 'Chai Wan'
2025-06-17 10:46:39,436 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:46:39,437 - DEBUG - send_request_headers.complete
2025-06-17 10:46:39,438 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:46:39,439 - DEBUG - send_request_body.complete
2025-06-17 10:46:39,440 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:46:39,699 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:16:39 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'84'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'498676'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998828822'), (b'x-ratelimit-tokens-query-cost', b'95'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'49'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'd18b2f21670969528ef2e24ddaf1e446'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510137a5cc3ffa2-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:46:39,700 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:46:39,701 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:46:39,702 - DEBUG - receive_response_body.complete
2025-06-17 10:46:39,703 - DEBUG - response_closed.started
2025-06-17 10:46:39,703 - DEBUG - response_closed.complete
2025-06-17 10:46:39,705 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:46:39,707 - DEBUG - Cleaned query: 'chai wan'
2025-06-17 10:46:39,714 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:46:39,725 - INFO - No coupon name matched for query: 'chai wan'
2025-06-17 10:46:39,729 - DEBUG - Query: chai wan, Category: None, Location: {'name': 'Chai Wan', 'type': 'selected_area', 'id': '18', 'table': 'hong_kong'}, Coupon Name: None, Discount: None
2025-06-17 10:46:39,732 - DEBUG - Location IDs for Chai Wan in hong_kong: ['18']
2025-06-17 10:46:39,732 - DEBUG - Searching coupons with selected_area IN ['18'], area = None
2025-06-17 10:46:39,733 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.selected_area IN (%s) ORDER BY c.created_at DESC LIMIT %s with params: ['18', 20]
2025-06-17 10:46:39,738 - DEBUG - Found 11 rows
2025-06-17 10:46:39,739 - DEBUG - Valid area IDs for coupon ID 940 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,741 - DEBUG - Valid area IDs for coupon ID 939 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,746 - DEBUG - Valid area IDs for coupon ID 938 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,749 - DEBUG - Valid area IDs for coupon ID 559 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,750 - DEBUG - Valid area IDs for coupon ID 507 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,752 - DEBUG - Valid area IDs for coupon ID 506 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 10:46:39,753 - DEBUG - Valid area IDs for coupon ID 393 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:46:39,753 - DEBUG - Valid area IDs for coupon ID 391 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:46:39,754 - DEBUG - Valid area IDs for coupon ID 390 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:46:39,756 - DEBUG - Valid area IDs for coupon ID 388 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:46:39,757 - DEBUG - Valid area IDs for coupon ID 344 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:46:39,758 - DEBUG - Returning 11 coupons for category 'None', location 'Chai Wan'
2025-06-17 10:46:39,758 - DEBUG - Coupon results: [{'id': 940, 'name_en': 'Coupon 791', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 939, 'name_en': 'Coupon 790', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 938, 'name_en': 'Coupon 789', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 559, 'name_en': 'Coupon 442', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 507, 'name_en': 'Coupon 407', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 506, 'name_en': 'Coupon 406', 'selected_area': '18', 'territory': '', 'area': '1'}, {'id': 393, 'name_en': 'Coupon 293', 'selected_area': '18', 'territory': '', 'area': '3'}, {'id': 391, 'name_en': 'Coupon 291', 'selected_area': '18', 'territory': '', 'area': '3'}, {'id': 390, 'name_en': 'Coupon 290', 'selected_area': '18', 'territory': '', 'area': '3'}, {'id': 388, 'name_en': 'Coupon 288', 'selected_area': '18', 'territory': '', 'area': '3'}, {'id': 344, 'name_en': 'Coupon 244', 'selected_area': '18', 'territory': '', 'area': '3'}]
2025-06-17 10:46:41,423 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:41,473 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:41,473 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:43,138 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:43,174 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:43,174 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:44,788 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:44,831 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:44,832 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:46,506 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:46,549 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:46,550 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:48,195 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:48,248 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:48,249 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:49,868 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:50,237 - DEBUG - Found area name: Chai Wan for selected_area: 18, table: hong_kong
2025-06-17 10:46:50,238 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:51,887 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:51,940 - WARNING - Selected_area '18' found in hong_kong, but coupon_area '3' expects new_territories
2025-06-17 10:46:51,942 - DEBUG - Found area name: Tuen Mun for selected_area: 18, table: new_territories
2025-06-17 10:46:51,945 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:53,995 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:54,053 - WARNING - Selected_area '18' found in hong_kong, but coupon_area '3' expects new_territories
2025-06-17 10:46:54,054 - DEBUG - Found area name: Tuen Mun for selected_area: 18, table: new_territories
2025-06-17 10:46:54,054 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:55,713 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:55,754 - WARNING - Selected_area '18' found in hong_kong, but coupon_area '3' expects new_territories
2025-06-17 10:46:55,755 - DEBUG - Found area name: Tuen Mun for selected_area: 18, table: new_territories
2025-06-17 10:46:55,759 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:57,378 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:57,417 - WARNING - Selected_area '18' found in hong_kong, but coupon_area '3' expects new_territories
2025-06-17 10:46:57,417 - DEBUG - Found area name: Tuen Mun for selected_area: 18, table: new_territories
2025-06-17 10:46:57,417 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:59,018 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:46:59,071 - WARNING - Selected_area '18' found in hong_kong, but coupon_area '3' expects new_territories
2025-06-17 10:46:59,071 - DEBUG - Found area name: Tuen Mun for selected_area: 18, table: new_territories
2025-06-17 10:46:59,074 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:59,080 - DEBUG - close.started
2025-06-17 10:46:59,082 - DEBUG - close.complete
2025-06-17 10:46:59,082 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:46:59,090 - INFO - Database connection closed
2025-06-17 10:46:59,092 - INFO - 127.0.0.1 - - [17/Jun/2025 10:46:59] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:46:59,112 - INFO - Connected to database
2025-06-17 10:47:00,798 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:00,840 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:47:00,847 - INFO - Database connection closed
2025-06-17 10:47:00,847 - INFO - 127.0.0.1 - - [17/Jun/2025 10:47:00] "GET / HTTP/1.1" 200 -
2025-06-17 10:47:00,991 - INFO - 127.0.0.1 - - [17/Jun/2025 10:47:00] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:47:43,794 - INFO - Connected to database
2025-06-17 10:47:45,623 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:45,670 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:47:45,679 - INFO - Database connection closed
2025-06-17 10:47:45,681 - INFO - 127.0.0.1 - - [17/Jun/2025 10:47:45] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:47:45,706 - INFO - Connected to database
2025-06-17 10:47:47,405 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:47,452 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:47:47,459 - INFO - Database connection closed
2025-06-17 10:47:47,460 - INFO - 127.0.0.1 - - [17/Jun/2025 10:47:47] "GET / HTTP/1.1" 200 -
2025-06-17 10:47:47,608 - INFO - 127.0.0.1 - - [17/Jun/2025 10:47:47] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:47:52,387 - INFO - Connected to database
2025-06-17 10:47:54,178 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:54,226 - DEBUG - Extracting category from query: 'kowloon', words: ['kowloon']
2025-06-17 10:47:54,227 - INFO - No category matched for query: kowloon
2025-06-17 10:47:54,237 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:47:54,295 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D728EFD0>
2025-06-17 10:47:54,297 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000217D73BE2A0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:47:54,336 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217DABE8950>
2025-06-17 10:47:54,337 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:47:54,337 - DEBUG - send_request_headers.complete
2025-06-17 10:47:54,338 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:47:54,339 - DEBUG - send_request_body.complete
2025-06-17 10:47:54,339 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:47:54,628 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:17:54 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'71'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499670'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998828303'), (b'x-ratelimit-tokens-query-cost', b'140'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'72'), (b'x-kong-proxy-latency', b'15'), (b'x-kong-request-id', b'fec1637feb2dab4947e4b6432d60355b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=GU8PujuvfzjxipV9D_FZyuFtLh99l4_cCYmUsMNxXkU-1750137474-1.0.1.1-iDdNOSOo95EVjSXGCVTpwdzet1iRLW_nBOJ26McoypV6uHwopjQXLE1KXRcfo6a3qU_So9OB5uQboodnn8FlpVklxxdTma.r7jkkvlkX_8c; path=/; expires=Tue, 17-Jun-25 05:47:54 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=n54RwSpZ2yFpxRlrn7dkytjB5MdQ0CtiGrkkH4gWdXs-1750137474583-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510154e7a2b6ed4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:47:54,630 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:47:54,630 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:47:54,631 - DEBUG - receive_response_body.complete
2025-06-17 10:47:54,632 - DEBUG - response_closed.started
2025-06-17 10:47:54,632 - DEBUG - response_closed.complete
2025-06-17 10:47:54,635 - DEBUG - Mistral location analysis: None
2025-06-17 10:47:54,635 - DEBUG - Location candidates: ['kowloon']
2025-06-17 10:47:54,636 - INFO - Normalized area match: 'kowloon' -> 'Kowloon'
2025-06-17 10:47:54,648 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:47:54,650 - DEBUG - send_request_headers.complete
2025-06-17 10:47:54,650 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:47:54,651 - DEBUG - send_request_body.complete
2025-06-17 10:47:54,651 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:47:54,931 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:17:54 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499574'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998828207'), (b'x-ratelimit-tokens-query-cost', b'96'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'ece881081a904e0b06207b1178e3d574'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951015507c4f6ed4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:47:54,933 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:47:54,933 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:47:54,934 - DEBUG - receive_response_body.complete
2025-06-17 10:47:54,935 - DEBUG - response_closed.started
2025-06-17 10:47:54,935 - DEBUG - response_closed.complete
2025-06-17 10:47:54,937 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:47:54,938 - DEBUG - Cleaned query: 'kowloon'
2025-06-17 10:47:54,950 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:47:54,956 - INFO - No coupon name matched for query: 'kowloon'
2025-06-17 10:47:54,957 - DEBUG - Query: kowloon, Category: None, Location: {'name': 'Kowloon', 'type': 'area', 'id': '2'}, Coupon Name: None, Discount: None
2025-06-17 10:47:54,959 - DEBUG - Valid selected_area IDs for area 2: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,961 - DEBUG - Searching coupons with area: 2, selected_areas: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,962 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['2', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', 20]
2025-06-17 10:47:54,967 - DEBUG - Found 20 rows
2025-06-17 10:47:54,969 - DEBUG - Valid area IDs for coupon ID 1265 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,970 - DEBUG - Valid area IDs for coupon ID 1261 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,971 - DEBUG - Valid area IDs for coupon ID 1260 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,972 - DEBUG - Valid area IDs for coupon ID 1259 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,973 - DEBUG - Valid area IDs for coupon ID 1258 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,974 - DEBUG - Valid area IDs for coupon ID 1245 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,975 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,976 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,978 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,982 - DEBUG - Valid area IDs for coupon ID 1226 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,984 - DEBUG - Valid area IDs for coupon ID 1223 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,985 - DEBUG - Valid area IDs for coupon ID 1200 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,986 - DEBUG - Valid area IDs for coupon ID 1190 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,987 - DEBUG - Valid area IDs for coupon ID 1169 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,988 - DEBUG - Valid area IDs for coupon ID 1166 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,989 - DEBUG - Valid area IDs for coupon ID 1162 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,991 - DEBUG - Valid area IDs for coupon ID 1161 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,992 - DEBUG - Valid area IDs for coupon ID 1159 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:54,993 - DEBUG - Valid area IDs for coupon ID 1158 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:55,011 - DEBUG - Valid area IDs for coupon ID 1157 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:47:55,026 - DEBUG - Returning 20 coupons for category 'None', location 'Kowloon'
2025-06-17 10:47:55,038 - DEBUG - Coupon results: [{'id': 1265, 'name_en': 'KC Test Coupon', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1261, 'name_en': 'KFC Free Gift', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1260, 'name_en': 'Commission Test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1259, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1258, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1245, 'name_en': 'test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1239, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1235, 'name_en': 'KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1227, 'name_en': 'Created by branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1226, 'name_en': 'Kingsman Mens Style', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1223, 'name_en': 'Kings Man Coupon Test', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1200, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1190, 'name_en': 'main 100', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1169, 'name_en': 'KFCVoucher$10', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1166, 'name_en': 'Branch 2 coupon', 'selected_area': '29', 'territory': '', 'area': '2'}, {'id': 1162, 'name_en': '111', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1161, 'name_en': 'Testing coupon name', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1159, 'name_en': 'XYZ', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1158, 'name_en': '12312', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1157, 'name_en': '1112', 'selected_area': '4', 'territory': '', 'area': '2'}]
2025-06-17 10:47:56,948 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:56,990 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:47:56,991 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:47:58,662 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:47:58,703 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:47:58,704 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:00,623 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:00,804 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:00,804 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:02,484 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:02,523 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:02,524 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:04,185 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:04,224 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:04,226 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:05,889 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:05,932 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:05,933 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:07,554 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:07,598 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:48:07,599 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:09,235 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:09,270 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:09,271 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:10,900 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:10,959 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:48:10,962 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:12,633 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:12,670 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:48:12,671 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:14,330 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:14,387 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:48:14,388 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:16,034 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:16,096 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:48:16,096 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:17,750 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:17,798 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:48:17,798 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:19,758 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:19,800 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 10:48:19,801 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:21,398 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:21,469 - DEBUG - Found area name: Yau Ma Tei for selected_area: 29, table: kowloon
2025-06-17 10:48:21,469 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:23,040 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:23,078 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:48:23,079 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:24,755 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:24,797 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:48:24,797 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:26,452 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:26,511 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 10:48:26,512 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:28,179 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:28,222 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:48:28,225 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:29,906 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:30,079 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 10:48:30,080 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:30,085 - DEBUG - close.started
2025-06-17 10:48:30,091 - DEBUG - close.complete
2025-06-17 10:48:30,091 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:30,098 - INFO - Database connection closed
2025-06-17 10:48:30,099 - INFO - 127.0.0.1 - - [17/Jun/2025 10:48:30] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:48:30,122 - INFO - Connected to database
2025-06-17 10:48:31,819 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:31,862 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:48:31,869 - INFO - Database connection closed
2025-06-17 10:48:31,871 - INFO - 127.0.0.1 - - [17/Jun/2025 10:48:31] "GET / HTTP/1.1" 200 -
2025-06-17 10:48:32,021 - INFO - 127.0.0.1 - - [17/Jun/2025 10:48:32] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 10:48:53,718 - INFO - Connected to database
2025-06-17 10:48:55,485 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:55,528 - DEBUG - Extracting category from query: 'created by branch', words: ['created', 'by', 'branch']
2025-06-17 10:48:55,530 - INFO - No category matched for query: created by branch
2025-06-17 10:48:55,542 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 10:48:55,571 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D725AAD0>
2025-06-17 10:48:55,572 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000217D7297D10> server_hostname='api.mistral.ai' timeout=None
2025-06-17 10:48:55,611 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000217D725B8A0>
2025-06-17 10:48:55,612 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:48:55,613 - DEBUG - send_request_headers.complete
2025-06-17 10:48:55,613 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:48:55,615 - DEBUG - send_request_body.complete
2025-06-17 10:48:55,616 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:48:56,165 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:18:56 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'82'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499860'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998828067'), (b'x-ratelimit-tokens-query-cost', b'140'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'3180f44b55b8b553d037120bb34f7a38'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=sZCiySGbS.FiGpkc1LCyYBmGaTaHvE8EG5cDdCi_FwQ-1750137536-1.0.1.1-uO5543I8zeQP8.03wgQk7KvjkJCehJ4AIO0ix36cae6zzTKgcwxcnMJVgCau6uSkIVSDAvNcy2ut5i007kfIrLIVonxOdwgHrKVPufpsZ_g; path=/; expires=Tue, 17-Jun-25 05:48:56 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=E2YtTOV9RbOhbeopvP7WW.OgESFtmEBD4mhgmBLp90I-1750137536121-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951016cd78bd441b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:48:56,169 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:48:56,170 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:48:56,171 - DEBUG - receive_response_body.complete
2025-06-17 10:48:56,171 - DEBUG - response_closed.started
2025-06-17 10:48:56,172 - DEBUG - response_closed.complete
2025-06-17 10:48:56,174 - DEBUG - Mistral location analysis: None
2025-06-17 10:48:56,175 - DEBUG - Location candidates: ['created by branch', 'created by', 'created', 'by branch', 'by', 'branch']
2025-06-17 10:48:56,185 - INFO - No valid location matched for query: created by branch
2025-06-17 10:48:56,194 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 10:48:56,196 - DEBUG - send_request_headers.complete
2025-06-17 10:48:56,198 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 10:48:56,199 - DEBUG - send_request_body.complete
2025-06-17 10:48:56,200 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 10:48:56,476 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:18:56 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'82'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499764'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998827971'), (b'x-ratelimit-tokens-query-cost', b'96'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'83'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'a074a214d7d2d77744d9be45c608b703'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951016d11c1a441b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 10:48:56,477 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 10:48:56,478 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 10:48:56,479 - DEBUG - receive_response_body.complete
2025-06-17 10:48:56,479 - DEBUG - response_closed.started
2025-06-17 10:48:56,480 - DEBUG - response_closed.complete
2025-06-17 10:48:56,483 - DEBUG - Mistral coupon name analysis: None
2025-06-17 10:48:56,484 - DEBUG - Cleaned query: 'created by branch'
2025-06-17 10:48:56,492 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 10:48:56,492 - INFO - Exact full query match: 'created by branch' -> 'Created by Branch' from coupon
2025-06-17 10:48:56,493 - DEBUG - Query: created by branch, Category: None, Location: None, Coupon Name: Created by Branch, Discount: None
2025-06-17 10:48:56,494 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['created by branch', 'created by branch', 20]
2025-06-17 10:48:56,499 - DEBUG - Found 4 rows
2025-06-17 10:48:56,501 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:48:56,503 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:48:56,504 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 10:48:56,506 - DEBUG - Valid area IDs for coupon ID 1200 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 10:48:56,506 - DEBUG - Returning 4 coupons for category 'None', location 'None'
2025-06-17 10:48:56,506 - DEBUG - Coupon results: [{'id': 1239, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1227, 'name_en': 'Created by branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1221, 'name_en': 'Created by branch', 'selected_area': '25', 'territory': '', 'area': '3'}, {'id': 1200, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}]
2025-06-17 10:48:58,234 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:48:58,303 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:48:58,304 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:00,458 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:49:00,884 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:49:00,885 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:02,562 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:49:02,603 - DEBUG - Found area name: Lai King for selected_area: 25, table: new_territories
2025-06-17 10:49:02,604 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:04,283 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:49:04,325 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 10:49:04,328 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:04,341 - DEBUG - close.started
2025-06-17 10:49:04,342 - DEBUG - close.complete
2025-06-17 10:49:04,345 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:04,355 - INFO - Database connection closed
2025-06-17 10:49:04,355 - INFO - 127.0.0.1 - - [17/Jun/2025 10:49:04] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 10:49:04,373 - INFO - Connected to database
2025-06-17 10:49:06,046 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 10:49:06,087 - DEBUG - Using proactor: IocpProactor
2025-06-17 10:49:06,093 - INFO - Database connection closed
2025-06-17 10:49:06,094 - INFO - 127.0.0.1 - - [17/Jun/2025 10:49:06] "GET / HTTP/1.1" 200 -
2025-06-17 10:49:06,254 - INFO - 127.0.0.1 - - [17/Jun/2025 10:49:06] "[36mGET /static/favicon.ico HTTP/1.1[0m" 304 -
2025-06-17 11:20:43,961 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 11:20:43,962 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 11:20:43,963 - INFO -  * Restarting with stat
2025-06-17 11:20:45,063 - WARNING -  * Debugger is active!
2025-06-17 11:20:45,067 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:10,624 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:10,757 - INFO -  * Restarting with stat
2025-06-17 11:21:12,300 - WARNING -  * Debugger is active!
2025-06-17 11:21:12,306 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:13,389 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:13,510 - INFO -  * Restarting with stat
2025-06-17 11:21:14,721 - WARNING -  * Debugger is active!
2025-06-17 11:21:14,724 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:33,147 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:33,270 - INFO -  * Restarting with stat
2025-06-17 11:21:34,723 - WARNING -  * Debugger is active!
2025-06-17 11:21:34,730 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:37,853 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:37,977 - INFO -  * Restarting with stat
2025-06-17 11:21:39,253 - WARNING -  * Debugger is active!
2025-06-17 11:21:39,261 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:43,367 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:43,500 - INFO -  * Restarting with stat
2025-06-17 11:21:45,101 - WARNING -  * Debugger is active!
2025-06-17 11:21:45,107 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:46,192 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:46,310 - INFO -  * Restarting with stat
2025-06-17 11:21:47,832 - WARNING -  * Debugger is active!
2025-06-17 11:21:47,836 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:50,942 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:51,059 - INFO -  * Restarting with stat
2025-06-17 11:21:52,487 - WARNING -  * Debugger is active!
2025-06-17 11:21:52,493 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:21:56,601 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:21:56,738 - INFO -  * Restarting with stat
2025-06-17 11:21:58,095 - WARNING -  * Debugger is active!
2025-06-17 11:21:58,098 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:22:02,969 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:02] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 11:22:03,059 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:03] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 11:22:03,091 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:03] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:03,715 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:03] "[33mGET /favicon.ico HTTP/1.1[0m" 404 -
2025-06-17 11:22:14,364 - INFO - Connected to database
2025-06-17 11:22:14,374 - INFO - Database connection closed
2025-06-17 11:22:14,374 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:14] "POST /login HTTP/1.1" 200 -
2025-06-17 11:22:14,420 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:14] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:16,054 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:16] "GET /register HTTP/1.1" 200 -
2025-06-17 11:22:16,135 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:16] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:26,775 - INFO - Connected to database
2025-06-17 11:22:27,484 - INFO - Database connection closed
2025-06-17 11:22:27,485 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:27] "[32mPOST /register HTTP/1.1[0m" 302 -
2025-06-17 11:22:27,495 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:27] "GET /login HTTP/1.1" 200 -
2025-06-17 11:22:27,539 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:27] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:35,819 - INFO - Connected to database
2025-06-17 11:22:36,505 - INFO - Database connection closed
2025-06-17 11:22:36,506 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:36] "POST /login HTTP/1.1" 200 -
2025-06-17 11:22:36,541 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:36] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:40,481 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:40] "GET /register HTTP/1.1" 200 -
2025-06-17 11:22:40,522 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:40] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:51,662 - INFO - Connected to database
2025-06-17 11:22:51,668 - INFO - Database connection closed
2025-06-17 11:22:51,668 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:51] "POST /register HTTP/1.1" 200 -
2025-06-17 11:22:51,712 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:51] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:22:55,525 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:55] "GET /login HTTP/1.1" 200 -
2025-06-17 11:22:55,573 - INFO - 127.0.0.1 - - [17/Jun/2025 11:22:55] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:02,514 - INFO - Connected to database
2025-06-17 11:23:03,160 - INFO - Database connection closed
2025-06-17 11:23:03,160 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:03] "POST /login HTTP/1.1" 200 -
2025-06-17 11:23:03,234 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:03] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:06,035 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:06] "GET /login HTTP/1.1" 200 -
2025-06-17 11:23:06,085 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:06] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:14,078 - INFO - Connected to database
2025-06-17 11:23:14,810 - INFO - Database connection closed
2025-06-17 11:23:14,811 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:14] "POST /login HTTP/1.1" 200 -
2025-06-17 11:23:14,833 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:14] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:17,491 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:17] "GET /register HTTP/1.1" 200 -
2025-06-17 11:23:17,528 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:17] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:34,754 - INFO - Connected to database
2025-06-17 11:23:35,444 - INFO - Database connection closed
2025-06-17 11:23:35,444 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:35] "[32mPOST /register HTTP/1.1[0m" 302 -
2025-06-17 11:23:35,454 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:35] "GET /login HTTP/1.1" 200 -
2025-06-17 11:23:35,542 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:35] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:23:44,212 - INFO - Connected to database
2025-06-17 11:23:44,870 - INFO - Database connection closed
2025-06-17 11:23:44,871 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:44] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 11:23:44,888 - INFO - Connected to database
2025-06-17 11:23:47,581 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:23:47,640 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 11:23:47,643 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 11:23:49,000 - DEBUG - Loading model cost 1.359 seconds.
2025-06-17 11:23:49,001 - DEBUG - Prefix dict has been built successfully.
2025-06-17 11:23:49,037 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:23:49,091 - INFO - Database connection closed
2025-06-17 11:23:49,092 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:49] "GET / HTTP/1.1" 200 -
2025-06-17 11:23:49,138 - INFO - 127.0.0.1 - - [17/Jun/2025 11:23:49] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:24:03,870 - INFO - Connected to database
2025-06-17 11:24:05,579 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:05,623 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 11:24:05,624 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,624 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,624 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,626 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,627 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,628 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,628 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,628 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,629 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,631 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,634 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,634 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,634 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,635 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,635 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,636 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,636 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,637 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,637 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,637 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,637 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,638 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,639 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,640 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,641 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,641 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,643 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,646 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:24:05,647 - INFO - No category matched for query: coupons for hong kong
2025-06-17 11:24:05,656 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 11:24:05,757 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000018676297CB0>
2025-06-17 11:24:05,757 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000018675FB10A0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 11:24:05,834 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000018679C84050>
2025-06-17 11:24:05,834 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 11:24:05,835 - DEBUG - send_request_headers.complete
2025-06-17 11:24:05,836 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 11:24:05,836 - DEBUG - send_request_body.complete
2025-06-17 11:24:05,837 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 11:24:06,145 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:54:06 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998827828'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'86'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'd5f8a90054e8db1ce776060951078073'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=Akoe4C0UbwRXGu0AVnwDx5q1fRJ6BKVL5_6dmYe7.d0-1750139646-1.0.1.1-.QjE.x6SrNksw3OwesnWSrGlNGL6I2q.LTi3xzN490LKlsT_infYhNMN5.H5QCnOBFKP4EzNzYU4EltmesDbN.lj9Q8UO4pOCvBusOtaixw; path=/; expires=Tue, 17-Jun-25 06:24:06 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=bl_KkBcOPmggrhvzbUw9kiBPM9s0Gs3knTxMqG7zhOc-1750139646080-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95104a525af73a1b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 11:24:06,149 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 11:24:06,150 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 11:24:06,151 - DEBUG - receive_response_body.complete
2025-06-17 11:24:06,151 - DEBUG - response_closed.started
2025-06-17 11:24:06,152 - DEBUG - response_closed.complete
2025-06-17 11:24:06,155 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 11:24:06,168 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 11:24:06,170 - DEBUG - send_request_headers.complete
2025-06-17 11:24:06,171 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 11:24:06,171 - DEBUG - send_request_body.complete
2025-06-17 11:24:06,172 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 11:24:06,438 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 05:54:06 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'69'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998827730'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'69'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'09ac953f7341861215f0c61990fe7028'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95104a546db63a1b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 11:24:06,439 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 11:24:06,440 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 11:24:06,441 - DEBUG - receive_response_body.complete
2025-06-17 11:24:06,441 - DEBUG - response_closed.started
2025-06-17 11:24:06,443 - DEBUG - response_closed.complete
2025-06-17 11:24:06,445 - DEBUG - Mistral coupon name analysis: None
2025-06-17 11:24:06,447 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 11:24:06,455 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 11:24:06,487 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 11:24:06,488 - DEBUG - Query: coupons for hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 11:24:06,489 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,489 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,490 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 11:24:06,493 - DEBUG - Found 20 rows
2025-06-17 11:24:06,494 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,500 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,501 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,503 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,504 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,505 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,506 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,507 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,510 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,515 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,517 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,518 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,518 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,519 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,519 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,520 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,522 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,522 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,523 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,524 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 11:24:06,525 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 11:24:07,984 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:08,012 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:08,013 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:09,918 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:09,961 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:09,961 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:11,926 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:11,977 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:11,978 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:13,659 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:13,702 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:13,702 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:15,379 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:15,438 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:15,447 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:17,149 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:17,200 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:17,201 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:18,869 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:18,904 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:18,905 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:20,564 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:20,605 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:20,609 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:22,415 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:22,470 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:22,470 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:24,317 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:24,369 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:24,370 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:26,165 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:26,233 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:26,234 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:28,025 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:28,068 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:28,068 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:29,770 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:29,843 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:29,844 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:31,518 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:31,564 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:31,565 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:33,261 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:33,744 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:33,745 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:35,399 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:35,450 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:35,451 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:37,189 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:37,237 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:37,240 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:38,913 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:38,992 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:38,995 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:40,665 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:40,713 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:40,714 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:42,414 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:42,459 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 11:24:42,460 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:42,465 - DEBUG - close.started
2025-06-17 11:24:42,466 - DEBUG - close.complete
2025-06-17 11:24:42,466 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:42,478 - INFO - Database connection closed
2025-06-17 11:24:42,478 - INFO - 127.0.0.1 - - [17/Jun/2025 11:24:42] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 11:24:42,500 - INFO - Connected to database
2025-06-17 11:24:44,190 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:24:44,255 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:24:44,262 - INFO - Database connection closed
2025-06-17 11:24:44,262 - INFO - 127.0.0.1 - - [17/Jun/2025 11:24:44] "GET / HTTP/1.1" 200 -
2025-06-17 11:24:44,296 - INFO - 127.0.0.1 - - [17/Jun/2025 11:24:44] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:25:22,282 - INFO - Connected to database
2025-06-17 11:25:22,285 - INFO - Database connection closed
2025-06-17 11:25:22,285 - INFO - 127.0.0.1 - - [17/Jun/2025 11:25:22] "[32mGET /logout HTTP/1.1[0m" 302 -
2025-06-17 11:25:22,295 - INFO - 127.0.0.1 - - [17/Jun/2025 11:25:22] "GET /login HTTP/1.1" 200 -
2025-06-17 11:25:22,334 - INFO - 127.0.0.1 - - [17/Jun/2025 11:25:22] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:25:24,889 - INFO - 127.0.0.1 - - [17/Jun/2025 11:25:24] "GET /register HTTP/1.1" 200 -
2025-06-17 11:25:24,966 - INFO - 127.0.0.1 - - [17/Jun/2025 11:25:24] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:37:07,367 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:37:07,519 - INFO -  * Restarting with stat
2025-06-17 11:37:08,854 - WARNING -  * Debugger is active!
2025-06-17 11:37:08,856 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:37:18,031 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:37:18,145 - INFO -  * Restarting with stat
2025-06-17 11:37:19,195 - WARNING -  * Debugger is active!
2025-06-17 11:37:19,198 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:37:21,262 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:37:21,381 - INFO -  * Restarting with stat
2025-06-17 11:37:22,476 - WARNING -  * Debugger is active!
2025-06-17 11:37:22,480 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:37:23,522 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:37:23,633 - INFO -  * Restarting with stat
2025-06-17 11:37:24,741 - WARNING -  * Debugger is active!
2025-06-17 11:37:24,744 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:49:11,712 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 11:49:11,712 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 11:49:11,714 - INFO -  * Restarting with stat
2025-06-17 11:49:12,805 - WARNING -  * Debugger is active!
2025-06-17 11:49:12,809 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:49:17,359 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:17] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 11:49:17,380 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:17] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 11:49:17,400 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:17] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:49:25,546 - INFO - Connected to database
2025-06-17 11:49:25,885 - INFO - Database connection closed
2025-06-17 11:49:25,887 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:25] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 11:49:25,900 - INFO - Connected to database
2025-06-17 11:49:25,908 - INFO - Database connection closed
2025-06-17 11:49:25,926 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:25] "[35m[1mGET / HTTP/1.1[0m" 500 -
2025-06-17 11:49:26,136 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:26] "[36mGET /?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1[0m" 304 -
2025-06-17 11:49:26,138 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:26] "[36mGET /?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1[0m" 304 -
2025-06-17 11:49:26,163 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:26] "GET /?__debugger__=yes&cmd=resource&f=console.png&s=Pe6tDGlojwJy5KvWLcwY HTTP/1.1" 200 -
2025-06-17 11:49:26,192 - INFO - 127.0.0.1 - - [17/Jun/2025 11:49:26] "[36mGET /?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1[0m" 304 -
2025-06-17 11:50:21,790 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 11:50:21,991 - INFO -  * Restarting with stat
2025-06-17 11:50:52,480 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 11:50:52,481 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 11:50:52,482 - INFO -  * Restarting with stat
2025-06-17 11:50:53,514 - WARNING -  * Debugger is active!
2025-06-17 11:50:53,517 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 11:50:55,707 - INFO - 127.0.0.1 - - [17/Jun/2025 11:50:55] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 11:50:55,723 - INFO - 127.0.0.1 - - [17/Jun/2025 11:50:55] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 11:50:55,745 - INFO - 127.0.0.1 - - [17/Jun/2025 11:50:55] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:51:03,225 - INFO - Connected to database
2025-06-17 11:51:03,600 - INFO - Database connection closed
2025-06-17 11:51:03,601 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:03] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 11:51:03,612 - INFO - Connected to database
2025-06-17 11:51:05,363 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:05,407 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 11:51:05,410 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 11:51:06,455 - DEBUG - Loading model cost 1.047 seconds.
2025-06-17 11:51:06,456 - DEBUG - Prefix dict has been built successfully.
2025-06-17 11:51:06,465 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:06,486 - INFO - Database connection closed
2025-06-17 11:51:06,488 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:06] "GET / HTTP/1.1" 200 -
2025-06-17 11:51:06,537 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:06] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 11:51:13,389 - INFO - Connected to database
2025-06-17 11:51:14,982 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:15,019 - DEBUG - Extracting category from query: 'coupons for kowloon', words: ['coupons', 'for', 'kowloon']
2025-06-17 11:51:15,019 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,020 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,020 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,026 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,026 - DEBUG - Ignoring word: 'coupons'
2025-06-17 11:51:15,026 - INFO - No category matched for query: coupons for kowloon
2025-06-17 11:51:15,032 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 11:51:15,093 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A0C38BCB0>
2025-06-17 11:51:15,094 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000024A0BFAAF90> server_hostname='api.mistral.ai' timeout=None
2025-06-17 11:51:15,133 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A0C002710>
2025-06-17 11:51:15,134 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 11:51:15,135 - DEBUG - send_request_headers.complete
2025-06-17 11:51:15,136 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 11:51:15,137 - DEBUG - send_request_body.complete
2025-06-17 11:51:15,138 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 11:51:15,427 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:21:15 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998827586'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'835a6c53c016547747eb553dbbca694c'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=oALvi4Qg0i0U3Bd4Kc60K3nL7w7Uq35.X9d9uy6lSYg-1750141275-1.0.1.1-oWt19i6Y5voKmUlY91Qmi7svfm8G_IJUQiPrFXdp870dpjidUC_zAKmf1wEYsq37AgvLVxF.MY.Pp66wrwVZSSl9HKLoCtyjRfnf6iXVwsg; path=/; expires=Tue, 17-Jun-25 06:51:15 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=2052tX6BR07aEDyx9u567RwFPge0H.ZYqu140joAhos-1750141275381-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95107219789f3f42-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 11:51:15,431 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 11:51:15,433 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 11:51:15,434 - DEBUG - receive_response_body.complete
2025-06-17 11:51:15,435 - DEBUG - response_closed.started
2025-06-17 11:51:15,436 - DEBUG - response_closed.complete
2025-06-17 11:51:15,438 - DEBUG - Mistral location analysis: None
2025-06-17 11:51:15,439 - DEBUG - Location candidates: ['coupons for kowloon', 'coupons for', 'for kowloon', 'kowloon']
2025-06-17 11:51:15,446 - INFO - Normalized area match: 'kowloon' -> 'Kowloon'
2025-06-17 11:51:15,458 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 11:51:15,459 - DEBUG - send_request_headers.complete
2025-06-17 11:51:15,460 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 11:51:15,461 - DEBUG - send_request_body.complete
2025-06-17 11:51:15,462 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 11:51:15,739 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:21:15 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'70'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499756'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998827486'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'70'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'b582e20ed3870d061077fd145361175c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510721b7b583f42-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 11:51:15,741 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 11:51:15,741 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 11:51:15,742 - DEBUG - receive_response_body.complete
2025-06-17 11:51:15,743 - DEBUG - response_closed.started
2025-06-17 11:51:15,744 - DEBUG - response_closed.complete
2025-06-17 11:51:15,746 - DEBUG - Mistral coupon name analysis: None
2025-06-17 11:51:15,748 - DEBUG - Cleaned query: 'coupons kowloon'
2025-06-17 11:51:15,758 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 11:51:15,775 - INFO - No coupon name matched for query: 'coupons for kowloon'
2025-06-17 11:51:15,776 - DEBUG - Query: coupons for kowloon, Category: None, Location: {'name': 'Kowloon', 'type': 'area', 'id': '2'}, Coupon Name: None, Discount: None
2025-06-17 11:51:15,778 - DEBUG - Valid selected_area IDs for area 2: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,779 - DEBUG - Searching coupons with area: 2, selected_areas: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,780 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['2', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', 20]
2025-06-17 11:51:15,788 - DEBUG - Found 20 rows
2025-06-17 11:51:15,790 - DEBUG - Valid area IDs for coupon ID 1265 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,793 - DEBUG - Valid area IDs for coupon ID 1261 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,795 - DEBUG - Valid area IDs for coupon ID 1260 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,797 - DEBUG - Valid area IDs for coupon ID 1259 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,799 - DEBUG - Valid area IDs for coupon ID 1258 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,801 - DEBUG - Valid area IDs for coupon ID 1245 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,804 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,807 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,809 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,811 - DEBUG - Valid area IDs for coupon ID 1226 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,813 - DEBUG - Valid area IDs for coupon ID 1223 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,816 - DEBUG - Valid area IDs for coupon ID 1200 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,819 - DEBUG - Valid area IDs for coupon ID 1190 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,821 - DEBUG - Valid area IDs for coupon ID 1169 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,823 - DEBUG - Valid area IDs for coupon ID 1166 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,825 - DEBUG - Valid area IDs for coupon ID 1162 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,827 - DEBUG - Valid area IDs for coupon ID 1161 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,828 - DEBUG - Valid area IDs for coupon ID 1159 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,831 - DEBUG - Valid area IDs for coupon ID 1158 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,834 - DEBUG - Valid area IDs for coupon ID 1157 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 11:51:15,835 - DEBUG - Returning 20 coupons for category 'None', location 'Kowloon'
2025-06-17 11:51:15,836 - DEBUG - Coupon results: [{'id': 1265, 'name_en': 'KC Test Coupon', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1261, 'name_en': 'KFC Free Gift', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1260, 'name_en': 'Commission Test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1259, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1258, 'name_en': 'Toy KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1245, 'name_en': 'test', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1239, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1235, 'name_en': 'KFC', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1227, 'name_en': 'Created by branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1226, 'name_en': 'Kingsman Mens Style', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1223, 'name_en': 'Kings Man Coupon Test', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1200, 'name_en': 'Created by Branch', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1190, 'name_en': 'main 100', 'selected_area': '33', 'territory': '', 'area': '2'}, {'id': 1169, 'name_en': 'KFCVoucher$10', 'selected_area': '26', 'territory': '', 'area': '2'}, {'id': 1166, 'name_en': 'Branch 2 coupon', 'selected_area': '29', 'territory': '', 'area': '2'}, {'id': 1162, 'name_en': '111', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1161, 'name_en': 'Testing coupon name', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1159, 'name_en': 'XYZ', 'selected_area': '28', 'territory': '', 'area': '2'}, {'id': 1158, 'name_en': '12312', 'selected_area': '4', 'territory': '', 'area': '2'}, {'id': 1157, 'name_en': '1112', 'selected_area': '4', 'territory': '', 'area': '2'}]
2025-06-17 11:51:17,258 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:17,303 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:17,304 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:18,726 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:18,757 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:18,758 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:20,224 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:20,251 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:20,252 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:21,677 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:21,717 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:21,718 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:23,191 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:23,223 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:23,223 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:24,658 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:24,704 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:24,704 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:26,245 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:26,272 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 11:51:26,273 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:27,722 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:27,749 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:27,750 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:29,176 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:29,205 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 11:51:29,206 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:30,738 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:30,764 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 11:51:30,764 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:32,288 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:32,319 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 11:51:32,319 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:33,837 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:33,871 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 11:51:33,872 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:35,332 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:35,365 - DEBUG - Found area name: Whampoa for selected_area: 33, table: kowloon
2025-06-17 11:51:35,366 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:36,877 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:36,920 - DEBUG - Found area name: Kowloon Station for selected_area: 26, table: kowloon
2025-06-17 11:51:36,920 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:38,385 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:38,406 - DEBUG - Found area name: Yau Ma Tei for selected_area: 29, table: kowloon
2025-06-17 11:51:38,407 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:39,913 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:39,953 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 11:51:39,953 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:41,325 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:41,364 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 11:51:41,364 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:42,822 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:42,853 - DEBUG - Found area name: Mong Kok for selected_area: 28, table: kowloon
2025-06-17 11:51:42,853 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:44,289 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:44,322 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 11:51:44,322 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:45,858 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:45,893 - DEBUG - Found area name: Kwun Tong for selected_area: 4, table: kowloon
2025-06-17 11:51:45,894 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:45,898 - DEBUG - close.started
2025-06-17 11:51:45,898 - DEBUG - close.complete
2025-06-17 11:51:45,899 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:45,905 - INFO - Database connection closed
2025-06-17 11:51:45,906 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:45] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 11:51:45,924 - INFO - Connected to database
2025-06-17 11:51:47,435 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 11:51:47,470 - DEBUG - Using proactor: IocpProactor
2025-06-17 11:51:47,475 - INFO - Database connection closed
2025-06-17 11:51:47,476 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:47] "GET / HTTP/1.1" 200 -
2025-06-17 11:51:47,498 - INFO - 127.0.0.1 - - [17/Jun/2025 11:51:47] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:00:54,160 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:00:54,330 - INFO -  * Restarting with stat
2025-06-17 12:00:56,104 - WARNING -  * Debugger is active!
2025-06-17 12:00:56,109 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:01:07,376 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:07] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:01:07,403 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:07] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:01:07,428 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:07] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:01:12,834 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:12] "GET /register HTTP/1.1" 200 -
2025-06-17 12:01:12,882 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:12] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:01:27,606 - INFO - Connected to database
2025-06-17 12:01:27,609 - INFO - Database connection closed
2025-06-17 12:01:27,609 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:27] "POST /register HTTP/1.1" 200 -
2025-06-17 12:01:27,630 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:27] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:01:41,052 - INFO - Connected to database
2025-06-17 12:01:41,393 - INFO - Database connection closed
2025-06-17 12:01:41,393 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:41] "[32mPOST /register HTTP/1.1[0m" 302 -
2025-06-17 12:01:41,401 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:41] "GET /login HTTP/1.1" 200 -
2025-06-17 12:01:41,428 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:41] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:01:48,481 - INFO - Connected to database
2025-06-17 12:01:48,801 - INFO - Database connection closed
2025-06-17 12:01:48,801 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:48] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:01:48,818 - INFO - Connected to database
2025-06-17 12:01:50,560 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:01:50,592 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:01:50,593 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:01:51,680 - DEBUG - Loading model cost 1.087 seconds.
2025-06-17 12:01:51,681 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:01:51,692 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:01:51,720 - INFO - Database connection closed
2025-06-17 12:01:51,721 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:51] "GET / HTTP/1.1" 200 -
2025-06-17 12:01:51,770 - INFO - 127.0.0.1 - - [17/Jun/2025 12:01:51] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:02:03,506 - INFO - Connected to database
2025-06-17 12:02:04,996 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:02:05,032 - DEBUG - Extracting category from query: 'give coupons for new territories', words: ['give', 'coupons', 'for', 'new', 'territories']
2025-06-17 12:02:05,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,033 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,033 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,033 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,038 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,038 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,038 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,038 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,039 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,039 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,039 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:02:05,039 - INFO - No category matched for query: give coupons for new territories
2025-06-17 12:02:05,047 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:02:05,100 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002C313F8FA10>
2025-06-17 12:02:05,101 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002C313FC0F80> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:02:05,138 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002C314037110>
2025-06-17 12:02:05,139 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:02:05,140 - DEBUG - send_request_headers.complete
2025-06-17 12:02:05,141 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:02:05,142 - DEBUG - send_request_body.complete
2025-06-17 12:02:05,143 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:02:05,421 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:32:05 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'88'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825940'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'88'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'1ff5f128785a0c7d34f67662e15c5372'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=zQVnbXU2iCstBeW230kJcK5klpuCti5BTPTlwSqMBVA-1750141925-1.0.1.1-G_pQNxVhm8O2_FT33f3HYFlpcTD0.zGMoDquZa9lvLF0UvADsKK1IM_JBzFzlmEwjd5E_X77Nwb.wWhQuRV_MmwZpgVVK1SOx0cIV0NOhCs; path=/; expires=Tue, 17-Jun-25 07:02:05 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=QxX40CNAcIzwHF6_F6nP0eaT0HQl4TtTUV22np_bL4s-1750141925373-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951081f7fae24928-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:02:05,424 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:02:05,425 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:02:05,427 - DEBUG - receive_response_body.complete
2025-06-17 12:02:05,428 - DEBUG - response_closed.started
2025-06-17 12:02:05,429 - DEBUG - response_closed.complete
2025-06-17 12:02:05,433 - DEBUG - Mistral location analysis: None
2025-06-17 12:02:05,434 - DEBUG - Location candidates: ['give coupons for new', 'give coupons for', 'give coupons', 'coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 12:02:05,453 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 12:02:05,468 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:02:05,469 - DEBUG - send_request_headers.complete
2025-06-17 12:02:05,470 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:02:05,471 - DEBUG - send_request_body.complete
2025-06-17 12:02:05,472 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:02:05,761 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:32:05 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'97'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825841'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'98'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'bcf8777b163d9b31754bbf1c3cb8593a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951081fa0dbc4928-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:02:05,763 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:02:05,764 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:02:05,765 - DEBUG - receive_response_body.complete
2025-06-17 12:02:05,766 - DEBUG - response_closed.started
2025-06-17 12:02:05,769 - DEBUG - response_closed.complete
2025-06-17 12:02:05,773 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:02:05,777 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 12:02:05,785 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:02:05,820 - INFO - No coupon name matched for query: 'give coupons for new territories'
2025-06-17 12:02:05,821 - DEBUG - Query: give coupons for new territories, Category: None, Location: {'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name: None, Discount: None
2025-06-17 12:02:05,822 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,823 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,823 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 12:02:05,827 - DEBUG - Found 20 rows
2025-06-17 12:02:05,830 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,831 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,832 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,833 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,834 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,835 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,835 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,836 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,837 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,838 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,839 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,840 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,840 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,841 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,842 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,843 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,844 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,845 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,846 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,847 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:02:05,848 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 12:02:05,848 - ERROR - Error processing query 'give coupons for new territories': name 'Markup' is not defined
2025-06-17 12:02:05,849 - DEBUG - close.started
2025-06-17 12:02:05,849 - DEBUG - close.complete
2025-06-17 12:02:05,850 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:02:05,855 - INFO - Database connection closed
2025-06-17 12:02:05,856 - INFO - 127.0.0.1 - - [17/Jun/2025 12:02:05] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:02:05,874 - INFO - Connected to database
2025-06-17 12:02:07,317 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:02:07,361 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:02:07,367 - INFO - Database connection closed
2025-06-17 12:02:07,368 - INFO - 127.0.0.1 - - [17/Jun/2025 12:02:07] "GET / HTTP/1.1" 200 -
2025-06-17 12:02:07,386 - INFO - 127.0.0.1 - - [17/Jun/2025 12:02:07] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:03:30,324 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:03:30,529 - INFO -  * Restarting with stat
2025-06-17 12:03:31,758 - WARNING -  * Debugger is active!
2025-06-17 12:03:31,763 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:05:29,368 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:05:29,633 - INFO -  * Restarting with stat
2025-06-17 12:05:30,793 - WARNING -  * Debugger is active!
2025-06-17 12:05:30,796 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:05:33,561 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:33] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:05:33,625 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:33] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:05:33,651 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:33] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:05:40,134 - INFO - Connected to database
2025-06-17 12:05:40,517 - INFO - Database connection closed
2025-06-17 12:05:40,518 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:40] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:05:40,532 - INFO - Connected to database
2025-06-17 12:05:42,348 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:05:42,378 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:05:42,382 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:05:43,414 - DEBUG - Loading model cost 1.036 seconds.
2025-06-17 12:05:43,415 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:05:43,448 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:05:43,463 - INFO - Database connection closed
2025-06-17 12:05:43,464 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:43] "GET / HTTP/1.1" 200 -
2025-06-17 12:05:43,503 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:43] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:05:47,951 - INFO - Connected to database
2025-06-17 12:05:49,685 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:05:49,717 - DEBUG - Extracting category from query: 'give coupons for new territories', words: ['give', 'coupons', 'for', 'new', 'territories']
2025-06-17 12:05:49,717 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,718 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,718 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,718 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,719 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,719 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,719 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,719 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,719 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,720 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,720 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,720 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,720 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,721 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,721 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,721 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,721 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,722 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,722 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,722 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,722 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,723 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,723 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,723 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,723 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,723 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,724 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,724 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:05:49,724 - INFO - No category matched for query: give coupons for new territories
2025-06-17 12:05:49,732 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:05:49,782 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002433A2638C0>
2025-06-17 12:05:49,783 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000024339DD6690> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:05:49,822 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024339E6B890>
2025-06-17 12:05:49,823 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:05:49,824 - DEBUG - send_request_headers.complete
2025-06-17 12:05:49,825 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:05:49,826 - DEBUG - send_request_body.complete
2025-06-17 12:05:49,827 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:05:50,115 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:35:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'91'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825698'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'92'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'efe4863a03e7cc6d9cc1476e28c5ea21'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=tVPubAQqdX3.5FpW4DHSEcrbgQh8ubwNmrn5tQ_jtOA-1750142150-1.0.1.1-oR7AiF3rWrA0LnN21tmaQxo5HtA6b3EaZ1FzOsLQbcNWuLPDQQB.Njn.qpIctIdULXDkTaEiWbnB2pHqqjtUPwLVBgRoU8nu9xlf10OOLlw; path=/; expires=Tue, 17-Jun-25 07:05:50 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=_NgRmgoYxxghrpVbghElDtyAc3AU.b7hHcQ98QiMU.w-1750142150068-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951087743c356e29-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:05:50,117 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:05:50,117 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:05:50,117 - DEBUG - receive_response_body.complete
2025-06-17 12:05:50,118 - DEBUG - response_closed.started
2025-06-17 12:05:50,118 - DEBUG - response_closed.complete
2025-06-17 12:05:50,119 - DEBUG - Mistral location analysis: None
2025-06-17 12:05:50,119 - DEBUG - Location candidates: ['give coupons for new', 'give coupons for', 'give coupons', 'coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 12:05:50,125 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 12:05:50,132 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:05:50,133 - DEBUG - send_request_headers.complete
2025-06-17 12:05:50,134 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:05:50,134 - DEBUG - send_request_body.complete
2025-06-17 12:05:50,135 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:05:50,408 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:35:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'79'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825599'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'79'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'a603a525c7d7d235f46ce73c3492637d'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951087762e576e29-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:05:50,409 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:05:50,409 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:05:50,410 - DEBUG - receive_response_body.complete
2025-06-17 12:05:50,411 - DEBUG - response_closed.started
2025-06-17 12:05:50,412 - DEBUG - response_closed.complete
2025-06-17 12:05:50,414 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:05:50,415 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 12:05:50,424 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:05:50,464 - INFO - No coupon name matched for query: 'give coupons for new territories'
2025-06-17 12:05:50,465 - DEBUG - Query: give coupons for new territories, Category: None, Location: {'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name: None, Discount: None
2025-06-17 12:05:50,467 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,468 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,468 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 12:05:50,476 - DEBUG - Found 20 rows
2025-06-17 12:05:50,478 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,481 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,484 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,487 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,490 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,491 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,493 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,495 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,497 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,500 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,502 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,503 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,505 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,506 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,508 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,509 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,511 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,513 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,515 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,517 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:05:50,517 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 12:05:50,518 - DEBUG - close.started
2025-06-17 12:05:50,519 - DEBUG - close.complete
2025-06-17 12:05:50,519 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:05:50,529 - INFO - Database connection closed
2025-06-17 12:05:50,531 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:50] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:05:50,555 - INFO - Connected to database
2025-06-17 12:05:52,041 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:05:52,075 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:05:52,079 - INFO - Database connection closed
2025-06-17 12:05:52,080 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:52] "GET / HTTP/1.1" 200 -
2025-06-17 12:05:52,101 - INFO - 127.0.0.1 - - [17/Jun/2025 12:05:52] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:06:04,622 - INFO - Connected to database
2025-06-17 12:06:06,012 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:06:06,041 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:06:06,042 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,044 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,044 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,044 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,048 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,048 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,048 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,048 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:06:06,049 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:06:06,053 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:06:06,129 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024339E6B9D0>
2025-06-17 12:06:06,130 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002433A290F80> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:06:06,168 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024339EC0640>
2025-06-17 12:06:06,169 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:06:06,170 - DEBUG - send_request_headers.complete
2025-06-17 12:06:06,171 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:06:06,172 - DEBUG - send_request_body.complete
2025-06-17 12:06:06,172 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:06:06,738 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:36:06 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'93'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499615'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825456'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'93'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'7f93797c8e82f00fa18e9327e55b6f63'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=C5CeFluN70BPcq7Brzdpw5M4Wa9sVZaz3kcAEbW45DE-1750142166-1.0.1.1-yxt18QDIk0D2FPNsXIkgDcUBHTj5UgXzHBKXhWknZASKi3dF14ODpz7eRrMChIg9tVuD.DqpL9egZEoWWi8Rs1JGhntGTuAKHbUneBson4w; path=/; expires=Tue, 17-Jun-25 07:06:06 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=retcU9uMTDo8PSPwdF3fHCFfcx5jA09cmsQh_Pwf5XM-1750142166688-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951087da69163de5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:06:06,740 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:06:06,740 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:06:06,742 - DEBUG - receive_response_body.complete
2025-06-17 12:06:06,743 - DEBUG - response_closed.started
2025-06-17 12:06:06,743 - DEBUG - response_closed.complete
2025-06-17 12:06:06,746 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:06:06,756 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:06:06,758 - DEBUG - send_request_headers.complete
2025-06-17 12:06:06,758 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:06:06,759 - DEBUG - send_request_body.complete
2025-06-17 12:06:06,760 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:06:07,154 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:36:06 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'71'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499517'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825358'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'71'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'dbe83625dfebc933b20afe69338c2b75'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951087de1e913de5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:06:07,155 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:06:07,156 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:06:07,158 - DEBUG - receive_response_body.complete
2025-06-17 12:06:07,159 - DEBUG - response_closed.started
2025-06-17 12:06:07,159 - DEBUG - response_closed.complete
2025-06-17 12:06:07,162 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:06:07,163 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:06:07,173 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:06:07,215 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:06:07,216 - DEBUG - Query: coupons for hong kong, Category: None, Location: {'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name: None, Discount: None
2025-06-17 12:06:07,219 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,220 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,221 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:06:07,228 - DEBUG - Found 20 rows
2025-06-17 12:06:07,231 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,234 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,236 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,238 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,239 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,241 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,243 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,245 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,247 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,249 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,250 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,252 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,253 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,254 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,256 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,257 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,260 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,263 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,265 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,266 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:06:07,267 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:06:07,268 - DEBUG - close.started
2025-06-17 12:06:07,268 - DEBUG - close.complete
2025-06-17 12:06:07,269 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:06:07,279 - INFO - Database connection closed
2025-06-17 12:06:07,280 - INFO - 127.0.0.1 - - [17/Jun/2025 12:06:07] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:06:07,303 - INFO - Connected to database
2025-06-17 12:06:08,686 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:06:08,738 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:06:08,744 - INFO - Database connection closed
2025-06-17 12:06:08,745 - INFO - 127.0.0.1 - - [17/Jun/2025 12:06:08] "GET / HTTP/1.1" 200 -
2025-06-17 12:06:08,779 - INFO - 127.0.0.1 - - [17/Jun/2025 12:06:08] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:08:24,201 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:08:24,359 - INFO -  * Restarting with stat
2025-06-17 12:08:26,872 - WARNING -  * Debugger is active!
2025-06-17 12:08:26,876 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:08:28,940 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:08:29,070 - INFO -  * Restarting with stat
2025-06-17 12:08:30,293 - WARNING -  * Debugger is active!
2025-06-17 12:08:30,296 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:08:33,371 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:08:33,502 - INFO -  * Restarting with stat
2025-06-17 12:08:34,804 - WARNING -  * Debugger is active!
2025-06-17 12:08:34,807 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:08:35,871 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:08:36,017 - INFO -  * Restarting with stat
2025-06-17 12:08:37,307 - WARNING -  * Debugger is active!
2025-06-17 12:08:37,312 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:08:39,364 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:08:39,505 - INFO -  * Restarting with stat
2025-06-17 12:08:40,759 - WARNING -  * Debugger is active!
2025-06-17 12:08:40,762 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:00,294 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:00,481 - INFO -  * Restarting with stat
2025-06-17 12:09:01,708 - WARNING -  * Debugger is active!
2025-06-17 12:09:01,712 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:04,777 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:04,897 - INFO -  * Restarting with stat
2025-06-17 12:09:06,045 - WARNING -  * Debugger is active!
2025-06-17 12:09:06,048 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:09,117 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:09,232 - INFO -  * Restarting with stat
2025-06-17 12:09:10,441 - WARNING -  * Debugger is active!
2025-06-17 12:09:10,444 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:10,473 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:10,587 - INFO -  * Restarting with stat
2025-06-17 12:09:11,721 - WARNING -  * Debugger is active!
2025-06-17 12:09:11,724 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:14,797 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:14,909 - INFO -  * Restarting with stat
2025-06-17 12:09:16,063 - WARNING -  * Debugger is active!
2025-06-17 12:09:16,066 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:20,156 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:09:20,261 - INFO -  * Restarting with stat
2025-06-17 12:09:21,387 - WARNING -  * Debugger is active!
2025-06-17 12:09:21,390 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:09:28,674 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:28] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:09:28,700 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:28] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:09:28,724 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:28] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:09:35,095 - INFO - Connected to database
2025-06-17 12:09:35,471 - INFO - Database connection closed
2025-06-17 12:09:35,471 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:35] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:09:35,487 - INFO - Connected to database
2025-06-17 12:09:37,092 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:09:37,118 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:09:37,119 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:09:37,934 - DEBUG - Loading model cost 0.816 seconds.
2025-06-17 12:09:37,935 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:09:37,945 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:09:37,967 - INFO - Database connection closed
2025-06-17 12:09:37,967 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:37] "GET / HTTP/1.1" 200 -
2025-06-17 12:09:38,015 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:38] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:09:41,042 - INFO - Connected to database
2025-06-17 12:09:42,570 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:09:42,605 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:09:42,606 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,607 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,607 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,607 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,607 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,608 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,608 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,608 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,609 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,609 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,609 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,609 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,609 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,610 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,610 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,610 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,610 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,611 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,612 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,614 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,614 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,615 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,615 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,615 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,615 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,616 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,616 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,616 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:09:42,616 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:09:42,621 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:09:42,762 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000012657D578C0>
2025-06-17 12:09:42,763 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000126578CAD50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:09:42,857 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000012657957890>
2025-06-17 12:09:42,859 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:09:42,861 - DEBUG - send_request_headers.complete
2025-06-17 12:09:42,862 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:09:42,864 - DEBUG - send_request_body.complete
2025-06-17 12:09:42,865 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:09:44,436 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:39:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'1292'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825215'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'1293'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'ff09336669189e78e723690c0ada0e65'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=ppVaiHQJLxAdsg8ZQroUvEgs2gJ.WRTnkoRjlMthzQE-1750142384-1.0.1.1-vnN2NlDyPEuDKNFu03CtmoxHYDZtLzFrx0khy2weaFjRoUApTjDcAcGD2PtQ8c_isTfu7OU_r3z7weRg.lhTgRxe3jc7odH9FQsQGJTwnNE; path=/; expires=Tue, 17-Jun-25 07:09:44 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=AQ2FueEOoyDSXi44ixGnVQ16q1Kp24NSCdIhR3NgO6I-1750142384387-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95108d250b639f83-SIN'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:09:44,437 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:09:44,438 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:09:44,440 - DEBUG - receive_response_body.complete
2025-06-17 12:09:44,440 - DEBUG - response_closed.started
2025-06-17 12:09:44,441 - DEBUG - response_closed.complete
2025-06-17 12:09:44,443 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:09:44,457 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:09:44,458 - DEBUG - send_request_headers.complete
2025-06-17 12:09:44,458 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:09:44,459 - DEBUG - send_request_body.complete
2025-06-17 12:09:44,459 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:09:44,805 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:39:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'78'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998825117'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'79'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'eeb4f116c68172211d9a0c0a6882516b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95108d2f0ba89f83-SIN'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:09:44,807 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:09:44,808 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:09:44,809 - DEBUG - receive_response_body.complete
2025-06-17 12:09:44,809 - DEBUG - response_closed.started
2025-06-17 12:09:44,810 - DEBUG - response_closed.complete
2025-06-17 12:09:44,814 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:09:44,816 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:09:44,823 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:09:44,862 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:09:44,863 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:09:44,863 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:09:44,865 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,866 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,867 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:09:44,875 - DEBUG - Found 20 rows
2025-06-17 12:09:44,877 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,879 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,880 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,882 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,884 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,886 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,887 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,889 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,891 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,892 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,893 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,894 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,897 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,899 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,901 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,902 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,903 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,904 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,905 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,907 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:09:44,907 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:09:44,909 - ERROR - Error processing query 'coupons for hong kong': 1146 (42S02): Table 'coupon.areas' doesn't exist
2025-06-17 12:09:44,910 - DEBUG - close.started
2025-06-17 12:09:44,911 - DEBUG - close.complete
2025-06-17 12:09:44,912 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:09:44,924 - INFO - Database connection closed
2025-06-17 12:09:44,925 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:44] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:09:44,950 - INFO - Connected to database
2025-06-17 12:09:46,270 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:09:46,318 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:09:46,323 - INFO - Database connection closed
2025-06-17 12:09:46,323 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:46] "GET / HTTP/1.1" 200 -
2025-06-17 12:09:46,345 - INFO - 127.0.0.1 - - [17/Jun/2025 12:09:46] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:10:20,248 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:10:20,389 - INFO -  * Restarting with stat
2025-06-17 12:10:21,474 - WARNING -  * Debugger is active!
2025-06-17 12:10:21,478 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:10:25,565 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:10:25,686 - INFO -  * Restarting with stat
2025-06-17 12:10:26,760 - WARNING -  * Debugger is active!
2025-06-17 12:10:26,763 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:10:29,827 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:10:29,943 - INFO -  * Restarting with stat
2025-06-17 12:10:31,033 - WARNING -  * Debugger is active!
2025-06-17 12:10:31,036 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:10:33,932 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:33] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:10:33,950 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:33] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:10:33,974 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:33] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:10:40,081 - INFO - Connected to database
2025-06-17 12:10:40,476 - INFO - Database connection closed
2025-06-17 12:10:40,477 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:40] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:10:40,492 - INFO - Connected to database
2025-06-17 12:10:42,185 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:10:42,208 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:10:42,209 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:10:43,136 - DEBUG - Loading model cost 0.928 seconds.
2025-06-17 12:10:43,137 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:10:43,147 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:10:43,174 - INFO - Database connection closed
2025-06-17 12:10:43,174 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:43] "GET / HTTP/1.1" 200 -
2025-06-17 12:10:43,229 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:43] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:10:46,095 - INFO - Connected to database
2025-06-17 12:10:47,658 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:10:47,700 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:10:47,700 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,701 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,701 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,701 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,702 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,702 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,703 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,703 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,703 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,703 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,704 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,704 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,704 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,705 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,705 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,705 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,706 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,706 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,707 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,707 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,708 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,708 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,708 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,708 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,708 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,709 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,709 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,709 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:10:47,710 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:10:47,715 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:10:47,759 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001411B1678C0>
2025-06-17 12:10:47,760 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001411ADCA690> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:10:47,791 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001411AE57890>
2025-06-17 12:10:47,792 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:10:47,793 - DEBUG - send_request_headers.complete
2025-06-17 12:10:47,794 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:10:47,795 - DEBUG - send_request_body.complete
2025-06-17 12:10:47,796 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:10:48,090 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:40:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998824974'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'ae13916f8076981033334661e4a97040'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=ElqBeBNOqS.cJy3xlmsjKOHoP03zBjcGB0VZBujHVXA-1750142448-1.0.1.1-cLGUNnYXhHPuom.bdlp_rrXZ71x7uxfKg1Kqh3.hIZwv4qwiHa.RyRFa2D20JZE_OCbWbJXr1MnzaseMEZ7xcgc0_meamoxWwHekiO9TWUI; path=/; expires=Tue, 17-Jun-25 07:10:48 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=rRnO0gDNJBABtzkXZDKgUE8GoLdtgjK78Kjb2fobyXQ-1750142448040-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95108eba88d53ca0-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:10:48,093 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:10:48,094 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:10:48,095 - DEBUG - receive_response_body.complete
2025-06-17 12:10:48,096 - DEBUG - response_closed.started
2025-06-17 12:10:48,096 - DEBUG - response_closed.complete
2025-06-17 12:10:48,100 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:10:48,113 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:10:48,115 - DEBUG - send_request_headers.complete
2025-06-17 12:10:48,116 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:10:48,118 - DEBUG - send_request_body.complete
2025-06-17 12:10:48,118 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:10:48,396 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:40:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'80'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998824876'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'81'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'f1330f295ab6a76c1545854765c96b09'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95108ebc8bc83ca0-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:10:48,397 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:10:48,397 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:10:48,399 - DEBUG - receive_response_body.complete
2025-06-17 12:10:48,400 - DEBUG - response_closed.started
2025-06-17 12:10:48,400 - DEBUG - response_closed.complete
2025-06-17 12:10:48,403 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:10:48,407 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:10:48,419 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:10:48,453 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:10:48,454 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:10:48,455 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:10:48,458 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,459 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,460 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:10:48,467 - DEBUG - Found 20 rows
2025-06-17 12:10:48,469 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,471 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,473 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,475 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,477 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,478 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,480 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,482 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,485 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,488 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,489 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,491 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,493 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,494 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,495 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,496 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,497 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,499 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,500 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,501 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:10:48,502 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:10:48,522 - DEBUG - close.started
2025-06-17 12:10:48,523 - DEBUG - close.complete
2025-06-17 12:10:48,524 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:10:48,532 - INFO - Database connection closed
2025-06-17 12:10:48,533 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:48] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:10:48,553 - INFO - Connected to database
2025-06-17 12:10:49,951 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:10:49,978 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:10:49,984 - INFO - Database connection closed
2025-06-17 12:10:49,984 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:49] "GET / HTTP/1.1" 200 -
2025-06-17 12:10:50,007 - INFO - 127.0.0.1 - - [17/Jun/2025 12:10:50] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:12:32,674 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:12:32,812 - INFO -  * Restarting with stat
2025-06-17 12:12:33,907 - WARNING -  * Debugger is active!
2025-06-17 12:12:33,916 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:13:04,799 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:04] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:13:04,816 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:04] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:13:04,839 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:04] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:13:10,346 - INFO - Connected to database
2025-06-17 12:13:10,726 - INFO - Database connection closed
2025-06-17 12:13:10,727 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:10] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:13:10,745 - INFO - Connected to database
2025-06-17 12:13:12,487 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:13:12,523 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:13:12,525 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:13:13,620 - DEBUG - Loading model cost 1.096 seconds.
2025-06-17 12:13:13,621 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:13:13,631 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:13:13,651 - INFO - Database connection closed
2025-06-17 12:13:13,652 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:13] "GET / HTTP/1.1" 200 -
2025-06-17 12:13:13,698 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:13] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:13:16,744 - INFO - Connected to database
2025-06-17 12:13:18,394 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:13:18,424 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:13:18,425 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,425 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,425 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,425 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,426 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,426 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,426 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,427 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,427 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,427 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,427 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,428 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,428 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,428 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,428 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,430 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,430 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,430 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,430 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,431 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,431 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,431 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:13:18,431 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:13:18,439 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:13:18,477 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001B9BA4D78C0>
2025-06-17 12:13:18,478 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001B9BA13A690> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:13:18,524 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001B9BA1C7890>
2025-06-17 12:13:18,525 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:13:18,526 - DEBUG - send_request_headers.complete
2025-06-17 12:13:18,527 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:13:18,529 - DEBUG - send_request_body.complete
2025-06-17 12:13:18,529 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:13:18,847 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:43:18 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'102'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499552'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998823027'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'102'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'fb8fb41b6f49d0765c72dd78688d4911'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=6aKpVDlMpbd3gNYPNMv1p_mH2QvQ6ui9wOZY7K9HMNQ-1750142598-1.0.1.1-psrN1slMDuC2NNwco1Lz6PnMhiKtcpaZYlf.6awA8DXMJLeAFKPUxeIXhDHRD0yPFvg1lh9iyuhbNg.NwwAi3RqDhmZTn4MWYw38qJVJXcA; path=/; expires=Tue, 17-Jun-25 07:13:18 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=.JshISRacpoX2FZLykGFYvMKy2_VGdO1tyL001G.Wkk-1750142598784-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951092689ca83b5b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:13:18,852 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:13:18,853 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:13:18,854 - DEBUG - receive_response_body.complete
2025-06-17 12:13:18,855 - DEBUG - response_closed.started
2025-06-17 12:13:18,855 - DEBUG - response_closed.complete
2025-06-17 12:13:18,859 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:13:18,874 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:13:18,875 - DEBUG - send_request_headers.complete
2025-06-17 12:13:18,876 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:13:18,878 - DEBUG - send_request_body.complete
2025-06-17 12:13:18,878 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:13:19,168 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 06:43:19 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499454'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822929'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'3e5770324debd37167f86476ca5b962f'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510926ae82e3b5b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:13:19,168 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:13:19,169 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:13:19,169 - DEBUG - receive_response_body.complete
2025-06-17 12:13:19,169 - DEBUG - response_closed.started
2025-06-17 12:13:19,170 - DEBUG - response_closed.complete
2025-06-17 12:13:19,171 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:13:19,173 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:13:19,181 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:13:19,216 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:13:19,217 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:13:19,217 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:13:19,220 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,221 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,222 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:13:19,227 - DEBUG - Found 20 rows
2025-06-17 12:13:19,229 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,230 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,232 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,234 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,236 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,239 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,240 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,241 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,243 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,245 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,246 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,248 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,250 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,253 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,255 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,256 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,257 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,258 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,260 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,262 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:13:19,262 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:13:19,280 - DEBUG - close.started
2025-06-17 12:13:19,281 - DEBUG - close.complete
2025-06-17 12:13:19,282 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:13:19,289 - INFO - Database connection closed
2025-06-17 12:13:19,289 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:19] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:13:19,310 - INFO - Connected to database
2025-06-17 12:13:20,917 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:13:20,948 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:13:20,954 - INFO - Database connection closed
2025-06-17 12:13:20,955 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:20] "GET / HTTP/1.1" 200 -
2025-06-17 12:13:20,980 - INFO - 127.0.0.1 - - [17/Jun/2025 12:13:20] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:23:30,869 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:23:31,114 - INFO -  * Restarting with stat
2025-06-17 12:24:02,838 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 12:24:02,838 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 12:24:02,839 - INFO -  * Restarting with stat
2025-06-17 12:24:03,887 - WARNING -  * Debugger is active!
2025-06-17 12:24:03,890 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:24:07,548 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:07] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:24:07,565 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:07] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:24:07,589 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:07] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:24:14,100 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:14] "[35m[1mPOST /login HTTP/1.1[0m" 500 -
2025-06-17 12:24:14,382 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:14] "GET /login?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1" 200 -
2025-06-17 12:24:14,389 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:14] "GET /login?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1" 200 -
2025-06-17 12:24:14,404 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:14] "GET /login?__debugger__=yes&cmd=resource&f=console.png&s=pDZ2MnWSzhIii0KMVqaW HTTP/1.1" 200 -
2025-06-17 12:24:14,421 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:14] "GET /login?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1" 200 -
2025-06-17 12:24:39,420 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:39] "GET /register HTTP/1.1" 200 -
2025-06-17 12:24:39,441 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:39] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:24:49,031 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:49] "[35m[1mPOST /register HTTP/1.1[0m" 500 -
2025-06-17 12:24:49,050 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:49] "GET /register?__debugger__=yes&cmd=resource&f=style.css HTTP/1.1" 200 -
2025-06-17 12:24:49,051 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:49] "GET /register?__debugger__=yes&cmd=resource&f=debugger.js HTTP/1.1" 200 -
2025-06-17 12:24:49,067 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:49] "GET /register?__debugger__=yes&cmd=resource&f=console.png&s=pDZ2MnWSzhIii0KMVqaW HTTP/1.1" 200 -
2025-06-17 12:24:49,085 - INFO - 127.0.0.1 - - [17/Jun/2025 12:24:49] "GET /register?__debugger__=yes&cmd=resource&f=console.png HTTP/1.1" 200 -
2025-06-17 12:27:44,189 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:27:44,309 - INFO -  * Restarting with stat
2025-06-17 12:27:45,423 - WARNING -  * Debugger is active!
2025-06-17 12:27:45,426 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:27:54,841 - DEBUG - Register attempt: name=None, email=diya.dave11@gmail.com, password=********
2025-06-17 12:27:54,852 - INFO - 127.0.0.1 - - [17/Jun/2025 12:27:54] "POST /register HTTP/1.1" 200 -
2025-06-17 12:27:54,875 - INFO - 127.0.0.1 - - [17/Jun/2025 12:27:54] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:28:03,247 - DEBUG - Register attempt: name=None, email=diya.dave11@gmail.com, password=********
2025-06-17 12:28:03,250 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:03] "POST /register HTTP/1.1" 200 -
2025-06-17 12:28:03,288 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:03] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:28:18,266 - DEBUG - Register attempt: name=None, email=diya.dave11@gmail.com, password=********
2025-06-17 12:28:18,268 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:18] "POST /register HTTP/1.1" 200 -
2025-06-17 12:28:18,289 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:18] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:28:20,300 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:20] "GET /login HTTP/1.1" 200 -
2025-06-17 12:28:20,323 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:20] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:28:25,804 - DEBUG - Login attempt: email=None, password=********
2025-06-17 12:28:25,805 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:25] "POST /login HTTP/1.1" 200 -
2025-06-17 12:28:25,836 - INFO - 127.0.0.1 - - [17/Jun/2025 12:28:25] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:29:24,230 - DEBUG - Login attempt: email=None, password=********
2025-06-17 12:29:24,231 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:24] "POST /login HTTP/1.1" 200 -
2025-06-17 12:29:24,257 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:24] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:29:26,820 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:26] "GET /register HTTP/1.1" 200 -
2025-06-17 12:29:26,839 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:26] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:29:36,201 - DEBUG - Register attempt: name=None, email=diya.dave1103@gmail.com, password=********
2025-06-17 12:29:36,202 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:36] "POST /register HTTP/1.1" 200 -
2025-06-17 12:29:36,224 - INFO - 127.0.0.1 - - [17/Jun/2025 12:29:36] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:31:24,592 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:31:24,771 - INFO -  * Restarting with stat
2025-06-17 12:31:26,039 - WARNING -  * Debugger is active!
2025-06-17 12:31:26,042 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:32:41,994 - DEBUG - Register attempt: name=None, email=diya.dave1103@gmail.com, password=********
2025-06-17 12:32:41,995 - WARNING - Registration failed: Name missing
2025-06-17 12:32:42,093 - INFO - 127.0.0.1 - - [17/Jun/2025 12:32:42] "POST /register HTTP/1.1" 200 -
2025-06-17 12:32:55,861 - DEBUG - Register attempt: name=diya, email=diya.dave11@gmail.com, password=********
2025-06-17 12:32:56,136 - INFO - Connected to database
2025-06-17 12:32:56,357 - INFO - Registration successful: diya.dave11@gmail.com
2025-06-17 12:32:56,358 - INFO - Database connection closed
2025-06-17 12:32:56,358 - INFO - 127.0.0.1 - - [17/Jun/2025 12:32:56] "[32mPOST /register HTTP/1.1[0m" 302 -
2025-06-17 12:32:56,413 - INFO - 127.0.0.1 - - [17/Jun/2025 12:32:56] "GET /login HTTP/1.1" 200 -
2025-06-17 12:33:09,638 - DEBUG - Login attempt: email=diya.dave1103@gmail.com, password=********
2025-06-17 12:33:09,647 - INFO - Connected to database
2025-06-17 12:33:09,649 - WARNING - Login failed: Invalid credentials for diya.dave1103@gmail.com
2025-06-17 12:33:09,650 - INFO - Database connection closed
2025-06-17 12:33:09,651 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:09] "POST /login HTTP/1.1" 200 -
2025-06-17 12:33:15,382 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 12:33:15,390 - INFO - Connected to database
2025-06-17 12:33:15,624 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 12:33:15,625 - INFO - Database connection closed
2025-06-17 12:33:15,625 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:15] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:33:15,639 - INFO - Connected to database
2025-06-17 12:33:16,229 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:33:16,243 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:33:16,244 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:33:16,674 - DEBUG - Loading model cost 0.431 seconds.
2025-06-17 12:33:16,675 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:33:16,681 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:33:16,689 - INFO - Database connection closed
2025-06-17 12:33:16,690 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:16] "GET / HTTP/1.1" 200 -
2025-06-17 12:33:16,714 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:16] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:33:23,273 - INFO - Connected to database
2025-06-17 12:33:23,779 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:33:23,793 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:33:23,793 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,793 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,794 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,795 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,795 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,795 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,795 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,796 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,797 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:23,798 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:33:23,802 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:33:23,852 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A08BA3B60>
2025-06-17 12:33:23,852 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000024A0880D7F0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:33:23,884 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A08895450>
2025-06-17 12:33:23,885 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:33:23,886 - DEBUG - send_request_headers.complete
2025-06-17 12:33:23,886 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:33:23,886 - DEBUG - send_request_body.complete
2025-06-17 12:33:23,887 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:33:24,212 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:03:24 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'97'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822786'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'98'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'15e353794c0dd47ed240342d64a83227'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=4cMJXqVXvxe0eb2o0syojudt4w9F.FKKcH68RHA8hOo-1750143804-1.0.1.1-rNjFkDrlMuiKaXcmIa4fSF1A8aYAMoA5blgtR71MZQWXw5pt2q6OUnoMgxrzDOBFJziBWT2ySjlXIGj_4ARUX4t8TRtgwLvqrO0IGGSjnxs; path=/; expires=Tue, 17-Jun-25 07:33:24 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Qs5LljYxZ53i_UVR_sCh4kPPZwo2FtU3SksWXHXbGF8-1750143804164-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510afd62c2f47e6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:33:24,215 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:33:24,216 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:33:24,217 - DEBUG - receive_response_body.complete
2025-06-17 12:33:24,217 - DEBUG - response_closed.started
2025-06-17 12:33:24,217 - DEBUG - response_closed.complete
2025-06-17 12:33:24,219 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:33:24,224 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:33:24,225 - DEBUG - send_request_headers.complete
2025-06-17 12:33:24,225 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:33:24,226 - DEBUG - send_request_body.complete
2025-06-17 12:33:24,226 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:33:24,500 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:03:24 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822688'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'8915197ca429da52d6f5ee66796c791e'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510afd84f3247e6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:33:24,501 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:33:24,502 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:33:24,503 - DEBUG - receive_response_body.complete
2025-06-17 12:33:24,503 - DEBUG - response_closed.started
2025-06-17 12:33:24,503 - DEBUG - response_closed.complete
2025-06-17 12:33:24,504 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:33:24,505 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:33:24,508 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:33:24,517 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:33:24,517 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:33:24,517 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:33:24,518 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,519 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,519 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:33:24,523 - DEBUG - Found 20 rows
2025-06-17 12:33:24,523 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,524 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,525 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,525 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,526 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,527 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,527 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,528 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,529 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,530 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,531 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,531 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,532 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,532 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,533 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,533 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,534 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,534 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,535 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,535 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:24,535 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:33:24,554 - DEBUG - close.started
2025-06-17 12:33:24,555 - DEBUG - close.complete
2025-06-17 12:33:24,555 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:33:24,558 - INFO - Database connection closed
2025-06-17 12:33:24,558 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:24] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:33:24,573 - INFO - Connected to database
2025-06-17 12:33:25,082 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:33:25,097 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:33:25,100 - INFO - Database connection closed
2025-06-17 12:33:25,100 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:25] "GET / HTTP/1.1" 200 -
2025-06-17 12:33:25,121 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:25] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:33:48,425 - INFO - Connected to database
2025-06-17 12:33:48,922 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:33:48,946 - DEBUG - Extracting category from query: 'coupons for gucci store', words: ['coupons', 'for', 'gucci', 'store']
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,946 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,947 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,948 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,949 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,950 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,951 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,952 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,953 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:33:48,954 - DEBUG - Ignoring word: 'store'
2025-06-17 12:33:48,954 - INFO - No category matched for query: coupons for gucci store
2025-06-17 12:33:48,957 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:33:48,997 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A0C4C0690>
2025-06-17 12:33:48,997 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000024A08C5D7F0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:33:49,037 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A08B2F950>
2025-06-17 12:33:49,037 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:33:49,038 - DEBUG - send_request_headers.complete
2025-06-17 12:33:49,039 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:33:49,040 - DEBUG - send_request_body.complete
2025-06-17 12:33:49,040 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:33:49,354 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:03:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499616'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822545'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'85'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'1207181506459f0ebcbc726347272e2e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=PEbINrxzHcbKjNMTWhUnb8Q1SMbwNrW6vwM7mOYaA30-1750143829-1.0.1.1-a3.lY6zeSPn8LTJRdU4SnLxJym0dOt6c5Hourb.dMSIImZXydAzyVkCU2miIfwKP_ir.jUXu8axVBJI3_uz1wYEGG5BBWBHgKddlIiD8MNM; path=/; expires=Tue, 17-Jun-25 07:33:49 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=pcDUFlmpyKmRt8T0RBGRfCaDA..8oWfJ_YdVsXwBd8I-1750143829303-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b0735afd3b4f-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:33:49,357 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:33:49,358 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:33:49,359 - DEBUG - receive_response_body.complete
2025-06-17 12:33:49,360 - DEBUG - response_closed.started
2025-06-17 12:33:49,360 - DEBUG - response_closed.complete
2025-06-17 12:33:49,362 - DEBUG - Mistral location analysis: None
2025-06-17 12:33:49,363 - DEBUG - Location candidates: ['coupons for gucci store', 'coupons for gucci', 'coupons for', 'for gucci store', 'for gucci', 'gucci store']
2025-06-17 12:33:49,366 - INFO - No valid location matched for query: coupons for gucci store
2025-06-17 12:33:49,370 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:33:49,370 - DEBUG - send_request_headers.complete
2025-06-17 12:33:49,370 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:33:49,371 - DEBUG - send_request_body.complete
2025-06-17 12:33:49,371 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:33:49,662 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:03:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'91'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499517'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822446'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'92'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'2581012aa67e977e4b94133f9ad4c849'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b0756da23b4f-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:33:49,663 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:33:49,668 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:33:49,669 - DEBUG - receive_response_body.complete
2025-06-17 12:33:49,670 - DEBUG - response_closed.started
2025-06-17 12:33:49,670 - DEBUG - response_closed.complete
2025-06-17 12:33:49,674 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:33:49,674 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 12:33:49,678 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:33:49,684 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 12:33:49,684 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 12:33:49,685 - DEBUG - Final: Query=coupons for gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 12:33:49,685 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 12:33:49,689 - DEBUG - Found 1 rows
2025-06-17 12:33:49,690 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:33:49,690 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 12:33:49,692 - DEBUG - close.started
2025-06-17 12:33:49,692 - DEBUG - close.complete
2025-06-17 12:33:49,693 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:33:49,695 - INFO - Database connection closed
2025-06-17 12:33:49,695 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:49] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:33:49,709 - INFO - Connected to database
2025-06-17 12:33:50,222 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:33:50,249 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:33:50,253 - INFO - Database connection closed
2025-06-17 12:33:50,253 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:50] "GET / HTTP/1.1" 200 -
2025-06-17 12:33:50,282 - INFO - 127.0.0.1 - - [17/Jun/2025 12:33:50] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:34:01,049 - INFO - Connected to database
2025-06-17 12:34:01,556 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:34:01,574 - DEBUG - Extracting category from query: 'coupons for gucci store', words: ['coupons', 'for', 'gucci', 'store']
2025-06-17 12:34:01,574 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,576 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,577 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,577 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,577 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,577 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,577 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,578 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,579 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,580 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,581 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:34:01,582 - DEBUG - Ignoring word: 'store'
2025-06-17 12:34:01,582 - INFO - No category matched for query: coupons for gucci store
2025-06-17 12:34:01,588 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:34:01,605 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A08D1B230>
2025-06-17 12:34:01,605 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000024A08BD96D0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:34:01,632 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000024A08BC2B10>
2025-06-17 12:34:01,632 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:34:01,633 - DEBUG - send_request_headers.complete
2025-06-17 12:34:01,633 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:34:01,633 - DEBUG - send_request_body.complete
2025-06-17 12:34:01,634 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:34:02,206 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:04:02 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'95'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499374'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822303'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'96'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'00483676b6a78427bf65f14e75761a0e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=WFZuyEWQRjt.cnpKFYYs8vpBNBPz_UbzyNbQ9QIt2Z0-1750143842-1.0.1.1-D0Tqp3fF2TmGCk_oGiVjlw8Cb9Tmo9bU2OJImkbbxBm2WgsXinKrDC1XFPD33Je.dMVqD_lCeX6ZXnA9AxTBqVWtQ_yYCVqs20qYbDbQy90; path=/; expires=Tue, 17-Jun-25 07:34:02 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=KnAOHv9ZwQbUhzbuT4A.hxPqA.uMj0SlE7lmcvVA.OQ-1750143842158-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b0c21c103fb4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:34:02,208 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:34:02,209 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:34:02,210 - DEBUG - receive_response_body.complete
2025-06-17 12:34:02,210 - DEBUG - response_closed.started
2025-06-17 12:34:02,211 - DEBUG - response_closed.complete
2025-06-17 12:34:02,213 - DEBUG - Mistral location analysis: None
2025-06-17 12:34:02,213 - DEBUG - Location candidates: ['coupons for gucci store', 'coupons for gucci', 'coupons for', 'for gucci store', 'for gucci', 'gucci store']
2025-06-17 12:34:02,218 - INFO - No valid location matched for query: coupons for gucci store
2025-06-17 12:34:02,225 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:34:02,226 - DEBUG - send_request_headers.complete
2025-06-17 12:34:02,226 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:34:02,227 - DEBUG - send_request_body.complete
2025-06-17 12:34:02,227 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:34:02,532 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:04:02 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'101'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499275'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822204'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'102'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'b2cf30290c64167af9df421e23b74f7c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b0c5c9c73fb4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:34:02,534 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:34:02,535 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:34:02,536 - DEBUG - receive_response_body.complete
2025-06-17 12:34:02,537 - DEBUG - response_closed.started
2025-06-17 12:34:02,537 - DEBUG - response_closed.complete
2025-06-17 12:34:02,539 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:34:02,540 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 12:34:02,544 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:34:02,550 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 12:34:02,551 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 12:34:02,551 - DEBUG - Final: Query=coupons for gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 12:34:02,552 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 12:34:02,557 - DEBUG - Found 1 rows
2025-06-17 12:34:02,558 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:34:02,559 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 12:34:02,561 - DEBUG - close.started
2025-06-17 12:34:02,561 - DEBUG - close.complete
2025-06-17 12:34:02,561 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:34:02,564 - INFO - Database connection closed
2025-06-17 12:34:02,564 - INFO - 127.0.0.1 - - [17/Jun/2025 12:34:02] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:34:02,577 - INFO - Connected to database
2025-06-17 12:34:03,077 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:34:03,094 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:34:03,097 - INFO - Database connection closed
2025-06-17 12:34:03,097 - INFO - 127.0.0.1 - - [17/Jun/2025 12:34:03] "GET / HTTP/1.1" 200 -
2025-06-17 12:34:03,114 - INFO - 127.0.0.1 - - [17/Jun/2025 12:34:03] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:37:16,352 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:37:16,521 - INFO -  * Restarting with stat
2025-06-17 12:37:34,238 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 12:37:34,239 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 12:37:34,240 - INFO -  * Restarting with stat
2025-06-17 12:37:35,257 - WARNING -  * Debugger is active!
2025-06-17 12:37:35,260 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:37:38,415 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:38] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:37:38,426 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:38] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:37:48,274 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 12:37:48,636 - INFO - Connected to database
2025-06-17 12:37:49,000 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 12:37:49,003 - INFO - Database connection closed
2025-06-17 12:37:49,003 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:49] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:37:49,016 - INFO - Connected to database
2025-06-17 12:37:50,558 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:37:50,586 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:37:50,589 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:37:51,582 - DEBUG - Loading model cost 0.994 seconds.
2025-06-17 12:37:51,583 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:37:51,601 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:37:51,625 - INFO - Database connection closed
2025-06-17 12:37:51,625 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:51] "GET / HTTP/1.1" 200 -
2025-06-17 12:37:51,663 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:51] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:37:54,514 - INFO - Connected to database
2025-06-17 12:37:56,143 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:37:56,175 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:37:56,176 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,176 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,176 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,177 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,178 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,178 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,178 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,178 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,179 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,179 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,184 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:37:56,184 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:37:56,192 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:37:56,225 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002BE370DFB60>
2025-06-17 12:37:56,226 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002BE36C5ED50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:37:56,263 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002BE36CE5BD0>
2025-06-17 12:37:56,264 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:37:56,266 - DEBUG - send_request_headers.complete
2025-06-17 12:37:56,266 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:37:56,267 - DEBUG - send_request_body.complete
2025-06-17 12:37:56,268 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:37:56,668 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:07:56 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998822061'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'76'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'1b03b07c604b771c8f7fc6297f978b37'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=v1R1zBCDigF.voKVDGzII0Dq.cfW_WmnPpQosiOtKvM-1750144076-1.0.1.1-9kpCrKfIT5oTl._4dCGl3fD1B8MTJS_QA9Z.haUHCcxzN65I_hUkRcaXP.yBRB1RnDtwWvhwW66sKnaL5Q_1uvHwkiyB0S2pGKOycc8yERQ; path=/; expires=Tue, 17-Jun-25 07:37:56 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=X9L0dvpKSsOkolL.JJmSOfka9DT_wz.A6a0n0KRRiSs-1750144076617-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b67c7b6755a5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:37:56,672 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:37:56,673 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:37:56,674 - DEBUG - receive_response_body.complete
2025-06-17 12:37:56,675 - DEBUG - response_closed.started
2025-06-17 12:37:56,676 - DEBUG - response_closed.complete
2025-06-17 12:37:56,679 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:37:56,694 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:37:56,696 - DEBUG - send_request_headers.complete
2025-06-17 12:37:56,697 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:37:56,698 - DEBUG - send_request_body.complete
2025-06-17 12:37:56,699 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:37:56,970 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:07:56 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'69'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821963'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'70'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'd173e5233f9b193cc7565d1f5325112f'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510b67f2eb855a5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:37:56,971 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:37:56,972 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:37:56,974 - DEBUG - receive_response_body.complete
2025-06-17 12:37:56,974 - DEBUG - response_closed.started
2025-06-17 12:37:56,975 - DEBUG - response_closed.complete
2025-06-17 12:37:56,980 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:37:56,983 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:37:56,991 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:37:57,018 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:37:57,018 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:37:57,019 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:37:57,021 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,022 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,022 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:37:57,027 - DEBUG - Found 20 rows
2025-06-17 12:37:57,029 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,030 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,032 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,033 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,035 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,036 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,037 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,039 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,040 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,041 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,043 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,044 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,046 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,047 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,049 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,050 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,051 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,054 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,056 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,057 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:37:57,058 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:37:57,060 - DEBUG - close.started
2025-06-17 12:37:57,061 - DEBUG - close.complete
2025-06-17 12:37:57,062 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:37:57,071 - INFO - Database connection closed
2025-06-17 12:37:57,071 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:57] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:37:57,092 - INFO - Connected to database
2025-06-17 12:37:58,361 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:37:58,382 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:37:58,386 - INFO - Database connection closed
2025-06-17 12:37:58,386 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:58] "GET / HTTP/1.1" 200 -
2025-06-17 12:37:58,410 - INFO - 127.0.0.1 - - [17/Jun/2025 12:37:58] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:42:40,860 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 12:42:41,103 - INFO -  * Restarting with stat
2025-06-17 12:42:42,411 - WARNING -  * Debugger is active!
2025-06-17 12:42:42,415 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:42:46,643 - INFO - 127.0.0.1 - - [17/Jun/2025 12:42:46] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:42:46,665 - INFO - 127.0.0.1 - - [17/Jun/2025 12:42:46] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:42:59,353 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 12:42:59,580 - INFO - Connected to database
2025-06-17 12:42:59,951 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 12:42:59,952 - INFO - Database connection closed
2025-06-17 12:42:59,953 - INFO - 127.0.0.1 - - [17/Jun/2025 12:42:59] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:42:59,969 - INFO - Connected to database
2025-06-17 12:43:01,894 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:01,954 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:43:01,958 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:43:03,054 - DEBUG - Loading model cost 1.098 seconds.
2025-06-17 12:43:03,054 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:43:03,071 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:03,085 - INFO - Database connection closed
2025-06-17 12:43:03,085 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:03] "GET / HTTP/1.1" 200 -
2025-06-17 12:43:03,130 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:03] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:43:07,607 - INFO - Connected to database
2025-06-17 12:43:09,006 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:09,031 - DEBUG - Extracting category from query: 'coupons for gucci store', words: ['coupons', 'for', 'gucci', 'store']
2025-06-17 12:43:09,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,032 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,032 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,033 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,033 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,033 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,034 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,035 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,037 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,038 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,038 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,039 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,039 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,039 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,039 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,039 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,040 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,041 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,042 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:09,044 - DEBUG - Ignoring word: 'store'
2025-06-17 12:43:09,044 - INFO - No category matched for query: coupons for gucci store
2025-06-17 12:43:09,049 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:43:09,093 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001E89BE23B60>
2025-06-17 12:43:09,094 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001E89BA86C30> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:43:09,153 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001E89BAFDD10>
2025-06-17 12:43:09,154 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:43:09,156 - DEBUG - send_request_headers.complete
2025-06-17 12:43:09,156 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:43:09,157 - DEBUG - send_request_body.complete
2025-06-17 12:43:09,158 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:43:09,458 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:13:09 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821820'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'76'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'd3c89c0245fa8f3aa0a2281ace676d2d'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=MbgqjnC9VGcS3BodhXF5Uf3Ol0G5JtrBkgM1iU4yVVM-1750144389-1.0.1.1-v.lcawZgT_zXhRPaxPatrqH1T2wzsiAF4q9nT55RAmicE.6kv9BwNjbbCwD5JdtDGNrEBOCg0mij6ea2Lbq5MYRkppb5Iubct268OKknyok; path=/; expires=Tue, 17-Jun-25 07:43:09 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=pXLl5h8IVgFHF0gArg3lIzyeCYa0vN1gsVhC8yNcjqU-1750144389399-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510be200e423b1f-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:43:09,461 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:43:09,462 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:43:09,464 - DEBUG - receive_response_body.complete
2025-06-17 12:43:09,466 - DEBUG - response_closed.started
2025-06-17 12:43:09,466 - DEBUG - response_closed.complete
2025-06-17 12:43:09,471 - DEBUG - Mistral location analysis: None
2025-06-17 12:43:09,472 - DEBUG - Location candidates: ['coupons for gucci store', 'coupons for gucci', 'coupons for', 'for gucci store', 'for gucci', 'gucci store']
2025-06-17 12:43:09,483 - INFO - No valid location matched for query: coupons for gucci store
2025-06-17 12:43:09,496 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:43:09,497 - DEBUG - send_request_headers.complete
2025-06-17 12:43:09,498 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:43:09,499 - DEBUG - send_request_body.complete
2025-06-17 12:43:09,499 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:43:10,077 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:13:09 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'76'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821721'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'76'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'f962375269181f1f89f9026983de756b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510be2239013b1f-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:43:10,079 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:43:10,080 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:43:10,081 - DEBUG - receive_response_body.complete
2025-06-17 12:43:10,082 - DEBUG - response_closed.started
2025-06-17 12:43:10,082 - DEBUG - response_closed.complete
2025-06-17 12:43:10,085 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:43:10,087 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 12:43:10,096 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:43:10,117 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 12:43:10,117 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 12:43:10,118 - DEBUG - Final: Query=coupons for gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 12:43:10,119 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 12:43:10,126 - DEBUG - Found 1 rows
2025-06-17 12:43:10,128 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:43:10,129 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 12:43:11,429 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:11,465 - DEBUG - Found area name: Shek O for selected_area: 33, table: hong_kong
2025-06-17 12:43:11,465 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:11,471 - DEBUG - close.started
2025-06-17 12:43:11,472 - DEBUG - close.complete
2025-06-17 12:43:11,472 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:11,477 - INFO - Database connection closed
2025-06-17 12:43:11,477 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:11] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:43:11,492 - INFO - Connected to database
2025-06-17 12:43:12,794 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:12,822 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:12,826 - INFO - Database connection closed
2025-06-17 12:43:12,827 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:12] "GET / HTTP/1.1" 200 -
2025-06-17 12:43:12,852 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:12] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:43:19,348 - INFO - Connected to database
2025-06-17 12:43:20,840 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:20,869 - DEBUG - Extracting category from query: 'give coupons for new territories', words: ['give', 'coupons', 'for', 'new', 'territories']
2025-06-17 12:43:20,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,876 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,876 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:43:20,877 - INFO - No category matched for query: give coupons for new territories
2025-06-17 12:43:20,881 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:43:20,909 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001E89BAFE0D0>
2025-06-17 12:43:20,910 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001E89BE61010> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:43:20,940 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001E89BB6CC30>
2025-06-17 12:43:20,941 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:43:20,941 - DEBUG - send_request_headers.complete
2025-06-17 12:43:20,942 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:43:20,943 - DEBUG - send_request_body.complete
2025-06-17 12:43:20,943 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:43:21,238 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:13:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'93'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499615'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821578'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'94'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'98a0287003c37455f15b9578d1669b6c'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=OcaKOr0jDXoCvBZ4AJTjeSWuwawWYFBba0VM6E2tTfw-1750144401-1.0.1.1-Xvk6Mo_1fSQIAq9eVSzdfa2rQKKkJlQRLvL4IUQMLKjWrtOtHEujOiTys.5uBkKNhSAx48q1OJFrCop53oQe0PRMXuNVUq5d3mdoO9fm3.A; path=/; expires=Tue, 17-Jun-25 07:43:21 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=VHOlbKZEPs3oabFdwN0Mw93zIpQk.nJj5pA0rClBGYM-1750144401181-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510be69bf17ff67-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:43:21,250 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:43:21,252 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:43:21,253 - DEBUG - receive_response_body.complete
2025-06-17 12:43:21,253 - DEBUG - response_closed.started
2025-06-17 12:43:21,254 - DEBUG - response_closed.complete
2025-06-17 12:43:21,261 - DEBUG - Mistral location analysis: None
2025-06-17 12:43:21,262 - DEBUG - Location candidates: ['give coupons for new', 'give coupons for', 'give coupons', 'coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 12:43:21,274 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 12:43:21,284 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:43:21,284 - DEBUG - send_request_headers.complete
2025-06-17 12:43:21,285 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:43:21,285 - DEBUG - send_request_body.complete
2025-06-17 12:43:21,285 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:43:21,562 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:13:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499516'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821479'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'b0917470bd50325780f3927a6ef6b705'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510be6bee4bff67-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:43:21,563 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:43:21,564 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:43:21,565 - DEBUG - receive_response_body.complete
2025-06-17 12:43:21,566 - DEBUG - response_closed.started
2025-06-17 12:43:21,568 - DEBUG - response_closed.complete
2025-06-17 12:43:21,572 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:43:21,573 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 12:43:21,581 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:43:21,616 - INFO - No coupon name matched for query: 'give coupons for new territories'
2025-06-17 12:43:21,617 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 12:43:21,618 - DEBUG - Final: Query=give coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 12:43:21,620 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,621 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,621 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 12:43:21,626 - DEBUG - Found 20 rows
2025-06-17 12:43:21,628 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,629 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,631 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,632 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,634 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,636 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,638 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,640 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,642 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,643 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,645 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,647 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,649 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,651 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,652 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,654 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,656 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,657 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,658 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,660 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:43:21,661 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 12:43:23,083 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:23,142 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 12:43:23,143 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:24,502 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:24,527 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 12:43:24,528 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:25,806 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:25,840 - DEBUG - Found area name: Lai King for selected_area: 25, table: new_territories
2025-06-17 12:43:25,841 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:27,104 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:27,128 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 12:43:27,128 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:28,446 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:28,486 - DEBUG - Found area name: Shatoujiao for selected_area: 26, table: new_territories
2025-06-17 12:43:28,487 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:29,707 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:29,731 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 12:43:29,732 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:30,883 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:30,910 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 12:43:30,910 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:32,329 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:32,374 - DEBUG - Found area name: Sha Tin for selected_area: 7, table: new_territories
2025-06-17 12:43:32,375 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:33,752 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:33,784 - DEBUG - Found area name: Kwai Chung for selected_area: 22, table: new_territories
2025-06-17 12:43:33,785 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:35,206 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:35,278 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 12:43:35,279 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:36,896 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:36,929 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 12:43:36,929 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:38,570 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:38,639 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 12:43:38,640 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:40,167 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:40,191 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 12:43:40,192 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:41,606 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:41,642 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 12:43:41,642 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:42,939 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:42,974 - DEBUG - Found area name: Tin Shui Wai for selected_area: 17, table: new_territories
2025-06-17 12:43:42,974 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:44,385 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:44,421 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 12:43:44,422 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:45,844 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:45,883 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 12:43:45,884 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:47,301 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:47,334 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 12:43:47,334 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:48,816 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:48,851 - DEBUG - Found area name: Tiu King Leng for selected_area: 29, table: new_territories
2025-06-17 12:43:48,851 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:50,226 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:50,256 - DEBUG - Found area name: Tseung Kwan O for selected_area: 4, table: new_territories
2025-06-17 12:43:50,256 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:50,261 - DEBUG - close.started
2025-06-17 12:43:50,262 - DEBUG - close.complete
2025-06-17 12:43:50,262 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:50,269 - INFO - Database connection closed
2025-06-17 12:43:50,270 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:50] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:43:50,293 - INFO - Connected to database
2025-06-17 12:43:51,889 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:43:51,918 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:43:51,922 - INFO - Database connection closed
2025-06-17 12:43:51,923 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:51] "GET / HTTP/1.1" 200 -
2025-06-17 12:43:51,942 - INFO - 127.0.0.1 - - [17/Jun/2025 12:43:51] "[33mGET /static/css/styles.css HTTP/1.1[0m" 404 -
2025-06-17 12:47:32,281 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\entity_extraction\\rules.py', reloading
2025-06-17 12:47:32,416 - INFO -  * Restarting with stat
2025-06-17 12:52:00,468 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 12:52:00,469 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 12:52:00,470 - INFO -  * Restarting with stat
2025-06-17 12:52:01,500 - WARNING -  * Debugger is active!
2025-06-17 12:52:01,503 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 12:52:05,389 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:05] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:52:05,408 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:05] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:52:14,351 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 12:52:14,521 - INFO - Connected to database
2025-06-17 12:52:14,836 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 12:52:14,839 - INFO - Database connection closed
2025-06-17 12:52:14,840 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:14] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:52:14,858 - INFO - Connected to database
2025-06-17 12:52:16,499 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:52:16,533 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 12:52:16,535 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 12:52:17,439 - DEBUG - Loading model cost 0.906 seconds.
2025-06-17 12:52:17,441 - DEBUG - Prefix dict has been built successfully.
2025-06-17 12:52:17,490 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:52:17,506 - INFO - Database connection closed
2025-06-17 12:52:17,507 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:17] "GET / HTTP/1.1" 200 -
2025-06-17 12:52:25,759 - INFO - Connected to database
2025-06-17 12:52:27,144 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:52:27,180 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 12:52:27,180 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,181 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,182 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,183 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,184 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,186 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,187 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,187 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,188 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,188 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,189 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,189 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,189 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,190 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,190 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,190 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,191 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,191 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,191 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,192 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,192 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,192 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:52:27,193 - INFO - No category matched for query: coupons for hong kong
2025-06-17 12:52:27,198 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:52:27,228 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029304FCFB60>
2025-06-17 12:52:27,229 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000029305005640> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:52:27,269 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002930513E990>
2025-06-17 12:52:27,271 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:52:27,273 - DEBUG - send_request_headers.complete
2025-06-17 12:52:27,273 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:52:27,274 - DEBUG - send_request_body.complete
2025-06-17 12:52:27,275 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:52:27,853 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:22:27 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'102'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821336'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'103'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'b85282198704372dfc45181e7191aa13'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=s26Xcn.TZNgV1j.76zwTYneXSiTIkGmVQn78vUiwvTk-1750144947-1.0.1.1-piJxqco4XZ_7hK9jMbUP_l89n3Ooe3RcKoCIU_ccnY07T1H0FahvL0XFJ5v5CWegXuQSRaIFrHRZyKr.hAFpdgILn3sDCiM2O5c5e5sKSMw; path=/; expires=Tue, 17-Jun-25 07:52:27 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=IPKIied5Pd8ucbzx8UADa_Azz9UsI.eo_dZf3GX9I1w-1750144947808-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510cbc04b6e3f6d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:52:27,856 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:52:27,856 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:52:27,857 - DEBUG - receive_response_body.complete
2025-06-17 12:52:27,858 - DEBUG - response_closed.started
2025-06-17 12:52:27,858 - DEBUG - response_closed.complete
2025-06-17 12:52:27,862 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 12:52:27,877 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:52:27,878 - DEBUG - send_request_headers.complete
2025-06-17 12:52:27,879 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:52:27,880 - DEBUG - send_request_body.complete
2025-06-17 12:52:27,881 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:52:28,180 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:22:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'91'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821238'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'92'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'7a0141459cfa984c80de1b70430ed97a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510cbc418823f6d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:52:28,182 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:52:28,183 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:52:28,183 - DEBUG - receive_response_body.complete
2025-06-17 12:52:28,184 - DEBUG - response_closed.started
2025-06-17 12:52:28,185 - DEBUG - response_closed.complete
2025-06-17 12:52:28,187 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:52:28,189 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 12:52:28,197 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:52:28,233 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 12:52:28,233 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 12:52:28,234 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 12:52:28,235 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,236 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,236 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 12:52:28,242 - DEBUG - Found 20 rows
2025-06-17 12:52:28,244 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,245 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,247 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,248 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,249 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,251 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,254 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,255 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,257 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,258 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,260 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,261 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,262 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,263 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,264 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,265 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,266 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,268 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,270 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,272 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 12:52:28,272 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 12:52:28,273 - DEBUG - close.started
2025-06-17 12:52:28,274 - DEBUG - close.complete
2025-06-17 12:52:28,275 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:52:28,283 - INFO - Database connection closed
2025-06-17 12:52:28,284 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:28] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:52:28,306 - INFO - Connected to database
2025-06-17 12:52:29,680 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:52:29,716 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:52:29,723 - INFO - Database connection closed
2025-06-17 12:52:29,723 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:29] "GET / HTTP/1.1" 200 -
2025-06-17 12:52:39,929 - INFO - Connected to database
2025-06-17 12:52:41,424 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:52:41,459 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:52:41,465 - INFO - Database connection closed
2025-06-17 12:52:41,466 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:41] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:52:41,473 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:41] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 12:52:41,483 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:41] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 12:52:51,010 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 12:52:51,023 - INFO - Connected to database
2025-06-17 12:52:51,453 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 12:52:51,455 - INFO - Database connection closed
2025-06-17 12:52:51,455 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:51] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 12:52:51,472 - INFO - Connected to database
2025-06-17 12:52:52,713 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:52:52,742 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:52:52,750 - INFO - Database connection closed
2025-06-17 12:52:52,750 - INFO - 127.0.0.1 - - [17/Jun/2025 12:52:52] "GET / HTTP/1.1" 200 -
2025-06-17 12:53:24,146 - INFO - Connected to database
2025-06-17 12:53:25,488 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:53:25,551 - DEBUG - Extracting category from query: 'give coupons for new territories', words: ['give', 'coupons', 'for', 'new', 'territories']
2025-06-17 12:53:25,556 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,563 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,565 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,565 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,566 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,567 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,567 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,568 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,568 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,568 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,569 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,569 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,570 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,570 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 12:53:25,576 - INFO - No category matched for query: give coupons for new territories
2025-06-17 12:53:25,581 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 12:53:25,638 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029304F334D0>
2025-06-17 12:53:25,640 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000293050952E0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 12:53:25,675 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029305146C40>
2025-06-17 12:53:25,677 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:53:25,678 - DEBUG - send_request_headers.complete
2025-06-17 12:53:25,678 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:53:25,679 - DEBUG - send_request_body.complete
2025-06-17 12:53:25,680 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:53:26,239 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:23:26 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'81'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499616'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998821095'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'82'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'5af7482aa5458a5cc9a7da579af21e69'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=3FN4uYueE5heRNqcZ08OyP4gNmoz5igIFuHkpaElZnQ-1750145006-1.0.1.1-XLqdagJzSamzZ0R0iWleJpdjUmIPJHU5G1YYq8ng.TDWqzPgA0ECqg3.Eohy3R3bHHiqibHEPt83LanevTyNmo0nNaLOyPF.PPbmLbXwsvI; path=/; expires=Tue, 17-Jun-25 07:53:26 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=YFlgp9pVT3k99uC_oLtaaeS7R3nXEzUn15yyi70gWWU-1750145006188-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510cd2d5dc2076e-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:53:26,241 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:53:26,242 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:53:26,243 - DEBUG - receive_response_body.complete
2025-06-17 12:53:26,244 - DEBUG - response_closed.started
2025-06-17 12:53:26,245 - DEBUG - response_closed.complete
2025-06-17 12:53:26,247 - DEBUG - Mistral location analysis: None
2025-06-17 12:53:26,248 - DEBUG - Location candidates: ['give coupons for new', 'give coupons for', 'give coupons', 'coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 12:53:26,264 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 12:53:26,276 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 12:53:26,277 - DEBUG - send_request_headers.complete
2025-06-17 12:53:26,278 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 12:53:26,279 - DEBUG - send_request_body.complete
2025-06-17 12:53:26,279 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 12:53:26,561 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 07:23:26 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499517'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998820996'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'5b6fad7d54b58c568d1da97d9f6dc825'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9510cd3119a1076e-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 12:53:26,563 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 12:53:26,564 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 12:53:26,565 - DEBUG - receive_response_body.complete
2025-06-17 12:53:26,565 - DEBUG - response_closed.started
2025-06-17 12:53:26,566 - DEBUG - response_closed.complete
2025-06-17 12:53:26,568 - DEBUG - Mistral coupon name analysis: None
2025-06-17 12:53:26,569 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 12:53:26,578 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 12:53:26,616 - INFO - No coupon name matched for query: 'give coupons for new territories'
2025-06-17 12:53:26,616 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 12:53:26,617 - DEBUG - Final: Query=give coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 12:53:26,619 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,620 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,621 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 12:53:26,627 - DEBUG - Found 20 rows
2025-06-17 12:53:26,629 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,631 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,633 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,635 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,637 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,640 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,643 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,645 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,648 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,650 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,652 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,654 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,657 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,660 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,663 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,665 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,667 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,668 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,670 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,673 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 12:53:26,673 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 12:53:26,675 - DEBUG - close.started
2025-06-17 12:53:26,677 - DEBUG - close.complete
2025-06-17 12:53:26,678 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:53:26,689 - INFO - Database connection closed
2025-06-17 12:53:26,690 - INFO - 127.0.0.1 - - [17/Jun/2025 12:53:26] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 12:53:26,721 - INFO - Connected to database
2025-06-17 12:53:28,158 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 12:53:28,190 - DEBUG - Using proactor: IocpProactor
2025-06-17 12:53:28,194 - INFO - Database connection closed
2025-06-17 12:53:28,195 - INFO - 127.0.0.1 - - [17/Jun/2025 12:53:28] "GET / HTTP/1.1" 200 -
2025-06-17 14:02:45,809 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 14:02:45,810 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 14:02:45,812 - INFO -  * Restarting with stat
2025-06-17 14:02:47,253 - WARNING -  * Debugger is active!
2025-06-17 14:02:47,257 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:02:50,477 - INFO - 127.0.0.1 - - [17/Jun/2025 14:02:50] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:02:50,517 - INFO - 127.0.0.1 - - [17/Jun/2025 14:02:50] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:03:01,390 - DEBUG - Login attempt: email=diya.dave1103@gmail.com, password=********
2025-06-17 14:03:01,759 - INFO - Connected to database
2025-06-17 14:03:01,761 - WARNING - Login failed: Invalid credentials for diya.dave1103@gmail.com
2025-06-17 14:03:01,771 - INFO - Database connection closed
2025-06-17 14:03:01,773 - INFO - 127.0.0.1 - - [17/Jun/2025 14:03:01] "POST /login HTTP/1.1" 200 -
2025-06-17 14:03:08,382 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:03:08,416 - INFO - Connected to database
2025-06-17 14:03:09,016 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:03:09,018 - INFO - Database connection closed
2025-06-17 14:03:09,018 - INFO - 127.0.0.1 - - [17/Jun/2025 14:03:09] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:03:09,036 - INFO - Connected to database
2025-06-17 14:03:11,128 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:03:11,196 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:03:11,206 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:03:12,468 - DEBUG - Loading model cost 1.264 seconds.
2025-06-17 14:03:12,469 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:03:12,482 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:03:12,510 - INFO - Database connection closed
2025-06-17 14:03:12,511 - INFO - 127.0.0.1 - - [17/Jun/2025 14:03:12] "GET / HTTP/1.1" 200 -
2025-06-17 14:03:20,471 - INFO - Connected to database
2025-06-17 14:03:22,084 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:03:22,129 - DEBUG - Extracting category from query: 'coupons for gucci store', words: ['coupons', 'for', 'gucci', 'store']
2025-06-17 14:03:22,129 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,130 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,131 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,131 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,132 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,132 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,133 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,133 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,133 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,133 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,133 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,134 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,134 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,134 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,134 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,135 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,136 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,136 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,137 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,137 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,138 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,138 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,139 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,139 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,139 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,140 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,140 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,141 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,142 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,143 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,144 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,144 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,146 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,146 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,146 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,146 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,147 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,147 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,147 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,148 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,149 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,149 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,150 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,150 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,151 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,151 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,152 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,152 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,153 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,153 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,153 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,154 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,154 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,154 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,155 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:03:22,155 - DEBUG - Ignoring word: 'store'
2025-06-17 14:03:22,156 - INFO - No category matched for query: coupons for gucci store
2025-06-17 14:03:22,168 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:03:22,217 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000018F3299FB60>
2025-06-17 14:03:22,217 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000018F329D5010> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:03:22,249 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000018F32B0E850>
2025-06-17 14:03:22,250 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:03:22,251 - DEBUG - send_request_headers.complete
2025-06-17 14:03:22,251 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:03:22,252 - DEBUG - send_request_body.complete
2025-06-17 14:03:22,252 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:03:22,538 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:33:22 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'80'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998819446'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'81'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'c7fb655618b7c9090c38a864cbf6f555'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=WjTa1tRNJl1OYxH0Dwwh2RlgHsHun6K0r5APs8gXuMI-1750149202-1.0.1.1-r6rkgAWa425U.ptpRABZasBc_bLLy7wnujNTZuu1NzK8jtKb13CBZkTqaBx09g5dZfpIV4Tgzh5sH25Qn6tGX69MMedJQhFQ9OhvWwGLLbk; path=/; expires=Tue, 17-Jun-25 09:03:22 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=9wPpNcQynTBk4.r6Pj_jA4kq43WItMHORxb2sKiR14E-1750149202474-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951133a1cab885d9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:03:22,544 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:03:22,545 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:03:22,546 - DEBUG - receive_response_body.complete
2025-06-17 14:03:22,546 - DEBUG - response_closed.started
2025-06-17 14:03:22,547 - DEBUG - response_closed.complete
2025-06-17 14:03:22,549 - DEBUG - Mistral location analysis: None
2025-06-17 14:03:22,550 - DEBUG - Location candidates: ['coupons for gucci store', 'coupons for gucci', 'coupons for', 'for gucci store', 'for gucci', 'gucci store']
2025-06-17 14:03:22,563 - INFO - No valid location matched for query: coupons for gucci store
2025-06-17 14:03:22,572 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:03:22,573 - DEBUG - send_request_headers.complete
2025-06-17 14:03:22,574 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:03:22,578 - DEBUG - send_request_body.complete
2025-06-17 14:03:22,579 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:03:22,864 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:33:22 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998819347'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'0d6d4b6d2a39396ff0387000b885ed6a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951133a3dd8b85d9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:03:22,865 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:03:22,866 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:03:22,867 - DEBUG - receive_response_body.complete
2025-06-17 14:03:22,868 - DEBUG - response_closed.started
2025-06-17 14:03:22,868 - DEBUG - response_closed.complete
2025-06-17 14:03:22,871 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:03:22,873 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 14:03:22,882 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:03:22,904 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 14:03:22,905 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 14:03:22,906 - DEBUG - Final: Query=coupons for gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 14:03:22,907 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 14:03:22,916 - DEBUG - Found 1 rows
2025-06-17 14:03:22,918 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:03:22,919 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 14:03:22,921 - DEBUG - close.started
2025-06-17 14:03:22,922 - DEBUG - close.complete
2025-06-17 14:03:22,923 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:03:22,938 - INFO - Database connection closed
2025-06-17 14:03:22,939 - INFO - 127.0.0.1 - - [17/Jun/2025 14:03:22] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:03:22,958 - INFO - Connected to database
2025-06-17 14:03:24,564 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:03:24,955 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:03:24,964 - INFO - Database connection closed
2025-06-17 14:03:24,964 - INFO - 127.0.0.1 - - [17/Jun/2025 14:03:24] "GET / HTTP/1.1" 200 -
2025-06-17 14:04:53,899 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:04:54,100 - INFO -  * Restarting with stat
2025-06-17 14:07:58,726 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 14:07:58,727 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 14:07:58,729 - INFO -  * Restarting with stat
2025-06-17 14:08:00,349 - WARNING -  * Debugger is active!
2025-06-17 14:08:00,354 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:08:02,629 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:02] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:08:02,648 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:02] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:08:09,857 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:08:10,253 - INFO - Connected to database
2025-06-17 14:08:10,889 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:08:10,892 - INFO - Database connection closed
2025-06-17 14:08:10,892 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:10] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:08:10,910 - INFO - Connected to database
2025-06-17 14:08:13,133 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:08:13,170 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:08:13,172 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:08:14,882 - DEBUG - Loading model cost 1.712 seconds.
2025-06-17 14:08:14,883 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:08:14,896 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:08:14,919 - INFO - Database connection closed
2025-06-17 14:08:14,920 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:14] "GET / HTTP/1.1" 200 -
2025-06-17 14:08:24,613 - INFO - Connected to database
2025-06-17 14:08:26,522 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:08:26,571 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 14:08:26,571 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,571 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,572 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,573 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,574 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,574 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,582 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,582 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,583 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,583 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,584 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,584 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,586 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,586 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,587 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,588 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,588 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,589 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,589 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,589 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,590 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:08:26,591 - INFO - No category matched for query: coupons for hong kong
2025-06-17 14:08:26,605 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:08:26,715 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013D99B3FB60>
2025-06-17 14:08:26,716 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000013D99B75400> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:08:26,753 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000013D99CAE990>
2025-06-17 14:08:26,754 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:08:26,755 - DEBUG - send_request_headers.complete
2025-06-17 14:08:26,755 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:08:26,756 - DEBUG - send_request_body.complete
2025-06-17 14:08:26,756 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:08:27,086 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:38:27 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'102'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998819204'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'103'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'e1c9195446d9535e01cc850670c55053'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=jM1LRwWhizGQk5YqHh_CkRqWeGR22yISgHPXpnaAfbc-1750149507-1.0.1.1-a9t5Aq_cORGhhBf0VW9wHNMpbd5kNJbP0pBcq480Tj1oBJhUKNvb9hqDr0npEckdb97F4M7fFdTt8WoCTt0XNOSd5EL1PZGrxx.3uU8tkbg; path=/; expires=Tue, 17-Jun-25 09:08:27 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=xvGKT0tXdwL_klALKNd.1s2nZCL5sIOW2wEwXH2cOqU-1750149507015-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95113b10fa813b22-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:08:27,089 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:08:27,090 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:08:27,091 - DEBUG - receive_response_body.complete
2025-06-17 14:08:27,095 - DEBUG - response_closed.started
2025-06-17 14:08:27,097 - DEBUG - response_closed.complete
2025-06-17 14:08:27,103 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 14:08:27,116 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:08:27,117 - DEBUG - send_request_headers.complete
2025-06-17 14:08:27,118 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:08:27,119 - DEBUG - send_request_body.complete
2025-06-17 14:08:27,119 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:08:27,395 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:38:27 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'76'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998819106'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'585499156f832a36a2a2327f0583f36c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95113b133d6b3b22-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:08:27,396 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:08:27,397 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:08:27,398 - DEBUG - receive_response_body.complete
2025-06-17 14:08:27,398 - DEBUG - response_closed.started
2025-06-17 14:08:27,399 - DEBUG - response_closed.complete
2025-06-17 14:08:27,401 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:08:27,404 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 14:08:27,414 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:08:27,443 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 14:08:27,445 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 14:08:27,447 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 14:08:27,449 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,449 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,450 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:08:27,453 - DEBUG - Found 20 rows
2025-06-17 14:08:27,454 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,456 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,457 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,458 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,460 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,463 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,466 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,467 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,468 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,469 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,470 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,471 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,472 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,473 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,474 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,475 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,476 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,479 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,481 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,483 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:08:27,483 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 14:08:27,484 - DEBUG - close.started
2025-06-17 14:08:27,485 - DEBUG - close.complete
2025-06-17 14:08:27,486 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:08:27,495 - INFO - Database connection closed
2025-06-17 14:08:27,497 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:27] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:08:27,518 - INFO - Connected to database
2025-06-17 14:08:29,324 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:08:29,365 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:08:29,370 - INFO - Database connection closed
2025-06-17 14:08:29,370 - INFO - 127.0.0.1 - - [17/Jun/2025 14:08:29] "GET / HTTP/1.1" 200 -
2025-06-17 14:11:41,818 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:11:42,874 - INFO -  * Restarting with stat
2025-06-17 14:11:44,980 - WARNING -  * Debugger is active!
2025-06-17 14:11:44,988 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:11:47,961 - INFO - 127.0.0.1 - - [17/Jun/2025 14:11:47] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:11:47,981 - INFO - 127.0.0.1 - - [17/Jun/2025 14:11:47] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:11:55,331 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:11:55,646 - INFO - Connected to database
2025-06-17 14:11:56,247 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:11:56,250 - INFO - Database connection closed
2025-06-17 14:11:56,250 - INFO - 127.0.0.1 - - [17/Jun/2025 14:11:56] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:11:56,272 - INFO - Connected to database
2025-06-17 14:11:58,179 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:11:58,244 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:11:58,246 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:11:59,952 - DEBUG - Loading model cost 1.707 seconds.
2025-06-17 14:11:59,953 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:11:59,968 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:11:59,990 - INFO - Database connection closed
2025-06-17 14:11:59,992 - INFO - 127.0.0.1 - - [17/Jun/2025 14:11:59] "GET / HTTP/1.1" 200 -
2025-06-17 14:12:05,168 - INFO - Connected to database
2025-06-17 14:12:07,212 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:12:07,255 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 14:12:07,256 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,256 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,257 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,257 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,258 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,258 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,259 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,259 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,260 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,260 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,261 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,261 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,261 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,261 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,261 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,262 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,262 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,263 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,265 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,265 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,267 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,268 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,268 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,269 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,269 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,270 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,270 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,270 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:07,270 - INFO - No category matched for query: coupons for hong kong
2025-06-17 14:12:07,278 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:12:07,322 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A291767B60>
2025-06-17 14:12:07,323 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001A2917A1520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:12:07,374 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A2918D2AD0>
2025-06-17 14:12:07,374 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:12:07,375 - DEBUG - send_request_headers.complete
2025-06-17 14:12:07,376 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:12:07,376 - DEBUG - send_request_body.complete
2025-06-17 14:12:07,377 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:12:07,691 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:42:07 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'97'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818963'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'98'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'2bff3878b0a61b409153c33d3ebef47b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=OXRxqodm_D8sT3LvXB6HdG4PVnsHADVFsqaURksGCzA-1750149727-1.0.1.1-sX4OsOrXffIcslQ6joojBuGTPdlNBQIJAEwycyZicDR.rtegKObuffAgdfd86LaOv92sFbUN05rCCBd.X3fSKguEgxZ_62QZ0HDRO9RVV_Q; path=/; expires=Tue, 17-Jun-25 09:12:07 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=28MgT4P6K6H7mf1TFZHQ8RiD2D.smClZ5kGZrs8VU5o-1750149727624-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95114073e89c46f0-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:12:07,693 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:12:07,694 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:12:07,695 - DEBUG - receive_response_body.complete
2025-06-17 14:12:07,695 - DEBUG - response_closed.started
2025-06-17 14:12:07,696 - DEBUG - response_closed.complete
2025-06-17 14:12:07,699 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 14:12:07,709 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:12:07,711 - DEBUG - send_request_headers.complete
2025-06-17 14:12:07,711 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:12:07,712 - DEBUG - send_request_body.complete
2025-06-17 14:12:07,712 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:12:08,149 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:42:08 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'238'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818865'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'239'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'08e2604315125918a5305553a0cbd113'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95114075fb3a46f0-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:12:08,151 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:12:08,151 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:12:08,152 - DEBUG - receive_response_body.complete
2025-06-17 14:12:08,152 - DEBUG - response_closed.started
2025-06-17 14:12:08,153 - DEBUG - response_closed.complete
2025-06-17 14:12:08,155 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:12:08,159 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 14:12:08,217 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:12:08,322 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 14:12:08,323 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 14:12:08,323 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 14:12:08,325 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,325 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,326 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:12:08,330 - DEBUG - Found 20 rows
2025-06-17 14:12:08,333 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,334 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,336 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,338 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,340 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,341 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,342 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,343 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,344 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,345 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,347 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,350 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,352 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,353 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,355 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,356 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,357 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,358 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,359 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,360 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:12:08,361 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 14:12:08,361 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,417 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,418 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,418 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,419 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,421 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,422 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,422 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,423 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,424 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,425 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,425 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,425 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,427 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,427 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,427 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,428 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,430 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,432 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,433 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,433 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,435 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,436 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,436 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,437 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,438 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,439 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,439 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,439 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,440 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,441 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,441 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,442 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,444 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,444 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,444 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,444 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,446 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,451 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,452 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,453 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,455 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,455 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,455 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,456 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,457 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,457 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,458 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,458 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,459 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,460 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,460 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,461 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,462 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,462 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,464 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,465 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,467 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,468 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,468 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,469 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,470 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,471 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,471 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,472 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,473 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,474 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,474 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,474 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,476 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,476 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,477 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,478 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,479 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,482 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,482 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,484 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:12:08,486 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:12:08,487 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:12:08,487 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:12:08,488 - DEBUG - close.started
2025-06-17 14:12:08,489 - DEBUG - close.complete
2025-06-17 14:12:08,489 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:12:08,499 - INFO - Database connection closed
2025-06-17 14:12:08,513 - INFO - 127.0.0.1 - - [17/Jun/2025 14:12:08] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:12:08,874 - INFO - Connected to database
2025-06-17 14:12:11,576 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:12:11,621 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:12:11,627 - INFO - Database connection closed
2025-06-17 14:12:11,627 - INFO - 127.0.0.1 - - [17/Jun/2025 14:12:11] "GET / HTTP/1.1" 200 -
2025-06-17 14:12:22,751 - INFO - Connected to database
2025-06-17 14:12:24,572 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:12:24,617 - DEBUG - Extracting category from query: 'give coupons for new territories', words: ['give', 'coupons', 'for', 'new', 'territories']
2025-06-17 14:12:24,618 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,618 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,618 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,619 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,619 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,619 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,620 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,621 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,621 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,621 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,622 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,622 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,622 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,623 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,623 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,623 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,624 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,624 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,625 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,625 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,626 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,628 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,632 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,632 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,633 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,633 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,633 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,633 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:12:24,634 - INFO - No category matched for query: give coupons for new territories
2025-06-17 14:12:24,640 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:12:24,677 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A2916CF610>
2025-06-17 14:12:24,680 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001A2917A1520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:12:24,709 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A2916DF490>
2025-06-17 14:12:24,714 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:12:24,715 - DEBUG - send_request_headers.complete
2025-06-17 14:12:24,715 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:12:24,716 - DEBUG - send_request_body.complete
2025-06-17 14:12:24,716 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:12:25,004 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:42:24 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'97'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499616'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818722'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'98'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'ea058000877cc72d942d9b733cb8ff57'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=NuextzEVI7zdCHNfSflkBIsWHD9bJJl4Xw_qF8Nr4gU-1750149744-1.0.1.1-Q3S7vRs_qhG5gXREt.RuZSD0kA00WPUk.51RsusTwdluOZ6E9DY8wr1Y_5NfTXVwppm_qQGYvfYcD0TMTDgo8h9nVV3LbFDszamPXa2PFZs; path=/; expires=Tue, 17-Jun-25 09:12:24 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=X04T4rL9QbG04pjpCr5uoQZT2jRgBqB6nMoTOLe7MGQ-1750149744948-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951140e03a1e0027-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:12:25,005 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:12:25,006 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:12:25,007 - DEBUG - receive_response_body.complete
2025-06-17 14:12:25,008 - DEBUG - response_closed.started
2025-06-17 14:12:25,009 - DEBUG - response_closed.complete
2025-06-17 14:12:25,013 - DEBUG - Mistral location analysis: None
2025-06-17 14:12:25,016 - DEBUG - Location candidates: ['give coupons for new', 'give coupons for', 'give coupons', 'coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 14:12:25,033 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 14:12:25,045 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:12:25,048 - DEBUG - send_request_headers.complete
2025-06-17 14:12:25,048 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:12:25,049 - DEBUG - send_request_body.complete
2025-06-17 14:12:25,049 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:12:25,331 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:42:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'96'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499517'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818623'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'97'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'ade8bc5cbc9d4c1ebcb4df22e89b7077'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951140e2490b0027-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:12:25,332 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:12:25,335 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:12:25,338 - DEBUG - receive_response_body.complete
2025-06-17 14:12:25,342 - DEBUG - response_closed.started
2025-06-17 14:12:25,347 - DEBUG - response_closed.complete
2025-06-17 14:12:25,353 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:12:25,357 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 14:12:25,364 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:12:25,397 - INFO - No coupon name matched for query: 'give coupons for new territories'
2025-06-17 14:12:25,397 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 14:12:25,398 - DEBUG - Final: Query=give coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 14:12:25,399 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,400 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,400 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 14:12:25,403 - DEBUG - Found 20 rows
2025-06-17 14:12:25,404 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,405 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,406 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,407 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,408 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,409 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,411 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,412 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,414 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,415 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,416 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,417 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,422 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,425 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,427 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,431 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,434 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,435 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,437 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,438 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:12:25,438 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 14:12:25,439 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,441 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:12:25,441 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,441 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,442 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,443 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:12:25,444 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,446 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,446 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,449 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 14:12:25,449 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,450 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,450 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,452 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:12:25,452 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,452 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,453 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,455 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:12:25,455 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,456 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,456 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,458 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:12:25,458 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,459 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,461 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,464 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:12:25,464 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,464 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,465 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,467 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:12:25,467 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,467 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,468 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,469 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:12:25,470 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,470 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,471 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,473 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:12:25,473 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,473 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,474 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,475 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:12:25,476 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,477 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,477 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,479 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:12:25,480 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,481 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,481 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,483 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:12:25,484 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,484 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,485 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,487 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:12:25,488 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,488 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,488 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,490 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:12:25,491 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,492 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,492 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,497 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:12:25,498 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,498 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,499 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,501 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:12:25,501 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,502 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,502 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,504 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:12:25,505 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,505 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,506 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,509 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:12:25,513 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,514 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,515 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:12:25,517 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:12:25,517 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:12:25,518 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:12:25,519 - DEBUG - close.started
2025-06-17 14:12:25,521 - DEBUG - close.complete
2025-06-17 14:12:25,521 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:12:25,533 - INFO - Database connection closed
2025-06-17 14:12:25,533 - INFO - 127.0.0.1 - - [17/Jun/2025 14:12:25] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:12:25,558 - INFO - Connected to database
2025-06-17 14:12:27,257 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:12:27,500 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:12:27,506 - INFO - Database connection closed
2025-06-17 14:12:27,506 - INFO - 127.0.0.1 - - [17/Jun/2025 14:12:27] "GET / HTTP/1.1" 200 -
2025-06-17 14:15:48,200 - INFO - Connected to database
2025-06-17 14:15:50,339 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:15:50,386 - DEBUG - Extracting category from query: 'coupons for gucci store', words: ['coupons', 'for', 'gucci', 'store']
2025-06-17 14:15:50,386 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,387 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,387 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,389 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,389 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,389 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,389 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,390 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,390 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,390 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,390 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,391 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,391 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,391 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,392 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,392 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,393 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,393 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,394 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,394 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,394 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,395 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,395 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,396 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,396 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,396 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,397 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,397 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,398 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,399 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,399 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,401 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,401 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,403 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,404 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,405 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,405 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,405 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,405 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,406 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,406 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,407 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,407 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,408 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,409 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,410 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,411 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,411 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:15:50,411 - DEBUG - Ignoring word: 'store'
2025-06-17 14:15:50,412 - INFO - No category matched for query: coupons for gucci store
2025-06-17 14:15:50,423 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:15:50,460 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A2918E8510>
2025-06-17 14:15:50,461 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001A2917A1520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:15:50,495 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001A29508DEB0>
2025-06-17 14:15:50,496 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:15:50,497 - DEBUG - send_request_headers.complete
2025-06-17 14:15:50,497 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:15:50,497 - DEBUG - send_request_body.complete
2025-06-17 14:15:50,498 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:15:50,798 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:45:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'84'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818480'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'85'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'5e8ea21875e9961ccbeadc2e6077593a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=zjdXV9194vMyIalc6uWNmxtBT.qJT_1B2YeB4ByrTjA-1750149950-1.0.1.1-ITXf9UMRwIDKPPxcoHqL9Vb.VGzN4aRgzPVbnWLbXNlBEtDiztDy9ijqHXTCi.Q2MUaMz2YrqWaFftAi8oMOfl8Y.zj4RLGmyd3UzcxCbG0; path=/; expires=Tue, 17-Jun-25 09:15:50 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=S95Pt3Si2mnOFcLDnau6seXKbQ7XGPdWLyC2MCUunoI-1750149950733-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951145e65c444841-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:15:50,801 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:15:50,802 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:15:50,803 - DEBUG - receive_response_body.complete
2025-06-17 14:15:50,803 - DEBUG - response_closed.started
2025-06-17 14:15:50,804 - DEBUG - response_closed.complete
2025-06-17 14:15:50,809 - DEBUG - Mistral location analysis: None
2025-06-17 14:15:50,816 - DEBUG - Location candidates: ['coupons for gucci store', 'coupons for gucci', 'coupons for', 'for gucci store', 'for gucci', 'gucci store']
2025-06-17 14:15:50,828 - INFO - No valid location matched for query: coupons for gucci store
2025-06-17 14:15:50,840 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:15:50,841 - DEBUG - send_request_headers.complete
2025-06-17 14:15:50,842 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:15:50,843 - DEBUG - send_request_body.complete
2025-06-17 14:15:50,844 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:15:51,134 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:45:51 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'89'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818381'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'90'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'1e8d3265317b8814bf18bb7b935cb03b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951145e88f654841-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:15:51,136 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:15:51,137 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:15:51,138 - DEBUG - receive_response_body.complete
2025-06-17 14:15:51,139 - DEBUG - response_closed.started
2025-06-17 14:15:51,139 - DEBUG - response_closed.complete
2025-06-17 14:15:51,141 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:15:51,142 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 14:15:51,154 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:15:51,176 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 14:15:51,177 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 14:15:51,178 - DEBUG - Final: Query=coupons for gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 14:15:51,179 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 14:15:51,183 - DEBUG - Found 1 rows
2025-06-17 14:15:51,185 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:15:51,187 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 14:15:51,188 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:15:51,190 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:15:51,190 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:15:51,191 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:15:51,192 - DEBUG - close.started
2025-06-17 14:15:51,192 - DEBUG - close.complete
2025-06-17 14:15:51,193 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:15:51,206 - INFO - Database connection closed
2025-06-17 14:15:51,207 - INFO - 127.0.0.1 - - [17/Jun/2025 14:15:51] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:15:51,234 - INFO - Connected to database
2025-06-17 14:15:52,847 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:15:52,892 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:15:52,903 - INFO - Database connection closed
2025-06-17 14:15:52,906 - INFO - 127.0.0.1 - - [17/Jun/2025 14:15:52] "GET / HTTP/1.1" 200 -
2025-06-17 14:16:37,487 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:16:38,263 - INFO -  * Restarting with stat
2025-06-17 14:16:40,089 - WARNING -  * Debugger is active!
2025-06-17 14:16:40,095 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:16:40,765 - INFO - 127.0.0.1 - - [17/Jun/2025 14:16:40] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:16:40,783 - INFO - 127.0.0.1 - - [17/Jun/2025 14:16:40] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:16:47,638 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:16:47,949 - INFO - Connected to database
2025-06-17 14:16:48,628 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:16:48,630 - INFO - Database connection closed
2025-06-17 14:16:48,630 - INFO - 127.0.0.1 - - [17/Jun/2025 14:16:48] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:16:48,652 - INFO - Connected to database
2025-06-17 14:16:51,158 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:16:51,194 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:16:51,195 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:16:52,889 - DEBUG - Loading model cost 1.695 seconds.
2025-06-17 14:16:52,891 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:16:52,891 - DEBUG - Rendering index with 0 messages
2025-06-17 14:16:52,900 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:16:52,916 - INFO - Database connection closed
2025-06-17 14:16:52,917 - INFO - 127.0.0.1 - - [17/Jun/2025 14:16:52] "GET / HTTP/1.1" 200 -
2025-06-17 14:16:56,432 - INFO - Connected to database
2025-06-17 14:16:58,500 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:16:58,544 - DEBUG - Session messages after trim: 0 messages
2025-06-17 14:16:58,546 - DEBUG - Extracting category from query: 'coupons for kowloon', words: ['coupons', 'for', 'kowloon']
2025-06-17 14:16:58,547 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,548 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,548 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,549 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,549 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,550 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,550 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,551 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,553 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,555 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,556 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,556 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,557 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,557 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:16:58,563 - INFO - No category matched for query: coupons for kowloon
2025-06-17 14:16:58,573 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:16:58,603 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028927897B60>
2025-06-17 14:16:58,605 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000028927466D50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:16:58,640 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000289279EAAD0>
2025-06-17 14:16:58,641 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:16:58,643 - DEBUG - send_request_headers.complete
2025-06-17 14:16:58,643 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:16:58,643 - DEBUG - send_request_body.complete
2025-06-17 14:16:58,643 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:16:58,941 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:46:58 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'81'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818237'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'82'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'063f6565216509612f37031386f0ea13'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=7GqxfZHPb3cOUtptqMTMyvuI0u6R3uRDxQE5ziMyVhM-1750150018-1.0.1.1-A2z51VbS0tLL.TClIjJvZq7lq.RccE759tp44dDZUGAIy6uPmNTQYOQJWItWI2_ovHGl8M88dN8I.sDM3i3R6Vm8VZcpVjMXCWvU43eQkvg; path=/; expires=Tue, 17-Jun-25 09:16:58 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=eF3GQJWpb5WHBxmv7DextPLsVMWJLp3gILAltopmAr0-1750150018868-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951147904d2e47c2-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:16:58,945 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:16:58,946 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:16:58,949 - DEBUG - receive_response_body.complete
2025-06-17 14:16:58,950 - DEBUG - response_closed.started
2025-06-17 14:16:58,951 - DEBUG - response_closed.complete
2025-06-17 14:16:58,957 - DEBUG - Mistral location analysis: None
2025-06-17 14:16:58,958 - DEBUG - Location candidates: ['coupons for kowloon', 'coupons for', 'for kowloon', 'kowloon']
2025-06-17 14:16:58,966 - INFO - Normalized area match: 'kowloon' -> 'Kowloon'
2025-06-17 14:16:58,978 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:16:58,979 - DEBUG - send_request_headers.complete
2025-06-17 14:16:58,980 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:16:58,981 - DEBUG - send_request_body.complete
2025-06-17 14:16:58,981 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:16:59,262 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:46:59 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499756'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998818137'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'87350034d4f64f46be8fbb1f82173d22'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951147926fc447c2-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:16:59,263 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:16:59,263 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:16:59,264 - DEBUG - receive_response_body.complete
2025-06-17 14:16:59,265 - DEBUG - response_closed.started
2025-06-17 14:16:59,266 - DEBUG - response_closed.complete
2025-06-17 14:16:59,268 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:16:59,271 - DEBUG - Cleaned query: 'coupons kowloon'
2025-06-17 14:16:59,278 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:16:59,295 - INFO - No coupon name matched for query: 'coupons for kowloon'
2025-06-17 14:16:59,296 - DEBUG - Extracted: Category=None, Location={'name': 'Kowloon', 'type': 'area', 'id': '2'}, Discount=None, Coupon Name=None
2025-06-17 14:16:59,296 - DEBUG - Final: Query=coupons for kowloon, Category=None, Location={'name': 'Kowloon', 'type': 'area', 'id': '2'}, Coupon Name=None, Discount=None
2025-06-17 14:16:59,299 - DEBUG - Valid selected_area IDs for area 2: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,299 - DEBUG - Searching coupons with area: 2, selected_areas: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,300 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['2', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', 20]
2025-06-17 14:16:59,307 - DEBUG - Found 20 rows
2025-06-17 14:16:59,319 - DEBUG - Valid area IDs for coupon ID 1265 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,330 - DEBUG - Valid area IDs for coupon ID 1261 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,340 - DEBUG - Valid area IDs for coupon ID 1260 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,442 - DEBUG - Valid area IDs for coupon ID 1259 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,449 - DEBUG - Valid area IDs for coupon ID 1258 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,458 - DEBUG - Valid area IDs for coupon ID 1245 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,553 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,563 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,568 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,574 - DEBUG - Valid area IDs for coupon ID 1226 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,671 - DEBUG - Valid area IDs for coupon ID 1223 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,674 - DEBUG - Valid area IDs for coupon ID 1200 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,676 - DEBUG - Valid area IDs for coupon ID 1190 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,677 - DEBUG - Valid area IDs for coupon ID 1169 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,679 - DEBUG - Valid area IDs for coupon ID 1166 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,681 - DEBUG - Valid area IDs for coupon ID 1162 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,683 - DEBUG - Valid area IDs for coupon ID 1161 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,690 - DEBUG - Valid area IDs for coupon ID 1159 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,692 - DEBUG - Valid area IDs for coupon ID 1158 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,795 - DEBUG - Valid area IDs for coupon ID 1157 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:16:59,799 - DEBUG - Returning 20 coupons for category 'None', location 'Kowloon'
2025-06-17 14:16:59,805 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,811 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,811 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,812 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,813 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,815 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,815 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,816 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,816 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,819 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,822 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,823 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,824 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,826 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,827 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,827 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,828 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,830 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,830 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,831 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,831 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,832 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,833 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,833 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,834 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,839 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:16:59,847 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:16:59,858 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:16:59,862 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:16:59,870 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:16:59,877 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,065 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,074 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,081 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:17:00,082 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,083 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,087 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,089 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:17:00,090 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,090 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,091 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,097 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:17:00,100 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,105 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,108 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,127 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:17:00,127 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,128 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,131 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,212 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:17:00,213 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,213 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,213 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,215 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:17:00,215 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,216 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,216 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,224 - DEBUG - Resolved selected_area 29 to Yau Ma Tei via kowloon table
2025-06-17 14:17:00,229 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,230 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,231 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,232 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:00,233 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,233 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,234 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,237 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:17:00,238 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,238 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,250 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,330 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:17:00,354 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,355 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,355 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,358 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:00,364 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,365 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,365 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:17:00,367 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:00,370 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:00,371 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:00,372 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:17:00,373 - DEBUG - close.started
2025-06-17 14:17:00,374 - DEBUG - close.complete
2025-06-17 14:17:00,390 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:17:00,401 - INFO - Database connection closed
2025-06-17 14:17:00,403 - INFO - 127.0.0.1 - - [17/Jun/2025 14:17:00] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:17:00,425 - INFO - Connected to database
2025-06-17 14:17:02,444 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:17:02,487 - DEBUG - Rendering index with 2 messages
2025-06-17 14:17:02,491 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:17:02,499 - INFO - Database connection closed
2025-06-17 14:17:02,499 - INFO - 127.0.0.1 - - [17/Jun/2025 14:17:02] "GET / HTTP/1.1" 200 -
2025-06-17 14:17:19,081 - INFO - Connected to database
2025-06-17 14:17:21,021 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:17:21,071 - DEBUG - Session messages after trim: 2 messages
2025-06-17 14:17:21,073 - DEBUG - Extracting category from query: 'coupons for kwuntong', words: ['coupons', 'for', 'kwuntong']
2025-06-17 14:17:21,073 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,074 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,074 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,075 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,075 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,076 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,077 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,077 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,078 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,078 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,078 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,079 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,079 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,079 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,079 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,080 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,080 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,081 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,081 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,081 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,083 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,085 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,085 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,085 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,086 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,086 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,086 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,087 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:17:21,087 - INFO - No category matched for query: coupons for kwuntong
2025-06-17 14:17:21,095 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:17:21,176 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000289277FF610>
2025-06-17 14:17:21,176 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000289278CD130> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:17:21,221 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028927813490>
2025-06-17 14:17:21,222 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:17:21,222 - DEBUG - send_request_headers.complete
2025-06-17 14:17:21,223 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:17:21,223 - DEBUG - send_request_body.complete
2025-06-17 14:17:21,224 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:17:21,538 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:47:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'87'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499613'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817994'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'88'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'3090a0241ce79f3c5844e60a199c684d'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=W886lFh0akv8t80FnHvlaDFzR1rGKwASyTmdoWAinrQ-1750150041-1.0.1.1-VoSZD8s2amIi_5xfCqhUUt6PdA2vHARmXYRey8tbC3ruuMgqF6qcCwsbHaALfLkMuCLoxeZxSmOt6yW5b6s.yKrw11CM0Z2ARA7WRbqbMIE; path=/; expires=Tue, 17-Jun-25 09:17:21 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=YUKAulsy5fCzhZuUIgfkKz3vY7vuVHn_bmhKV3tsfvc-1750150041472-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511481d6e543b0d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:17:21,539 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:17:21,539 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:17:21,540 - DEBUG - receive_response_body.complete
2025-06-17 14:17:21,541 - DEBUG - response_closed.started
2025-06-17 14:17:21,541 - DEBUG - response_closed.complete
2025-06-17 14:17:21,543 - DEBUG - Mistral location analysis: None
2025-06-17 14:17:21,543 - DEBUG - Location candidates: ['coupons for kwuntong', 'coupons for', 'for kwuntong', 'kwuntong']
2025-06-17 14:17:21,555 - INFO - Fuzzy location matched: kowloon 'Kwun Tong' with candidate 'kwuntong'
2025-06-17 14:17:21,567 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:17:21,568 - DEBUG - send_request_headers.complete
2025-06-17 14:17:21,569 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:17:21,570 - DEBUG - send_request_body.complete
2025-06-17 14:17:21,570 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:17:21,861 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:47:21 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499514'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817895'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'83'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'3b1f060b8544611c1d15be6efa2ce95a'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511481f88d93b0d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:17:21,863 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:17:21,864 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:17:21,864 - DEBUG - receive_response_body.complete
2025-06-17 14:17:21,865 - DEBUG - response_closed.started
2025-06-17 14:17:21,865 - DEBUG - response_closed.complete
2025-06-17 14:17:21,867 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:17:21,867 - DEBUG - Cleaned query: 'coupons kwuntong'
2025-06-17 14:17:21,874 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:17:21,896 - INFO - No coupon name matched for query: 'coupons for kwuntong'
2025-06-17 14:17:21,898 - DEBUG - Extracted: Category=None, Location={'name': 'Kwun Tong', 'type': 'selected_area', 'id': '4', 'table': 'kowloon'}, Discount=None, Coupon Name=None
2025-06-17 14:17:21,899 - DEBUG - Final: Query=coupons for kwuntong, Category=None, Location={'name': 'Kwun Tong', 'type': 'selected_area', 'id': '4', 'table': 'kowloon'}, Coupon Name=None, Discount=None
2025-06-17 14:17:21,903 - DEBUG - Location IDs for Kwun Tong in kowloon: ['4']
2025-06-17 14:17:21,904 - DEBUG - Searching coupons with selected_area IN ['4'], area = None
2025-06-17 14:17:21,904 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.selected_area IN (%s) ORDER BY c.created_at DESC LIMIT %s with params: ['4', 20]
2025-06-17 14:17:21,909 - DEBUG - Found 20 rows
2025-06-17 14:17:21,911 - DEBUG - Valid area IDs for coupon ID 1162 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,912 - DEBUG - Valid area IDs for coupon ID 1158 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,914 - DEBUG - Valid area IDs for coupon ID 1157 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,917 - DEBUG - Valid area IDs for coupon ID 962 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,919 - DEBUG - Valid area IDs for coupon ID 961 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,921 - DEBUG - Valid area IDs for coupon ID 950 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,922 - DEBUG - Valid area IDs for coupon ID 947 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,924 - DEBUG - Valid area IDs for coupon ID 929 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,925 - DEBUG - Valid area IDs for coupon ID 928 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,926 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,928 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,930 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,937 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,938 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,940 - DEBUG - Valid area IDs for coupon ID 897 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:17:21,941 - DEBUG - Valid area IDs for coupon ID 890 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,942 - DEBUG - Valid area IDs for coupon ID 885 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,945 - DEBUG - Valid area IDs for coupon ID 884 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,947 - DEBUG - Valid area IDs for coupon ID 879 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,950 - DEBUG - Valid area IDs for coupon ID 878 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:17:21,954 - DEBUG - Returning 20 coupons for category 'None', location 'Kwun Tong'
2025-06-17 14:17:21,955 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,957 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,957 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,958 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,958 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,960 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,961 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,962 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,963 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,971 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,972 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,972 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,973 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,975 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,975 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,976 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,976 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,978 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,986 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,986 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,987 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,989 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,989 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,990 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,990 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,992 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,993 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:21,993 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:21,993 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:21,996 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:21,996 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,003 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,004 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,007 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,008 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,008 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,010 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,012 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,016 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,020 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,021 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,022 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,025 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,026 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,027 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,028 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,028 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,031 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,038 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,038 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,039 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,039 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,041 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,042 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,042 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,043 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,043 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,045 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,046 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,062 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,077 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,077 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 3
2025-06-17 14:17:22,091 - WARNING - Selected_area '4' found in kowloon, but coupon_area '3' expects new_territories
2025-06-17 14:17:22,093 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:17:22,094 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:17:22,094 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:17:22,095 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,103 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,325 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,325 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,326 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,328 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,328 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,329 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,329 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,332 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,333 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,334 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,334 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,336 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,337 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,337 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,338 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:17:22,340 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:17:22,340 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:17:22,341 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:17:22,341 - DEBUG - Added system response. Total messages: 4
2025-06-17 14:17:22,342 - DEBUG - close.started
2025-06-17 14:17:22,344 - DEBUG - close.complete
2025-06-17 14:17:22,344 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:17:22,357 - INFO - Database connection closed
2025-06-17 14:17:22,358 - INFO - 127.0.0.1 - - [17/Jun/2025 14:17:22] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:17:22,380 - INFO - Connected to database
2025-06-17 14:17:24,550 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:17:24,589 - DEBUG - Rendering index with 4 messages
2025-06-17 14:17:24,591 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:17:24,600 - INFO - Database connection closed
2025-06-17 14:17:24,602 - INFO - 127.0.0.1 - - [17/Jun/2025 14:17:24] "GET / HTTP/1.1" 200 -
2025-06-17 14:21:49,519 - INFO - Connected to database
2025-06-17 14:21:51,287 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:21:51,329 - DEBUG - Rendering index with 4 messages
2025-06-17 14:21:51,466 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:21:51,473 - INFO - Database connection closed
2025-06-17 14:21:51,473 - INFO - 127.0.0.1 - - [17/Jun/2025 14:21:51] "GET / HTTP/1.1" 200 -
2025-06-17 14:26:50,967 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:26:51,233 - INFO -  * Restarting with stat
2025-06-17 14:26:52,822 - WARNING -  * Debugger is active!
2025-06-17 14:26:52,826 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:26:56,018 - INFO - 127.0.0.1 - - [17/Jun/2025 14:26:56] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:26:56,036 - INFO - 127.0.0.1 - - [17/Jun/2025 14:26:56] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:27:03,347 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:27:03,641 - INFO - Connected to database
2025-06-17 14:27:04,246 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:27:04,247 - INFO - Database connection closed
2025-06-17 14:27:04,248 - INFO - 127.0.0.1 - - [17/Jun/2025 14:27:04] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:27:04,262 - INFO - Connected to database
2025-06-17 14:27:06,470 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:27:06,512 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:27:06,514 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:27:08,215 - DEBUG - Loading model cost 1.703 seconds.
2025-06-17 14:27:08,216 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:27:08,217 - DEBUG - Rendering index with 0 messages
2025-06-17 14:27:08,226 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:27:08,258 - INFO - Database connection closed
2025-06-17 14:27:08,259 - INFO - 127.0.0.1 - - [17/Jun/2025 14:27:08] "GET / HTTP/1.1" 200 -
2025-06-17 14:27:31,834 - INFO - Connected to database
2025-06-17 14:27:33,479 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:27:33,527 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 14:27:33,528 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 14:27:33,529 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,530 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,530 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,531 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,531 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,533 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,534 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,537 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,538 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,538 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,539 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,539 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,540 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,540 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,541 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,541 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,542 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,542 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,543 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,543 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,544 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,544 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,545 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,545 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,546 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,546 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,547 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,547 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:27:33,547 - INFO - No category matched for query: coupons for hong kong
2025-06-17 14:27:33,560 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:27:33,609 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002583102BA10>
2025-06-17 14:27:33,610 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000025830C9AD50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:27:33,645 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000002583117AAD0>
2025-06-17 14:27:33,646 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:27:33,647 - DEBUG - send_request_headers.complete
2025-06-17 14:27:33,647 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:27:33,648 - DEBUG - send_request_body.complete
2025-06-17 14:27:33,648 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:27:33,936 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:57:33 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817752'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'ed39b369a02a654b1625f32eb5a21c2b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=ei63_nAgskdkkwEqTWDApmqdlQBM0t0u89Hl5gSO0zQ-1750150653-1.0.1.1-zPOgaCZRXK2EUiC8EyNyeG40fK56m4yotlGo.AoPS5eephMd7TuEyLY77yPeDb13SXNlZK1qfj1sTkruA6YCT79ibSOtrusJ1AvKL_HoZes; path=/; expires=Tue, 17-Jun-25 09:27:33 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=sGlZV2kWXqhSlxvfcK863Rs7bJfzVeg2VM2D42.01wY-1750150653864-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511571109418374-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:27:33,938 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:27:33,939 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:27:33,940 - DEBUG - receive_response_body.complete
2025-06-17 14:27:33,940 - DEBUG - response_closed.started
2025-06-17 14:27:33,941 - DEBUG - response_closed.complete
2025-06-17 14:27:33,948 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 14:27:33,971 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:27:33,972 - DEBUG - send_request_headers.complete
2025-06-17 14:27:33,972 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:27:33,973 - DEBUG - send_request_body.complete
2025-06-17 14:27:33,973 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:27:34,244 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:57:34 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817654'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'c72f102a1933c55a212d2960ee398f0b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951157130c048374-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:27:34,245 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:27:34,246 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:27:34,247 - DEBUG - receive_response_body.complete
2025-06-17 14:27:34,247 - DEBUG - response_closed.started
2025-06-17 14:27:34,248 - DEBUG - response_closed.complete
2025-06-17 14:27:34,254 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:27:34,258 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 14:27:34,265 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:27:34,297 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 14:27:34,327 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 14:27:34,327 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 14:27:34,328 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,329 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,330 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:27:34,334 - DEBUG - Found 20 rows
2025-06-17 14:27:34,335 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,337 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,338 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,340 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,341 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,343 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,344 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,345 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,346 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,347 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,348 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,349 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,352 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,354 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,356 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,357 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,358 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,359 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,360 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,362 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:27:34,362 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 14:27:34,363 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,364 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,365 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,365 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,365 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,367 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,370 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,370 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,371 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,373 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,373 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,374 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,374 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,375 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,376 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,377 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,378 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,379 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,379 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,380 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,380 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,382 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,382 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,383 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,383 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,387 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,387 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,387 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,389 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,391 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,392 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,392 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,393 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,394 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,394 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,395 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,396 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,397 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,397 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,398 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,398 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,400 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,402 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,402 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,404 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,407 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,408 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,409 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,409 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,410 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,411 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,411 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,412 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,414 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,414 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,415 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,415 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,418 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,419 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,422 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,422 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,424 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,425 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,425 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,425 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,427 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,427 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,428 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,429 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,430 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,430 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,431 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,431 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,432 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,433 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,437 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,438 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:27:34,440 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:27:34,440 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:27:34,441 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:27:34,441 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:27:34,441 - DEBUG - close.started
2025-06-17 14:27:34,442 - DEBUG - close.complete
2025-06-17 14:27:34,442 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:27:34,449 - INFO - Database connection closed
2025-06-17 14:27:34,449 - INFO - 127.0.0.1 - - [17/Jun/2025 14:27:34] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:27:34,465 - INFO - Connected to database
2025-06-17 14:27:36,229 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:27:36,296 - DEBUG - Rendering index with 2 messages
2025-06-17 14:27:36,298 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:27:36,309 - INFO - Database connection closed
2025-06-17 14:27:36,309 - INFO - 127.0.0.1 - - [17/Jun/2025 14:27:36] "GET / HTTP/1.1" 200 -
2025-06-17 14:28:08,365 - INFO - Connected to database
2025-06-17 14:28:10,253 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:28:10,318 - DEBUG - Cleared session messages. Starting fresh for query: coupons for food
2025-06-17 14:28:10,320 - DEBUG - Extracting category from query: 'coupons for food', words: ['coupons', 'for', 'food']
2025-06-17 14:28:10,320 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:28:10,321 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 14:28:10,336 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:28:10,362 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025830F8F610>
2025-06-17 14:28:10,363 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002583105D520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:28:10,400 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025830FA3950>
2025-06-17 14:28:10,401 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:28:10,402 - DEBUG - send_request_headers.complete
2025-06-17 14:28:10,403 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:28:10,404 - DEBUG - send_request_body.complete
2025-06-17 14:28:10,404 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:28:10,688 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:58:10 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499618'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817513'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'b7cdf427847e63213d212c3e202e7f40'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=xeg1_STEdFeWuFX0bF6EGUYvtEVtN3xDYpac8U.7U3Q-1750150690-1.0.1.1-VzcpRH4blABdbQcTf6m..iDiPhHV9WGGURGYR_H1I5FBYVgkqZAm8n7kT40XiV4j0fudKgYLe8N4XwJuVVrMYxwXZyIeoVWA_QBvYR512rg; path=/; expires=Tue, 17-Jun-25 09:28:10 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=ajD.vcLkATR1I2xtBuatWVj7Y1d8uMTohGec7NEbieY-1750150690631-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951157f6cf4a8ee3-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:28:10,689 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:28:10,690 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:28:10,691 - DEBUG - receive_response_body.complete
2025-06-17 14:28:10,692 - DEBUG - response_closed.started
2025-06-17 14:28:10,693 - DEBUG - response_closed.complete
2025-06-17 14:28:10,695 - DEBUG - Mistral location analysis: None
2025-06-17 14:28:10,696 - DEBUG - Location candidates: ['coupons for food', 'coupons for', 'for food']
2025-06-17 14:28:10,700 - INFO - No valid location matched for query: coupons for food
2025-06-17 14:28:10,711 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:28:10,714 - DEBUG - send_request_headers.complete
2025-06-17 14:28:10,714 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:28:10,715 - DEBUG - send_request_body.complete
2025-06-17 14:28:10,716 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:28:11,171 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 08:58:11 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499521'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817416'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'5392840137354f3115f6b229ac384c4c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951157f8b96f8ee3-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:28:11,173 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:28:11,174 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:28:11,174 - DEBUG - receive_response_body.complete
2025-06-17 14:28:11,175 - DEBUG - response_closed.started
2025-06-17 14:28:11,176 - DEBUG - response_closed.complete
2025-06-17 14:28:11,180 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:28:11,181 - DEBUG - Cleaned query: 'coupons food'
2025-06-17 14:28:11,187 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:28:11,202 - INFO - No coupon name matched for query: 'coupons for food'
2025-06-17 14:28:11,203 - DEBUG - Extracted: Category=Food, Location=None, Discount=None, Coupon Name=None
2025-06-17 14:28:11,203 - DEBUG - Final: Query=coupons for food, Category=Food, Location={'id': '1', 'name': 'Hong Kong', 'type': 'area'}, Coupon Name=None, Discount=None
2025-06-17 14:28:11,206 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,206 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,207 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', '1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:28:11,212 - DEBUG - Found 20 rows
2025-06-17 14:28:11,213 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,215 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,216 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,218 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,219 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,220 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,221 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,222 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,223 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,224 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,225 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,227 - DEBUG - Valid area IDs for coupon ID 1236 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,229 - DEBUG - Valid area IDs for coupon ID 1234 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,231 - DEBUG - Valid area IDs for coupon ID 1229 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,232 - DEBUG - Valid area IDs for coupon ID 1194 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,233 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,234 - DEBUG - Valid area IDs for coupon ID 1187 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,235 - DEBUG - Valid area IDs for coupon ID 1186 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,236 - DEBUG - Valid area IDs for coupon ID 1185 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,238 - DEBUG - Valid area IDs for coupon ID 1055 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:28:11,238 - DEBUG - Returning 20 coupons for category 'Food', location 'Hong Kong'
2025-06-17 14:28:11,239 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,240 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,241 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,241 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,242 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,248 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,248 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,249 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,250 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,251 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,252 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,252 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,253 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,254 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,254 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,255 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,255 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,256 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,257 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,257 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,258 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,263 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,264 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,264 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,265 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,266 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,267 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,267 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,267 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,269 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,269 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,270 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,270 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,272 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,272 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,273 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,273 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,274 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,275 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,275 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,290 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,293 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,305 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,317 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,330 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,337 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,343 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,366 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,366 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,368 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,457 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,464 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,465 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,468 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,472 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,567 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,577 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,590 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,595 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,596 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,596 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,599 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,599 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,600 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,600 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,602 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,603 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,610 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,616 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,621 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,623 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,627 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,631 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,633 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,633 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,634 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,634 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:28:11,636 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:28:11,637 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:28:11,637 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:28:11,637 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:28:11,638 - DEBUG - close.started
2025-06-17 14:28:11,639 - DEBUG - close.complete
2025-06-17 14:28:11,640 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:28:11,649 - INFO - Database connection closed
2025-06-17 14:28:11,650 - INFO - 127.0.0.1 - - [17/Jun/2025 14:28:11] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:28:11,671 - INFO - Connected to database
2025-06-17 14:28:13,276 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:28:13,323 - DEBUG - Rendering index with 2 messages
2025-06-17 14:28:13,324 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:28:13,334 - INFO - Database connection closed
2025-06-17 14:28:13,334 - INFO - 127.0.0.1 - - [17/Jun/2025 14:28:13] "GET / HTTP/1.1" 200 -
2025-06-17 14:29:59,216 - INFO - Connected to database
2025-06-17 14:30:01,407 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:30:01,454 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:30:01,462 - INFO - Database connection closed
2025-06-17 14:30:01,463 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:01] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:30:01,472 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:01] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:30:01,482 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:01] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:30:09,777 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:30:09,797 - INFO - Connected to database
2025-06-17 14:30:10,352 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:30:10,356 - INFO - Database connection closed
2025-06-17 14:30:10,357 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:10] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:30:10,415 - INFO - Connected to database
2025-06-17 14:30:12,719 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:30:12,758 - DEBUG - Rendering index with 1 messages
2025-06-17 14:30:12,759 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:30:12,767 - INFO - Database connection closed
2025-06-17 14:30:12,767 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:12] "GET / HTTP/1.1" 200 -
2025-06-17 14:30:42,122 - INFO - Connected to database
2025-06-17 14:30:43,810 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:30:43,862 - DEBUG - Cleared session messages. Starting fresh for query: coupons for new territories
2025-06-17 14:30:43,865 - DEBUG - Extracting category from query: 'coupons for new territories', words: ['coupons', 'for', 'new', 'territories']
2025-06-17 14:30:43,866 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,866 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,866 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,868 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,868 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:30:43,875 - INFO - No category matched for query: coupons for new territories
2025-06-17 14:30:43,887 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:30:43,923 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000258311A5220>
2025-06-17 14:30:43,923 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000258310EE4E0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:30:43,959 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025831180B90>
2025-06-17 14:30:43,962 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:30:43,965 - DEBUG - send_request_headers.complete
2025-06-17 14:30:43,966 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:30:43,967 - DEBUG - send_request_body.complete
2025-06-17 14:30:43,968 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:30:44,269 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:00:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'89'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499858'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817274'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'90'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'2c9ab77d7aaf0a7a545b9b0148bcdd49'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=5YUKqHO0BGYQNfKWGZsVlPAAazwFhaspIR5Edc_Cvrw-1750150844-1.0.1.1-aKq_NPObZGS5ccyw086klsFwzDUd0NQdlUJae2AK2XXBzAQrK_boAJKkZUP4FrepEGMBrsjLu.37ljmhFi5Q2Jtbl2cDSJ1k78tpzAHwmvo; path=/; expires=Tue, 17-Jun-25 09:30:44 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=voDDL7EJQHYdWyUMKtlj26Er0HljtMqMG7jwam5upmA-1750150844204-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115bb68f6247f4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:30:44,271 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:30:44,272 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:30:44,273 - DEBUG - receive_response_body.complete
2025-06-17 14:30:44,273 - DEBUG - response_closed.started
2025-06-17 14:30:44,274 - DEBUG - response_closed.complete
2025-06-17 14:30:44,276 - DEBUG - Mistral location analysis: None
2025-06-17 14:30:44,282 - DEBUG - Location candidates: ['coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 14:30:44,290 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 14:30:44,303 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:30:44,305 - DEBUG - send_request_headers.complete
2025-06-17 14:30:44,305 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:30:44,306 - DEBUG - send_request_body.complete
2025-06-17 14:30:44,307 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:30:44,580 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:00:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'71'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499760'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817176'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'2d81f613b5d56a779ed89356f627b61e'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115bb8aa1347f4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:30:44,582 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:30:44,582 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:30:44,583 - DEBUG - receive_response_body.complete
2025-06-17 14:30:44,584 - DEBUG - response_closed.started
2025-06-17 14:30:44,584 - DEBUG - response_closed.complete
2025-06-17 14:30:44,586 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:30:44,587 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 14:30:44,592 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:30:44,630 - INFO - No coupon name matched for query: 'coupons for new territories'
2025-06-17 14:30:44,630 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 14:30:44,631 - DEBUG - Final: Query=coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 14:30:44,633 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,633 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,634 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 14:30:44,636 - DEBUG - Found 20 rows
2025-06-17 14:30:44,637 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,638 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,639 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,640 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,641 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,642 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,645 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,647 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,648 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,649 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,652 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,653 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,655 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,656 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,657 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,658 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,659 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,663 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,665 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,666 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:30:44,667 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 14:30:44,668 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,669 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:30:44,670 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,670 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,671 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,673 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:30:44,673 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,674 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,674 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,676 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 14:30:44,677 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,678 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,680 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,683 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:30:44,683 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,684 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,684 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,686 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:30:44,687 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,687 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,688 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,689 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:30:44,690 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,691 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,691 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,692 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:30:44,693 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,694 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,694 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,697 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:30:44,698 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,698 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,699 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,700 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:30:44,701 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,701 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,702 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,703 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:30:44,704 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,704 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,705 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,706 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:30:44,707 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,707 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,708 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,709 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:30:44,714 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,715 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,716 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,717 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:30:44,718 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,718 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,719 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,720 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:30:44,721 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,721 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,721 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,723 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:30:44,723 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,724 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,724 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,727 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:30:44,729 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,732 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,732 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,734 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:30:44,734 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,735 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,735 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,736 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:30:44,737 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,737 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,738 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,740 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:30:44,741 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,741 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,741 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:30:44,742 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:30:44,743 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:30:44,746 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:30:44,748 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:30:44,749 - DEBUG - close.started
2025-06-17 14:30:44,749 - DEBUG - close.complete
2025-06-17 14:30:44,749 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:30:44,754 - INFO - Database connection closed
2025-06-17 14:30:44,754 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:44] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:30:44,774 - INFO - Connected to database
2025-06-17 14:30:46,399 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:30:46,441 - DEBUG - Rendering index with 2 messages
2025-06-17 14:30:46,446 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:30:46,459 - INFO - Database connection closed
2025-06-17 14:30:46,462 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:46] "GET / HTTP/1.1" 200 -
2025-06-17 14:30:50,883 - INFO - Connected to database
2025-06-17 14:30:52,456 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:30:52,534 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:30:52,542 - INFO - Database connection closed
2025-06-17 14:30:52,543 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:52] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:30:52,555 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:52] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:30:52,574 - INFO - 127.0.0.1 - - [17/Jun/2025 14:30:52] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:32:01,987 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:32:02,004 - INFO - Connected to database
2025-06-17 14:32:02,531 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:32:02,533 - INFO - Database connection closed
2025-06-17 14:32:02,534 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:02] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:32:02,560 - INFO - Connected to database
2025-06-17 14:32:04,654 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:32:04,691 - DEBUG - Rendering index with 1 messages
2025-06-17 14:32:04,815 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:32:04,823 - INFO - Database connection closed
2025-06-17 14:32:04,823 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:04] "GET / HTTP/1.1" 200 -
2025-06-17 14:32:15,901 - INFO - Connected to database
2025-06-17 14:32:18,053 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:32:18,100 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 14:32:18,102 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 14:32:18,103 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,103 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,104 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,104 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,105 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,105 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,106 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,107 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,108 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,110 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,110 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,111 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,111 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,112 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,112 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,113 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,113 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,114 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,114 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,115 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,115 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,115 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:18,118 - INFO - No category matched for query: coupons for hong kong
2025-06-17 14:32:18,130 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:32:18,180 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025831067240>
2025-06-17 14:32:18,180 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000025830C9AD50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:32:18,210 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025831067130>
2025-06-17 14:32:18,211 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:32:18,212 - DEBUG - send_request_headers.complete
2025-06-17 14:32:18,213 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:32:18,213 - DEBUG - send_request_body.complete
2025-06-17 14:32:18,214 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:32:18,522 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:02:18 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'86'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998817033'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'86'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'153990200983c7212846502a1fd8f30e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=JVtSDmLqQDsSE4IYX9krrArmFdoKFhz_hTk1B5pR1j4-1750150938-1.0.1.1-Xm6l77oq923bz36lbjrjXCAg57cIoIylZCURyZ8YUQiCaafEqegRFH8IrEr0KxQawyyDvELbBJndQP7GWWlikOIN7LxoQGLnKzVSd7dEPCY; path=/; expires=Tue, 17-Jun-25 09:32:18 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=ZarkifnLR3KjPuE0DEH_hODIg_MpyWMKrA6UXlYXaRE-1750150938455-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115e038b4d3b46-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:32:18,523 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:32:18,524 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:32:18,525 - DEBUG - receive_response_body.complete
2025-06-17 14:32:18,525 - DEBUG - response_closed.started
2025-06-17 14:32:18,526 - DEBUG - response_closed.complete
2025-06-17 14:32:18,528 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 14:32:18,541 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:32:18,542 - DEBUG - send_request_headers.complete
2025-06-17 14:32:18,542 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:32:18,543 - DEBUG - send_request_body.complete
2025-06-17 14:32:18,544 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:32:18,816 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:02:18 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816935'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'9b5ecc5060c37914d282062ebcfabb13'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115e059d723b46-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:32:18,817 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:32:18,817 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:32:18,818 - DEBUG - receive_response_body.complete
2025-06-17 14:32:18,819 - DEBUG - response_closed.started
2025-06-17 14:32:18,819 - DEBUG - response_closed.complete
2025-06-17 14:32:18,822 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:32:18,822 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 14:32:18,860 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:32:19,084 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 14:32:19,084 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 14:32:19,085 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 14:32:19,088 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,088 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,089 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:32:19,096 - DEBUG - Found 20 rows
2025-06-17 14:32:19,098 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,100 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,102 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,103 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,104 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,108 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,110 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,111 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,112 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,114 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,115 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,116 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,118 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,119 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,120 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,122 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,123 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,125 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,127 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,128 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:32:19,128 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 14:32:19,129 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,131 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,132 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,132 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,133 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,135 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,135 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,135 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,136 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,137 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,138 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,138 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,139 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,141 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,141 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,141 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,142 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,145 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,145 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,145 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,146 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,147 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,148 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,148 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,149 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,150 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,151 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,151 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,152 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,153 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,154 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,154 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,154 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,155 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,156 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,156 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,160 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,162 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,163 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,163 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,164 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,165 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,165 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,166 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,166 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,168 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,168 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,169 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,170 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,171 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,172 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,172 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,173 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,176 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,177 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,177 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,178 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,180 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,180 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,180 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,181 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,182 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,183 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,183 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,184 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,185 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,186 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,245 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,246 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,249 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,249 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,250 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,250 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,252 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,253 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,253 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,254 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:32:19,257 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:32:19,257 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:32:19,258 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:32:19,259 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:32:19,260 - DEBUG - close.started
2025-06-17 14:32:19,261 - DEBUG - close.complete
2025-06-17 14:32:19,262 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:32:19,268 - INFO - Database connection closed
2025-06-17 14:32:19,269 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:19] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:32:19,289 - INFO - Connected to database
2025-06-17 14:32:20,913 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:32:20,955 - DEBUG - Rendering index with 2 messages
2025-06-17 14:32:20,961 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:32:20,967 - INFO - Database connection closed
2025-06-17 14:32:20,968 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:20] "GET / HTTP/1.1" 200 -
2025-06-17 14:32:36,264 - INFO - Connected to database
2025-06-17 14:32:37,921 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:32:37,961 - DEBUG - Cleared session messages. Starting fresh for query: coupons for new territories
2025-06-17 14:32:37,962 - DEBUG - Extracting category from query: 'coupons for new territories', words: ['coupons', 'for', 'new', 'territories']
2025-06-17 14:32:37,963 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,963 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,964 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,964 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,965 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,965 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,965 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,966 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,966 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,966 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,967 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,967 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,967 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,968 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,968 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,968 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,973 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,976 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,976 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,976 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,976 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,976 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,977 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,977 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,977 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,977 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,977 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,978 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:32:37,978 - INFO - No category matched for query: coupons for new territories
2025-06-17 14:32:37,984 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:32:38,029 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025834945950>
2025-06-17 14:32:38,029 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000258310ECF80> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:32:38,090 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000025834945650>
2025-06-17 14:32:38,091 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:32:38,092 - DEBUG - send_request_headers.complete
2025-06-17 14:32:38,092 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:32:38,093 - DEBUG - send_request_body.complete
2025-06-17 14:32:38,093 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:32:38,380 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:02:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'82'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816793'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'82'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'0dac0518f5167d610c7fd671f5cc6046'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=H3.r41oaluRP_NXs9ILD7.wnuBF8I7zBJxDQah_3itI-1750150958-1.0.1.1-.7Ds9zyU1Fiool9YQmjlRQPEF1i7WNvS2m9JjxlxpbFWDxnBc_gkvv8hOoBK9ITTumH9gdt6gvYYfu80XzEh6DI_ja0Tv.IqyyNab0zT0VA; path=/; expires=Tue, 17-Jun-25 09:32:38 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=8SVfYhm14llrbKHclY281k6Ws2mOoGzi2CnZpSYsaIY-1750150958317-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115e7fdf1559a9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:32:38,382 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:32:38,382 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:32:38,383 - DEBUG - receive_response_body.complete
2025-06-17 14:32:38,384 - DEBUG - response_closed.started
2025-06-17 14:32:38,384 - DEBUG - response_closed.complete
2025-06-17 14:32:38,389 - DEBUG - Mistral location analysis: None
2025-06-17 14:32:38,389 - DEBUG - Location candidates: ['coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 14:32:38,398 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 14:32:38,408 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:32:38,409 - DEBUG - send_request_headers.complete
2025-06-17 14:32:38,410 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:32:38,410 - DEBUG - send_request_body.complete
2025-06-17 14:32:38,411 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:32:38,679 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:02:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'79'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499519'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816695'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'80'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'102075255fda4f21fba7ac56fe5a0b21'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95115e81d8e859a9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:32:38,680 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:32:38,682 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:32:38,683 - DEBUG - receive_response_body.complete
2025-06-17 14:32:38,683 - DEBUG - response_closed.started
2025-06-17 14:32:38,684 - DEBUG - response_closed.complete
2025-06-17 14:32:38,686 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:32:38,687 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 14:32:38,696 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:32:38,731 - INFO - No coupon name matched for query: 'coupons for new territories'
2025-06-17 14:32:38,732 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 14:32:38,733 - DEBUG - Final: Query=coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 14:32:38,734 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,735 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,736 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 14:32:38,741 - DEBUG - Found 20 rows
2025-06-17 14:32:38,742 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,744 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,745 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,747 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,747 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,748 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,749 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,750 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,751 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,758 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,760 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,761 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,762 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,763 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,764 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,765 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,767 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,768 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,771 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,772 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:32:38,772 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 14:32:38,774 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,776 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:32:38,776 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,776 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,777 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,778 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:32:38,779 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,780 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,780 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,782 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 14:32:38,782 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,783 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,783 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,784 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:32:38,785 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,790 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,791 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,793 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:32:38,794 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,794 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,794 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,796 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:32:38,796 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,797 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,797 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,798 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:32:38,799 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,799 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,800 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,801 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:32:38,803 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,804 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,807 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,809 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:32:38,810 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,810 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,810 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,811 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:32:38,812 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,812 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,813 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,814 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:32:38,816 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,816 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,816 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,817 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:32:38,818 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,818 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,820 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,823 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:32:38,835 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,849 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,862 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,865 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:32:38,875 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,881 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,882 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:38,893 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:32:38,989 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:38,997 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:38,998 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:39,004 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:32:39,007 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:39,008 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:39,012 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:39,122 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:32:39,124 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:39,125 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:39,126 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:39,129 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:32:39,129 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:39,130 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:39,130 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:39,132 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:32:39,133 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:39,133 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:39,134 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:32:39,137 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:32:39,137 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:32:39,141 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:32:39,146 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:32:39,147 - DEBUG - close.started
2025-06-17 14:32:39,155 - DEBUG - close.complete
2025-06-17 14:32:39,160 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:32:39,269 - INFO - Database connection closed
2025-06-17 14:32:39,273 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:39] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:32:39,296 - INFO - Connected to database
2025-06-17 14:32:40,925 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:32:40,962 - DEBUG - Rendering index with 2 messages
2025-06-17 14:32:40,963 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:32:40,969 - INFO - Database connection closed
2025-06-17 14:32:40,970 - INFO - 127.0.0.1 - - [17/Jun/2025 14:32:40] "GET / HTTP/1.1" 200 -
2025-06-17 14:33:41,037 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:33:41,248 - INFO -  * Restarting with stat
2025-06-17 14:33:43,366 - WARNING -  * Debugger is active!
2025-06-17 14:33:43,372 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:33:46,749 - INFO - 127.0.0.1 - - [17/Jun/2025 14:33:46] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:33:46,761 - INFO - 127.0.0.1 - - [17/Jun/2025 14:33:46] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:33:53,760 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:33:54,049 - INFO - Connected to database
2025-06-17 14:33:54,674 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:33:54,677 - INFO - Database connection closed
2025-06-17 14:33:54,677 - INFO - 127.0.0.1 - - [17/Jun/2025 14:33:54] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:33:54,696 - INFO - Connected to database
2025-06-17 14:33:56,923 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:33:56,975 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:33:56,978 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:33:58,740 - DEBUG - Loading model cost 1.764 seconds.
2025-06-17 14:33:58,741 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:33:58,743 - DEBUG - Rendering index with 0 messages
2025-06-17 14:33:58,753 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:33:58,777 - INFO - Database connection closed
2025-06-17 14:33:58,778 - INFO - 127.0.0.1 - - [17/Jun/2025 14:33:58] "GET / HTTP/1.1" 200 -
2025-06-17 14:34:07,806 - INFO - Connected to database
2025-06-17 14:34:09,605 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:34:09,643 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 14:34:09,645 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 14:34:09,645 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,646 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,646 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,647 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,647 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,648 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,648 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,649 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,653 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,654 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,655 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,657 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,657 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,658 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,658 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,659 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,659 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,660 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,661 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,661 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,662 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,662 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,663 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,663 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,664 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:09,664 - INFO - No category matched for query: coupons for hong kong
2025-06-17 14:34:09,675 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:34:09,754 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CCCBA10>
2025-06-17 14:34:09,769 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000021D5CD05520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:34:09,811 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CE3AAD0>
2025-06-17 14:34:09,812 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:34:09,813 - DEBUG - send_request_headers.complete
2025-06-17 14:34:09,814 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:34:09,815 - DEBUG - send_request_body.complete
2025-06-17 14:34:09,815 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:34:10,140 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:04:10 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'88'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816552'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'89'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'e359d52c48ef930ef791563c035c9966'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=QXlkP_mYG3IPDyBpkaJzCwMRWPcGFN9deBmPZNFRPts-1750151050-1.0.1.1-Mz3TnpF3T9._wqO0DH0ShG0Nr6crltWr408avscPQTggi4pLtzieYZ6R4PwdDg6dY97X_R_zKFKUhASbSpgj6Y0VdEfLDmwAwDUM4_AKXrI; path=/; expires=Tue, 17-Jun-25 09:34:10 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=NLniL0kKwBAanstbjbKbdZ74ELs48U7yR5isutxO_AE-1750151050074-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951160bd3f9f4025-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:34:10,142 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:34:10,143 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:34:10,144 - DEBUG - receive_response_body.complete
2025-06-17 14:34:10,145 - DEBUG - response_closed.started
2025-06-17 14:34:10,145 - DEBUG - response_closed.complete
2025-06-17 14:34:10,148 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 14:34:10,162 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:34:10,163 - DEBUG - send_request_headers.complete
2025-06-17 14:34:10,163 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:34:10,164 - DEBUG - send_request_body.complete
2025-06-17 14:34:10,165 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:34:10,454 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:04:10 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816454'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'd2c0932e30153267457922372ff17a4b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951160bf4a284025-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:34:10,455 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:34:10,456 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:34:10,457 - DEBUG - receive_response_body.complete
2025-06-17 14:34:10,457 - DEBUG - response_closed.started
2025-06-17 14:34:10,458 - DEBUG - response_closed.complete
2025-06-17 14:34:10,460 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:34:10,462 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 14:34:10,471 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:34:10,498 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 14:34:10,505 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 14:34:10,505 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 14:34:10,508 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,508 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,509 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 14:34:10,515 - DEBUG - Found 20 rows
2025-06-17 14:34:10,516 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,518 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,519 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,521 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,522 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,524 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,525 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,526 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,527 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,529 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,530 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,532 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,533 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,534 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,536 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,538 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,539 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,540 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,542 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,543 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:34:10,544 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 14:34:10,544 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,546 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,546 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,546 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,547 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,549 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,550 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,550 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,552 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,554 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,555 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,556 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,556 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,558 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,559 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,559 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,560 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,562 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,562 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,563 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,563 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,565 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,565 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,567 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,568 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,570 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,571 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,572 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,572 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,574 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,575 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,575 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,575 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,577 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,577 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,577 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,578 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,579 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,580 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,580 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,581 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,582 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,584 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,584 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,584 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,587 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,587 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,588 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,588 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,590 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,590 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,591 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,591 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,593 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,593 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,594 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,594 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,595 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,596 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,596 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,596 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,598 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,599 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,599 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,600 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,602 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,602 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,604 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,605 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,607 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,608 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,608 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,608 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,610 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,610 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,610 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,611 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:34:10,612 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:34:10,613 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:34:10,613 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:34:10,613 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:34:10,614 - DEBUG - close.started
2025-06-17 14:34:10,615 - DEBUG - close.complete
2025-06-17 14:34:10,615 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:34:10,626 - INFO - Database connection closed
2025-06-17 14:34:10,626 - INFO - 127.0.0.1 - - [17/Jun/2025 14:34:10] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:34:10,643 - INFO - Connected to database
2025-06-17 14:34:12,273 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:34:12,313 - DEBUG - Rendering index with 2 messages
2025-06-17 14:34:12,314 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:34:12,324 - INFO - Database connection closed
2025-06-17 14:34:12,324 - INFO - 127.0.0.1 - - [17/Jun/2025 14:34:12] "GET / HTTP/1.1" 200 -
2025-06-17 14:34:30,178 - INFO - Connected to database
2025-06-17 14:34:31,883 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:34:31,923 - DEBUG - Cleared session messages. Starting fresh for query: coupons for new territories
2025-06-17 14:34:31,925 - DEBUG - Extracting category from query: 'coupons for new territories', words: ['coupons', 'for', 'new', 'territories']
2025-06-17 14:34:31,925 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,925 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,926 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,926 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,926 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,927 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,927 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,928 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,932 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,933 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,934 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,934 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,935 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,935 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,936 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,936 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,936 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,936 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,937 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,937 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,937 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,938 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,938 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,939 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,939 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,939 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,940 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,940 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:34:31,940 - INFO - No category matched for query: coupons for new territories
2025-06-17 14:34:31,951 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:34:31,984 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CBE3610>
2025-06-17 14:34:31,985 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000021D5C8FAE70> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:34:32,020 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CBF3950>
2025-06-17 14:34:32,021 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:34:32,022 - DEBUG - send_request_headers.complete
2025-06-17 14:34:32,022 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:34:32,023 - DEBUG - send_request_body.complete
2025-06-17 14:34:32,023 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:34:32,299 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:04:32 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816312'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'9a255f16bfbb3b3e471042480638d941'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=y6xALvFj_wSler2zhD25dPfY0GGAMATL5vAo9UTNgq8-1750151072-1.0.1.1-rlOEPks541G9FMkrzfdyQNLqwYHP.cYt.92GIdJlV7A2HBg7uEit33ax3Bv15GAmsYNQ2OVDs8OL8Q03_wxCyFvXxL61DIc_LU.DTgCLNZg; path=/; expires=Tue, 17-Jun-25 09:34:32 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Tx2X66MbK0Q2aGdL1dt6Mf0GCU54Sv53gFwB4cm3B1A-1750151072230-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116147dc41ff77-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:34:32,301 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:34:32,302 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:34:32,303 - DEBUG - receive_response_body.complete
2025-06-17 14:34:32,303 - DEBUG - response_closed.started
2025-06-17 14:34:32,304 - DEBUG - response_closed.complete
2025-06-17 14:34:32,306 - DEBUG - Mistral location analysis: None
2025-06-17 14:34:32,306 - DEBUG - Location candidates: ['coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 14:34:32,317 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 14:34:32,325 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:34:32,326 - DEBUG - send_request_headers.complete
2025-06-17 14:34:32,327 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:34:32,327 - DEBUG - send_request_body.complete
2025-06-17 14:34:32,331 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:34:32,626 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:04:32 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'100'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499519'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816214'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'100'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'd17b6439258ded319e94005c0b178014'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116149cc84ff77-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:34:32,627 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:34:32,632 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:34:32,633 - DEBUG - receive_response_body.complete
2025-06-17 14:34:32,634 - DEBUG - response_closed.started
2025-06-17 14:34:32,635 - DEBUG - response_closed.complete
2025-06-17 14:34:32,639 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:34:32,640 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 14:34:32,645 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:34:32,687 - INFO - No coupon name matched for query: 'coupons for new territories'
2025-06-17 14:34:32,687 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 14:34:32,688 - DEBUG - Final: Query=coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 14:34:32,689 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,690 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,691 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 14:34:32,694 - DEBUG - Found 20 rows
2025-06-17 14:34:32,699 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,702 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,703 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,704 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,706 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,707 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,708 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,709 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,710 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,712 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,713 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,716 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,718 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,719 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,720 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,721 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,722 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,723 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,724 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,726 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:34:32,726 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 14:34:32,727 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:32,743 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:34:32,782 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:32,790 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:32,898 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:32,923 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:34:32,982 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:32,983 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:32,984 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:32,987 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 14:34:33,025 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,037 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,043 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,089 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:34:33,092 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,092 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,093 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,097 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:34:33,103 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,104 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,104 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,107 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:34:33,111 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,136 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,138 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,142 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:34:33,142 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,143 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,144 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,151 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 14:34:33,152 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,152 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,154 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,156 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:34:33,157 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,157 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,158 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,159 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:34:33,160 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,160 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,160 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,164 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:34:33,165 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,165 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,166 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,168 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:34:33,168 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,169 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,169 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,171 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:34:33,171 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,172 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,172 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,174 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:34:33,175 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,175 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,176 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,178 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:34:33,179 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,179 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,179 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,181 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:34:33,181 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,182 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,182 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,185 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:34:33,185 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,185 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,186 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,188 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:34:33,188 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,189 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,189 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,191 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:34:33,191 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,192 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,192 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:34:33,195 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:34:33,195 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:34:33,196 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:34:33,197 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:34:33,198 - DEBUG - close.started
2025-06-17 14:34:33,199 - DEBUG - close.complete
2025-06-17 14:34:33,199 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:34:33,206 - INFO - Database connection closed
2025-06-17 14:34:33,207 - INFO - 127.0.0.1 - - [17/Jun/2025 14:34:33] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:34:33,226 - INFO - Connected to database
2025-06-17 14:34:34,840 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:34:34,900 - DEBUG - Rendering index with 2 messages
2025-06-17 14:34:34,902 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:34:34,907 - INFO - Database connection closed
2025-06-17 14:34:34,908 - INFO - 127.0.0.1 - - [17/Jun/2025 14:34:34] "GET / HTTP/1.1" 200 -
2025-06-17 14:36:25,889 - INFO - Connected to database
2025-06-17 14:36:27,843 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:36:27,893 - DEBUG - Cleared session messages. Starting fresh for query: give food coupons
2025-06-17 14:36:27,894 - DEBUG - Extracting category from query: 'give food coupons', words: ['give', 'food', 'coupons']
2025-06-17 14:36:27,895 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 14:36:27,907 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:36:28,025 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CE588A0>
2025-06-17 14:36:28,025 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000021D5C8FAE70> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:36:28,067 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D605F9EB0>
2025-06-17 14:36:28,068 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:36:28,068 - DEBUG - send_request_headers.complete
2025-06-17 14:36:28,068 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:36:28,069 - DEBUG - send_request_body.complete
2025-06-17 14:36:28,069 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:36:28,354 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:06:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499859'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998816073'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'f675736363c9712b1b27155da9af5303'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=0pgvUdebuiT1VB79Ct.YCqHGtue04ZpPvlRgT8xsK70-1750151188-1.0.1.1-9pIY91N2isn5l8fbxrs0sfDyObmg7DD9eIAybJkWVmQH3c.jY3xyOqtVk3TG3JNQDVgc9BX6dZxOFwGdYANs1Jsq0KLrpi9qUBjrGrnF9Qs; path=/; expires=Tue, 17-Jun-25 09:36:28 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=RS.CUPipDq0vuhTJnh0X56gkX5EyGYLdG9K7NVyCDhE-1750151188280-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511641d2faf84f5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:36:28,355 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:36:28,356 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:36:28,357 - DEBUG - receive_response_body.complete
2025-06-17 14:36:28,358 - DEBUG - response_closed.started
2025-06-17 14:36:28,358 - DEBUG - response_closed.complete
2025-06-17 14:36:28,361 - DEBUG - Mistral location analysis: None
2025-06-17 14:36:28,361 - DEBUG - Location candidates: ['give food coupons', 'give food', 'food coupons']
2025-06-17 14:36:28,367 - INFO - No valid location matched for query: give food coupons
2025-06-17 14:36:28,379 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:36:28,380 - DEBUG - send_request_headers.complete
2025-06-17 14:36:28,381 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:36:28,382 - DEBUG - send_request_body.complete
2025-06-17 14:36:28,383 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:36:28,812 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:06:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'140'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499762'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998815976'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'141'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'66d7f9357f96680d66ce2a5e75377942'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511641f191b84f5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:36:28,813 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:36:28,814 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:36:28,814 - DEBUG - receive_response_body.complete
2025-06-17 14:36:28,815 - DEBUG - response_closed.started
2025-06-17 14:36:28,815 - DEBUG - response_closed.complete
2025-06-17 14:36:28,816 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:36:28,816 - DEBUG - Cleaned query: 'food coupons'
2025-06-17 14:36:28,821 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:36:28,840 - INFO - No coupon name matched for query: 'give food coupons'
2025-06-17 14:36:28,842 - DEBUG - Extracted: Category=Food, Location=None, Discount=None, Coupon Name=None
2025-06-17 14:36:28,843 - DEBUG - Final: Query=give food coupons, Category=Food, Location={'id': '3', 'name': 'New Territories', 'type': 'area'}, Coupon Name=None, Discount=None
2025-06-17 14:36:28,845 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,846 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,846 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', '3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 14:36:28,850 - DEBUG - Found 20 rows
2025-06-17 14:36:28,851 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,852 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,854 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,855 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,859 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,860 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,866 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,875 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,878 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,879 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,880 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,881 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,882 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,883 - DEBUG - Valid area IDs for coupon ID 899 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,884 - DEBUG - Valid area IDs for coupon ID 898 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,884 - DEBUG - Valid area IDs for coupon ID 897 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,885 - DEBUG - Valid area IDs for coupon ID 896 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,886 - DEBUG - Valid area IDs for coupon ID 809 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,887 - DEBUG - Valid area IDs for coupon ID 808 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,893 - DEBUG - Valid area IDs for coupon ID 807 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:36:28,893 - DEBUG - Returning 20 coupons for category 'Food', location 'New Territories'
2025-06-17 14:36:28,894 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,895 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 14:36:28,895 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,896 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,896 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,898 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:36:28,898 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,899 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,899 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,900 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:36:28,900 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,901 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,901 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,902 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,903 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,905 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,908 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,910 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,911 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,911 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,912 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,913 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,914 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,914 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,916 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,917 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,918 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,918 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,918 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,919 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,924 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,925 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,925 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,926 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:36:28,927 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,927 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,928 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,929 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,930 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,930 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,933 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,934 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,934 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,935 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,936 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,942 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 14:36:28,942 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,943 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,943 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,945 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,945 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,947 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,948 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,949 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,950 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,950 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,950 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,951 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,952 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,953 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,955 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,960 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:36:28,960 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,961 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,961 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,963 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 14:36:28,963 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,963 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,964 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,965 - DEBUG - Resolved selected_area 15 to Yuen Long via new_territories table
2025-06-17 14:36:28,965 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,968 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,968 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,969 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 14:36:28,969 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,973 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,975 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 14:36:28,977 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 14:36:28,977 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:36:28,978 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:36:28,978 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:36:28,979 - DEBUG - close.started
2025-06-17 14:36:28,980 - DEBUG - close.complete
2025-06-17 14:36:28,981 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:36:28,988 - INFO - Database connection closed
2025-06-17 14:36:28,989 - INFO - 127.0.0.1 - - [17/Jun/2025 14:36:28] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:36:29,005 - INFO - Connected to database
2025-06-17 14:36:30,936 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:36:30,978 - DEBUG - Rendering index with 2 messages
2025-06-17 14:36:30,979 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:36:30,991 - INFO - Database connection closed
2025-06-17 14:36:30,991 - INFO - 127.0.0.1 - - [17/Jun/2025 14:36:30] "GET / HTTP/1.1" 200 -
2025-06-17 14:36:48,454 - INFO - Connected to database
2025-06-17 14:36:50,354 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:36:50,395 - DEBUG - Cleared session messages. Starting fresh for query: coupons for 80% discount
2025-06-17 14:36:50,397 - DEBUG - Extracting category from query: 'coupons for 80% discount', words: ['coupons', 'for', '80%', 'discount']
2025-06-17 14:36:50,397 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,398 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,399 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,399 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,400 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,401 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,402 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,403 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,404 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,404 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,405 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,405 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,406 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,406 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,406 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,407 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,408 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,409 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,411 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,411 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,411 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:36:50,412 - INFO - No category matched for query: coupons for 80% discount
2025-06-17 14:36:50,422 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:36:50,455 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D605F8D10>
2025-06-17 14:36:50,456 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000021D5CD8D250> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:36:50,489 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D605F8E20>
2025-06-17 14:36:50,489 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:36:50,491 - DEBUG - send_request_headers.complete
2025-06-17 14:36:50,491 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:36:50,492 - DEBUG - send_request_body.complete
2025-06-17 14:36:50,493 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:36:50,887 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:06:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'168'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998815831'), (b'x-ratelimit-tokens-query-cost', b'145'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'169'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'4e1f3903272495015913835d55b9e56c'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=.8_iap6f78xGFUkhvQPfjUgZTIB.tV1aL8I5xIXMe.I-1750151210-1.0.1.1-tUr3B1p8dEQ4LEJkJqvwvoqlCW.MN_0GJ5a0X0Xb6jC5sCiOFnlmEM_6cmdnrx8mEcbz77sPILJEes6OA9XI_u.cERgYeDnPpyGhO7uZQqA; path=/; expires=Tue, 17-Jun-25 09:36:50 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=UinawoMXAUut7GXlhFSba1paXkbRfmwb1OZhQ3DsaJ0-1750151210815-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951164a94c3f3c7c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:36:50,888 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:36:50,889 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:36:50,889 - DEBUG - receive_response_body.complete
2025-06-17 14:36:50,890 - DEBUG - response_closed.started
2025-06-17 14:36:50,890 - DEBUG - response_closed.complete
2025-06-17 14:36:50,891 - DEBUG - Mistral location analysis: None
2025-06-17 14:36:50,892 - DEBUG - Location candidates: ['coupons for 80% discount', 'coupons for 80%', 'coupons for', 'for 80% discount', 'for 80%', '80% discount', '80%']
2025-06-17 14:36:50,899 - INFO - No valid location matched for query: coupons for 80% discount
2025-06-17 14:36:50,902 - DEBUG - Extracted English single/at least discount: min=80%
2025-06-17 14:36:50,908 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:36:50,908 - DEBUG - send_request_headers.complete
2025-06-17 14:36:50,909 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:36:50,909 - DEBUG - send_request_body.complete
2025-06-17 14:36:50,910 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:36:51,189 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:06:51 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'79'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499516'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998815730'), (b'x-ratelimit-tokens-query-cost', b'101'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'80'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'7735fe28eb2f133e3dc453742ba5085c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951164abef7f3c7c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:36:51,190 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:36:51,191 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:36:51,191 - DEBUG - receive_response_body.complete
2025-06-17 14:36:51,192 - DEBUG - response_closed.started
2025-06-17 14:36:51,192 - DEBUG - response_closed.complete
2025-06-17 14:36:51,194 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:36:51,195 - DEBUG - Cleaned query: 'coupons 80%'
2025-06-17 14:36:51,202 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:36:51,204 - INFO - Fuzzy coupon name match: 'coupons 80%' -> 'Coupon 380' from coupon
2025-06-17 14:36:51,204 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 80, 'max': 100}, Coupon Name=Coupon 380
2025-06-17 14:36:51,205 - DEBUG - Final: Query=coupons for 80% discount, Category=Food, Location=None, Coupon Name=Coupon 380, Discount={'min': 80, 'max': 100}
2025-06-17 14:36:51,206 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.percentage >= %s AND c.percentage <= %s AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', 80, 100, 'coupon 380', 'coupon 380', 20]
2025-06-17 14:36:51,208 - DEBUG - Found 0 rows
2025-06-17 14:36:51,209 - DEBUG - Returning 0 coupons for category 'Food', location 'None'
2025-06-17 14:36:51,209 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:36:51,210 - DEBUG - close.started
2025-06-17 14:36:51,211 - DEBUG - close.complete
2025-06-17 14:36:51,212 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:36:51,220 - INFO - Database connection closed
2025-06-17 14:36:51,221 - INFO - 127.0.0.1 - - [17/Jun/2025 14:36:51] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:36:51,241 - INFO - Connected to database
2025-06-17 14:36:52,910 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:36:52,968 - DEBUG - Rendering index with 2 messages
2025-06-17 14:36:52,971 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:36:52,978 - INFO - Database connection closed
2025-06-17 14:36:52,978 - INFO - 127.0.0.1 - - [17/Jun/2025 14:36:52] "GET / HTTP/1.1" 200 -
2025-06-17 14:37:17,433 - INFO - Connected to database
2025-06-17 14:37:18,118 - INFO - Connected to database
2025-06-17 14:37:19,483 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:37:20,024 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:37:20,036 - INFO - Database connection closed
2025-06-17 14:37:20,037 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:20] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:37:20,638 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:37:20,701 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:37:20,707 - INFO - Database connection closed
2025-06-17 14:37:20,708 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:20] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:37:20,719 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:20] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:37:20,728 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:20] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:37:25,818 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:37:25,834 - INFO - Connected to database
2025-06-17 14:37:26,467 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:37:26,469 - INFO - Database connection closed
2025-06-17 14:37:26,469 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:26] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:37:26,487 - INFO - Connected to database
2025-06-17 14:37:28,419 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:37:28,484 - DEBUG - Rendering index with 1 messages
2025-06-17 14:37:28,490 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:37:28,615 - INFO - Database connection closed
2025-06-17 14:37:28,627 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:28] "GET / HTTP/1.1" 200 -
2025-06-17 14:37:43,145 - INFO - Connected to database
2025-06-17 14:37:44,977 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:37:45,026 - DEBUG - Cleared session messages. Starting fresh for query: coupons with 80% discount
2025-06-17 14:37:45,029 - DEBUG - Extracting category from query: 'coupons with 80% discount', words: ['coupons', 'with', '80%', 'discount']
2025-06-17 14:37:45,029 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,029 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,030 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,031 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,031 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,032 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,035 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,036 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,037 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,040 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,042 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,043 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,044 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,044 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,045 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,046 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,047 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,048 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,049 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,050 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,050 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,050 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:37:45,051 - INFO - No category matched for query: coupons with 80% discount
2025-06-17 14:37:45,063 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:37:45,110 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5C5D0D50>
2025-06-17 14:37:45,112 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000021D5CD05520> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:37:45,148 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000021D5CD12250>
2025-06-17 14:37:45,195 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:37:45,196 - DEBUG - send_request_headers.complete
2025-06-17 14:37:45,196 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:37:45,197 - DEBUG - send_request_body.complete
2025-06-17 14:37:45,197 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:37:45,470 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:07:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'87'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499556'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998814672'), (b'x-ratelimit-tokens-query-cost', b'145'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'52'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'88'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'c4179408990d5871ee2f3a72d84aa01a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=HE0E2HmrOuEVuhO7YLXScGp_GpjGATlMJyZFHBtXeV0-1750151265-1.0.1.1-xU_cfHip7138RHibEQiPU_tY_TAEH8oWehlLLJ4QRjBoEdwD3U0naVWiiKQIZi1NvPJuqrp4xM8gypERaxoKu81MDf10chNvt0.rQpAhaXQ; path=/; expires=Tue, 17-Jun-25 09:37:45 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Z62ZQwEcdSQo1u5JYXyNheuOKkFbEVA0XSiprfi1NJg-1750151265434-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951165ff5915a3b1-AMD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:37:45,473 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:37:45,474 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:37:45,475 - DEBUG - receive_response_body.complete
2025-06-17 14:37:45,475 - DEBUG - response_closed.started
2025-06-17 14:37:45,476 - DEBUG - response_closed.complete
2025-06-17 14:37:45,478 - DEBUG - Mistral location analysis: None
2025-06-17 14:37:45,478 - DEBUG - Location candidates: ['coupons with 80% discount', 'coupons with 80%', 'coupons with', 'with 80% discount', 'with 80%', 'with', '80% discount', '80%']
2025-06-17 14:37:45,495 - INFO - No valid location matched for query: coupons with 80% discount
2025-06-17 14:37:45,496 - DEBUG - Extracted English single/at least discount: min=80%
2025-06-17 14:37:45,503 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:37:45,508 - DEBUG - send_request_headers.complete
2025-06-17 14:37:45,509 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:37:45,510 - DEBUG - send_request_body.complete
2025-06-17 14:37:45,510 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:37:45,774 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:07:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'76'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499455'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998814571'), (b'x-ratelimit-tokens-query-cost', b'101'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'51'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'9f3f890cfc73d634d3124950904a7647'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951166014b05a3b1-AMD'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:37:45,775 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:37:45,776 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:37:45,777 - DEBUG - receive_response_body.complete
2025-06-17 14:37:45,778 - DEBUG - response_closed.started
2025-06-17 14:37:45,778 - DEBUG - response_closed.complete
2025-06-17 14:37:45,780 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:37:45,781 - DEBUG - Cleaned query: 'coupons with 80%'
2025-06-17 14:37:45,791 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:37:45,835 - INFO - No coupon name matched for query: 'coupons with 80% discount'
2025-06-17 14:37:45,836 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 80, 'max': 100}, Coupon Name=None
2025-06-17 14:37:45,836 - DEBUG - Final: Query=coupons with 80% discount, Category=None, Location=None, Coupon Name=None, Discount={'min': 80, 'max': 100}
2025-06-17 14:37:45,840 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: [80, 100, 20]
2025-06-17 14:37:45,844 - DEBUG - Found 20 rows
2025-06-17 14:37:45,845 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,847 - DEBUG - Valid area IDs for coupon ID 1228 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,848 - DEBUG - Valid area IDs for coupon ID 1225 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,849 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,850 - DEBUG - Valid area IDs for coupon ID 1010 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,852 - DEBUG - Valid area IDs for coupon ID 997 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,854 - DEBUG - Valid area IDs for coupon ID 966 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,860 - DEBUG - Valid area IDs for coupon ID 965 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,861 - DEBUG - Valid area IDs for coupon ID 964 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,863 - DEBUG - Valid area IDs for coupon ID 958 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,864 - DEBUG - Valid area IDs for coupon ID 957 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,865 - DEBUG - Valid area IDs for coupon ID 956 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,866 - DEBUG - Valid area IDs for coupon ID 950 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,867 - DEBUG - Valid area IDs for coupon ID 949 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,868 - DEBUG - Valid area IDs for coupon ID 940 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,869 - DEBUG - Valid area IDs for coupon ID 890 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,871 - DEBUG - Valid area IDs for coupon ID 889 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:37:45,873 - DEBUG - Valid area IDs for coupon ID 882 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,875 - DEBUG - Valid area IDs for coupon ID 877 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,876 - DEBUG - Valid area IDs for coupon ID 876 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:37:45,877 - DEBUG - Returning 20 coupons for category 'None', location 'None'
2025-06-17 14:37:45,877 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,879 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:37:45,879 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,880 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,880 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,882 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:37:45,882 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,883 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,883 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,884 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:37:45,885 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,886 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,886 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,888 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:37:45,889 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,890 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,890 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,893 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:37:45,894 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,894 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,895 - DEBUG - Attempting to resolve selected_area: 27, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,896 - DEBUG - Resolved selected_area 27 to Prince Edward via kowloon table
2025-06-17 14:37:45,896 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,897 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,897 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,899 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:37:45,899 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,900 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,900 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,901 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:37:45,902 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,902 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,902 - DEBUG - Attempting to resolve selected_area: 31, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,907 - DEBUG - Resolved selected_area 31 to Tsim Sha Tsui via kowloon table
2025-06-17 14:37:45,907 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,908 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,909 - DEBUG - Attempting to resolve selected_area: 21, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,910 - DEBUG - Resolved selected_area 21 to Cheung Sha Wan via kowloon table
2025-06-17 14:37:45,911 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,911 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,911 - DEBUG - Attempting to resolve selected_area: 21, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,912 - DEBUG - Resolved selected_area 21 to Cheung Sha Wan via kowloon table
2025-06-17 14:37:45,913 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,913 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,914 - DEBUG - Attempting to resolve selected_area: 21, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,916 - DEBUG - Resolved selected_area 21 to Cheung Sha Wan via kowloon table
2025-06-17 14:37:45,917 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,918 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,919 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,925 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:37:45,926 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,927 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,927 - DEBUG - Attempting to resolve selected_area: 13, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,929 - DEBUG - Resolved selected_area 13 to Wong Tai Sin via kowloon table
2025-06-17 14:37:45,929 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,930 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,932 - DEBUG - Attempting to resolve selected_area: 18, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,933 - DEBUG - Resolved selected_area 18 to Chai Wan via hong_kong table
2025-06-17 14:37:45,933 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,934 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,934 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,935 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:37:45,936 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,936 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,938 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 1
2025-06-17 14:37:45,941 - DEBUG - Resolved selected_area 15 to North Point via hong_kong table
2025-06-17 14:37:45,941 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:37:45,942 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:37:45,942 - DEBUG - Attempting to resolve selected_area: 31, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,945 - DEBUG - Resolved selected_area 31 to Tsim Sha Tsui via kowloon table
2025-06-17 14:37:45,946 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,946 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,946 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,948 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:37:45,948 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,948 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,949 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:37:45,950 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:37:45,950 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:37:45,951 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:37:45,951 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:37:45,952 - DEBUG - close.started
2025-06-17 14:37:45,953 - DEBUG - close.complete
2025-06-17 14:37:45,953 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:37:45,964 - INFO - Database connection closed
2025-06-17 14:37:45,964 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:45] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:37:45,985 - INFO - Connected to database
2025-06-17 14:37:47,794 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:37:47,849 - DEBUG - Rendering index with 2 messages
2025-06-17 14:37:47,851 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:37:47,862 - INFO - Database connection closed
2025-06-17 14:37:47,862 - INFO - 127.0.0.1 - - [17/Jun/2025 14:37:47] "GET / HTTP/1.1" 200 -
2025-06-17 14:41:28,836 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:41:29,193 - INFO -  * Restarting with stat
2025-06-17 14:41:30,974 - WARNING -  * Debugger is active!
2025-06-17 14:41:30,980 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:41:32,268 - INFO - 127.0.0.1 - - [17/Jun/2025 14:41:32] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:41:32,286 - INFO - 127.0.0.1 - - [17/Jun/2025 14:41:32] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:41:38,764 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:41:38,969 - INFO - Connected to database
2025-06-17 14:41:39,618 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:41:39,621 - INFO - Database connection closed
2025-06-17 14:41:39,622 - INFO - 127.0.0.1 - - [17/Jun/2025 14:41:39] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:41:39,639 - INFO - Connected to database
2025-06-17 14:41:41,710 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:41:41,742 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:41:41,744 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:41:43,435 - DEBUG - Loading model cost 1.693 seconds.
2025-06-17 14:41:43,436 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:41:43,438 - DEBUG - Rendering index with 0 messages
2025-06-17 14:41:43,506 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:41:43,526 - INFO - Database connection closed
2025-06-17 14:41:43,526 - INFO - 127.0.0.1 - - [17/Jun/2025 14:41:43] "GET / HTTP/1.1" 200 -
2025-06-17 14:41:56,324 - INFO - Connected to database
2025-06-17 14:41:57,989 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:41:58,051 - DEBUG - Cleared session messages. Starting fresh for query: coupons with 60% discount
2025-06-17 14:41:58,056 - DEBUG - Extracting category from query: 'coupons with 60% discount', words: ['coupons', 'with', '60%', 'discount']
2025-06-17 14:41:58,057 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,057 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,058 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,058 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,059 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,059 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,060 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,061 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,062 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,063 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,063 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,064 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,065 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,065 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,066 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,066 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,071 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,072 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,073 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,073 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,074 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,074 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,075 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,075 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,076 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,076 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,077 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,078 - DEBUG - Ignoring word: 'coupons'
2025-06-17 14:41:58,079 - INFO - No category matched for query: coupons with 60% discount
2025-06-17 14:41:58,094 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:41:58,131 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560B1BA10>
2025-06-17 14:41:58,132 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D56075B2F0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:41:58,181 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560C6AAD0>
2025-06-17 14:41:58,181 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:41:58,182 - DEBUG - send_request_headers.complete
2025-06-17 14:41:58,183 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:41:58,186 - DEBUG - send_request_body.complete
2025-06-17 14:41:58,186 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:41:58,452 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:11:58 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'69'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499855'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813931'), (b'x-ratelimit-tokens-query-cost', b'145'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'70'), (b'x-kong-proxy-latency', b'8'), (b'x-kong-request-id', b'f9b1650ef5ba516e51272a34c11b9176'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=2MuBJh2i6zBVboHA1NaAXgdu236V.vCvGq5mYaPbmkc-1750151518-1.0.1.1-3Csuq0CnFYt5UhVtcWMH1cGkUYX3vKXRRjhIuBcEDrdwhPXStfDtT0l0POQwgt.hjmYaglqlS800MWqc5bWsppduFf3LdY_BfRMNxRUhhlY; path=/; expires=Tue, 17-Jun-25 09:41:58 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Q8hjW8l_L_3HfOjUKPQtcEdeI6G.OFMtjck5WzZGSs4-1750151518384-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116c2c5ef43c52-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:41:58,453 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:41:58,454 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:41:58,455 - DEBUG - receive_response_body.complete
2025-06-17 14:41:58,456 - DEBUG - response_closed.started
2025-06-17 14:41:58,457 - DEBUG - response_closed.complete
2025-06-17 14:41:58,461 - DEBUG - Mistral location analysis: None
2025-06-17 14:41:58,462 - DEBUG - Location candidates: ['coupons with 60% discount', 'coupons with 60%', 'coupons with', 'with 60% discount', 'with 60%', 'with', '60% discount', '60%']
2025-06-17 14:41:58,480 - INFO - No valid location matched for query: coupons with 60% discount
2025-06-17 14:41:58,482 - DEBUG - Extracted English single/at least discount: min=60%
2025-06-17 14:41:58,495 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:41:58,497 - DEBUG - send_request_headers.complete
2025-06-17 14:41:58,497 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:41:58,498 - DEBUG - send_request_body.complete
2025-06-17 14:41:58,499 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:41:58,790 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:11:58 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'86'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499754'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813830'), (b'x-ratelimit-tokens-query-cost', b'101'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'87'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'47e0d43b8d2d8e192cf0353d228ad763'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116c2e597b3c52-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:41:58,792 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:41:58,792 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:41:58,794 - DEBUG - receive_response_body.complete
2025-06-17 14:41:58,795 - DEBUG - response_closed.started
2025-06-17 14:41:58,795 - DEBUG - response_closed.complete
2025-06-17 14:41:58,797 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:41:58,801 - DEBUG - Cleaned query: 'coupons with 60%'
2025-06-17 14:41:58,806 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:41:58,834 - INFO - No coupon name matched for query: 'coupons with 60% discount'
2025-06-17 14:41:58,838 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 60, 'max': 100}, Coupon Name=None
2025-06-17 14:41:58,838 - DEBUG - Final: Query=coupons with 60% discount, Category=None, Location=None, Coupon Name=None, Discount={'min': 60, 'max': 100}
2025-06-17 14:41:58,840 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: [60, 100, 20]
2025-06-17 14:41:58,844 - DEBUG - Found 20 rows
2025-06-17 14:41:58,846 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,847 - DEBUG - Valid area IDs for coupon ID 1239 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,848 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,849 - DEBUG - Valid area IDs for coupon ID 1228 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,853 - DEBUG - Valid area IDs for coupon ID 1227 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,855 - DEBUG - Valid area IDs for coupon ID 1226 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,856 - DEBUG - Valid area IDs for coupon ID 1225 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,857 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,859 - DEBUG - Valid area IDs for coupon ID 1166 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,860 - DEBUG - Valid area IDs for coupon ID 1163 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,861 - DEBUG - Valid area IDs for coupon ID 1161 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,862 - DEBUG - Valid area IDs for coupon ID 1065 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,863 - DEBUG - Valid area IDs for coupon ID 1037 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,865 - DEBUG - Valid area IDs for coupon ID 1036 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,866 - DEBUG - Valid area IDs for coupon ID 1033 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,867 - DEBUG - Valid area IDs for coupon ID 1013 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,871 - DEBUG - Valid area IDs for coupon ID 1010 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:41:58,872 - DEBUG - Valid area IDs for coupon ID 997 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,874 - DEBUG - Valid area IDs for coupon ID 966 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:41:58,874 - DEBUG - Returning 20 coupons for category 'None', location 'None'
2025-06-17 14:41:58,875 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,877 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:41:58,878 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,878 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,879 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:58,880 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:41:58,881 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:58,881 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:58,882 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,884 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:41:58,886 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,889 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,944 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,947 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:41:58,948 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,948 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,949 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:58,953 - DEBUG - Resolved selected_area 33 to Whampoa via kowloon table
2025-06-17 14:41:58,956 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:58,956 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:58,957 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:58,959 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:41:58,959 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:58,960 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:58,960 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,963 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:41:58,963 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,964 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,964 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,967 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:41:58,972 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,972 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,972 - DEBUG - No selected_area provided, returning 'Any'
2025-06-17 14:41:58,973 - DEBUG - No area_id provided, returning 'Any'
2025-06-17 14:41:58,973 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:58,975 - DEBUG - Resolved selected_area 29 to Yau Ma Tei via kowloon table
2025-06-17 14:41:58,976 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:58,976 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:58,977 - DEBUG - Attempting to resolve selected_area: 32, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,992 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:58,993 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:58,993 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:58,995 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:41:58,995 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:58,996 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:58,997 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:58,999 - DEBUG - Resolved selected_area 25 to Aberdeen via hong_kong table
2025-06-17 14:41:59,000 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:59,001 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:59,002 - DEBUG - Attempting to resolve selected_area: 27, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:59,005 - DEBUG - Resolved selected_area 27 to Prince Edward via kowloon table
2025-06-17 14:41:59,006 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:59,007 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:59,007 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:59,010 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:41:59,011 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:59,011 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:59,011 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:59,013 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:41:59,014 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:59,014 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:59,015 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:59,016 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:41:59,017 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:59,017 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:59,018 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:41:59,021 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:41:59,022 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:41:59,022 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:41:59,023 - DEBUG - Attempting to resolve selected_area: 27, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:59,024 - DEBUG - Resolved selected_area 27 to Prince Edward via kowloon table
2025-06-17 14:41:59,025 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:59,025 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:59,025 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:41:59,026 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:41:59,027 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:41:59,027 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:41:59,028 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:41:59,028 - DEBUG - close.started
2025-06-17 14:41:59,029 - DEBUG - close.complete
2025-06-17 14:41:59,030 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:41:59,041 - INFO - Database connection closed
2025-06-17 14:41:59,041 - INFO - 127.0.0.1 - - [17/Jun/2025 14:41:59] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:41:59,061 - INFO - Connected to database
2025-06-17 14:42:00,729 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:42:00,773 - DEBUG - Rendering index with 2 messages
2025-06-17 14:42:00,774 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:42:00,780 - INFO - Database connection closed
2025-06-17 14:42:00,781 - INFO - 127.0.0.1 - - [17/Jun/2025 14:42:00] "GET / HTTP/1.1" 200 -
2025-06-17 14:42:25,799 - INFO - Connected to database
2025-06-17 14:42:27,584 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:42:27,622 - DEBUG - Cleared session messages. Starting fresh for query: food coupons
2025-06-17 14:42:27,623 - DEBUG - Extracting category from query: 'food coupons', words: ['food', 'coupons']
2025-06-17 14:42:27,624 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 14:42:27,635 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:42:27,674 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560A3F610>
2025-06-17 14:42:27,675 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D560B51130> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:42:27,710 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560A53950>
2025-06-17 14:42:27,716 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:42:27,717 - DEBUG - send_request_headers.complete
2025-06-17 14:42:27,717 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:42:27,718 - DEBUG - send_request_body.complete
2025-06-17 14:42:27,718 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:42:28,008 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:12:27 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'71'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499614'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813690'), (b'x-ratelimit-tokens-query-cost', b'140'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'72'), (b'x-kong-proxy-latency', b'3'), (b'x-kong-request-id', b'7def283ec2fad1622535f33919a3d009'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=K_cTzTiZKYdyW3Sf2mcWQ4kGox.7cAEJH8ipseEad1k-1750151547-1.0.1.1-lA3IMEyFttar7P0EW8nP7FD2WTfPoTR5Sij99Z1hqoRTJ8MO5k.I9zi4JjwpAn9aL9R3HvQGYmZxPI4PwYCkTV1UF6a7KodhRfZ76LkpLKc; path=/; expires=Tue, 17-Jun-25 09:42:27 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Mpws8vY8WYpM4kI_nJcaAxvwULY2BiooxwJOfjOcCns-1750151547930-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116ce4fb323dfe-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:42:28,009 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:42:28,010 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:42:28,011 - DEBUG - receive_response_body.complete
2025-06-17 14:42:28,012 - DEBUG - response_closed.started
2025-06-17 14:42:28,012 - DEBUG - response_closed.complete
2025-06-17 14:42:28,015 - DEBUG - Mistral location analysis: None
2025-06-17 14:42:28,015 - DEBUG - Location candidates: ['food coupons']
2025-06-17 14:42:28,017 - INFO - No valid location matched for query: food coupons
2025-06-17 14:42:28,026 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:42:28,033 - DEBUG - send_request_headers.complete
2025-06-17 14:42:28,034 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:42:28,035 - DEBUG - send_request_body.complete
2025-06-17 14:42:28,035 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:42:28,329 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:12:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499518'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813594'), (b'x-ratelimit-tokens-query-cost', b'96'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'77'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'85ca327a82871b547bc66968a1845f07'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116ce6fdb13dfe-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:42:28,331 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:42:28,332 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:42:28,333 - DEBUG - receive_response_body.complete
2025-06-17 14:42:28,334 - DEBUG - response_closed.started
2025-06-17 14:42:28,334 - DEBUG - response_closed.complete
2025-06-17 14:42:28,336 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:42:28,337 - DEBUG - Cleaned query: 'food coupons'
2025-06-17 14:42:28,343 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:42:28,360 - INFO - No coupon name matched for query: 'food coupons'
2025-06-17 14:42:28,362 - DEBUG - Extracted: Category=Food, Location=None, Discount=None, Coupon Name=None
2025-06-17 14:42:28,369 - DEBUG - Final: Query=food coupons, Category=Food, Location=None, Coupon Name=None, Discount={'max': 100, 'min': 60}
2025-06-17 14:42:28,371 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 60, 100, 20]
2025-06-17 14:42:28,375 - DEBUG - Found 20 rows
2025-06-17 14:42:28,376 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,383 - DEBUG - Valid area IDs for coupon ID 997 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,385 - DEBUG - Valid area IDs for coupon ID 966 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,386 - DEBUG - Valid area IDs for coupon ID 965 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,387 - DEBUG - Valid area IDs for coupon ID 889 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,388 - DEBUG - Valid area IDs for coupon ID 862 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,389 - DEBUG - Valid area IDs for coupon ID 728 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,390 - DEBUG - Valid area IDs for coupon ID 727 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,391 - DEBUG - Valid area IDs for coupon ID 726 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,392 - DEBUG - Valid area IDs for coupon ID 725 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:42:28,395 - DEBUG - Valid area IDs for coupon ID 724 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:42:28,397 - DEBUG - Valid area IDs for coupon ID 723 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:42:28,403 - DEBUG - Valid area IDs for coupon ID 722 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,410 - DEBUG - Valid area IDs for coupon ID 721 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,417 - DEBUG - Valid area IDs for coupon ID 720 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:42:28,419 - DEBUG - Valid area IDs for coupon ID 715 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,423 - DEBUG - Valid area IDs for coupon ID 714 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,425 - DEBUG - Valid area IDs for coupon ID 713 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,426 - DEBUG - Valid area IDs for coupon ID 681 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,428 - DEBUG - Valid area IDs for coupon ID 629 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:28,430 - DEBUG - Returning 20 coupons for category 'Food', location 'None'
2025-06-17 14:42:28,431 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,433 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:42:28,434 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,434 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,435 - DEBUG - Attempting to resolve selected_area: 27, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,436 - DEBUG - Resolved selected_area 27 to Prince Edward via kowloon table
2025-06-17 14:42:28,437 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,437 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,438 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,439 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:42:28,440 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,440 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,440 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,442 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:42:28,442 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,443 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,445 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,449 - DEBUG - Resolved selected_area 15 to North Point via hong_kong table
2025-06-17 14:42:28,449 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,450 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,450 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,452 - DEBUG - Resolved selected_area 15 to North Point via hong_kong table
2025-06-17 14:42:28,452 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,453 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,453 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,455 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,455 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,456 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,456 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,457 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,458 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,458 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,459 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,461 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,461 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,461 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,464 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:42:28,466 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:42:28,467 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:42:28,467 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:42:28,468 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:42:28,470 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:42:28,470 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:42:28,471 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:42:28,471 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:42:28,472 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:42:28,472 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:42:28,472 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:42:28,473 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,474 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,474 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,475 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,475 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,477 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,478 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,479 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,480 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:42:28,482 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:42:28,483 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:42:28,483 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:42:28,484 - DEBUG - Attempting to resolve selected_area: 12, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,485 - DEBUG - Resolved selected_area 12 to San Po Kong via kowloon table
2025-06-17 14:42:28,485 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,486 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,489 - DEBUG - Attempting to resolve selected_area: 12, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,490 - DEBUG - Resolved selected_area 12 to San Po Kong via kowloon table
2025-06-17 14:42:28,491 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,491 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,492 - DEBUG - Attempting to resolve selected_area: 12, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,494 - DEBUG - Resolved selected_area 12 to San Po Kong via kowloon table
2025-06-17 14:42:28,496 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,497 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,497 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,499 - DEBUG - Resolved selected_area 20 to Lai Chi Kok via kowloon table
2025-06-17 14:42:28,499 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,500 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,500 - DEBUG - Attempting to resolve selected_area: 31, territory: , location_table: None, coupon_area: 2
2025-06-17 14:42:28,502 - DEBUG - Resolved selected_area 31 to Tsim Sha Tsui via kowloon table
2025-06-17 14:42:28,503 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:28,503 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:28,503 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:42:28,504 - DEBUG - close.started
2025-06-17 14:42:28,504 - DEBUG - close.complete
2025-06-17 14:42:28,505 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:42:28,513 - INFO - Database connection closed
2025-06-17 14:42:28,514 - INFO - 127.0.0.1 - - [17/Jun/2025 14:42:28] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:42:28,534 - INFO - Connected to database
2025-06-17 14:42:30,146 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:42:30,185 - DEBUG - Rendering index with 2 messages
2025-06-17 14:42:30,187 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:42:30,192 - INFO - Database connection closed
2025-06-17 14:42:30,193 - INFO - 127.0.0.1 - - [17/Jun/2025 14:42:30] "GET / HTTP/1.1" 200 -
2025-06-17 14:42:46,651 - INFO - Connected to database
2025-06-17 14:42:48,337 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:42:48,385 - DEBUG - Cleared session messages. Starting fresh for query: tsim sha tsui
2025-06-17 14:42:48,387 - DEBUG - Extracting category from query: 'tsim sha tsui', words: ['tsim', 'sha', 'tsui']
2025-06-17 14:42:48,388 - INFO - No category matched for query: tsim sha tsui
2025-06-17 14:42:48,400 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:42:48,442 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560C948A0>
2025-06-17 14:42:48,444 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D560B51130> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:42:48,482 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D560C79D90>
2025-06-17 14:42:48,482 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:42:48,483 - DEBUG - send_request_headers.complete
2025-06-17 14:42:48,484 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:42:48,484 - DEBUG - send_request_body.complete
2025-06-17 14:42:48,484 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:42:48,792 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:12:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499376'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813452'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'31882a1b6d70bf153a486f16f8a32209'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=UBRWzcv_5zUWARUOJPWu_Bcp9ZHreXi9SByBSdLLzGY-1750151568-1.0.1.1-ZiKQVeE4ZJCN.fHCwsX_79p7nPei.RRyWQG5hNjdD.Ir8s200texj3N2dLYGclaVsmUY.awm2jizYVN3ujwXdR4SMVGAnGcAwBuRTU.9jno; path=/; expires=Tue, 17-Jun-25 09:42:48 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=dor0iJfr1zyHk4HjPK7mxgqQU6EfTRELYfp0ATzHNsU-1750151568727-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116d66cb326ec4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:42:48,795 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:42:48,796 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:42:48,797 - DEBUG - receive_response_body.complete
2025-06-17 14:42:48,797 - DEBUG - response_closed.started
2025-06-17 14:42:48,798 - DEBUG - response_closed.complete
2025-06-17 14:42:48,800 - DEBUG - Mistral location analysis: None
2025-06-17 14:42:48,801 - DEBUG - Location candidates: ['tsim sha tsui', 'tsim sha', 'tsim', 'sha tsui', 'sha', 'tsui']
2025-06-17 14:42:48,805 - INFO - Exact location matched: kowloon 'Tsim Sha Tsui'
2025-06-17 14:42:48,817 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:42:48,818 - DEBUG - send_request_headers.complete
2025-06-17 14:42:48,819 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:42:48,820 - DEBUG - send_request_body.complete
2025-06-17 14:42:48,820 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:42:49,075 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:12:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'70'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499278'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813354'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'70'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'320dac70acbcf34238b53e578aa31070'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95116d68dd136ec4-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:42:49,077 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:42:49,077 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:42:49,078 - DEBUG - receive_response_body.complete
2025-06-17 14:42:49,079 - DEBUG - response_closed.started
2025-06-17 14:42:49,080 - DEBUG - response_closed.complete
2025-06-17 14:42:49,082 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:42:49,083 - DEBUG - Cleaned query: 'tsim sha tsui'
2025-06-17 14:42:49,091 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:42:49,121 - INFO - No coupon name matched for query: 'tsim sha tsui'
2025-06-17 14:42:49,122 - DEBUG - Extracted: Category=None, Location={'name': 'Tsim Sha Tsui', 'type': 'selected_area', 'id': '31', 'table': 'kowloon'}, Discount=None, Coupon Name=None
2025-06-17 14:42:49,126 - DEBUG - Final: Query=tsim sha tsui, Category=Food, Location={'name': 'Tsim Sha Tsui', 'type': 'selected_area', 'id': '31', 'table': 'kowloon'}, Coupon Name=None, Discount={'max': 100, 'min': 60}
2025-06-17 14:42:49,130 - DEBUG - Location IDs for Tsim Sha Tsui in kowloon: ['31']
2025-06-17 14:42:49,131 - DEBUG - Searching coupons with selected_area IN ['31'], area = None
2025-06-17 14:42:49,131 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.selected_area IN (%s) AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', '31', 60, 100, 20]
2025-06-17 14:42:49,133 - DEBUG - Found 1 rows
2025-06-17 14:42:49,134 - DEBUG - Valid area IDs for coupon ID 629 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:42:49,135 - DEBUG - Returning 1 coupons for category 'Food', location 'Tsim Sha Tsui'
2025-06-17 14:42:49,136 - DEBUG - Attempting to resolve selected_area: 31, territory: , location_table: kowloon, coupon_area: 2
2025-06-17 14:42:49,138 - DEBUG - Resolved selected_area 31 to Tsim Sha Tsui via kowloon table
2025-06-17 14:42:49,138 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:42:49,139 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:42:49,139 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:42:49,141 - DEBUG - close.started
2025-06-17 14:42:49,145 - DEBUG - close.complete
2025-06-17 14:42:49,146 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:42:49,151 - INFO - Database connection closed
2025-06-17 14:42:49,151 - INFO - 127.0.0.1 - - [17/Jun/2025 14:42:49] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:42:49,174 - INFO - Connected to database
2025-06-17 14:42:50,769 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:42:50,801 - DEBUG - Rendering index with 2 messages
2025-06-17 14:42:50,802 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:42:50,811 - INFO - Database connection closed
2025-06-17 14:42:50,812 - INFO - 127.0.0.1 - - [17/Jun/2025 14:42:50] "GET / HTTP/1.1" 200 -
2025-06-17 14:43:08,857 - INFO - Connected to database
2025-06-17 14:43:10,661 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:43:11,295 - DEBUG - Session cleared via 'clear' action. Starting fresh.
2025-06-17 14:43:11,297 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:43:11,333 - INFO - Database connection closed
2025-06-17 14:43:11,337 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:11] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:43:11,406 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:11] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:43:11,414 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:11] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:43:20,861 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:43:20,898 - INFO - Connected to database
2025-06-17 14:43:22,287 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:43:22,288 - INFO - Database connection closed
2025-06-17 14:43:22,289 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:22] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:43:22,307 - INFO - Connected to database
2025-06-17 14:43:23,927 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:43:23,971 - DEBUG - Rendering index with 1 messages
2025-06-17 14:43:23,974 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:43:23,980 - INFO - Database connection closed
2025-06-17 14:43:23,983 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:23] "GET / HTTP/1.1" 200 -
2025-06-17 14:43:26,437 - INFO - Connected to database
2025-06-17 14:43:28,043 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:43:28,095 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:43:28,106 - INFO - Database connection closed
2025-06-17 14:43:28,106 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:28] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:43:28,113 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:28] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 14:43:28,125 - INFO - 127.0.0.1 - - [17/Jun/2025 14:43:28] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:46:29,466 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 14:46:30,027 - INFO -  * Restarting with stat
2025-06-17 14:46:31,702 - WARNING -  * Debugger is active!
2025-06-17 14:46:31,707 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 14:46:33,859 - INFO - 127.0.0.1 - - [17/Jun/2025 14:46:33] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 14:46:43,900 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 14:46:44,147 - INFO - Connected to database
2025-06-17 14:46:44,736 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 14:46:44,739 - INFO - Database connection closed
2025-06-17 14:46:44,740 - INFO - 127.0.0.1 - - [17/Jun/2025 14:46:44] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 14:46:44,758 - INFO - Connected to database
2025-06-17 14:46:47,319 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:46:47,367 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 14:46:47,369 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 14:46:49,062 - DEBUG - Loading model cost 1.695 seconds.
2025-06-17 14:46:49,063 - DEBUG - Prefix dict has been built successfully.
2025-06-17 14:46:49,065 - DEBUG - Rendering index with 0 messages
2025-06-17 14:46:49,073 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:46:49,096 - INFO - Database connection closed
2025-06-17 14:46:49,097 - INFO - 127.0.0.1 - - [17/Jun/2025 14:46:49] "GET / HTTP/1.1" 200 -
2025-06-17 14:47:02,480 - INFO - Connected to database
2025-06-17 14:47:04,196 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:04,239 - DEBUG - Cleared session messages. Starting fresh for query: food coupons
2025-06-17 14:47:04,241 - DEBUG - Extracting category from query: 'food coupons', words: ['food', 'coupons']
2025-06-17 14:47:04,241 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 14:47:04,250 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:47:04,298 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000252A671BA10>
2025-06-17 14:47:04,298 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000252A62EA840> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:47:04,344 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000252A6783110>
2025-06-17 14:47:04,345 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:47:04,346 - DEBUG - send_request_headers.complete
2025-06-17 14:47:04,347 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:47:04,348 - DEBUG - send_request_body.complete
2025-06-17 14:47:04,349 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:47:04,699 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:17:04 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'106'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499860'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813214'), (b'x-ratelimit-tokens-query-cost', b'140'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'107'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'd51eb64a7734384e685cac7d24d6f412'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=m_AkosOWlP1qkPc8kM8WqW1bhEZ8hku8cwjN47tlnGY-1750151824-1.0.1.1-SC3TdPGj6QSjzz0tG85TPq68UhNh8bhdvMz_6aGlmGn4ZpCXGmn7vwgQFRB8XYM_kUyaBneuJqjKwvgxX6jBi4vz8TqP5YprmRc4TpSJ3Rc; path=/; expires=Tue, 17-Jun-25 09:47:04 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=52.AixRsO9gv8XIRfGW8qjcqreFnXRlPLhaFB9.UVn8-1750151824602-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951173a5fa334728-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:47:04,701 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:47:04,702 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:47:04,703 - DEBUG - receive_response_body.complete
2025-06-17 14:47:04,704 - DEBUG - response_closed.started
2025-06-17 14:47:04,704 - DEBUG - response_closed.complete
2025-06-17 14:47:04,708 - DEBUG - Mistral location analysis: None
2025-06-17 14:47:04,708 - DEBUG - Location candidates: ['food coupons']
2025-06-17 14:47:04,711 - INFO - No valid location matched for query: food coupons
2025-06-17 14:47:04,723 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:47:04,725 - DEBUG - send_request_headers.complete
2025-06-17 14:47:04,725 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:47:04,726 - DEBUG - send_request_body.complete
2025-06-17 14:47:04,726 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:47:05,037 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:17:04 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'93'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499764'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998813118'), (b'x-ratelimit-tokens-query-cost', b'96'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'94'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'098735672d508d5ffebca275e034f55c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951173a84d214728-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:47:05,039 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:47:05,040 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:47:05,042 - DEBUG - receive_response_body.complete
2025-06-17 14:47:05,043 - DEBUG - response_closed.started
2025-06-17 14:47:05,045 - DEBUG - response_closed.complete
2025-06-17 14:47:05,050 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:47:05,053 - DEBUG - Cleaned query: 'food coupons'
2025-06-17 14:47:05,060 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:47:05,074 - INFO - No coupon name matched for query: 'food coupons'
2025-06-17 14:47:05,074 - DEBUG - Extracted: Category=Food, Location=None, Discount=None, Coupon Name=None
2025-06-17 14:47:05,075 - DEBUG - Final: Query=food coupons, Category=Food, Location=None, Coupon Name=None, Discount=None
2025-06-17 14:47:05,077 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20]
2025-06-17 14:47:05,081 - DEBUG - Found 20 rows
2025-06-17 14:47:05,082 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,084 - DEBUG - Valid area IDs for coupon ID 1265 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,086 - DEBUG - Valid area IDs for coupon ID 1261 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,089 - DEBUG - Valid area IDs for coupon ID 1260 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,091 - DEBUG - Valid area IDs for coupon ID 1259 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,092 - DEBUG - Valid area IDs for coupon ID 1258 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,093 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,094 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,095 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,097 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,097 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,098 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,100 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,101 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,102 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,103 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,105 - DEBUG - Valid area IDs for coupon ID 1236 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,108 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:05,109 - DEBUG - Valid area IDs for coupon ID 1234 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,110 - DEBUG - Valid area IDs for coupon ID 1229 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:05,111 - DEBUG - Returning 20 coupons for category 'Food', location 'None'
2025-06-17 14:47:05,112 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,114 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,115 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,115 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,115 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,117 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,117 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,118 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,119 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,121 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,122 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,122 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,122 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,124 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,125 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,125 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,126 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,127 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,128 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,128 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,129 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,130 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,130 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,130 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,131 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,132 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,133 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,133 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,134 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,136 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,137 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,139 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,139 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,142 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,142 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,142 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,143 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,144 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,144 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,145 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,145 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,146 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,147 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,147 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,148 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,149 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,150 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,151 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,151 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,156 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,156 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,157 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,158 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,159 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,160 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,160 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,160 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,161 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,162 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,162 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,163 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,164 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,165 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,165 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,165 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,167 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,167 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,167 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,167 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:05,169 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 14:47:05,169 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:05,170 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:05,170 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,172 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,172 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,173 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,174 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:05,176 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:05,176 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:05,177 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:05,177 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:47:05,177 - DEBUG - close.started
2025-06-17 14:47:05,178 - DEBUG - close.complete
2025-06-17 14:47:05,179 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:05,186 - INFO - Database connection closed
2025-06-17 14:47:05,186 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:05] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:47:05,208 - INFO - Connected to database
2025-06-17 14:47:06,785 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:06,824 - DEBUG - Rendering index with 2 messages
2025-06-17 14:47:06,825 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:06,829 - INFO - Database connection closed
2025-06-17 14:47:06,829 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:06] "GET / HTTP/1.1" 200 -
2025-06-17 14:47:28,113 - INFO - Connected to database
2025-06-17 14:47:29,712 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:29,759 - DEBUG - Cleared session messages. Starting fresh for query: 80% discount
2025-06-17 14:47:29,761 - DEBUG - Extracting category from query: '80% discount', words: ['80%', 'discount']
2025-06-17 14:47:29,762 - INFO - No category matched for query: 80% discount
2025-06-17 14:47:29,772 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 14:47:29,883 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000252A6677D90>
2025-06-17 14:47:29,885 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000252A6751880> server_hostname='api.mistral.ai' timeout=None
2025-06-17 14:47:29,943 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000252A63CCE90>
2025-06-17 14:47:29,944 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:47:29,945 - DEBUG - send_request_headers.complete
2025-06-17 14:47:29,946 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:47:29,949 - DEBUG - send_request_body.complete
2025-06-17 14:47:29,949 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:47:30,244 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:17:30 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'75'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499623'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998812977'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'a9970668fbf569104b897e7743a9202a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=pQXclvZCNPpBueMFzR40sSVZZ2NVGCQxPCN0n6eCRd0-1750151850-1.0.1.1-v.7kQCLMlaye2UpAvFx3UmlFc6utTMeHuXRC4vIQ3.5qzd87SuS1Ax2.jk5a7yTFxXC7eybiEVnmMP5a.aw2mS3IQKhnaKChCboZx0ApqTw; path=/; expires=Tue, 17-Jun-25 09:47:30 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=ecY0ru1Th_o5SDmLq0F6MmLVwi8ffCPDXdo6seINTlk-1750151850163-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95117445e9364bfa-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:47:30,293 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:47:30,294 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:47:30,295 - DEBUG - receive_response_body.complete
2025-06-17 14:47:30,296 - DEBUG - response_closed.started
2025-06-17 14:47:30,296 - DEBUG - response_closed.complete
2025-06-17 14:47:30,298 - DEBUG - Mistral location analysis: None
2025-06-17 14:47:30,300 - DEBUG - Location candidates: ['80% discount', '80%']
2025-06-17 14:47:30,304 - INFO - No valid location matched for query: 80% discount
2025-06-17 14:47:30,304 - DEBUG - Extracted English single/at least discount: min=80%
2025-06-17 14:47:30,315 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 14:47:30,316 - DEBUG - send_request_headers.complete
2025-06-17 14:47:30,317 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 14:47:30,318 - DEBUG - send_request_body.complete
2025-06-17 14:47:30,319 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 14:47:30,599 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:17:30 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'80'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499526'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998812880'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'81'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'6bc8fa0fd712d1363c673f70a8218b73'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951174483bb24bfa-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 14:47:30,601 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 14:47:30,602 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 14:47:30,603 - DEBUG - receive_response_body.complete
2025-06-17 14:47:30,603 - DEBUG - response_closed.started
2025-06-17 14:47:30,604 - DEBUG - response_closed.complete
2025-06-17 14:47:30,606 - DEBUG - Mistral coupon name analysis: None
2025-06-17 14:47:30,606 - DEBUG - Cleaned query: '80%'
2025-06-17 14:47:30,612 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 14:47:30,619 - INFO - No coupon name matched for query: '80% discount'
2025-06-17 14:47:30,620 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 80, 'max': 100}, Coupon Name=None
2025-06-17 14:47:30,621 - DEBUG - Final: Query=80% discount, Category=Food, Location=None, Coupon Name=None, Discount={'min': 80, 'max': 100}
2025-06-17 14:47:30,623 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: ['food', 80, 100, 20]
2025-06-17 14:47:30,627 - DEBUG - Found 20 rows
2025-06-17 14:47:30,629 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,633 - DEBUG - Valid area IDs for coupon ID 997 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,635 - DEBUG - Valid area IDs for coupon ID 966 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,637 - DEBUG - Valid area IDs for coupon ID 965 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,638 - DEBUG - Valid area IDs for coupon ID 889 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,639 - DEBUG - Valid area IDs for coupon ID 862 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,640 - DEBUG - Valid area IDs for coupon ID 728 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,642 - DEBUG - Valid area IDs for coupon ID 727 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,643 - DEBUG - Valid area IDs for coupon ID 726 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,645 - DEBUG - Valid area IDs for coupon ID 725 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:47:30,646 - DEBUG - Valid area IDs for coupon ID 724 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:47:30,647 - DEBUG - Valid area IDs for coupon ID 723 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:47:30,648 - DEBUG - Valid area IDs for coupon ID 722 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,650 - DEBUG - Valid area IDs for coupon ID 721 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,652 - DEBUG - Valid area IDs for coupon ID 720 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 14:47:30,653 - DEBUG - Valid area IDs for coupon ID 681 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,654 - DEBUG - Valid area IDs for coupon ID 629 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,656 - DEBUG - Valid area IDs for coupon ID 628 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,657 - DEBUG - Valid area IDs for coupon ID 620 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 14:47:30,659 - DEBUG - Valid area IDs for coupon ID 444 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 14:47:30,659 - DEBUG - Returning 20 coupons for category 'Food', location 'None'
2025-06-17 14:47:30,660 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,662 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 14:47:30,663 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,666 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,667 - DEBUG - Attempting to resolve selected_area: 27, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,669 - DEBUG - Resolved selected_area 27 to Prince Edward via kowloon table
2025-06-17 14:47:30,670 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,670 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,671 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,673 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:47:30,673 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,674 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,674 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,677 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:47:30,678 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,678 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,680 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,683 - DEBUG - Resolved selected_area 15 to North Point via hong_kong table
2025-06-17 14:47:30,684 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,685 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,686 - DEBUG - Attempting to resolve selected_area: 15, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,691 - DEBUG - Resolved selected_area 15 to North Point via hong_kong table
2025-06-17 14:47:30,692 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,692 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,693 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,694 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,695 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,696 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,696 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,698 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,699 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,699 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,700 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,702 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,702 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,703 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,703 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:47:30,706 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:47:30,706 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:47:30,706 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:47:30,707 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:47:30,708 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:47:30,709 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:47:30,709 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:47:30,710 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 14:47:30,711 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 14:47:30,712 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:47:30,712 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:47:30,713 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,716 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,716 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,717 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,717 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,719 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,719 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,720 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,720 - DEBUG - Attempting to resolve selected_area: 30, territory: , location_table: None, coupon_area: 1
2025-06-17 14:47:30,722 - DEBUG - Resolved selected_area 30 to Central via hong_kong table
2025-06-17 14:47:30,722 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 14:47:30,722 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 14:47:30,723 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,724 - DEBUG - Resolved selected_area 20 to Lai Chi Kok via kowloon table
2025-06-17 14:47:30,724 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,725 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,725 - DEBUG - Attempting to resolve selected_area: 31, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,726 - DEBUG - Resolved selected_area 31 to Tsim Sha Tsui via kowloon table
2025-06-17 14:47:30,727 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,727 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,728 - DEBUG - Attempting to resolve selected_area: 28, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,730 - DEBUG - Resolved selected_area 28 to Mong Kok via kowloon table
2025-06-17 14:47:30,731 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,731 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,731 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 14:47:30,733 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 14:47:30,733 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 14:47:30,734 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 14:47:30,734 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 14:47:30,736 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 14:47:30,737 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 14:47:30,737 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 14:47:30,738 - DEBUG - Added system response. Total messages: 2
2025-06-17 14:47:30,738 - DEBUG - close.started
2025-06-17 14:47:30,740 - DEBUG - close.complete
2025-06-17 14:47:30,740 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:30,747 - INFO - Database connection closed
2025-06-17 14:47:30,747 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:30] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:47:30,767 - INFO - Connected to database
2025-06-17 14:47:32,582 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:32,625 - DEBUG - Rendering index with 2 messages
2025-06-17 14:47:32,627 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:32,637 - INFO - Database connection closed
2025-06-17 14:47:32,637 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:32] "GET / HTTP/1.1" 200 -
2025-06-17 14:47:39,883 - INFO - Connected to database
2025-06-17 14:47:41,776 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:41,963 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 14:47:41,966 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:41,984 - INFO - Database connection closed
2025-06-17 14:47:41,985 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:41] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:47:42,006 - INFO - Connected to database
2025-06-17 14:47:43,659 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:43,690 - DEBUG - Rendering index with 1 messages
2025-06-17 14:47:43,690 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:43,701 - INFO - Database connection closed
2025-06-17 14:47:43,701 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:43] "GET / HTTP/1.1" 200 -
2025-06-17 14:47:55,386 - INFO - Connected to database
2025-06-17 14:47:56,966 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 14:47:57,077 - INFO - Revoked tokens for user ID 1163 during quit
2025-06-17 14:47:57,080 - DEBUG - Using proactor: IocpProactor
2025-06-17 14:47:57,085 - INFO - Database connection closed
2025-06-17 14:47:57,086 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:57] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 14:47:57,098 - INFO - 127.0.0.1 - - [17/Jun/2025 14:47:57] "GET /login HTTP/1.1" 200 -
2025-06-17 15:18:26,540 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 15:18:26,540 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 15:18:26,541 - INFO -  * Restarting with stat
2025-06-17 15:18:27,847 - WARNING -  * Debugger is active!
2025-06-17 15:18:27,850 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 15:19:23,804 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 15:19:23,946 - INFO - Connected to database
2025-06-17 15:19:24,572 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 15:19:24,615 - INFO - Database connection closed
2025-06-17 15:19:24,616 - INFO - 127.0.0.1 - - [17/Jun/2025 15:19:24] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 15:19:24,642 - INFO - Connected to database
2025-06-17 15:19:26,459 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:19:26,498 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 15:19:26,501 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 15:19:27,755 - DEBUG - Loading model cost 1.256 seconds.
2025-06-17 15:19:27,756 - DEBUG - Prefix dict has been built successfully.
2025-06-17 15:19:27,758 - DEBUG - Rendering index with 0 messages
2025-06-17 15:19:27,772 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:19:27,793 - INFO - Database connection closed
2025-06-17 15:19:27,794 - INFO - 127.0.0.1 - - [17/Jun/2025 15:19:27] "GET / HTTP/1.1" 200 -
2025-06-17 15:19:46,409 - INFO - Connected to database
2025-06-17 15:19:48,051 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:19:48,101 - DEBUG - Cleared session messages. Starting fresh for query: coupons forhong kong
2025-06-17 15:19:48,108 - DEBUG - Extracting category from query: 'coupons forhong kong', words: ['coupons', 'forhong', 'kong']
2025-06-17 15:19:48,108 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,109 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,109 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,109 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,110 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,110 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,111 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,111 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,111 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,112 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,112 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,112 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,113 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,113 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,113 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,114 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,115 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,115 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,116 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,117 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,118 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,118 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,121 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:19:48,121 - INFO - No category matched for query: coupons forhong kong
2025-06-17 15:19:48,132 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:19:48,180 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8C02F230>
2025-06-17 15:19:48,180 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001BE8C049640> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:19:48,212 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8C07F610>
2025-06-17 15:19:48,213 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:19:48,213 - DEBUG - send_request_headers.complete
2025-06-17 15:19:48,213 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:19:48,214 - DEBUG - send_request_body.complete
2025-06-17 15:19:48,214 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:19:48,483 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:49:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998808807'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'30967a4de24cfb5fcffe821ff394ea3b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=U5Gz9FSAiq2EInqYyyN0fi5M.E7QoICDPk8qZWhAkNQ-1750153788-1.0.1.1-qS_yjzmSuttNhBsbbfuOzO0ExTnYkdQDIcFptzasTyptFh82oIPgixueHtqztNv9Uzag_lkuHQaNLGkw3Bui5IXxqyiBdASErdXTBoZXu0w; path=/; expires=Tue, 17-Jun-25 10:19:48 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=ZAjaTMEAQ9S_ElXVLlr5d8BJHidtHtBqeJW0F3hCJYI-1750153788415-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a3981ef20029-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:19:48,485 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:19:48,486 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:19:48,488 - DEBUG - receive_response_body.complete
2025-06-17 15:19:48,488 - DEBUG - response_closed.started
2025-06-17 15:19:48,489 - DEBUG - response_closed.complete
2025-06-17 15:19:48,492 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 15:19:48,506 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:19:48,510 - DEBUG - send_request_headers.complete
2025-06-17 15:19:48,510 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:19:48,512 - DEBUG - send_request_body.complete
2025-06-17 15:19:48,512 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:19:48,775 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:49:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499757'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998808708'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'ed499a46f1d98a3dbcb23f37355fef48'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a399edc80029-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:19:48,777 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:19:48,777 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:19:48,779 - DEBUG - receive_response_body.complete
2025-06-17 15:19:48,779 - DEBUG - response_closed.started
2025-06-17 15:19:48,780 - DEBUG - response_closed.complete
2025-06-17 15:19:48,782 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:19:48,784 - DEBUG - Cleaned query: 'coupons forhong kong'
2025-06-17 15:19:48,796 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:19:48,827 - INFO - No coupon name matched for query: 'coupons forhong kong'
2025-06-17 15:19:48,828 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 15:19:48,829 - DEBUG - Final: Query=coupons forhong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 15:19:48,830 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,831 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,831 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 15:19:48,835 - DEBUG - Found 20 rows
2025-06-17 15:19:48,840 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,841 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,842 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,843 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,845 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,845 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,846 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,847 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,848 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,849 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,850 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,853 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,856 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,858 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,859 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,861 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,862 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,863 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,864 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,865 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:19:48,865 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 15:19:48,866 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,868 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,869 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,872 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,873 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,874 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,875 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,875 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,875 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,877 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,878 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,878 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,879 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,880 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,881 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,881 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,882 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,884 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,884 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,884 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,885 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,890 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,890 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,891 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,893 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,894 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,895 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,895 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,895 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,897 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,898 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,899 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,899 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,901 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,901 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,906 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,907 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,909 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,909 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,909 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,910 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,911 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,911 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,912 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,912 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,914 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,915 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,915 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,915 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,917 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,918 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,918 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,922 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,924 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,924 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,925 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,925 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,926 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,927 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,927 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,928 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,929 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,930 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,930 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,930 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,932 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,932 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,932 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,934 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,938 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,939 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,939 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,939 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,941 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,941 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,942 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,942 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:19:48,944 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:19:48,944 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:19:48,944 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:19:48,945 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:19:48,945 - DEBUG - close.started
2025-06-17 15:19:48,946 - DEBUG - close.complete
2025-06-17 15:19:48,947 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:19:48,956 - INFO - Database connection closed
2025-06-17 15:19:48,956 - INFO - 127.0.0.1 - - [17/Jun/2025 15:19:48] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:19:48,976 - INFO - Connected to database
2025-06-17 15:19:50,575 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:19:50,621 - DEBUG - Rendering index with 2 messages
2025-06-17 15:19:50,622 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:19:50,629 - INFO - Database connection closed
2025-06-17 15:19:50,629 - INFO - 127.0.0.1 - - [17/Jun/2025 15:19:50] "GET / HTTP/1.1" 200 -
2025-06-17 15:20:12,348 - INFO - Connected to database
2025-06-17 15:20:14,006 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:20:14,055 - DEBUG - Cleared session messages. Starting fresh for query: kfc coupons
2025-06-17 15:20:14,057 - DEBUG - Extracting category from query: 'kfc coupons', words: ['kfc', 'coupons']
2025-06-17 15:20:14,058 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,058 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,059 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,059 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,059 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,060 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,060 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,060 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,061 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,061 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,061 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,061 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,062 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,062 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,063 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,066 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,067 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,068 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,068 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,069 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,069 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,069 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,070 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,070 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,071 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,071 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,071 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,071 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:20:14,072 - INFO - No category matched for query: kfc coupons
2025-06-17 15:20:14,079 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:20:14,131 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8C07DE50>
2025-06-17 15:20:14,137 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001BE8C049640> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:20:14,172 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8BCCD350>
2025-06-17 15:20:14,173 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:20:14,174 - DEBUG - send_request_headers.complete
2025-06-17 15:20:14,174 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:20:14,174 - DEBUG - send_request_body.complete
2025-06-17 15:20:14,175 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:20:14,462 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:50:14 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'79'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499616'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998808567'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'80'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'5cb01f1d9fd07e5de7bbe042c2dfbe2e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=3Qqs3Tei83APKXdvlGLbIcFp7q1.WOaSDSjd4i6vVe4-1750153814-1.0.1.1-70kcVO7ksOCKfg3AxiHDhHg7MKajuSpzDn9Rjv9sCJ0QrFEExxDSBl55iRRO3GorQ5AaK0n3g61U4qU0ysukE7NCmOKlJOMhfucReYcV2TM; path=/; expires=Tue, 17-Jun-25 10:20:14 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=KTWgRYz61SJB0LQH.abhiJWaqrvJEGfZAbQ34OiojxU-1750153814398-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a43a587e6ccc-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:20:14,464 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:20:14,465 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:20:14,466 - DEBUG - receive_response_body.complete
2025-06-17 15:20:14,466 - DEBUG - response_closed.started
2025-06-17 15:20:14,467 - DEBUG - response_closed.complete
2025-06-17 15:20:14,469 - DEBUG - Mistral location analysis: None
2025-06-17 15:20:14,469 - DEBUG - Location candidates: ['kfc coupons', 'kfc']
2025-06-17 15:20:14,474 - INFO - No valid location matched for query: kfc coupons
2025-06-17 15:20:14,484 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:20:14,486 - DEBUG - send_request_headers.complete
2025-06-17 15:20:14,486 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:20:14,487 - DEBUG - send_request_body.complete
2025-06-17 15:20:14,488 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:20:14,773 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:50:14 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'89'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499519'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998808470'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'89'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'839e8b26cd126026642dd81dc0fedf28'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a43c4b006ccc-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:20:14,774 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:20:14,774 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:20:14,775 - DEBUG - receive_response_body.complete
2025-06-17 15:20:14,776 - DEBUG - response_closed.started
2025-06-17 15:20:14,776 - DEBUG - response_closed.complete
2025-06-17 15:20:14,778 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:20:14,779 - DEBUG - Cleaned query: 'kfc coupons'
2025-06-17 15:20:14,791 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:20:14,803 - INFO - Exact phrase match: 'kfc' -> 'KFC' from coupon
2025-06-17 15:20:14,804 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=KFC
2025-06-17 15:20:14,804 - DEBUG - Final: Query=kfc coupons, Category=None, Location=None, Coupon Name=KFC, Discount=None
2025-06-17 15:20:14,805 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['kfc', 'kfc', 20]
2025-06-17 15:20:14,809 - DEBUG - Found 1 rows
2025-06-17 15:20:14,810 - DEBUG - Valid area IDs for coupon ID 1235 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 15:20:14,811 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 15:20:14,812 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 2
2025-06-17 15:20:14,814 - DEBUG - Resolved selected_area 26 to Kowloon Station via kowloon table
2025-06-17 15:20:14,816 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 15:20:14,817 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 15:20:14,817 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:20:14,818 - DEBUG - close.started
2025-06-17 15:20:14,819 - DEBUG - close.complete
2025-06-17 15:20:14,819 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:20:14,824 - INFO - Database connection closed
2025-06-17 15:20:14,825 - INFO - 127.0.0.1 - - [17/Jun/2025 15:20:14] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:20:14,852 - INFO - Connected to database
2025-06-17 15:20:16,474 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:20:16,512 - DEBUG - Rendering index with 2 messages
2025-06-17 15:20:16,515 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:20:16,521 - INFO - Database connection closed
2025-06-17 15:20:16,522 - INFO - 127.0.0.1 - - [17/Jun/2025 15:20:16] "GET / HTTP/1.1" 200 -
2025-06-17 15:20:30,852 - INFO - Connected to database
2025-06-17 15:20:32,620 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:20:32,666 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 15:20:32,667 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:20:32,674 - INFO - Database connection closed
2025-06-17 15:20:32,675 - INFO - 127.0.0.1 - - [17/Jun/2025 15:20:32] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:20:32,692 - INFO - Connected to database
2025-06-17 15:20:34,322 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:20:34,368 - DEBUG - Rendering index with 1 messages
2025-06-17 15:20:34,369 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:20:34,405 - INFO - Database connection closed
2025-06-17 15:20:34,419 - INFO - 127.0.0.1 - - [17/Jun/2025 15:20:34] "GET / HTTP/1.1" 200 -
2025-06-17 15:23:58,929 - INFO - Connected to database
2025-06-17 15:24:00,521 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:24:00,561 - DEBUG - Cleared session messages. Starting fresh for query: gucci store coupons
2025-06-17 15:24:00,562 - DEBUG - Extracting category from query: 'gucci store coupons', words: ['gucci', 'store', 'coupons']
2025-06-17 15:24:00,562 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,563 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,563 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,564 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,564 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,564 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,566 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,567 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,568 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,568 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,569 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,570 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,570 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,571 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,571 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,572 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,572 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,572 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,573 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,573 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,574 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,574 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,575 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,576 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,576 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,577 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,577 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,578 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,578 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,579 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,580 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,580 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,581 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,581 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,581 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,584 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,584 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,585 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,585 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,586 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,586 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,586 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,587 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,587 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,587 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,588 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,589 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,589 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,590 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,590 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,591 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,592 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,592 - DEBUG - Ignoring word: 'store'
2025-06-17 15:24:00,592 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:24:00,592 - INFO - No category matched for query: gucci store coupons
2025-06-17 15:24:00,603 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:24:00,653 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8F9175C0>
2025-06-17 15:24:00,654 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001BE8BBE5D90> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:24:00,692 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001BE8C042450>
2025-06-17 15:24:00,693 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:24:00,693 - DEBUG - send_request_headers.complete
2025-06-17 15:24:00,694 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:24:00,695 - DEBUG - send_request_body.complete
2025-06-17 15:24:00,695 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:24:01,029 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:54:00 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499858'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998807213'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'f5b04664739de1362ba4145a762afd1b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=endrQ7aIyUQ4k2LV0MeiQonxETqxWYut3Gb2b_o041k-1750154040-1.0.1.1-sZ59VHh4ao.dMXEj8wqH2k_AMMDEtMon5mJQt4zHRAHkHRd7_4BZm_h3y0jYtAby2biQ0zkXRkzaN4UQ4pDd.pxusC2fSQjYjgKttQRc87A; path=/; expires=Tue, 17-Jun-25 10:24:00 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=PwxP8yD187uuUUmDjucw.ntETjMfDghzmQGCKiSWMTM-1750154040914-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a9c20d053bfe-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:24:01,030 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:24:01,031 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:24:01,034 - DEBUG - receive_response_body.complete
2025-06-17 15:24:01,035 - DEBUG - response_closed.started
2025-06-17 15:24:01,035 - DEBUG - response_closed.complete
2025-06-17 15:24:01,037 - DEBUG - Mistral location analysis: None
2025-06-17 15:24:01,039 - DEBUG - Location candidates: ['gucci store coupons', 'gucci store', 'store coupons']
2025-06-17 15:24:01,043 - INFO - No valid location matched for query: gucci store coupons
2025-06-17 15:24:01,053 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:24:01,054 - DEBUG - send_request_headers.complete
2025-06-17 15:24:01,055 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:24:01,055 - DEBUG - send_request_body.complete
2025-06-17 15:24:01,056 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:24:01,605 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:54:01 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499760'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998807115'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'117b3323ba9b7312e300ef7ec47d1609'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511a9c44fb93bfe-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:24:01,606 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:24:01,607 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:24:01,608 - DEBUG - receive_response_body.complete
2025-06-17 15:24:01,609 - DEBUG - response_closed.started
2025-06-17 15:24:01,609 - DEBUG - response_closed.complete
2025-06-17 15:24:01,611 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:24:01,612 - DEBUG - Cleaned query: 'gucci store coupons'
2025-06-17 15:24:01,621 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:24:01,636 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 15:24:01,637 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 15:24:01,638 - DEBUG - Final: Query=gucci store coupons, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 15:24:01,639 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 15:24:01,643 - DEBUG - Found 1 rows
2025-06-17 15:24:01,645 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:24:01,646 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 15:24:01,646 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:24:01,650 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:24:01,653 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:24:01,653 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:24:01,654 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:24:01,655 - DEBUG - close.started
2025-06-17 15:24:01,656 - DEBUG - close.complete
2025-06-17 15:24:01,656 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:24:01,663 - INFO - Database connection closed
2025-06-17 15:24:01,663 - INFO - 127.0.0.1 - - [17/Jun/2025 15:24:01] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:24:01,684 - INFO - Connected to database
2025-06-17 15:24:03,591 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:24:03,630 - DEBUG - Rendering index with 2 messages
2025-06-17 15:24:03,632 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:24:03,639 - INFO - Database connection closed
2025-06-17 15:24:03,639 - INFO - 127.0.0.1 - - [17/Jun/2025 15:24:03] "GET / HTTP/1.1" 200 -
2025-06-17 15:27:03,393 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 15:27:03,893 - INFO -  * Restarting with stat
2025-06-17 15:27:05,939 - WARNING -  * Debugger is active!
2025-06-17 15:27:05,945 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 15:27:09,590 - INFO - 127.0.0.1 - - [17/Jun/2025 15:27:09] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 15:27:09,621 - INFO - 127.0.0.1 - - [17/Jun/2025 15:27:09] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 15:27:15,365 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 15:27:15,711 - INFO - Connected to database
2025-06-17 15:27:16,332 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 15:27:16,334 - INFO - Database connection closed
2025-06-17 15:27:16,335 - INFO - 127.0.0.1 - - [17/Jun/2025 15:27:16] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 15:27:16,351 - INFO - Connected to database
2025-06-17 15:27:18,103 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:27:18,145 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 15:27:18,147 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 15:27:19,422 - DEBUG - Loading model cost 1.277 seconds.
2025-06-17 15:27:19,424 - DEBUG - Prefix dict has been built successfully.
2025-06-17 15:27:19,425 - DEBUG - Rendering index with 0 messages
2025-06-17 15:27:19,439 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:27:19,458 - INFO - Database connection closed
2025-06-17 15:27:19,458 - INFO - 127.0.0.1 - - [17/Jun/2025 15:27:19] "GET / HTTP/1.1" 200 -
2025-06-17 15:28:31,634 - INFO - Connected to database
2025-06-17 15:28:33,364 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:28:33,406 - DEBUG - Cleared session messages. Starting fresh for query: give me hong kong coupons
2025-06-17 15:28:33,409 - DEBUG - Extracting category from query: 'give me hong kong coupons', words: ['give', 'me', 'hong', 'kong', 'coupons']
2025-06-17 15:28:33,410 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,412 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,413 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,413 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,414 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,414 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,415 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,416 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,416 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,417 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,417 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,418 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,418 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,419 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,419 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,420 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,420 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,421 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,421 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,422 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,423 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,423 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,427 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,428 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,429 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,430 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:28:33,430 - INFO - No category matched for query: give me hong kong coupons
2025-06-17 15:28:33,439 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:28:33,499 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BDFAFCB0>
2025-06-17 15:28:33,500 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D0BE035B50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:28:33,544 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BE1A2AD0>
2025-06-17 15:28:33,546 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:28:33,547 - DEBUG - send_request_headers.complete
2025-06-17 15:28:33,547 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:28:33,548 - DEBUG - send_request_body.complete
2025-06-17 15:28:33,549 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:28:33,868 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:58:33 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'102'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499856'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806971'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'103'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'0045be2020ccda34ab46ab677b95c12a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=9xlTOozEg0g9P9_3Y.MvHFI9BN3vlZuy31vH6ZmC80s-1750154313-1.0.1.1-Wjxvnb6A3oZY13b6LRaHargvLb4M5zpRChs4QROKB8Tikt3d591hI3zEJ.8i4G0GGhwnlPRgBfbVWopCuA9CWBhfSE7Acjt_qf4w08AOxnE; path=/; expires=Tue, 17-Jun-25 10:28:33 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=iSmFfIzi30_FTURoyjNtNoAqyuGHkj8YEJhy3dfaR6s-1750154313797-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511b06b696980b5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:28:33,869 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:28:33,870 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:28:33,871 - DEBUG - receive_response_body.complete
2025-06-17 15:28:33,871 - DEBUG - response_closed.started
2025-06-17 15:28:33,872 - DEBUG - response_closed.complete
2025-06-17 15:28:33,874 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 15:28:33,886 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:28:33,887 - DEBUG - send_request_headers.complete
2025-06-17 15:28:33,888 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:28:33,889 - DEBUG - send_request_body.complete
2025-06-17 15:28:33,890 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:28:34,188 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 09:58:34 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499757'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806872'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'86'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'34dc3c32170e073447b7cd2e0d48ba1b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511b06d8bf480b5-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:28:34,190 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:28:34,194 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:28:34,195 - DEBUG - receive_response_body.complete
2025-06-17 15:28:34,196 - DEBUG - response_closed.started
2025-06-17 15:28:34,196 - DEBUG - response_closed.complete
2025-06-17 15:28:34,200 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:28:34,202 - DEBUG - Cleaned query: 'hong kong coupons'
2025-06-17 15:28:34,213 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:28:34,244 - INFO - No coupon name matched for query: 'give me hong kong coupons'
2025-06-17 15:28:34,245 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 15:28:34,246 - DEBUG - Final: Query=give me hong kong coupons, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 15:28:34,247 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,248 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,248 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 15:28:34,252 - DEBUG - Found 20 rows
2025-06-17 15:28:34,253 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,255 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,256 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,259 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,265 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,267 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,272 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,274 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,280 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,281 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,281 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,282 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,283 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,284 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,285 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,286 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,287 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,288 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,289 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,290 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:28:34,295 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 15:28:34,296 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,298 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,298 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,299 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,299 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,300 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,301 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,301 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,302 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,304 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,304 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,304 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,305 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,306 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,307 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,312 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,313 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,315 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,315 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,316 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,316 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,317 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,317 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,317 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,318 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,319 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,319 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,319 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,320 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,321 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,321 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,322 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,322 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,324 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,326 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,329 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,329 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,331 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,332 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,332 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,332 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,333 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,333 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,334 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,335 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,337 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,337 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,338 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,338 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,341 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,344 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,344 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,345 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,347 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,349 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,350 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,350 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,352 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,352 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,352 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,352 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,354 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,354 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,354 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,355 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,357 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,360 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,361 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,363 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,364 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,365 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,365 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,365 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,366 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,367 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,368 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,368 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:28:34,370 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:28:34,370 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:28:34,371 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:28:34,371 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:28:34,372 - DEBUG - close.started
2025-06-17 15:28:34,372 - DEBUG - close.complete
2025-06-17 15:28:34,373 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:28:34,382 - INFO - Database connection closed
2025-06-17 15:28:34,383 - INFO - 127.0.0.1 - - [17/Jun/2025 15:28:34] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:28:34,403 - INFO - Connected to database
2025-06-17 15:28:35,968 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:28:36,016 - DEBUG - Rendering index with 2 messages
2025-06-17 15:28:36,017 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:28:36,023 - INFO - Database connection closed
2025-06-17 15:28:36,024 - INFO - 127.0.0.1 - - [17/Jun/2025 15:28:36] "GET / HTTP/1.1" 200 -
2025-06-17 15:39:01,608 - INFO - Connected to database
2025-06-17 15:39:03,313 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:03,364 - DEBUG - Cleared session messages. Starting fresh for query: coupons for food
2025-06-17 15:39:03,365 - DEBUG - Extracting category from query: 'coupons for food', words: ['coupons', 'for', 'food']
2025-06-17 15:39:03,366 - DEBUG - Ignoring word: 'coupons'
2025-06-17 15:39:03,366 - INFO - Exact category match: 'food' -> 'Food'
2025-06-17 15:39:03,376 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:39:03,415 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BDF73610>
2025-06-17 15:39:03,416 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D0BDBDAF00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:39:03,459 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BDF93950>
2025-06-17 15:39:03,460 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:03,461 - DEBUG - send_request_headers.complete
2025-06-17 15:39:03,461 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:03,462 - DEBUG - send_request_body.complete
2025-06-17 15:39:03,462 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:03,736 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:03 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'71'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499859'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806731'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'72'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'758d164bb7000a4a622c4d7203db0264'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=_PwmoR8TNa0LlEiMbjDXRnyBGw5yi8iabp3U5uITDZM-1750154943-1.0.1.1-YP4Caia5WScOO_dVpKf5P3KDH9NXeUhOCue__bYb4CPSiTlXOQ7z6U58WJ_cEPTsdcTkfR0Rfg5UkuQyeXk5dF6rTVlcVP_rTqlErpEYacQ; path=/; expires=Tue, 17-Jun-25 10:39:03 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=nIjejpLZh6LY4hd3vCMnG57pClgYpUr7hBVDNIVvQus-1750154943666-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511bfcc5f1e80bb-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:03,741 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:03,741 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:03,742 - DEBUG - receive_response_body.complete
2025-06-17 15:39:03,743 - DEBUG - response_closed.started
2025-06-17 15:39:03,743 - DEBUG - response_closed.complete
2025-06-17 15:39:03,745 - DEBUG - Mistral location analysis: None
2025-06-17 15:39:03,746 - DEBUG - Location candidates: ['coupons for food', 'coupons for', 'for food']
2025-06-17 15:39:03,757 - INFO - No valid location matched for query: coupons for food
2025-06-17 15:39:03,767 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:03,770 - DEBUG - send_request_headers.complete
2025-06-17 15:39:03,771 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:03,772 - DEBUG - send_request_body.complete
2025-06-17 15:39:03,773 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:04,070 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:04 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'101'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499762'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806634'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'101'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'558dbe4a85a35b50d6181c5a7138aa0b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511bfce493080bb-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:04,071 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:04,071 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:04,072 - DEBUG - receive_response_body.complete
2025-06-17 15:39:04,073 - DEBUG - response_closed.started
2025-06-17 15:39:04,073 - DEBUG - response_closed.complete
2025-06-17 15:39:04,074 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:39:04,074 - DEBUG - Cleaned query: 'coupons food'
2025-06-17 15:39:04,080 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:39:04,097 - INFO - No coupon name matched for query: 'coupons for food'
2025-06-17 15:39:04,097 - DEBUG - Extracted: Category=Food, Location=None, Discount=None, Coupon Name=None
2025-06-17 15:39:04,097 - DEBUG - Final: Query=coupons for food, Category=Food, Location={'id': '1', 'name': 'Hong Kong', 'type': 'area'}, Coupon Name=None, Discount=None
2025-06-17 15:39:04,099 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,100 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,100 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', '1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 15:39:04,105 - DEBUG - Found 20 rows
2025-06-17 15:39:04,107 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,109 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,110 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,111 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,111 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,112 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,113 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,114 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,115 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,116 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,117 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,119 - DEBUG - Valid area IDs for coupon ID 1236 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,122 - DEBUG - Valid area IDs for coupon ID 1234 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,124 - DEBUG - Valid area IDs for coupon ID 1229 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,125 - DEBUG - Valid area IDs for coupon ID 1194 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,126 - DEBUG - Valid area IDs for coupon ID 1191 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,127 - DEBUG - Valid area IDs for coupon ID 1187 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,128 - DEBUG - Valid area IDs for coupon ID 1186 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,129 - DEBUG - Valid area IDs for coupon ID 1185 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,131 - DEBUG - Valid area IDs for coupon ID 1055 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 15:39:04,131 - DEBUG - Returning 20 coupons for category 'Food', location 'Hong Kong'
2025-06-17 15:39:04,131 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,132 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,132 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,133 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,133 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,137 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,137 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,138 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,139 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,141 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,141 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,142 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,142 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,143 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,143 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,144 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,144 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,145 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,146 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,146 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,146 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,147 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,148 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,148 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,149 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,150 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,152 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,153 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,155 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,157 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,157 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,158 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,158 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,159 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,160 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,161 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,161 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,163 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,163 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,163 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,163 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,165 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,165 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,165 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,166 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,167 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,169 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,169 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,170 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,173 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,174 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,174 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,174 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,176 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,176 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,176 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,177 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,178 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,178 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,178 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,178 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,180 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,180 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,180 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,181 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,182 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,183 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,183 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,184 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,187 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,187 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,188 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,188 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,190 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,191 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,191 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,191 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 15:39:04,192 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 15:39:04,192 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 15:39:04,193 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 15:39:04,193 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:39:04,194 - DEBUG - close.started
2025-06-17 15:39:04,195 - DEBUG - close.complete
2025-06-17 15:39:04,195 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:04,199 - INFO - Database connection closed
2025-06-17 15:39:04,200 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:04] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:39:04,227 - INFO - Connected to database
2025-06-17 15:39:05,754 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:05,798 - DEBUG - Rendering index with 2 messages
2025-06-17 15:39:05,799 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:05,809 - INFO - Database connection closed
2025-06-17 15:39:05,809 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:05] "GET / HTTP/1.1" 200 -
2025-06-17 15:39:22,965 - INFO - Connected to database
2025-06-17 15:39:24,668 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:24,719 - DEBUG - Cleared session messages. Starting fresh for query: coupon with 20% discount
2025-06-17 15:39:24,720 - DEBUG - Extracting category from query: 'coupon with 20% discount', words: ['coupon', 'with', '20%', 'discount']
2025-06-17 15:39:24,721 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,721 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,722 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,723 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,723 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,724 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,724 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,725 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,725 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,726 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,726 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,727 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,727 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,728 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,729 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,729 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,733 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,734 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,735 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,735 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,737 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,737 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,738 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,739 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,739 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:24,740 - INFO - No category matched for query: coupon with 20% discount
2025-06-17 15:39:24,753 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:39:24,793 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BE1808A0>
2025-06-17 15:39:24,794 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D0BDBDAF00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:39:24,839 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0C194DD90>
2025-06-17 15:39:24,840 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:24,840 - DEBUG - send_request_headers.complete
2025-06-17 15:39:24,841 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:24,841 - DEBUG - send_request_body.complete
2025-06-17 15:39:24,842 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:25,132 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'95'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806489'), (b'x-ratelimit-tokens-query-cost', b'145'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'96'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'0419b00a18b6c840d1da455776246649'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=r.RCd7sq0bDuVVNagdeXgHkEOl3DesjDHC3wJXmUI.0-1750154965-1.0.1.1-H1TdNfPBic9kZQyKH1dpWBwb3v1XyDDuvR7oI.MRHytnN_IynSXAeeteWEXesVOPv1CE2ESEsy6fFq.TNvFj9qHxKVnBxtaMEYZDM6XafH0; path=/; expires=Tue, 17-Jun-25 10:39:25 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=1ZqLmmBQFHDGcBY66p7yUC0T91x71nfKF3VfoVpv.rA-1750154965063-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c051fb336f00-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:25,135 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:25,136 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:25,137 - DEBUG - receive_response_body.complete
2025-06-17 15:39:25,137 - DEBUG - response_closed.started
2025-06-17 15:39:25,138 - DEBUG - response_closed.complete
2025-06-17 15:39:25,139 - DEBUG - Mistral location analysis: None
2025-06-17 15:39:25,140 - DEBUG - Location candidates: ['coupon with 20% discount', 'coupon with 20%', 'coupon with', 'with 20% discount', 'with 20%', 'with', '20% discount', '20%']
2025-06-17 15:39:25,159 - INFO - No valid location matched for query: coupon with 20% discount
2025-06-17 15:39:25,160 - DEBUG - Extracted English single/at least discount: min=20%
2025-06-17 15:39:25,172 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:25,173 - DEBUG - send_request_headers.complete
2025-06-17 15:39:25,173 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:25,174 - DEBUG - send_request_body.complete
2025-06-17 15:39:25,175 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:25,737 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499516'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806388'), (b'x-ratelimit-tokens-query-cost', b'101'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'7'), (b'x-kong-request-id', b'51a8736c4ff46d1f8524341d31209a0e'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c0540d056f00-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:25,739 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:25,739 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:25,740 - DEBUG - receive_response_body.complete
2025-06-17 15:39:25,741 - DEBUG - response_closed.started
2025-06-17 15:39:25,741 - DEBUG - response_closed.complete
2025-06-17 15:39:25,744 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:39:25,744 - DEBUG - Cleaned query: 'coupon with 20%'
2025-06-17 15:39:25,753 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 15:39:25,775 - INFO - Fuzzy coupon name match: 'coupon' -> 'Coupon 9' from coupon
2025-06-17 15:39:25,777 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 20, 'max': 100}, Coupon Name=Coupon 9
2025-06-17 15:39:25,778 - DEBUG - Final: Query=coupon with 20% discount, Category=Food, Location=None, Coupon Name=Coupon 9, Discount={'min': 20, 'max': 100}
2025-06-17 15:39:25,779 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.percentage >= %s AND c.percentage <= %s AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20, 100, 'coupon 9', 'coupon 9', 20]
2025-06-17 15:39:25,784 - DEBUG - Found 0 rows
2025-06-17 15:39:25,784 - DEBUG - Returning 0 coupons for category 'Food', location 'None'
2025-06-17 15:39:25,785 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:39:25,786 - DEBUG - close.started
2025-06-17 15:39:25,787 - DEBUG - close.complete
2025-06-17 15:39:25,788 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:25,794 - INFO - Database connection closed
2025-06-17 15:39:25,795 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:25] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:39:25,819 - INFO - Connected to database
2025-06-17 15:39:27,438 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:27,486 - DEBUG - Rendering index with 2 messages
2025-06-17 15:39:27,487 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:27,493 - INFO - Database connection closed
2025-06-17 15:39:27,494 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:27] "GET / HTTP/1.1" 200 -
2025-06-17 15:39:39,718 - INFO - Connected to database
2025-06-17 15:39:41,352 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:41,407 - DEBUG - Cleared session messages. Starting fresh for query: coupon 9
2025-06-17 15:39:41,409 - DEBUG - Extracting category from query: 'coupon 9', words: ['coupon', '9']
2025-06-17 15:39:41,409 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,428 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,431 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,440 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,449 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,457 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,566 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,580 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,581 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,582 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,582 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,583 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,583 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,584 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,597 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,606 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,726 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,738 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,756 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,774 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,774 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,797 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,854 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,881 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,886 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,892 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,896 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,896 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:41,897 - INFO - No category matched for query: coupon 9
2025-06-17 15:39:41,905 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:39:42,022 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0C194D040>
2025-06-17 15:39:42,023 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D0BE0D5BE0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:39:42,055 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0C194D150>
2025-06-17 15:39:42,056 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:42,057 - DEBUG - send_request_headers.complete
2025-06-17 15:39:42,057 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:42,058 - DEBUG - send_request_body.complete
2025-06-17 15:39:42,058 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:42,319 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:42 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'69'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499375'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806247'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'70'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'b53d6b56f3e6c2351f97ba5a872d476a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=4DSXJdqHKmfERxBMB4Q_fT_xBgpihzxXDVTEzXkFMEw-1750154982-1.0.1.1-e0yarCA9KZoBYnrhCItFW3KFRvg4tQ1BU9HkDAX4vPERvX291JdUMzFyx0tfP_0ulbe2.qMTo.WeT8qjpqd0FKTAxLJOxaZ19Ox.A.nwOt4; path=/; expires=Tue, 17-Jun-25 10:39:42 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=rP2350NsT3DfghDC9_0hh0ZH_UBXHuuD0NdrIByqUcM-1750154982253-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c0bd9c190e67-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:42,321 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:42,321 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:42,322 - DEBUG - receive_response_body.complete
2025-06-17 15:39:42,323 - DEBUG - response_closed.started
2025-06-17 15:39:42,323 - DEBUG - response_closed.complete
2025-06-17 15:39:42,325 - DEBUG - Mistral location analysis: None
2025-06-17 15:39:42,326 - DEBUG - Location candidates: ['coupon 9', '9']
2025-06-17 15:39:42,329 - INFO - No valid location matched for query: coupon 9
2025-06-17 15:39:42,338 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:42,339 - DEBUG - send_request_headers.complete
2025-06-17 15:39:42,340 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:42,341 - DEBUG - send_request_body.complete
2025-06-17 15:39:42,341 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:42,612 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:42 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'80'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499278'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806150'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'81'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'c89fb346fc03fe1d1240465831e57f06'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c0bf5df20e67-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:42,613 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:42,614 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:42,615 - DEBUG - receive_response_body.complete
2025-06-17 15:39:42,616 - DEBUG - response_closed.started
2025-06-17 15:39:42,617 - DEBUG - response_closed.complete
2025-06-17 15:39:42,619 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:39:42,619 - DEBUG - Cleaned query: 'coupon 9'
2025-06-17 15:39:42,620 - DEBUG - Preserved coupon name: 'Coupon 9'
2025-06-17 15:39:42,621 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Coupon 9
2025-06-17 15:39:42,621 - DEBUG - Final: Query=coupon 9, Category=Food, Location=None, Coupon Name=Coupon 9, Discount={'max': 100, 'min': 20}
2025-06-17 15:39:42,625 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND TRIM(LOWER(cat.name_en)) = %s AND c.percentage >= %s AND c.percentage <= %s AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['food', 20, 100, 'coupon 9', 'coupon 9', 20]
2025-06-17 15:39:42,636 - DEBUG - Found 0 rows
2025-06-17 15:39:42,636 - DEBUG - Returning 0 coupons for category 'Food', location 'None'
2025-06-17 15:39:42,637 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:39:42,638 - DEBUG - close.started
2025-06-17 15:39:42,639 - DEBUG - close.complete
2025-06-17 15:39:42,639 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:42,648 - INFO - Database connection closed
2025-06-17 15:39:42,648 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:42] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:39:42,666 - INFO - Connected to database
2025-06-17 15:39:44,258 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:44,304 - DEBUG - Rendering index with 2 messages
2025-06-17 15:39:44,305 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:44,315 - INFO - Database connection closed
2025-06-17 15:39:44,316 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:44] "GET / HTTP/1.1" 200 -
2025-06-17 15:39:48,414 - INFO - Connected to database
2025-06-17 15:39:50,020 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:50,063 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 15:39:50,064 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:50,071 - INFO - Database connection closed
2025-06-17 15:39:50,071 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:50] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:39:50,089 - INFO - Connected to database
2025-06-17 15:39:51,721 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:51,772 - DEBUG - Rendering index with 1 messages
2025-06-17 15:39:51,773 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:51,798 - INFO - Database connection closed
2025-06-17 15:39:51,799 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:51] "GET / HTTP/1.1" 200 -
2025-06-17 15:39:57,121 - INFO - Connected to database
2025-06-17 15:39:58,853 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:39:58,916 - DEBUG - Cleared session messages. Starting fresh for query: coupon 9
2025-06-17 15:39:58,922 - DEBUG - Extracting category from query: 'coupon 9', words: ['coupon', '9']
2025-06-17 15:39:58,953 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,954 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,955 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,959 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,968 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,970 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,972 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:58,988 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,002 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,005 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,014 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,016 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,017 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,017 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,018 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,018 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,019 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,019 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,020 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,020 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,021 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,021 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,022 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,022 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,024 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,025 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,026 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,027 - DEBUG - Ignoring word: 'coupon'
2025-06-17 15:39:59,027 - INFO - No category matched for query: coupon 9
2025-06-17 15:39:59,036 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 15:39:59,066 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BE18B250>
2025-06-17 15:39:59,111 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D0BE035B50> server_hostname='api.mistral.ai' timeout=None
2025-06-17 15:39:59,146 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D0BE18B450>
2025-06-17 15:39:59,147 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:59,148 - DEBUG - send_request_headers.complete
2025-06-17 15:39:59,148 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:59,149 - DEBUG - send_request_body.complete
2025-06-17 15:39:59,149 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:59,430 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:59 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499137'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998806009'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'53'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'ac62b963633e373bd591ee1486265514'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=YjYktIGdqRYhWVOpZgaYw0JeHLl1wjBI5WR.dUFqCfw-1750154999-1.0.1.1-NJDtpYku26PTZb7btmNvBVu_1_32I.UNBDwTDIqp6KLWlYcUR21ByAy_g7Z3gcYX8urJCr60n6u7nJsQzPoCfBjLL3YwvUFrrQMgdSlc.bU; path=/; expires=Tue, 17-Jun-25 10:39:59 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=0VElvKf82GwhPg7aBWZMbDPlX7iAdGUNf3CrDlpPMfk-1750154999350-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c1285e37ff74-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:59,431 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:59,431 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:59,432 - DEBUG - receive_response_body.complete
2025-06-17 15:39:59,433 - DEBUG - response_closed.started
2025-06-17 15:39:59,433 - DEBUG - response_closed.complete
2025-06-17 15:39:59,435 - DEBUG - Mistral location analysis: None
2025-06-17 15:39:59,436 - DEBUG - Location candidates: ['coupon 9', '9']
2025-06-17 15:39:59,441 - INFO - No valid location matched for query: coupon 9
2025-06-17 15:39:59,452 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 15:39:59,453 - DEBUG - send_request_headers.complete
2025-06-17 15:39:59,454 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 15:39:59,455 - DEBUG - send_request_body.complete
2025-06-17 15:39:59,455 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 15:39:59,730 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 10:09:59 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'79'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499040'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998805912'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'52'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'80'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'd130cd482d270a3122b22a1717b10224'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9511c12a4e58ff74-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 15:39:59,731 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 15:39:59,732 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 15:39:59,733 - DEBUG - receive_response_body.complete
2025-06-17 15:39:59,734 - DEBUG - response_closed.started
2025-06-17 15:39:59,734 - DEBUG - response_closed.complete
2025-06-17 15:39:59,737 - DEBUG - Mistral coupon name analysis: None
2025-06-17 15:39:59,737 - DEBUG - Cleaned query: 'coupon 9'
2025-06-17 15:39:59,738 - DEBUG - Preserved coupon name: 'Coupon 9'
2025-06-17 15:39:59,738 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Coupon 9
2025-06-17 15:39:59,741 - DEBUG - Final: Query=coupon 9, Category=None, Location=None, Coupon Name=Coupon 9, Discount=None
2025-06-17 15:39:59,742 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['coupon 9', 'coupon 9', 20]
2025-06-17 15:39:59,747 - DEBUG - Found 1 rows
2025-06-17 15:39:59,749 - DEBUG - Valid area IDs for coupon ID 104 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 15:39:59,750 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 15:39:59,750 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 15:39:59,753 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 15:39:59,753 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 15:39:59,754 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 15:39:59,755 - DEBUG - Added system response. Total messages: 2
2025-06-17 15:39:59,755 - DEBUG - close.started
2025-06-17 15:39:59,757 - DEBUG - close.complete
2025-06-17 15:39:59,758 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:39:59,766 - INFO - Database connection closed
2025-06-17 15:39:59,767 - INFO - 127.0.0.1 - - [17/Jun/2025 15:39:59] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 15:39:59,793 - INFO - Connected to database
2025-06-17 15:40:01,843 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 15:40:01,883 - DEBUG - Rendering index with 2 messages
2025-06-17 15:40:01,885 - DEBUG - Using proactor: IocpProactor
2025-06-17 15:40:01,893 - INFO - Database connection closed
2025-06-17 15:40:01,894 - INFO - 127.0.0.1 - - [17/Jun/2025 15:40:01] "GET / HTTP/1.1" 200 -
2025-06-17 16:02:56,193 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\extract_coupon_to_json.py', reloading
2025-06-17 16:02:56,321 - INFO -  * Restarting with stat
2025-06-17 16:02:57,298 - WARNING -  * Debugger is active!
2025-06-17 16:02:57,300 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:02:59,356 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\extract_coupon_to_json.py', reloading
2025-06-17 16:02:59,461 - INFO -  * Restarting with stat
2025-06-17 16:03:00,451 - WARNING -  * Debugger is active!
2025-06-17 16:03:00,454 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:03:05,560 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\extract_coupon_to_json.py', reloading
2025-06-17 16:03:05,656 - INFO -  * Restarting with stat
2025-06-17 16:03:06,639 - WARNING -  * Debugger is active!
2025-06-17 16:03:06,642 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:20,005 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:20,216 - INFO -  * Restarting with stat
2025-06-17 16:07:21,339 - WARNING -  * Debugger is active!
2025-06-17 16:07:21,342 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:34,573 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:34,671 - INFO -  * Restarting with stat
2025-06-17 16:07:35,756 - WARNING -  * Debugger is active!
2025-06-17 16:07:35,759 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:38,823 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:38,936 - INFO -  * Restarting with stat
2025-06-17 16:07:39,997 - WARNING -  * Debugger is active!
2025-06-17 16:07:40,000 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:43,061 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:43,180 - INFO -  * Restarting with stat
2025-06-17 16:07:44,427 - WARNING -  * Debugger is active!
2025-06-17 16:07:44,429 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:45,479 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:45,581 - INFO -  * Restarting with stat
2025-06-17 16:07:46,611 - WARNING -  * Debugger is active!
2025-06-17 16:07:46,613 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:51,710 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:51,821 - INFO -  * Restarting with stat
2025-06-17 16:07:52,962 - WARNING -  * Debugger is active!
2025-06-17 16:07:52,966 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:07:55,021 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:07:55,119 - INFO -  * Restarting with stat
2025-06-17 16:07:56,348 - WARNING -  * Debugger is active!
2025-06-17 16:07:56,351 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:08:03,474 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:08:03,583 - INFO -  * Restarting with stat
2025-06-17 16:08:04,764 - WARNING -  * Debugger is active!
2025-06-17 16:08:04,769 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:08:05,817 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 16:08:05,936 - INFO -  * Restarting with stat
2025-06-17 16:08:07,106 - WARNING -  * Debugger is active!
2025-06-17 16:08:07,109 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:20:41,679 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\generate_token_and_update.py', reloading
2025-06-17 16:20:41,800 - INFO -  * Restarting with stat
2025-06-17 16:20:42,823 - WARNING -  * Debugger is active!
2025-06-17 16:20:42,826 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:32:34,093 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 16:32:34,093 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 16:32:34,095 - INFO -  * Restarting with stat
2025-06-17 16:32:35,080 - WARNING -  * Debugger is active!
2025-06-17 16:32:35,084 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:32:41,673 - INFO - 127.0.0.1 - - [17/Jun/2025 16:32:41] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 16:32:41,686 - INFO - 127.0.0.1 - - [17/Jun/2025 16:32:41] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 16:32:47,963 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 16:32:48,279 - INFO - Connected to database
2025-06-17 16:32:48,617 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 16:32:48,618 - INFO - Database connection closed
2025-06-17 16:32:48,619 - INFO - 127.0.0.1 - - [17/Jun/2025 16:32:48] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 16:32:48,633 - INFO - Connected to database
2025-06-17 16:32:50,014 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:32:50,037 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 16:32:50,039 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 16:32:50,909 - DEBUG - Loading model cost 0.872 seconds.
2025-06-17 16:32:50,911 - DEBUG - Prefix dict has been built successfully.
2025-06-17 16:32:50,912 - DEBUG - Rendering index with 0 messages
2025-06-17 16:32:50,917 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:32:50,937 - INFO - Database connection closed
2025-06-17 16:32:50,938 - INFO - 127.0.0.1 - - [17/Jun/2025 16:32:50] "GET / HTTP/1.1" 200 -
2025-06-17 16:33:24,059 - INFO - Connected to database
2025-06-17 16:33:25,425 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:33:25,461 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 16:33:25,463 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 16:33:25,463 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,463 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,464 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,465 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,466 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,467 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,468 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,469 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,469 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,469 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,469 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:25,469 - INFO - No category matched for query: coupons for hong kong
2025-06-17 16:33:25,476 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:33:25,566 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B07BDFCB0>
2025-06-17 16:33:25,567 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000029B07846F00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:33:25,606 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B07D5AD50>
2025-06-17 16:33:25,607 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:33:25,608 - DEBUG - send_request_headers.complete
2025-06-17 16:33:25,609 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:33:25,609 - DEBUG - send_request_body.complete
2025-06-17 16:33:25,610 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:33:25,897 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:03:25 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'77'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998804364'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'78'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'c0e8d630dd9e5d3e6bcec77fa66e8c25'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=cMrp919yLKAk7JyzHkAXp_hFW30jHkDi_v3ziQPUGfE-1750158205-1.0.1.1-kayysMRfdoFnqQe8sB.IhxeAguYJXRcY0M44_dGS4.wagiZLrrha4kn1g1hGyNQz6m.Nayk3QN0DmCSeue8hk.SpycZ.ctI1jbDeQyCFxo4; path=/; expires=Tue, 17-Jun-25 11:33:25 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=usa8rD9xmOXGu6MLfPDhnHfsSpheww6KPo9JXi31ye4-1750158205809-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95120f70be59418c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:33:25,898 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:33:25,899 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:33:25,900 - DEBUG - receive_response_body.complete
2025-06-17 16:33:25,900 - DEBUG - response_closed.started
2025-06-17 16:33:25,901 - DEBUG - response_closed.complete
2025-06-17 16:33:25,903 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 16:33:25,913 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:33:25,914 - DEBUG - send_request_headers.complete
2025-06-17 16:33:25,915 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:33:25,916 - DEBUG - send_request_body.complete
2025-06-17 16:33:25,917 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:33:26,241 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:03:26 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'120'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998804266'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'121'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'aeab5a6b76e5fa3370d9ed6e2dacc474'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95120f72a948418c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:33:26,243 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:33:26,244 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:33:26,245 - DEBUG - receive_response_body.complete
2025-06-17 16:33:26,246 - DEBUG - response_closed.started
2025-06-17 16:33:26,246 - DEBUG - response_closed.complete
2025-06-17 16:33:26,248 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:33:26,255 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 16:33:26,261 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 16:33:26,297 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 16:33:26,298 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 16:33:26,299 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 16:33:26,300 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,301 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,301 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 16:33:26,306 - DEBUG - Found 20 rows
2025-06-17 16:33:26,308 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,309 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,310 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,312 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,313 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,315 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,317 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,319 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,320 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,321 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,322 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,323 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,324 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,324 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,325 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,326 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,328 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,329 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,330 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,330 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:33:26,331 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 16:33:26,331 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,332 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,333 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,333 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,333 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,335 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,335 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,335 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,335 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,336 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,337 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,337 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,337 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,338 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,338 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,338 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,339 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,340 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,340 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,340 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,341 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,342 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,342 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,343 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,343 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,345 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,345 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,345 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,345 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,347 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,347 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,347 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,347 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,349 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,349 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,349 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,349 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,350 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,351 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,351 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,351 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,352 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,352 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,352 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,352 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,353 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,353 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,354 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,354 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,356 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,356 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,356 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,357 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,358 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,358 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,358 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,359 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,360 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,361 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,361 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,361 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,362 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,363 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,363 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,363 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,364 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,364 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,365 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,365 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,366 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,366 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,366 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,366 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,367 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,368 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,368 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,368 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:33:26,369 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:33:26,369 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:33:26,369 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:33:26,370 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:33:26,370 - DEBUG - close.started
2025-06-17 16:33:26,370 - DEBUG - close.complete
2025-06-17 16:33:26,370 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:33:26,377 - INFO - Database connection closed
2025-06-17 16:33:26,377 - INFO - 127.0.0.1 - - [17/Jun/2025 16:33:26] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:33:26,391 - INFO - Connected to database
2025-06-17 16:33:27,713 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:33:27,750 - DEBUG - Rendering index with 2 messages
2025-06-17 16:33:27,751 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:33:27,756 - INFO - Database connection closed
2025-06-17 16:33:27,758 - INFO - 127.0.0.1 - - [17/Jun/2025 16:33:27] "GET / HTTP/1.1" 200 -
2025-06-17 16:33:42,928 - INFO - Connected to database
2025-06-17 16:33:44,278 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:33:44,314 - DEBUG - Cleared session messages. Starting fresh for query: coupons for new territories
2025-06-17 16:33:44,316 - DEBUG - Extracting category from query: 'coupons for new territories', words: ['coupons', 'for', 'new', 'territories']
2025-06-17 16:33:44,316 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,317 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,317 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,317 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,318 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,318 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,318 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,319 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,319 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,320 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,320 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,320 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,321 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,321 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,321 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,322 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,322 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,322 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,322 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,323 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,323 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,323 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,324 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,324 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,324 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,324 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,324 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,325 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:33:44,325 - INFO - No category matched for query: coupons for new territories
2025-06-17 16:33:44,330 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:33:44,445 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B07AE7890>
2025-06-17 16:33:44,445 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000029B07C1DD00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:33:44,478 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B07B73A80>
2025-06-17 16:33:44,479 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:33:44,480 - DEBUG - send_request_headers.complete
2025-06-17 16:33:44,481 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:33:44,482 - DEBUG - send_request_body.complete
2025-06-17 16:33:44,483 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:33:44,799 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:03:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'83'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998804124'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'5252d51638ed6149fbf0a82904a34b2d'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=yBFWif38hysjGMqKSjJtj4KepkFbwHwrkzBkmPKjLkw-1750158224-1.0.1.1-ry_il1k2LIqsLPyle3dRge1QJk9LUY6MJox4cT_pjpnwq1iqFDkoi5DQKXUoV.DEZ_uk5uhGqM33kY4sHKllgKNjKcIdhVOMEqpxqO1T.5g; path=/; expires=Tue, 17-Jun-25 11:33:44 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=l0omDQo_aRz2OvCZX5_BR3Jc4Hptt1K7a_CQy2MbRzc-1750158224699-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95120fe6be3f482c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:33:44,803 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:33:44,804 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:33:44,805 - DEBUG - receive_response_body.complete
2025-06-17 16:33:44,808 - DEBUG - response_closed.started
2025-06-17 16:33:44,809 - DEBUG - response_closed.complete
2025-06-17 16:33:44,812 - DEBUG - Mistral location analysis: None
2025-06-17 16:33:44,813 - DEBUG - Location candidates: ['coupons for new territories', 'coupons for new', 'coupons for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 16:33:44,823 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 16:33:44,831 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:33:44,832 - DEBUG - send_request_headers.complete
2025-06-17 16:33:44,833 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:33:44,835 - DEBUG - send_request_body.complete
2025-06-17 16:33:44,835 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:33:45,108 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:03:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499519'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998804026'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'd8112030d9c621496f7cd8226821e622'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95120fe8e893482c-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:33:45,110 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:33:45,110 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:33:45,112 - DEBUG - receive_response_body.complete
2025-06-17 16:33:45,113 - DEBUG - response_closed.started
2025-06-17 16:33:45,113 - DEBUG - response_closed.complete
2025-06-17 16:33:45,115 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:33:45,115 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 16:33:45,122 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 16:33:45,154 - INFO - No coupon name matched for query: 'coupons for new territories'
2025-06-17 16:33:45,155 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 16:33:45,155 - DEBUG - Final: Query=coupons for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 16:33:45,157 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,158 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,159 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 16:33:45,166 - DEBUG - Found 20 rows
2025-06-17 16:33:45,168 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,169 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,171 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,174 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,176 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,178 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,180 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,182 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,183 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,184 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,187 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,188 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,190 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,192 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,194 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,196 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,197 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,198 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,200 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,202 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:33:45,202 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 16:33:45,203 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,205 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:33:45,205 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,205 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,206 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,208 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:33:45,208 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,209 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,209 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,211 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 16:33:45,211 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,211 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,212 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,213 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 16:33:45,214 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,214 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,214 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,216 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 16:33:45,216 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,216 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,217 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,218 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:33:45,219 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,219 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,219 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,221 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 16:33:45,222 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,222 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,222 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,223 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 16:33:45,224 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,224 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,224 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,225 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:33:45,225 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,226 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,226 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,227 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:33:45,228 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,228 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,228 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,230 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:33:45,230 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,230 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,230 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,232 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:33:45,232 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,232 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,232 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,234 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:33:45,235 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,235 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,236 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,237 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:33:45,238 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,238 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,238 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,239 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:33:45,240 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,240 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,240 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,242 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:33:45,242 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,242 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,242 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,244 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:33:45,244 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,244 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,245 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,246 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:33:45,246 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,246 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,247 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,248 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:33:45,248 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,248 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,249 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:33:45,250 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:33:45,251 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:33:45,251 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:33:45,251 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:33:45,252 - DEBUG - close.started
2025-06-17 16:33:45,252 - DEBUG - close.complete
2025-06-17 16:33:45,253 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:33:45,261 - INFO - Database connection closed
2025-06-17 16:33:45,262 - INFO - 127.0.0.1 - - [17/Jun/2025 16:33:45] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:33:45,280 - INFO - Connected to database
2025-06-17 16:33:46,501 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:33:46,532 - DEBUG - Rendering index with 2 messages
2025-06-17 16:33:46,534 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:33:46,540 - INFO - Database connection closed
2025-06-17 16:33:46,540 - INFO - 127.0.0.1 - - [17/Jun/2025 16:33:46] "GET / HTTP/1.1" 200 -
2025-06-17 16:34:40,901 - INFO - Connected to database
2025-06-17 16:34:42,175 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:34:42,211 - DEBUG - Cleared session messages. Starting fresh for query: coupon 754
2025-06-17 16:34:42,213 - DEBUG - Extracting category from query: 'coupon 754', words: ['coupon', '754']
2025-06-17 16:34:42,213 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,213 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,213 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,214 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,214 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,214 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,215 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,215 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,215 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,215 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,216 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,216 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,216 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,216 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,217 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,217 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,217 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,217 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,218 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,218 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,218 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,218 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,219 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,219 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,220 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,220 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,220 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,220 - DEBUG - Ignoring word: 'coupon'
2025-06-17 16:34:42,221 - INFO - No category matched for query: coupon 754
2025-06-17 16:34:42,227 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:34:42,339 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B0B4FC9D0>
2025-06-17 16:34:42,340 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x0000029B07C1DD00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:34:42,392 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000029B07D8DEB0>
2025-06-17 16:34:42,393 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:34:42,394 - DEBUG - send_request_headers.complete
2025-06-17 16:34:42,395 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:34:42,396 - DEBUG - send_request_body.complete
2025-06-17 16:34:42,396 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:34:42,706 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:04:42 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'93'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803883'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'94'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'b2523d600126a227f34ed748bf15786a'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=Q4GSYSlsOXWxz73Up5OyIl6MaidPW8.ICt_EkF0ApvA-1750158282-1.0.1.1-OpkzpoGBikVwjI_B1jGdo7gUwHwiuA1a.dv9gW5HWGDaCNX_Zg1OAmKlpOoPBokAyXf93ZrQWdPrY_GO5B11YJECvasp0buLDh3CVsjdLws; path=/; expires=Tue, 17-Jun-25 11:34:42 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=mVtwVtFInFmaYy4Z22jh2qHoJ9_Y6qqTKVmz5mWvMyY-1750158282622-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95121150be01c1ac-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:34:42,709 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:34:42,709 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:34:42,711 - DEBUG - receive_response_body.complete
2025-06-17 16:34:42,712 - DEBUG - response_closed.started
2025-06-17 16:34:42,712 - DEBUG - response_closed.complete
2025-06-17 16:34:42,717 - DEBUG - Mistral location analysis: None
2025-06-17 16:34:42,718 - DEBUG - Location candidates: ['coupon 754', '754']
2025-06-17 16:34:42,722 - INFO - No valid location matched for query: coupon 754
2025-06-17 16:34:42,734 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:34:42,735 - DEBUG - send_request_headers.complete
2025-06-17 16:34:42,736 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:34:42,737 - DEBUG - send_request_body.complete
2025-06-17 16:34:42,737 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:34:43,057 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:04:42 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'82'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803784'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'84'), (b'x-kong-proxy-latency', b'11'), (b'x-kong-request-id', b'28c980549212507ffbb1a72b1a343312'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'95121152cfecc1ac-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:34:43,058 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:34:43,059 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:34:43,060 - DEBUG - receive_response_body.complete
2025-06-17 16:34:43,061 - DEBUG - response_closed.started
2025-06-17 16:34:43,062 - DEBUG - response_closed.complete
2025-06-17 16:34:43,065 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:34:43,066 - DEBUG - Cleaned query: 'coupon 754'
2025-06-17 16:34:43,067 - DEBUG - Preserved coupon name: 'Coupon 754'
2025-06-17 16:34:43,068 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Coupon 754
2025-06-17 16:34:43,070 - DEBUG - Final: Query=coupon 754, Category=None, Location=None, Coupon Name=Coupon 754, Discount=None
2025-06-17 16:34:43,074 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['coupon 754', 'coupon 754', 20]
2025-06-17 16:34:43,078 - DEBUG - Found 1 rows
2025-06-17 16:34:43,080 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:34:43,081 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 16:34:43,082 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:34:43,084 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:34:43,085 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:34:43,085 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:34:43,086 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:34:43,087 - DEBUG - close.started
2025-06-17 16:34:43,088 - DEBUG - close.complete
2025-06-17 16:34:43,089 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:34:43,096 - INFO - Database connection closed
2025-06-17 16:34:43,096 - INFO - 127.0.0.1 - - [17/Jun/2025 16:34:43] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:34:43,120 - INFO - Connected to database
2025-06-17 16:34:44,309 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:34:44,351 - DEBUG - Rendering index with 2 messages
2025-06-17 16:34:44,351 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:34:44,357 - INFO - Database connection closed
2025-06-17 16:34:44,357 - INFO - 127.0.0.1 - - [17/Jun/2025 16:34:44] "GET / HTTP/1.1" 200 -
2025-06-17 16:38:08,802 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 16:38:08,802 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 16:38:08,804 - INFO -  * Restarting with stat
2025-06-17 16:38:09,791 - WARNING -  * Debugger is active!
2025-06-17 16:38:09,796 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 16:38:12,756 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:12] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 16:38:12,769 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:12] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 16:38:32,410 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 16:38:32,717 - INFO - Connected to database
2025-06-17 16:38:33,016 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 16:38:33,018 - INFO - Database connection closed
2025-06-17 16:38:33,019 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:33] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 16:38:33,034 - INFO - Connected to database
2025-06-17 16:38:34,484 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:38:34,521 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 16:38:34,524 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 16:38:35,483 - DEBUG - Loading model cost 0.961 seconds.
2025-06-17 16:38:35,484 - DEBUG - Prefix dict has been built successfully.
2025-06-17 16:38:35,485 - DEBUG - Rendering index with 0 messages
2025-06-17 16:38:35,491 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:38:35,506 - INFO - Database connection closed
2025-06-17 16:38:35,507 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:35] "GET / HTTP/1.1" 200 -
2025-06-17 16:38:48,224 - INFO - Connected to database
2025-06-17 16:38:49,514 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:38:49,549 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 16:38:49,551 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 16:38:49,551 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,552 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,553 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,553 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,554 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,555 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,555 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,556 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,556 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,557 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,557 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,558 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,559 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,560 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,561 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,562 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:38:49,563 - INFO - No category matched for query: coupons for hong kong
2025-06-17 16:38:49,568 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:38:49,621 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C711383CB0>
2025-06-17 16:38:49,621 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C710FB6F00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:38:49,660 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C7114FAD50>
2025-06-17 16:38:49,662 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:38:49,663 - DEBUG - send_request_headers.complete
2025-06-17 16:38:49,663 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:38:49,664 - DEBUG - send_request_body.complete
2025-06-17 16:38:49,665 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:38:49,969 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:08:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'104'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803641'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'104'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'c419d96d0375f83fcb4cca29715b7046'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=I9IM5igovjOxCxN0k1E7J5En9O26fn4Oc7AYZHT8XHM-1750158529-1.0.1.1-k6JY5MxeabXjOLtGtOzj2HCOtVDnGMbrnYrnIEpvtlb97wOts1AXBFI3yq_43FDFmfnsxsy0SGl9SV37DxO8eoVkcfb4B22kwX6MOUa8CyY; path=/; expires=Tue, 17-Jun-25 11:38:49 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=qnNbaGO6UGYGvLcgXTjmiq9._yu_dAU6Bqi7QPXC3Gs-1750158529892-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512175a1dc83ab7-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:38:49,973 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:38:49,974 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:38:49,975 - DEBUG - receive_response_body.complete
2025-06-17 16:38:49,976 - DEBUG - response_closed.started
2025-06-17 16:38:49,976 - DEBUG - response_closed.complete
2025-06-17 16:38:49,981 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 16:38:49,996 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:38:49,998 - DEBUG - send_request_headers.complete
2025-06-17 16:38:49,998 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:38:49,999 - DEBUG - send_request_body.complete
2025-06-17 16:38:50,000 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:38:50,285 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:08:50 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803543'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'6dc7037cd194214eda3312399dcf4a39'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512175c2fd43ab7-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:38:50,287 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:38:50,288 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:38:50,300 - DEBUG - receive_response_body.complete
2025-06-17 16:38:50,300 - DEBUG - response_closed.started
2025-06-17 16:38:50,301 - DEBUG - response_closed.complete
2025-06-17 16:38:50,306 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:38:50,308 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 16:38:50,316 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 16:38:50,351 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 16:38:50,352 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 16:38:50,353 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 16:38:50,355 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,356 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,356 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 16:38:50,361 - DEBUG - Found 20 rows
2025-06-17 16:38:50,363 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,365 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,366 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,368 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,370 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,372 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,374 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,375 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,376 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,378 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,379 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,380 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,382 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,384 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,385 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,387 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,391 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,393 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,395 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,397 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 16:38:50,398 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 16:38:50,398 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,400 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,401 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,402 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,403 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,408 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,408 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,408 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,409 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,411 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,412 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,412 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,413 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,416 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,417 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,417 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,417 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,420 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,421 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,422 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,422 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,425 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,426 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,427 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,427 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,429 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,430 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,430 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,430 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,432 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,433 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,433 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,434 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,436 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,437 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,438 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,439 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,442 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,442 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,443 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,443 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,446 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,446 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,447 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,447 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,450 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,450 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,451 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,451 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,454 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,454 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,454 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,455 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,457 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,458 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,458 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,459 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,461 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,461 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,462 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,462 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,465 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,465 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,466 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,466 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,469 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,469 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,469 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,470 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,473 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,474 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,474 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,475 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,477 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,477 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,478 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,479 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 16:38:50,480 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 16:38:50,480 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 16:38:50,481 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 16:38:50,481 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:38:50,482 - DEBUG - close.started
2025-06-17 16:38:50,483 - DEBUG - close.complete
2025-06-17 16:38:50,483 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:38:50,493 - INFO - Database connection closed
2025-06-17 16:38:50,494 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:50] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:38:50,516 - INFO - Connected to database
2025-06-17 16:38:51,800 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:38:51,829 - DEBUG - Rendering index with 2 messages
2025-06-17 16:38:51,830 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:38:51,834 - INFO - Database connection closed
2025-06-17 16:38:51,835 - INFO - 127.0.0.1 - - [17/Jun/2025 16:38:51] "GET / HTTP/1.1" 200 -
2025-06-17 16:39:13,957 - INFO - Connected to database
2025-06-17 16:39:15,206 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:39:15,275 - DEBUG - Cleared session messages. Starting fresh for query: coupons of new territories
2025-06-17 16:39:15,276 - DEBUG - Extracting category from query: 'coupons of new territories', words: ['coupons', 'of', 'new', 'territories']
2025-06-17 16:39:15,279 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,279 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,279 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,280 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,288 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,288 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,288 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,289 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,289 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,290 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,290 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,290 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,291 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,291 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,291 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,292 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,293 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,293 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,293 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,294 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,294 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,294 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,295 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,295 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,295 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,295 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,296 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,296 - DEBUG - Ignoring word: 'coupons'
2025-06-17 16:39:15,296 - INFO - No category matched for query: coupons of new territories
2025-06-17 16:39:15,304 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:39:15,349 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C7112F7890>
2025-06-17 16:39:15,350 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C7113BDD00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:39:15,393 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C711313A80>
2025-06-17 16:39:15,394 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:39:15,395 - DEBUG - send_request_headers.complete
2025-06-17 16:39:15,395 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:39:15,396 - DEBUG - send_request_body.complete
2025-06-17 16:39:15,396 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:39:16,123 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:09:16 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'262'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499617'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803401'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'263'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'56ee86206ba5f4593434515f2823d034'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=QH9R2Kdsc3XWkoZF8nvt9tqfdtlxjqRofPxQOUX3uD4-1750158556-1.0.1.1-d0FlavFG7.K5tgK72mWGge4xiRHjdB6lTWJYFGKi.tJgUTg.q2W44CsQxW8QJfkXmDnhUGrDQoH0gu.HWFxvT5deIvUPfBfm0y8EX7olhrg; path=/; expires=Tue, 17-Jun-25 11:39:16 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=TMVxjYqQF3ickIHTel2nEePMQMPk2TZ4cmalO5IjtXc-1750158556050-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951217faefb54290-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:39:16,124 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:39:16,125 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:39:16,125 - DEBUG - receive_response_body.complete
2025-06-17 16:39:16,125 - DEBUG - response_closed.started
2025-06-17 16:39:16,126 - DEBUG - response_closed.complete
2025-06-17 16:39:16,127 - DEBUG - Mistral location analysis: None
2025-06-17 16:39:16,128 - DEBUG - Location candidates: ['coupons of new territories', 'coupons of new', 'coupons of', 'of new territories', 'of new', 'new territories', 'new', 'territories']
2025-06-17 16:39:16,133 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 16:39:16,141 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:39:16,142 - DEBUG - send_request_headers.complete
2025-06-17 16:39:16,142 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:39:16,143 - DEBUG - send_request_body.complete
2025-06-17 16:39:16,143 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:39:16,411 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:09:16 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499519'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803303'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'74'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'58608d5dc5c06610b5ebf002488bb225'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951217ff9d6c4290-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:39:16,413 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:39:16,415 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:39:16,416 - DEBUG - receive_response_body.complete
2025-06-17 16:39:16,416 - DEBUG - response_closed.started
2025-06-17 16:39:16,418 - DEBUG - response_closed.complete
2025-06-17 16:39:16,420 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:39:16,421 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 16:39:16,427 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 16:39:16,454 - INFO - No coupon name matched for query: 'coupons of new territories'
2025-06-17 16:39:16,454 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 16:39:16,455 - DEBUG - Final: Query=coupons of new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 16:39:16,457 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,457 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,458 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 16:39:16,462 - DEBUG - Found 20 rows
2025-06-17 16:39:16,463 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,464 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,466 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,467 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,468 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,469 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,470 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,471 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,472 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,473 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,473 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,474 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,475 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,476 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,476 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,477 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,478 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,478 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,479 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,480 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:16,481 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 16:39:16,481 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,482 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:39:16,483 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,483 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,484 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,485 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:39:16,485 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,486 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,486 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,487 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 16:39:16,488 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,488 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,488 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,489 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 16:39:16,490 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,490 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,490 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,491 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 16:39:16,491 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,491 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,492 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,493 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:39:16,493 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,493 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,494 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,495 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 16:39:16,495 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,495 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,496 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,497 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 16:39:16,498 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,498 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,499 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,500 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:39:16,501 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,501 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,501 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,502 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:16,503 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,503 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,503 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,504 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:16,504 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,505 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,505 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,506 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:16,506 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,506 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,507 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,508 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:16,508 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,508 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,509 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,510 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:16,510 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,510 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,511 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,512 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:16,512 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,512 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,512 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,514 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:16,514 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,514 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,515 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,516 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:16,517 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,517 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,517 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,518 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:16,519 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,519 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,519 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,520 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:16,520 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,521 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,521 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:16,522 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:16,522 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:16,522 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:16,523 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:39:16,523 - DEBUG - close.started
2025-06-17 16:39:16,524 - DEBUG - close.complete
2025-06-17 16:39:16,524 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:39:16,529 - INFO - Database connection closed
2025-06-17 16:39:16,529 - INFO - 127.0.0.1 - - [17/Jun/2025 16:39:16] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:39:16,545 - INFO - Connected to database
2025-06-17 16:39:17,769 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:39:17,821 - DEBUG - Rendering index with 2 messages
2025-06-17 16:39:17,822 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:39:17,828 - INFO - Database connection closed
2025-06-17 16:39:17,829 - INFO - 127.0.0.1 - - [17/Jun/2025 16:39:17] "GET / HTTP/1.1" 200 -
2025-06-17 16:39:42,977 - INFO - Connected to database
2025-06-17 16:39:44,194 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:39:44,247 - DEBUG - Cleared session messages. Starting fresh for query: upto 20% discount
2025-06-17 16:39:44,249 - DEBUG - Extracting category from query: 'upto 20% discount', words: ['upto', '20%', 'discount']
2025-06-17 16:39:44,251 - INFO - No category matched for query: upto 20% discount
2025-06-17 16:39:44,255 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 16:39:44,290 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C714CAC9D0>
2025-06-17 16:39:44,293 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001C7113BDD00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 16:39:44,329 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001C71152DEB0>
2025-06-17 16:39:44,331 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:39:44,331 - DEBUG - send_request_headers.complete
2025-06-17 16:39:44,334 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:39:44,335 - DEBUG - send_request_body.complete
2025-06-17 16:39:44,337 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:39:44,631 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:09:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'103'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499375'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803159'), (b'x-ratelimit-tokens-query-cost', b'144'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'103'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'76bd7c3bf8ca7063e40ab51f5f5f805e'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=8zMg_BMAKZNZX3GOKHHKkeSgZPHjGygHPWytT3C.eNc-1750158584-1.0.1.1-JU4FZI9L5aU1AGLcjCDpHIH_H5CerXtCOdYvBswWMKXvzheEwBTquGoFHmnATU8cYLoKin6_J6uVjkqh0_4CETLVcMSmgQ6uVD63PUJQwT4; path=/; expires=Tue, 17-Jun-25 11:39:44 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=rVKIzWC0DsvS31eY5gaBpSgQ3yjYjxtPiJDxFPjiYr4-1750158584556-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951218afbe453a4b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:39:44,633 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:39:44,634 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:39:44,635 - DEBUG - receive_response_body.complete
2025-06-17 16:39:44,636 - DEBUG - response_closed.started
2025-06-17 16:39:44,636 - DEBUG - response_closed.complete
2025-06-17 16:39:44,639 - DEBUG - Mistral location analysis: None
2025-06-17 16:39:44,640 - DEBUG - Location candidates: ['upto 20% discount', 'upto 20%', '20% discount', '20%']
2025-06-17 16:39:44,649 - INFO - No valid location matched for query: upto 20% discount
2025-06-17 16:39:44,650 - DEBUG - Extracted English 'up to' discount: max=20%
2025-06-17 16:39:44,661 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 16:39:44,663 - DEBUG - send_request_headers.complete
2025-06-17 16:39:44,664 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 16:39:44,665 - DEBUG - send_request_body.complete
2025-06-17 16:39:44,665 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 16:39:44,969 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 11:09:44 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'113'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499275'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998803059'), (b'x-ratelimit-tokens-query-cost', b'100'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'114'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'c8390842e295ec6205962c13db8ed62f'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'951218b1d8933a4b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 16:39:44,970 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 16:39:44,971 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 16:39:44,972 - DEBUG - receive_response_body.complete
2025-06-17 16:39:44,973 - DEBUG - response_closed.started
2025-06-17 16:39:44,974 - DEBUG - response_closed.complete
2025-06-17 16:39:44,977 - DEBUG - Mistral coupon name analysis: None
2025-06-17 16:39:44,978 - DEBUG - Cleaned query: '20%'
2025-06-17 16:39:44,987 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 16:39:44,992 - INFO - No coupon name matched for query: 'upto 20% discount'
2025-06-17 16:39:44,993 - DEBUG - Extracted: Category=None, Location=None, Discount={'min': 0, 'max': 20}, Coupon Name=None
2025-06-17 16:39:44,994 - DEBUG - Final: Query=upto 20% discount, Category=None, Location={'id': '3', 'name': 'New Territories', 'type': 'area'}, Coupon Name=None, Discount={'min': 0, 'max': 20}
2025-06-17 16:39:44,996 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:44,996 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:44,996 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) AND c.percentage >= %s AND c.percentage <= %s ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 0, 20, 20]
2025-06-17 16:39:45,001 - DEBUG - Found 20 rows
2025-06-17 16:39:45,003 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,005 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,006 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,008 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,010 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,012 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,013 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,015 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,016 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,017 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,019 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,020 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,022 - DEBUG - Valid area IDs for coupon ID 899 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,023 - DEBUG - Valid area IDs for coupon ID 898 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,024 - DEBUG - Valid area IDs for coupon ID 897 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,025 - DEBUG - Valid area IDs for coupon ID 896 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,027 - DEBUG - Valid area IDs for coupon ID 808 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,028 - DEBUG - Valid area IDs for coupon ID 807 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,029 - DEBUG - Valid area IDs for coupon ID 806 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,030 - DEBUG - Valid area IDs for coupon ID 479 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 16:39:45,030 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 16:39:45,030 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,032 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 16:39:45,032 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,033 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,033 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,035 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:45,035 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,036 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,036 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,037 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,037 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,038 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,038 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,039 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,039 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,039 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,040 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,041 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,042 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,043 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,043 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,045 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,045 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,045 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,045 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,046 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,047 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,047 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,047 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,049 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:45,049 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,049 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,049 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,050 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,050 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,051 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,051 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,052 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,052 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,053 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,053 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,055 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 16:39:45,055 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,055 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,055 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,057 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,057 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,057 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,058 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,059 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,060 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,060 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,060 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,061 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,062 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,062 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,062 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,064 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 16:39:45,064 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,064 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,064 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,065 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 16:39:45,066 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,066 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,066 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,067 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 16:39:45,068 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,068 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,069 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,070 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 16:39:45,070 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,070 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,071 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,072 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 16:39:45,072 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,073 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,073 - DEBUG - Attempting to resolve selected_area: 20, territory: , location_table: None, coupon_area: 3
2025-06-17 16:39:45,075 - DEBUG - Resolved selected_area 20 to Tsuen Wan via new_territories table
2025-06-17 16:39:45,075 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 16:39:45,075 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 16:39:45,076 - DEBUG - Added system response. Total messages: 2
2025-06-17 16:39:45,076 - DEBUG - close.started
2025-06-17 16:39:45,077 - DEBUG - close.complete
2025-06-17 16:39:45,077 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:39:45,082 - INFO - Database connection closed
2025-06-17 16:39:45,082 - INFO - 127.0.0.1 - - [17/Jun/2025 16:39:45] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:39:45,096 - INFO - Connected to database
2025-06-17 16:39:46,271 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:39:46,348 - DEBUG - Rendering index with 2 messages
2025-06-17 16:39:46,349 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:39:46,352 - INFO - Database connection closed
2025-06-17 16:39:46,353 - INFO - 127.0.0.1 - - [17/Jun/2025 16:39:46] "GET / HTTP/1.1" 200 -
2025-06-17 16:40:19,810 - INFO - Connected to database
2025-06-17 16:40:21,098 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:40:21,139 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 16:40:21,140 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:40:21,144 - INFO - Database connection closed
2025-06-17 16:40:21,145 - INFO - 127.0.0.1 - - [17/Jun/2025 16:40:21] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:40:21,160 - INFO - Connected to database
2025-06-17 16:40:22,247 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:40:22,275 - DEBUG - Rendering index with 1 messages
2025-06-17 16:40:22,276 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:40:22,279 - INFO - Database connection closed
2025-06-17 16:40:22,280 - INFO - 127.0.0.1 - - [17/Jun/2025 16:40:22] "GET / HTTP/1.1" 200 -
2025-06-17 16:40:27,148 - INFO - Connected to database
2025-06-17 16:40:28,393 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 16:40:28,458 - INFO - Revoked tokens for user ID 1163 during quit
2025-06-17 16:40:28,460 - DEBUG - Using proactor: IocpProactor
2025-06-17 16:40:28,464 - INFO - Database connection closed
2025-06-17 16:40:28,465 - INFO - 127.0.0.1 - - [17/Jun/2025 16:40:28] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 16:40:28,472 - INFO - 127.0.0.1 - - [17/Jun/2025 16:40:28] "GET /login HTTP/1.1" 200 -
2025-06-17 16:44:54,399 - INFO - 127.0.0.1 - - [17/Jun/2025 16:44:54] "[31m[1mGET /api/auth HTTP/1.1[0m" 405 -
2025-06-17 16:44:54,644 - INFO - 127.0.0.1 - - [17/Jun/2025 16:44:54] "[33mGET /favicon.ico HTTP/1.1[0m" 404 -
2025-06-17 17:12:56,267 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:12:56,268 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:12:56,270 - INFO -  * Restarting with stat
2025-06-17 17:12:57,202 - WARNING -  * Debugger is active!
2025-06-17 17:12:57,206 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:13:00,899 - INFO - 127.0.0.1 - - [17/Jun/2025 17:13:00] "[31m[1mGET /api/auth HTTP/1.1[0m" 405 -
2025-06-17 17:20:25,724 - INFO - 127.0.0.1 - - [17/Jun/2025 17:20:25] "[31m[1mPOST /api/auth HTTP/1.1[0m" 415 -
2025-06-17 17:21:54,684 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:21:54,814 - INFO - Connected to database
2025-06-17 17:21:55,036 - ERROR - Auth error: 1406 (22001): Data too long for column 'token' at row 1
2025-06-17 17:21:55,037 - INFO - Database connection closed
2025-06-17 17:21:55,037 - INFO - 127.0.0.1 - - [17/Jun/2025 17:21:55] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:26:52,665 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 17:26:52,868 - INFO -  * Restarting with stat
2025-06-17 17:26:54,780 - WARNING -  * Debugger is active!
2025-06-17 17:26:54,784 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:27:27,676 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\generate_token_and_update.py', reloading
2025-06-17 17:27:27,789 - INFO -  * Restarting with stat
2025-06-17 17:27:28,887 - WARNING -  * Debugger is active!
2025-06-17 17:27:28,890 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:27:40,068 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\extract_coupon_to_json.py', reloading
2025-06-17 17:27:40,179 - INFO -  * Restarting with stat
2025-06-17 17:27:41,232 - WARNING -  * Debugger is active!
2025-06-17 17:27:41,236 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:31:31,457 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 17:31:31,748 - INFO -  * Restarting with stat
2025-06-17 17:31:33,562 - WARNING -  * Debugger is active!
2025-06-17 17:31:33,566 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:31:48,603 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:31:48,604 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:31:48,605 - INFO -  * Restarting with stat
2025-06-17 17:31:49,700 - WARNING -  * Debugger is active!
2025-06-17 17:31:49,703 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:32:06,994 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:32:07,177 - INFO - Connected to database
2025-06-17 17:32:07,178 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:32:07,179 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:32:07,179 - DEBUG - Checking password
2025-06-17 17:32:07,401 - DEBUG - Password check passed
2025-06-17 17:32:07,402 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:32:07,404 - ERROR - Auth error: 1406 (22001): Data too long for column 'token' at row 1
2025-06-17 17:32:07,405 - INFO - Database connection closed
2025-06-17 17:32:07,405 - INFO - 127.0.0.1 - - [17/Jun/2025 17:32:07] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:35:09,720 - INFO -  * Detected change in 'C:\\Users\\Diya\\Downloads\\couponai-main\\couponai-main\\app.py', reloading
2025-06-17 17:35:09,845 - INFO -  * Restarting with stat
2025-06-17 17:35:11,299 - WARNING -  * Debugger is active!
2025-06-17 17:35:11,305 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:35:17,620 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:35:17,620 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:35:17,621 - INFO -  * Restarting with stat
2025-06-17 17:35:18,742 - WARNING -  * Debugger is active!
2025-06-17 17:35:18,747 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:35:32,949 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:35:33,090 - INFO - Connected to database
2025-06-17 17:35:33,090 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:35:33,092 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:35:33,093 - DEBUG - Checking password
2025-06-17 17:35:33,310 - DEBUG - Password check passed
2025-06-17 17:35:33,311 - DEBUG - Access token length: 327
2025-06-17 17:35:33,311 - DEBUG - Refresh token length: 328
2025-06-17 17:35:33,311 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:35:33,314 - ERROR - Auth error: 1406 (22001): Data too long for column 'token' at row 1
2025-06-17 17:35:33,314 - INFO - Database connection closed
2025-06-17 17:35:33,315 - INFO - 127.0.0.1 - - [17/Jun/2025 17:35:33] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:39:36,300 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:39:36,313 - INFO - Connected to database
2025-06-17 17:39:36,314 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:39:36,317 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:39:36,318 - DEBUG - Checking password
2025-06-17 17:39:36,554 - DEBUG - Password check passed
2025-06-17 17:39:36,554 - DEBUG - Access token length: 327
2025-06-17 17:39:36,554 - DEBUG - Refresh token length: 328
2025-06-17 17:39:36,555 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:39:36,621 - ERROR - Auth error: 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`coupon`.`api_tokens`, CONSTRAINT `api_tokens_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`))
2025-06-17 17:39:36,624 - INFO - Database connection closed
2025-06-17 17:39:36,624 - INFO - 127.0.0.1 - - [17/Jun/2025 17:39:36] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:39:50,140 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:39:50,140 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:39:50,142 - INFO -  * Restarting with stat
2025-06-17 17:39:51,617 - WARNING -  * Debugger is active!
2025-06-17 17:39:51,620 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:39:55,530 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:39:55,622 - INFO - Connected to database
2025-06-17 17:39:55,623 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:39:55,624 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:39:55,624 - DEBUG - Checking password
2025-06-17 17:39:55,847 - DEBUG - Password check passed
2025-06-17 17:39:55,848 - DEBUG - Access token length: 327
2025-06-17 17:39:55,848 - DEBUG - Refresh token length: 328
2025-06-17 17:39:55,848 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:39:55,911 - ERROR - Auth error: 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`coupon`.`api_tokens`, CONSTRAINT `api_tokens_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`))
2025-06-17 17:39:55,914 - INFO - Database connection closed
2025-06-17 17:39:55,915 - INFO - 127.0.0.1 - - [17/Jun/2025 17:39:55] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:45:17,468 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:45:17,468 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:45:17,470 - INFO -  * Restarting with stat
2025-06-17 17:45:18,772 - WARNING -  * Debugger is active!
2025-06-17 17:45:18,777 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:45:43,827 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:45:43,934 - INFO - Connected to database
2025-06-17 17:45:43,935 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:45:43,936 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:45:43,937 - DEBUG - Checking password
2025-06-17 17:45:44,162 - DEBUG - Password check passed
2025-06-17 17:45:44,162 - DEBUG - Access token length: 327
2025-06-17 17:45:44,162 - DEBUG - Refresh token length: 328
2025-06-17 17:45:44,163 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:45:44,224 - ERROR - Auth error: 1452 (23000): Cannot add or update a child row: a foreign key constraint fails (`coupon`.`api_tokens`, CONSTRAINT `api_tokens_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`))
2025-06-17 17:45:44,227 - INFO - Database connection closed
2025-06-17 17:45:44,227 - INFO - 127.0.0.1 - - [17/Jun/2025 17:45:44] "[35m[1mPOST /api/auth HTTP/1.1[0m" 500 -
2025-06-17 17:55:17,017 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 17:55:17,018 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 17:55:17,020 - INFO -  * Restarting with stat
2025-06-17 17:55:18,217 - WARNING -  * Debugger is active!
2025-06-17 17:55:18,226 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 17:55:23,644 - DEBUG - API Auth attempt: email=diya.dave11@gmail.com
2025-06-17 17:55:23,724 - INFO - Connected to database
2025-06-17 17:55:23,724 - DEBUG - Querying user with email: diya.dave11@gmail.com
2025-06-17 17:55:23,725 - DEBUG - User fetched: {'id': 1163, 'name': 'diya', 'email': 'diya.dave11@gmail.com', 'password': '$2b$12$0ZsT0Ev6HVqjtMobzpBr0uXZfgo1ALGRu.4c43vv2kEL9x9UFd8tm'}
2025-06-17 17:55:23,726 - DEBUG - Checking password
2025-06-17 17:55:23,934 - DEBUG - Password check passed
2025-06-17 17:55:23,935 - DEBUG - Access token length: 327
2025-06-17 17:55:23,935 - DEBUG - Refresh token length: 328
2025-06-17 17:55:23,935 - DEBUG - Inserting access token into api_tokens
2025-06-17 17:55:24,001 - DEBUG - Inserting refresh token into api_tokens
2025-06-17 17:55:24,008 - DEBUG - Tokens inserted successfully
2025-06-17 17:55:24,014 - INFO - Database connection closed
2025-06-17 17:55:24,015 - INFO - 127.0.0.1 - - [17/Jun/2025 17:55:24] "POST /api/auth HTTP/1.1" 200 -
2025-06-17 18:06:09,048 - INFO - 127.0.0.1 - - [17/Jun/2025 18:06:09] "GET /login HTTP/1.1" 200 -
2025-06-17 18:06:26,652 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 18:06:26,666 - INFO - Connected to database
2025-06-17 18:06:27,222 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 18:06:27,225 - INFO - Database connection closed
2025-06-17 18:06:27,225 - INFO - 127.0.0.1 - - [17/Jun/2025 18:06:27] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 18:06:27,250 - INFO - Connected to database
2025-06-17 18:06:29,182 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:06:29,219 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 18:06:29,221 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 18:06:30,385 - DEBUG - Loading model cost 1.165 seconds.
2025-06-17 18:06:30,386 - DEBUG - Prefix dict has been built successfully.
2025-06-17 18:06:30,387 - DEBUG - Rendering index with 0 messages
2025-06-17 18:06:30,397 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:06:30,421 - INFO - Database connection closed
2025-06-17 18:06:30,422 - INFO - 127.0.0.1 - - [17/Jun/2025 18:06:30] "GET / HTTP/1.1" 200 -
2025-06-17 18:06:46,837 - INFO - Connected to database
2025-06-17 18:06:48,249 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:06:48,298 - DEBUG - Cleared session messages. Starting fresh for query: coupons of gucci store
2025-06-17 18:06:48,300 - DEBUG - Extracting category from query: 'coupons of gucci store', words: ['coupons', 'of', 'gucci', 'store']
2025-06-17 18:06:48,300 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,300 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,301 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,301 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,302 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,302 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,303 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,303 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,303 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,304 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,304 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,304 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,305 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,305 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,306 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,307 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,307 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,307 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,308 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,308 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,308 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,309 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,309 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,309 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,310 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,310 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,311 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,311 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,311 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,312 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,312 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,312 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,312 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,313 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,313 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,314 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,314 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,314 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,314 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,315 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,315 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,316 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,316 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,316 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,317 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,317 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,317 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,317 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,318 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,318 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,319 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,319 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,319 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,320 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,321 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:06:48,321 - DEBUG - Ignoring word: 'store'
2025-06-17 18:06:48,322 - INFO - No category matched for query: coupons of gucci store
2025-06-17 18:06:48,333 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:06:48,426 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3A831FCB0>
2025-06-17 18:06:48,426 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D3A82C3920> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:06:48,456 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3A846AC10>
2025-06-17 18:06:48,457 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:06:48,458 - DEBUG - send_request_headers.complete
2025-06-17 18:06:48,458 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:06:48,459 - DEBUG - send_request_body.complete
2025-06-17 18:06:48,459 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:06:48,767 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 12:36:48 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'110'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998800152'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'111'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'f5732260c0bf524d9bdd32245aa75810'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=8B77vgpQ4z.V2Wb27Wc6TFsIvS6LwIYxaFYgf3QsLxg-1750163808-1.0.1.1-P_Lvve0YBNNzYJGJIKiSS9e_QnNsdS2vLMMfyjTfg2kGgIq5C6zyKMPz7SyFIQQkUzzMMOuHQcWJ9QyPU25gW9f0PHlcbErNMF0dzIp0FqI; path=/; expires=Tue, 17-Jun-25 13:06:48 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=Ik5wSG6vht1dbntfojJ7MADqZCEMtjQxiQl9Tbs3Shk-1750163808692-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512983a89c285b9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:06:48,769 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:06:48,770 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:06:48,771 - DEBUG - receive_response_body.complete
2025-06-17 18:06:48,772 - DEBUG - response_closed.started
2025-06-17 18:06:48,773 - DEBUG - response_closed.complete
2025-06-17 18:06:48,777 - DEBUG - Mistral location analysis: None
2025-06-17 18:06:48,777 - DEBUG - Location candidates: ['coupons of gucci store', 'coupons of gucci', 'coupons of', 'of gucci store', 'of gucci', 'gucci store']
2025-06-17 18:06:48,786 - INFO - No valid location matched for query: coupons of gucci store
2025-06-17 18:06:48,849 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:06:48,850 - DEBUG - send_request_headers.complete
2025-06-17 18:06:48,850 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:06:48,851 - DEBUG - send_request_body.complete
2025-06-17 18:06:48,852 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:06:49,149 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 12:36:49 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'81'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499758'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998800053'), (b'x-ratelimit-tokens-query-cost', b'99'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'83'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'60cf995b88fd3a32df04b66eb190405c'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512983cfba685b9-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:06:49,150 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:06:49,151 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:06:49,152 - DEBUG - receive_response_body.complete
2025-06-17 18:06:49,153 - DEBUG - response_closed.started
2025-06-17 18:06:49,153 - DEBUG - response_closed.complete
2025-06-17 18:06:49,155 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:06:49,156 - DEBUG - Cleaned query: 'coupons gucci store'
2025-06-17 18:06:49,164 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:06:49,183 - INFO - Exact phrase match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 18:06:49,232 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 18:06:49,232 - DEBUG - Final: Query=coupons of gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 18:06:49,234 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 18:06:49,239 - DEBUG - Found 1 rows
2025-06-17 18:06:49,241 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:06:49,241 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 18:06:49,242 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:06:49,245 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:06:49,245 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:06:49,246 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:06:49,246 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:06:49,247 - DEBUG - close.started
2025-06-17 18:06:49,248 - DEBUG - close.complete
2025-06-17 18:06:49,248 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:06:49,254 - INFO - Database connection closed
2025-06-17 18:06:49,255 - INFO - 127.0.0.1 - - [17/Jun/2025 18:06:49] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:06:49,270 - INFO - Connected to database
2025-06-17 18:06:50,638 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:06:50,669 - DEBUG - Rendering index with 2 messages
2025-06-17 18:06:50,671 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:06:50,676 - INFO - Database connection closed
2025-06-17 18:06:50,677 - INFO - 127.0.0.1 - - [17/Jun/2025 18:06:50] "GET / HTTP/1.1" 200 -
2025-06-17 18:22:26,418 - INFO - Connected to database
2025-06-17 18:22:27,954 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:22:28,006 - DEBUG - Cleared session messages. Starting fresh for query: coupons of new territories
2025-06-17 18:22:28,012 - DEBUG - Extracting category from query: 'coupons of new territories', words: ['coupons', 'of', 'new', 'territories']
2025-06-17 18:22:28,012 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,013 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,013 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,013 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,014 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,014 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,015 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,015 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,015 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,016 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,017 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,019 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,019 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,020 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,021 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,022 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,023 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,024 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,025 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,026 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:22:28,026 - INFO - No category matched for query: coupons of new territories
2025-06-17 18:22:28,037 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:22:28,072 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3A82839D0>
2025-06-17 18:22:28,073 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D3A7F52330> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:22:28,111 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3A829F230>
2025-06-17 18:22:28,111 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:22:28,113 - DEBUG - send_request_headers.complete
2025-06-17 18:22:28,113 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:22:28,115 - DEBUG - send_request_body.complete
2025-06-17 18:22:28,115 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:22:28,393 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 12:52:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499858'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799911'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'86'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'a87add0e928e894817a2a9287e428e35'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=7vkjjCiuuf2rIV0SUPvZ4qG4Cvm3p599auUe3TnVCOs-1750164748-1.0.1.1-i3La8e_Jj0Vd.pIHY47PljIg0TJ0BKHJObCK3DhhTSlSSbN7q_fWtaXm6efOEemi8DNy8fy68zA4hVADlZDO9122KcV_ozX7LR3fBx6SLeA; path=/; expires=Tue, 17-Jun-25 13:22:28 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=nWm.mfPR.afFhuECza07rG8Zfc6NyLXXtlJVQ9SmYDU-1750164748314-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512af2b5bc23ae6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:22:28,397 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:22:28,400 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:22:28,401 - DEBUG - receive_response_body.complete
2025-06-17 18:22:28,403 - DEBUG - response_closed.started
2025-06-17 18:22:28,405 - DEBUG - response_closed.complete
2025-06-17 18:22:28,409 - DEBUG - Mistral location analysis: None
2025-06-17 18:22:28,457 - DEBUG - Location candidates: ['coupons of new territories', 'coupons of new', 'coupons of', 'of new territories', 'of new', 'new territories', 'new', 'territories']
2025-06-17 18:22:28,464 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 18:22:28,473 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:22:28,474 - DEBUG - send_request_headers.complete
2025-06-17 18:22:28,474 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:22:28,474 - DEBUG - send_request_body.complete
2025-06-17 18:22:28,475 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:22:28,939 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 12:52:28 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'142'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499760'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799813'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'143'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'4dfd202ebeb72750e9929e02b0ca2010'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512af2d9e0e3ae6-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:22:28,940 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:22:28,940 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:22:28,941 - DEBUG - receive_response_body.complete
2025-06-17 18:22:28,942 - DEBUG - response_closed.started
2025-06-17 18:22:28,942 - DEBUG - response_closed.complete
2025-06-17 18:22:28,945 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:22:28,945 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 18:22:28,951 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:22:28,979 - INFO - No coupon name matched for query: 'coupons of new territories'
2025-06-17 18:22:28,979 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 18:22:28,980 - DEBUG - Final: Query=coupons of new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 18:22:28,982 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:28,982 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:28,983 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 18:22:28,988 - DEBUG - Found 20 rows
2025-06-17 18:22:29,000 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,014 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,027 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,037 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,044 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,052 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,058 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,063 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,174 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,183 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,192 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,199 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,207 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,214 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,218 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,230 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,234 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,309 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,316 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,328 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:22:29,335 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 18:22:29,337 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,342 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:22:29,345 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,346 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,346 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,349 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:22:29,349 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,350 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,350 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,352 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 18:22:29,352 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,353 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,353 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,354 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 18:22:29,355 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,355 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,356 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,358 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 18:22:29,359 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,359 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,359 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,361 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:22:29,362 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,362 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,362 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,364 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 18:22:29,364 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,365 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,365 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,367 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 18:22:29,367 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,368 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,369 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,370 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:22:29,371 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,371 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,372 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,373 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:22:29,373 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,374 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,374 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,376 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:22:29,377 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,377 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,377 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,379 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:22:29,380 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,380 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,380 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,382 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:22:29,382 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,383 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,383 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,385 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:22:29,385 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,386 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,386 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,388 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:22:29,389 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,389 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,389 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,391 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:22:29,391 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,391 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,392 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,394 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:22:29,394 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,394 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,395 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,396 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:22:29,397 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,397 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,398 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,400 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:22:29,400 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,400 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,400 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:22:29,402 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:22:29,402 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:22:29,403 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:22:29,403 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:22:29,404 - DEBUG - close.started
2025-06-17 18:22:29,404 - DEBUG - close.complete
2025-06-17 18:22:29,405 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:22:29,411 - INFO - Database connection closed
2025-06-17 18:22:29,411 - INFO - 127.0.0.1 - - [17/Jun/2025 18:22:29] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:22:29,428 - INFO - Connected to database
2025-06-17 18:22:30,940 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:22:30,989 - DEBUG - Rendering index with 2 messages
2025-06-17 18:22:30,990 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:22:30,995 - INFO - Database connection closed
2025-06-17 18:22:30,995 - INFO - 127.0.0.1 - - [17/Jun/2025 18:22:30] "GET / HTTP/1.1" 200 -
2025-06-17 18:22:45,783 - INFO - Connected to database
2025-06-17 18:22:47,308 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:22:47,343 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 18:22:47,344 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:22:47,350 - INFO - Database connection closed
2025-06-17 18:22:47,351 - INFO - 127.0.0.1 - - [17/Jun/2025 18:22:47] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:22:47,365 - INFO - Connected to database
2025-06-17 18:22:48,866 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:22:48,908 - DEBUG - Rendering index with 1 messages
2025-06-17 18:22:48,910 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:22:48,918 - INFO - Database connection closed
2025-06-17 18:22:48,918 - INFO - 127.0.0.1 - - [17/Jun/2025 18:22:48] "GET / HTTP/1.1" 200 -
2025-06-17 18:33:10,488 - INFO - Connected to database
2025-06-17 18:33:12,045 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:33:12,084 - DEBUG - Cleared session messages. Starting fresh for query: coupon for hong kong
2025-06-17 18:33:12,086 - DEBUG - Extracting category from query: 'coupon for hong kong', words: ['coupon', 'for', 'hong', 'kong']
2025-06-17 18:33:12,088 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,089 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,089 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,090 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,091 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,091 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,092 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,092 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,092 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,093 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,094 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,095 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,095 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,095 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,095 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,096 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,096 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,096 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,096 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,097 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,097 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,097 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,098 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,098 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,098 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,099 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,101 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,101 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:33:12,102 - INFO - No category matched for query: coupon for hong kong
2025-06-17 18:33:12,113 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:33:12,174 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3ABC0CE90>
2025-06-17 18:33:12,174 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001D3A83CE4E0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:33:12,220 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001D3A8352F90>
2025-06-17 18:33:12,223 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:33:12,225 - DEBUG - send_request_headers.complete
2025-06-17 18:33:12,225 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:33:12,226 - DEBUG - send_request_body.complete
2025-06-17 18:33:12,226 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:33:12,515 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:03:12 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799670'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'90'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'88d1f70dc4b9322f7d00b047688b5620'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=FXUYePyxZEifFGSQ7vSRjznSpizVUnafbOY7By95KdI-1750165392-1.0.1.1-Z0A1aos0nhfpHSk4vhTOqmwBczmH3NveDNW8hhaNvLTaeK4Z.uexL2kCnf5k376JotmGPDiQFn66rB8dJGevRnFT9CfI6mag3XqNEgYGHhM; path=/; expires=Tue, 17-Jun-25 13:33:12 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=TyWj2nsaBisF9AzXF4vfwylDSmTIoPkjbPYcQNyyBVc-1750165392436-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512bee50cf04436-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:33:12,517 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:33:12,517 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:33:12,518 - DEBUG - receive_response_body.complete
2025-06-17 18:33:12,519 - DEBUG - response_closed.started
2025-06-17 18:33:12,519 - DEBUG - response_closed.complete
2025-06-17 18:33:12,521 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 18:33:12,531 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:33:12,533 - DEBUG - send_request_headers.complete
2025-06-17 18:33:12,535 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:33:12,535 - DEBUG - send_request_body.complete
2025-06-17 18:33:12,536 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:33:12,810 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:03:12 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'73'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799572'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'2f1d01556a14e26bf844423fbcc62e16'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512bee6fe9b4436-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:33:12,811 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:33:12,812 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:33:12,813 - DEBUG - receive_response_body.complete
2025-06-17 18:33:12,813 - DEBUG - response_closed.started
2025-06-17 18:33:12,813 - DEBUG - response_closed.complete
2025-06-17 18:33:12,815 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:33:12,816 - DEBUG - Cleaned query: 'coupon hong kong'
2025-06-17 18:33:12,825 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:33:12,841 - INFO - Fuzzy coupon name match: 'coupon' -> 'Coupon 9' from coupon
2025-06-17 18:33:12,842 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=Coupon 9
2025-06-17 18:33:12,842 - DEBUG - Final: Query=coupon for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=Coupon 9, Discount=None
2025-06-17 18:33:12,843 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:33:12,844 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:33:12,844 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 'coupon 9', 'coupon 9', 20]
2025-06-17 18:33:12,847 - DEBUG - Found 0 rows
2025-06-17 18:33:12,848 - DEBUG - Returning 0 coupons for category 'None', location 'Hong Kong'
2025-06-17 18:33:12,851 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:33:12,851 - DEBUG - close.started
2025-06-17 18:33:12,852 - DEBUG - close.complete
2025-06-17 18:33:12,856 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:33:12,863 - INFO - Database connection closed
2025-06-17 18:33:12,863 - INFO - 127.0.0.1 - - [17/Jun/2025 18:33:12] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:33:12,884 - INFO - Connected to database
2025-06-17 18:33:14,330 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:33:14,373 - DEBUG - Rendering index with 2 messages
2025-06-17 18:33:14,375 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:33:14,383 - INFO - Database connection closed
2025-06-17 18:33:14,383 - INFO - 127.0.0.1 - - [17/Jun/2025 18:33:14] "GET / HTTP/1.1" 200 -
2025-06-17 18:33:35,665 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 18:33:35,665 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 18:33:35,667 - INFO -  * Restarting with stat
2025-06-17 18:33:36,873 - WARNING -  * Debugger is active!
2025-06-17 18:33:36,875 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 18:34:31,076 - INFO - 127.0.0.1 - - [17/Jun/2025 18:34:31] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 18:34:31,108 - INFO - 127.0.0.1 - - [17/Jun/2025 18:34:31] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 18:35:24,669 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 18:35:24,858 - INFO - Connected to database
2025-06-17 18:35:25,463 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 18:35:25,465 - INFO - Database connection closed
2025-06-17 18:35:25,465 - INFO - 127.0.0.1 - - [17/Jun/2025 18:35:25] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 18:35:25,486 - INFO - Connected to database
2025-06-17 18:35:27,199 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:35:27,249 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 18:35:27,250 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 18:35:28,433 - DEBUG - Loading model cost 1.184 seconds.
2025-06-17 18:35:28,433 - DEBUG - Prefix dict has been built successfully.
2025-06-17 18:35:28,435 - DEBUG - Rendering index with 0 messages
2025-06-17 18:35:28,443 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:35:28,466 - INFO - Database connection closed
2025-06-17 18:35:28,466 - INFO - 127.0.0.1 - - [17/Jun/2025 18:35:28] "GET / HTTP/1.1" 200 -
2025-06-17 18:35:36,044 - INFO - Connected to database
2025-06-17 18:35:37,650 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:35:37,732 - DEBUG - Cleared session messages. Starting fresh for query: coupon for hong kong
2025-06-17 18:35:37,734 - DEBUG - Extracting category from query: 'coupon for hong kong', words: ['coupon', 'for', 'hong', 'kong']
2025-06-17 18:35:37,735 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,735 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,735 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,736 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,737 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,737 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,738 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,738 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,739 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,739 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,739 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,740 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,741 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,743 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,743 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,744 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,745 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,745 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,745 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,746 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,746 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,747 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,747 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,747 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,747 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,748 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:35:37,748 - INFO - No category matched for query: coupon for hong kong
2025-06-17 18:35:37,761 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:35:37,793 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDCE3CB0>
2025-06-17 18:35:37,837 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000153BD90AF00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:35:37,869 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDE5AD50>
2025-06-17 18:35:37,870 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:35:37,871 - DEBUG - send_request_headers.complete
2025-06-17 18:35:37,871 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:35:37,873 - DEBUG - send_request_body.complete
2025-06-17 18:35:37,875 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:35:38,174 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:05:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'90'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499552'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799124'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'57'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'91'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'059827356d5e140c040d854254ecdf3d'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=_K1PlVtbAR72850kBzlBL_ysfqKwhYg9.mJ9qx6GFd0-1750165538-1.0.1.1-cCKe0MNqX0CJYWSBbJM.SJ1WdpzF3_MT2gfvHo5tSbqi8_Jg7sfUs5Q9GFzGtu6_lThU9ODVhxwSBbIDbtw7LPx4.v1wLtlRIFzjyUNW4iE; path=/; expires=Tue, 17-Jun-25 13:35:38 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=3Vl8Zct3q9IyVx4Tfm4rNG2xB8QKbnY2gGaSqmY6RCY-1750165538088-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c2734fb1401b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:35:38,176 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:35:38,177 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:35:38,178 - DEBUG - receive_response_body.complete
2025-06-17 18:35:38,178 - DEBUG - response_closed.started
2025-06-17 18:35:38,179 - DEBUG - response_closed.complete
2025-06-17 18:35:38,181 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 18:35:38,198 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:35:38,199 - DEBUG - send_request_headers.complete
2025-06-17 18:35:38,200 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:35:38,201 - DEBUG - send_request_body.complete
2025-06-17 18:35:38,202 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:35:38,587 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:05:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'88'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499454'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998799026'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'89'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'fb8ac75dcefe924ac800556009f33446'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c2755a01401b-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:35:38,589 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:35:38,590 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:35:38,591 - DEBUG - receive_response_body.complete
2025-06-17 18:35:38,592 - DEBUG - response_closed.started
2025-06-17 18:35:38,592 - DEBUG - response_closed.complete
2025-06-17 18:35:38,595 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:35:38,598 - DEBUG - Cleaned query: 'coupon hong kong'
2025-06-17 18:35:38,604 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:35:38,624 - INFO - Fuzzy coupon name match: 'coupon' -> 'Coupon 9' from coupon
2025-06-17 18:35:38,625 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=Coupon 9
2025-06-17 18:35:38,626 - DEBUG - Final: Query=coupon for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=Coupon 9, Discount=None
2025-06-17 18:35:38,628 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:35:38,628 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:35:38,629 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 'coupon 9', 'coupon 9', 20]
2025-06-17 18:35:38,632 - DEBUG - Found 0 rows
2025-06-17 18:35:38,632 - DEBUG - Returning 0 coupons for category 'None', location 'Hong Kong'
2025-06-17 18:35:38,633 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:35:38,634 - DEBUG - close.started
2025-06-17 18:35:38,635 - DEBUG - close.complete
2025-06-17 18:35:38,635 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:35:38,644 - INFO - Database connection closed
2025-06-17 18:35:38,645 - INFO - 127.0.0.1 - - [17/Jun/2025 18:35:38] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:35:38,662 - INFO - Connected to database
2025-06-17 18:35:40,169 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:35:40,237 - DEBUG - Rendering index with 2 messages
2025-06-17 18:35:40,240 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:35:40,248 - INFO - Database connection closed
2025-06-17 18:35:40,249 - INFO - 127.0.0.1 - - [17/Jun/2025 18:35:40] "GET / HTTP/1.1" 200 -
2025-06-17 18:36:22,045 - INFO - Connected to database
2025-06-17 18:36:23,622 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:36:23,669 - DEBUG - Cleared session messages. Starting fresh for query: gucci store
2025-06-17 18:36:23,671 - DEBUG - Extracting category from query: 'gucci store', words: ['gucci', 'store']
2025-06-17 18:36:23,679 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,681 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,689 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,696 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,803 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,824 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,836 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,846 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,954 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,969 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,969 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,970 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,970 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,970 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,970 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,971 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:23,985 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,065 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,088 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,098 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,103 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,107 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,109 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,110 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,110 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,111 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,111 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,111 - DEBUG - Ignoring word: 'store'
2025-06-17 18:36:24,112 - INFO - No category matched for query: gucci store
2025-06-17 18:36:24,121 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:36:24,175 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDBD7890>
2025-06-17 18:36:24,188 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000153BDD21D90> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:36:24,224 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDC77820>
2025-06-17 18:36:24,224 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:36:24,226 - DEBUG - send_request_headers.complete
2025-06-17 18:36:24,226 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:36:24,226 - DEBUG - send_request_body.complete
2025-06-17 18:36:24,227 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:36:24,628 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:06:24 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'72'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499314'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798886'), (b'x-ratelimit-tokens-query-cost', b'140'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'72'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'b80c043a0104193363361a1fdd7b4c25'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=KBc_sHHoFQARumytEaflo0H3Dq_hZ5T3bdzBft3loAk-1750165584-1.0.1.1-tWNNUBhzQrVKPZMr71J5x7N0ynq_pFq0S5NdclvfIr9ygbJl7OnQPYi.xHs6EW64jXqZQGg9bWbIKvNaNH.2.M92NhkgjZTb8PH0B3xY7iY; path=/; expires=Tue, 17-Jun-25 13:36:24 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=30AENphDOXPPVaGFCXgVMROWezLKW8USU6NcEREJBe0-1750165584542-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c3950bb23c5e-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:36:24,630 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:36:24,631 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:36:24,632 - DEBUG - receive_response_body.complete
2025-06-17 18:36:24,633 - DEBUG - response_closed.started
2025-06-17 18:36:24,633 - DEBUG - response_closed.complete
2025-06-17 18:36:24,635 - DEBUG - Mistral location analysis: None
2025-06-17 18:36:24,636 - DEBUG - Location candidates: ['gucci store']
2025-06-17 18:36:24,638 - INFO - No valid location matched for query: gucci store
2025-06-17 18:36:24,655 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:36:24,656 - DEBUG - send_request_headers.complete
2025-06-17 18:36:24,657 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:36:24,658 - DEBUG - send_request_body.complete
2025-06-17 18:36:24,659 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:36:24,984 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:06:24 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'104'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499218'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798790'), (b'x-ratelimit-tokens-query-cost', b'96'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'105'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'8c045915075d16550340405fa7346561'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c397be423c5e-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:36:24,986 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:36:24,987 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:36:24,987 - DEBUG - receive_response_body.complete
2025-06-17 18:36:24,988 - DEBUG - response_closed.started
2025-06-17 18:36:24,989 - DEBUG - response_closed.complete
2025-06-17 18:36:24,990 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:36:24,991 - DEBUG - Cleaned query: 'gucci store'
2025-06-17 18:36:24,998 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:36:25,001 - INFO - Exact full query match: 'gucci store' -> 'Gucci Store' from coupon
2025-06-17 18:36:25,001 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Gucci Store
2025-06-17 18:36:25,002 - DEBUG - Final: Query=gucci store, Category=None, Location=None, Coupon Name=Gucci Store, Discount=None
2025-06-17 18:36:25,003 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['gucci store', 'gucci store', 20]
2025-06-17 18:36:25,008 - DEBUG - Found 1 rows
2025-06-17 18:36:25,010 - DEBUG - Valid area IDs for coupon ID 1232 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:36:25,011 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 18:36:25,012 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:36:25,017 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:36:25,017 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:36:25,018 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:36:25,018 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:36:25,019 - DEBUG - close.started
2025-06-17 18:36:25,020 - DEBUG - close.complete
2025-06-17 18:36:25,020 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:36:25,026 - INFO - Database connection closed
2025-06-17 18:36:25,026 - INFO - 127.0.0.1 - - [17/Jun/2025 18:36:25] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:36:25,049 - INFO - Connected to database
2025-06-17 18:36:26,563 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:36:26,611 - DEBUG - Rendering index with 2 messages
2025-06-17 18:36:26,612 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:36:26,620 - INFO - Database connection closed
2025-06-17 18:36:26,621 - INFO - 127.0.0.1 - - [17/Jun/2025 18:36:26] "GET / HTTP/1.1" 200 -
2025-06-17 18:36:35,291 - INFO - Connected to database
2025-06-17 18:36:36,872 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:36:36,918 - DEBUG - Cleared session messages. Starting fresh for query: coupon 9
2025-06-17 18:36:36,919 - DEBUG - Extracting category from query: 'coupon 9', words: ['coupon', '9']
2025-06-17 18:36:36,919 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,920 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,920 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,920 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,921 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,921 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,922 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,922 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,923 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,923 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,923 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,924 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,924 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,924 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,925 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,925 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,926 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,927 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,927 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,928 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,928 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,928 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,929 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,930 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,930 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,931 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,931 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,932 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:36:36,932 - INFO - No category matched for query: coupon 9
2025-06-17 18:36:36,941 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:36:36,971 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153C160CB00>
2025-06-17 18:36:36,971 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000153BDDB2720> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:36:37,001 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDE61FD0>
2025-06-17 18:36:37,002 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:36:37,003 - DEBUG - send_request_headers.complete
2025-06-17 18:36:37,004 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:36:37,004 - DEBUG - send_request_body.complete
2025-06-17 18:36:37,005 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:36:37,312 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:06:37 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'97'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499859'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798649'), (b'x-ratelimit-tokens-query-cost', b'141'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'54'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'98'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'56ee6a70e58f3f1cf6c37f23822ad74f'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=6SJe8Msc0pctUX2oVBBZjxSo18wRtMxG0GG01cRSWA8-1750165597-1.0.1.1-c22V9NDJbG0DbwnOO8iYqtegwepTV_gT4tobKACmDm3ugwsf2olQHFyU7yxkfTf5L4TTn4x__01_wVoTkQwq8TYXaxngb.2tz2och0oZmmA; path=/; expires=Tue, 17-Jun-25 13:36:37 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=f7n2O09M04saYUF1zQWA_zcFDJ0gIb8u28f2N_0o_QE-1750165597231-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c3e4ee8f484d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:36:37,315 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:36:37,315 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:36:37,316 - DEBUG - receive_response_body.complete
2025-06-17 18:36:37,317 - DEBUG - response_closed.started
2025-06-17 18:36:37,317 - DEBUG - response_closed.complete
2025-06-17 18:36:37,320 - DEBUG - Mistral location analysis: None
2025-06-17 18:36:37,320 - DEBUG - Location candidates: ['coupon 9', '9']
2025-06-17 18:36:37,323 - INFO - No valid location matched for query: coupon 9
2025-06-17 18:36:37,333 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:36:37,334 - DEBUG - send_request_headers.complete
2025-06-17 18:36:37,335 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:36:37,335 - DEBUG - send_request_body.complete
2025-06-17 18:36:37,335 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:36:37,607 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:06:37 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499762'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798552'), (b'x-ratelimit-tokens-query-cost', b'97'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'53'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'c6bd801820408232d86b70339ac2ef41'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c3e6f8bd484d-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:36:37,609 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:36:37,610 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:36:37,611 - DEBUG - receive_response_body.complete
2025-06-17 18:36:37,612 - DEBUG - response_closed.started
2025-06-17 18:36:37,612 - DEBUG - response_closed.complete
2025-06-17 18:36:37,616 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:36:37,617 - DEBUG - Cleaned query: 'coupon 9'
2025-06-17 18:36:37,617 - DEBUG - Preserved coupon name: 'Coupon 9'
2025-06-17 18:36:37,618 - DEBUG - Extracted: Category=None, Location=None, Discount=None, Coupon Name=Coupon 9
2025-06-17 18:36:37,619 - DEBUG - Final: Query=coupon 9, Category=None, Location=None, Coupon Name=Coupon 9, Discount=None
2025-06-17 18:36:37,621 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['coupon 9', 'coupon 9', 20]
2025-06-17 18:36:37,627 - DEBUG - Found 1 rows
2025-06-17 18:36:37,631 - DEBUG - Valid area IDs for coupon ID 104 (area 2): ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33']
2025-06-17 18:36:37,632 - DEBUG - Returning 1 coupons for category 'None', location 'None'
2025-06-17 18:36:37,633 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 2
2025-06-17 18:36:37,634 - DEBUG - Resolved selected_area 4 to Kwun Tong via kowloon table
2025-06-17 18:36:37,635 - DEBUG - Attempting to resolve area_id: 2
2025-06-17 18:36:37,635 - DEBUG - Resolved area_id 2 to Kowloon via area_map
2025-06-17 18:36:37,636 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:36:37,637 - DEBUG - close.started
2025-06-17 18:36:37,638 - DEBUG - close.complete
2025-06-17 18:36:37,639 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:36:37,643 - INFO - Database connection closed
2025-06-17 18:36:37,645 - INFO - 127.0.0.1 - - [17/Jun/2025 18:36:37] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:36:37,663 - INFO - Connected to database
2025-06-17 18:36:39,169 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:36:39,208 - DEBUG - Rendering index with 2 messages
2025-06-17 18:36:39,210 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:36:39,218 - INFO - Database connection closed
2025-06-17 18:36:39,219 - INFO - 127.0.0.1 - - [17/Jun/2025 18:36:39] "GET / HTTP/1.1" 200 -
2025-06-17 18:37:15,230 - INFO - Connected to database
2025-06-17 18:37:16,710 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:16,746 - DEBUG - Cleared session messages. Starting fresh for query: coupon for new territories
2025-06-17 18:37:16,748 - DEBUG - Extracting category from query: 'coupon for new territories', words: ['coupon', 'for', 'new', 'territories']
2025-06-17 18:37:16,748 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,749 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,749 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,749 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,750 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,750 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,751 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,751 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,753 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,755 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,755 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,756 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,756 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,756 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,757 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,757 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,757 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,757 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,758 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,758 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,759 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,759 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,760 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,760 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,760 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,760 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,761 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,761 - DEBUG - Ignoring word: 'coupon'
2025-06-17 18:37:16,761 - INFO - No category matched for query: coupon for new territories
2025-06-17 18:37:16,770 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:37:16,797 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153C16316A0>
2025-06-17 18:37:16,797 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000153BDDB31D0> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:37:16,833 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153C16317B0>
2025-06-17 18:37:16,833 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:37:16,835 - DEBUG - send_request_headers.complete
2025-06-17 18:37:16,835 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:37:16,836 - DEBUG - send_request_body.complete
2025-06-17 18:37:16,837 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:37:17,100 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:07:17 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'72'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499620'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798410'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'73'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'c2dc8d3875c7db18375cc5220aef6f44'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=64HHeKP3AJUwAMDcXIjQim2xPSBKznlE_nBpPRQfmok-1750165637-1.0.1.1-h6D1dqqdZf7uYqjX43aPoAZJhEdW21_pS.jWE0cDGEhnR38YSKw5W1Gko84h53D3354h3mYlv_NrxrIPtOiCdXBeRBpJwcfSM0M_sVHRB1k; path=/; expires=Tue, 17-Jun-25 13:37:17 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=yjfhCePDeLV44Wjg.zvhcFOLqvwY1Ooi3O4aGPmEckQ-1750165637023-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c4ddef872e11-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:37:17,102 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:37:17,102 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:37:17,102 - DEBUG - receive_response_body.complete
2025-06-17 18:37:17,103 - DEBUG - response_closed.started
2025-06-17 18:37:17,103 - DEBUG - response_closed.complete
2025-06-17 18:37:17,104 - DEBUG - Mistral location analysis: None
2025-06-17 18:37:17,104 - DEBUG - Location candidates: ['coupon for new territories', 'coupon for new', 'coupon for', 'for new territories', 'for new', 'new territories', 'new', 'territories']
2025-06-17 18:37:17,108 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 18:37:17,122 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:37:17,124 - DEBUG - send_request_headers.complete
2025-06-17 18:37:17,124 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:37:17,126 - DEBUG - send_request_body.complete
2025-06-17 18:37:17,126 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:37:17,408 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:07:17 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'98'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499522'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798312'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'99'), (b'x-kong-proxy-latency', b'5'), (b'x-kong-request-id', b'2b074d46676fb033a5466c08bf34ce64'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c4dfa87c2e11-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:37:17,409 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:37:17,410 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:37:17,411 - DEBUG - receive_response_body.complete
2025-06-17 18:37:17,411 - DEBUG - response_closed.started
2025-06-17 18:37:17,412 - DEBUG - response_closed.complete
2025-06-17 18:37:17,414 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:37:17,414 - DEBUG - Cleaned query: 'coupon new territories'
2025-06-17 18:37:17,423 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:37:17,441 - INFO - Fuzzy coupon name match: 'coupon' -> 'Coupon 9' from coupon
2025-06-17 18:37:17,441 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=Coupon 9
2025-06-17 18:37:17,442 - DEBUG - Final: Query=coupon for new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=Coupon 9, Discount=None
2025-06-17 18:37:17,443 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:17,444 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:17,444 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) AND (TRIM(LOWER(COALESCE(c.name_en, ''))) = %s OR TRIM(LOWER(COALESCE(c.name_cn, ''))) = %s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 'coupon 9', 'coupon 9', 20]
2025-06-17 18:37:17,447 - DEBUG - Found 0 rows
2025-06-17 18:37:17,447 - DEBUG - Returning 0 coupons for category 'None', location 'New Territories'
2025-06-17 18:37:17,448 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:37:17,449 - DEBUG - close.started
2025-06-17 18:37:17,450 - DEBUG - close.complete
2025-06-17 18:37:17,450 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:17,460 - INFO - Database connection closed
2025-06-17 18:37:17,461 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:17] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:37:17,480 - INFO - Connected to database
2025-06-17 18:37:18,942 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:18,973 - DEBUG - Rendering index with 2 messages
2025-06-17 18:37:18,975 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:18,979 - INFO - Database connection closed
2025-06-17 18:37:18,979 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:18] "GET / HTTP/1.1" 200 -
2025-06-17 18:37:27,945 - INFO - Connected to database
2025-06-17 18:37:29,414 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:29,465 - DEBUG - Chatbot session data cleared via 'clear' action. Reloading index page.
2025-06-17 18:37:29,467 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:29,475 - INFO - Database connection closed
2025-06-17 18:37:29,476 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:29] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:37:29,496 - INFO - Connected to database
2025-06-17 18:37:30,954 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:31,005 - DEBUG - Rendering index with 1 messages
2025-06-17 18:37:31,006 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:31,013 - INFO - Database connection closed
2025-06-17 18:37:31,014 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:31] "GET / HTTP/1.1" 200 -
2025-06-17 18:37:43,323 - INFO - Connected to database
2025-06-17 18:37:44,809 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:44,862 - DEBUG - Cleared session messages. Starting fresh for query: coupons of new territories
2025-06-17 18:37:44,868 - DEBUG - Extracting category from query: 'coupons of new territories', words: ['coupons', 'of', 'new', 'territories']
2025-06-17 18:37:44,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,869 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,870 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,871 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,872 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,873 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,874 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,875 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,876 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,876 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,877 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,878 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,878 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,879 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,882 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,882 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,883 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,884 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,884 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,884 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,885 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,885 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,886 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,886 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:37:44,886 - INFO - No category matched for query: coupons of new territories
2025-06-17 18:37:44,894 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:37:44,964 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDE6A950>
2025-06-17 18:37:44,966 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x00000153BDD21D90> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:37:45,099 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x00000153BDE69850>
2025-06-17 18:37:45,108 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:37:45,210 - DEBUG - send_request_headers.complete
2025-06-17 18:37:45,210 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:37:45,212 - DEBUG - send_request_body.complete
2025-06-17 18:37:45,213 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:37:45,502 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:07:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'92'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499858'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798170'), (b'x-ratelimit-tokens-query-cost', b'142'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'56'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'94'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'7d5ac2134b6e570bd5b7e364e23dff09'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=DGn5Uzuhr3OqME67OKtSIoOI6vVbvhq.Eaf8MlMMKZE-1750165665-1.0.1.1-sj0eTDg28RNC9_1LNUxqHsT4MVrHti2MbdFiJOZu9H3czILmh1KPlK.B2XD6mGVzBGt4DS4WqeWfPFtTdUY0JQ4AGN9RrLwj2OF8VQJDkNo; path=/; expires=Tue, 17-Jun-25 13:37:45 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=3pZy3ig1dxryrNgFItdnMX8Z3Y1DC8vHhgsEWbAdY.g-1750165665417-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c58f2f573a20-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:37:45,505 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:37:45,506 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:37:45,507 - DEBUG - receive_response_body.complete
2025-06-17 18:37:45,508 - DEBUG - response_closed.started
2025-06-17 18:37:45,508 - DEBUG - response_closed.complete
2025-06-17 18:37:45,510 - DEBUG - Mistral location analysis: None
2025-06-17 18:37:45,520 - DEBUG - Location candidates: ['coupons of new territories', 'coupons of new', 'coupons of', 'of new territories', 'of new', 'new territories', 'new', 'territories']
2025-06-17 18:37:45,526 - INFO - Normalized area match: 'new territories' -> 'New Territories'
2025-06-17 18:37:45,540 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:37:45,541 - DEBUG - send_request_headers.complete
2025-06-17 18:37:45,542 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:37:45,543 - DEBUG - send_request_body.complete
2025-06-17 18:37:45,543 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:37:45,955 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:07:45 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'192'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499760'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998798072'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'55'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'193'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'a61c3939b6ed625691eff1401ef3506b'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512c591498c3a20-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:37:45,977 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:37:45,977 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:37:45,979 - DEBUG - receive_response_body.complete
2025-06-17 18:37:45,979 - DEBUG - response_closed.started
2025-06-17 18:37:45,980 - DEBUG - response_closed.complete
2025-06-17 18:37:45,984 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:37:45,984 - DEBUG - Cleaned query: 'coupons new territories'
2025-06-17 18:37:45,991 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:37:46,028 - INFO - No coupon name matched for query: 'coupons of new territories'
2025-06-17 18:37:46,028 - DEBUG - Extracted: Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Discount=None, Coupon Name=None
2025-06-17 18:37:46,032 - DEBUG - Final: Query=coupons of new territories, Category=None, Location={'name': 'New Territories', 'type': 'area', 'id': '3'}, Coupon Name=None, Discount=None
2025-06-17 18:37:46,034 - DEBUG - Valid selected_area IDs for area 3: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,034 - DEBUG - Searching coupons with area: 3, selected_areas: ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,035 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['3', '1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29', 20]
2025-06-17 18:37:46,038 - DEBUG - Found 20 rows
2025-06-17 18:37:46,039 - DEBUG - Valid area IDs for coupon ID 1243 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,040 - DEBUG - Valid area IDs for coupon ID 1242 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,041 - DEBUG - Valid area IDs for coupon ID 1221 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,042 - DEBUG - Valid area IDs for coupon ID 1034 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,043 - DEBUG - Valid area IDs for coupon ID 1019 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,044 - DEBUG - Valid area IDs for coupon ID 943 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,045 - DEBUG - Valid area IDs for coupon ID 942 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,047 - DEBUG - Valid area IDs for coupon ID 941 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,050 - DEBUG - Valid area IDs for coupon ID 936 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,051 - DEBUG - Valid area IDs for coupon ID 921 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,053 - DEBUG - Valid area IDs for coupon ID 918 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,054 - DEBUG - Valid area IDs for coupon ID 917 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,055 - DEBUG - Valid area IDs for coupon ID 916 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,056 - DEBUG - Valid area IDs for coupon ID 914 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,057 - DEBUG - Valid area IDs for coupon ID 911 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,058 - DEBUG - Valid area IDs for coupon ID 908 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,059 - DEBUG - Valid area IDs for coupon ID 905 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,060 - DEBUG - Valid area IDs for coupon ID 904 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,061 - DEBUG - Valid area IDs for coupon ID 902 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,063 - DEBUG - Valid area IDs for coupon ID 901 (area 3): ['1', '2', '4', '5', '6', '7', '8', '9', '10', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '28', '29']
2025-06-17 18:37:46,063 - DEBUG - Returning 20 coupons for category 'None', location 'New Territories'
2025-06-17 18:37:46,064 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,067 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:37:46,067 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,067 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,067 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,069 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:37:46,069 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,070 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,070 - DEBUG - Attempting to resolve selected_area: 25, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,071 - DEBUG - Resolved selected_area 25 to Lai King via new_territories table
2025-06-17 18:37:46,072 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,072 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,072 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,074 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 18:37:46,075 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,075 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,075 - DEBUG - Attempting to resolve selected_area: 26, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,076 - DEBUG - Resolved selected_area 26 to Shatoujiao via new_territories table
2025-06-17 18:37:46,077 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,077 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,078 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,081 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:37:46,081 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,081 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,082 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,083 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 18:37:46,083 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,084 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,084 - DEBUG - Attempting to resolve selected_area: 7, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,085 - DEBUG - Resolved selected_area 7 to Sha Tin via new_territories table
2025-06-17 18:37:46,086 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,086 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,086 - DEBUG - Attempting to resolve selected_area: 22, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,087 - DEBUG - Resolved selected_area 22 to Kwai Chung via new_territories table
2025-06-17 18:37:46,087 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,088 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,088 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,090 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:37:46,090 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,090 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,091 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,092 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:37:46,092 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,092 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,092 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,094 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:37:46,095 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,095 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,095 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,099 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:37:46,099 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,100 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,100 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,101 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:37:46,102 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,102 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,102 - DEBUG - Attempting to resolve selected_area: 17, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,103 - DEBUG - Resolved selected_area 17 to Tin Shui Wai via new_territories table
2025-06-17 18:37:46,103 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,104 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,104 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,105 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:37:46,105 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,106 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,107 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,109 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:37:46,109 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,109 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,109 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,111 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:37:46,111 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,111 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,112 - DEBUG - Attempting to resolve selected_area: 29, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,115 - DEBUG - Resolved selected_area 29 to Tiu King Leng via new_territories table
2025-06-17 18:37:46,115 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,116 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,116 - DEBUG - Attempting to resolve selected_area: 4, territory: , location_table: None, coupon_area: 3
2025-06-17 18:37:46,118 - DEBUG - Resolved selected_area 4 to Tseung Kwan O via new_territories table
2025-06-17 18:37:46,118 - DEBUG - Attempting to resolve area_id: 3
2025-06-17 18:37:46,118 - DEBUG - Resolved area_id 3 to New Territories via area_map
2025-06-17 18:37:46,119 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:37:46,119 - DEBUG - close.started
2025-06-17 18:37:46,120 - DEBUG - close.complete
2025-06-17 18:37:46,120 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:46,125 - INFO - Database connection closed
2025-06-17 18:37:46,126 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:46] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:37:46,142 - INFO - Connected to database
2025-06-17 18:37:47,490 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:37:47,535 - DEBUG - Rendering index with 2 messages
2025-06-17 18:37:47,536 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:37:47,539 - INFO - Database connection closed
2025-06-17 18:37:47,540 - INFO - 127.0.0.1 - - [17/Jun/2025 18:37:47] "GET / HTTP/1.1" 200 -
2025-06-17 18:42:02,094 - INFO - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://192.168.29.200:5001
2025-06-17 18:42:02,094 - INFO - [33mPress CTRL+C to quit[0m
2025-06-17 18:42:02,098 - INFO -  * Restarting with stat
2025-06-17 18:42:03,378 - WARNING -  * Debugger is active!
2025-06-17 18:42:03,381 - INFO -  * Debugger PIN: 100-222-383
2025-06-17 18:42:08,937 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:08] "[32mGET / HTTP/1.1[0m" 302 -
2025-06-17 18:42:08,957 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:08] "GET /login?next=/ HTTP/1.1" 200 -
2025-06-17 18:42:17,476 - DEBUG - Login attempt: email=diya.dave11@gmail.com, password=********
2025-06-17 18:42:17,883 - INFO - Connected to database
2025-06-17 18:42:18,463 - INFO - Login successful: diya.dave11@gmail.com
2025-06-17 18:42:18,465 - INFO - Database connection closed
2025-06-17 18:42:18,465 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:18] "[32mPOST /login HTTP/1.1[0m" 302 -
2025-06-17 18:42:18,480 - INFO - Connected to database
2025-06-17 18:42:20,339 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:42:20,400 - DEBUG - Building prefix dict from the default dictionary ...
2025-06-17 18:42:20,405 - DEBUG - Loading model from cache C:\Users\Diya\AppData\Local\Temp\jieba.cache
2025-06-17 18:42:21,653 - DEBUG - Loading model cost 1.252 seconds.
2025-06-17 18:42:21,655 - DEBUG - Prefix dict has been built successfully.
2025-06-17 18:42:21,657 - DEBUG - Rendering index with 0 messages
2025-06-17 18:42:21,663 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:42:21,685 - INFO - Database connection closed
2025-06-17 18:42:21,685 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:21] "GET / HTTP/1.1" 200 -
2025-06-17 18:42:28,904 - INFO - Connected to database
2025-06-17 18:42:30,587 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:42:30,646 - DEBUG - Cleared session messages. Starting fresh for query: coupons for hong kong
2025-06-17 18:42:30,648 - DEBUG - Extracting category from query: 'coupons for hong kong', words: ['coupons', 'for', 'hong', 'kong']
2025-06-17 18:42:30,648 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,649 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,649 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,650 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,650 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,650 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,651 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,652 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,653 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,653 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,653 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,653 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,654 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,654 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,654 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,655 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,655 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,655 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,656 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,657 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,657 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,660 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,660 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,661 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,661 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,662 - DEBUG - Ignoring word: 'coupons'
2025-06-17 18:42:30,662 - INFO - No category matched for query: coupons for hong kong
2025-06-17 18:42:30,672 - DEBUG - connect_tcp.started host='api.mistral.ai' port=443 local_address=None timeout=None socket_options=None
2025-06-17 18:42:30,749 - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028445D03CB0>
2025-06-17 18:42:30,750 - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000002844593AF00> server_hostname='api.mistral.ai' timeout=None
2025-06-17 18:42:30,789 - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x0000028445E7AD50>
2025-06-17 18:42:30,790 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:42:30,791 - DEBUG - send_request_headers.complete
2025-06-17 18:42:30,791 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:42:30,792 - DEBUG - send_request_body.complete
2025-06-17 18:42:30,793 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:42:31,077 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:12:30 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'74'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499857'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998797929'), (b'x-ratelimit-tokens-query-cost', b'143'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'59'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'75'), (b'x-kong-proxy-latency', b'6'), (b'x-kong-request-id', b'461ba722714b596711e47d3681bc4c0b'), (b'cf-cache-status', b'DYNAMIC'), (b'Set-Cookie', b'__cf_bm=bHK4BcIdxNzMVlMgsEJqS9OxrHbbV_EteHUheAG4x8s-1750165950-1.0.1.1-Vh9c_3haojml8qwIWn2KgJgHaxgKXtEN4uarCOTEfsTwJL7_3O72oQBf5.hXRcI2TFSYOx5.NkioKxJP0gxDR5UboFaK0wJBvHuGGIrcrEE; path=/; expires=Tue, 17-Jun-25 13:42:30 GMT; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Set-Cookie', b'_cfuvid=CANfOShhqONq5Q.7cLlPkgW6weKQ9SPZqHV2pxq9cv0-1750165950978-0.0.1.1-604800000; path=/; domain=.mistral.ai; HttpOnly; Secure; SameSite=None'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512cc880c3a3a20-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:42:31,080 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:42:31,081 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:42:31,083 - DEBUG - receive_response_body.complete
2025-06-17 18:42:31,083 - DEBUG - response_closed.started
2025-06-17 18:42:31,084 - DEBUG - response_closed.complete
2025-06-17 18:42:31,096 - DEBUG - Mistral location analysis: Hong Kong
2025-06-17 18:42:31,123 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-06-17 18:42:31,125 - DEBUG - send_request_headers.complete
2025-06-17 18:42:31,125 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-06-17 18:42:31,126 - DEBUG - send_request_body.complete
2025-06-17 18:42:31,126 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-06-17 18:42:31,445 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Tue, 17 Jun 2025 13:12:31 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'x-envoy-upstream-service-time', b'85'), (b'x-ratelimit-limit-tokens-minute', b'500000'), (b'x-ratelimit-remaining-tokens-minute', b'499759'), (b'x-ratelimit-limit-tokens-month', b'1000000000'), (b'x-ratelimit-remaining-tokens-month', b'998797831'), (b'x-ratelimit-tokens-query-cost', b'98'), (b'x-ratelimit-limit-req-minute', b'60'), (b'x-ratelimit-remaining-req-minute', b'58'), (b'access-control-allow-origin', b'*'), (b'x-kong-upstream-latency', b'86'), (b'x-kong-proxy-latency', b'4'), (b'x-kong-request-id', b'5132611f3efb166b70c36e009b958921'), (b'cf-cache-status', b'DYNAMIC'), (b'Strict-Transport-Security', b'max-age=15552000; includeSubDomains'), (b'Server', b'cloudflare'), (b'CF-RAY', b'9512cc8a2e5f3a20-BOM'), (b'Content-Encoding', b'gzip'), (b'alt-svc', b'h3=":443"; ma=86400')])
2025-06-17 18:42:31,447 - INFO - HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-17 18:42:31,448 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-06-17 18:42:31,449 - DEBUG - receive_response_body.complete
2025-06-17 18:42:31,450 - DEBUG - response_closed.started
2025-06-17 18:42:31,450 - DEBUG - response_closed.complete
2025-06-17 18:42:31,453 - DEBUG - Mistral coupon name analysis: None
2025-06-17 18:42:31,454 - DEBUG - Cleaned query: 'coupons hong kong'
2025-06-17 18:42:31,461 - DEBUG - Fetched 446 coupon names: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']...
2025-06-17 18:42:31,490 - INFO - No coupon name matched for query: 'coupons for hong kong'
2025-06-17 18:42:31,491 - DEBUG - Extracted: Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Discount=None, Coupon Name=None
2025-06-17 18:42:31,491 - DEBUG - Final: Query=coupons for hong kong, Category=None, Location={'name': 'Hong Kong', 'type': 'area', 'id': '1'}, Coupon Name=None, Discount=None
2025-06-17 18:42:31,493 - DEBUG - Valid selected_area IDs for area 1: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,493 - DEBUG - Searching coupons with area: 1, selected_areas: ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,494 - DEBUG - Executing query: 
                SELECT 
                    c.id, c.name_en, c.name_cn, c.description_en, c.description_cn,
                    c.cash_amount, c.percentage, c.expiry_date, c.quantity, c.status,
                    cat.id as category_id, cat.name_en as category_name_en, 
                    cat.name_cn as category_name_cn,
                    c.area, c.selected_area, c.territory,
                    cities.name as city_name, countries.name as country_name,
                    COALESCE(a.name_en, c.area) as area_name_en, COALESCE(a.name_cn, c.area) as area_name_cn
                FROM coupons c
                LEFT JOIN categories cat ON c.category_id = cat.id
                LEFT JOIN area a ON c.area = a.id
                LEFT JOIN cities ON c.city_id = cities.id
                LEFT JOIN countries ON c.country_id = countries.id
                WHERE c.deleted_at IS NULL
                AND c.quantity >= 0
                AND c.name_en IS NOT NULL
             AND c.area = %s AND c.selected_area IN (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s) ORDER BY c.created_at DESC LIMIT %s with params: ['1', '1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33', 20]
2025-06-17 18:42:31,498 - DEBUG - Found 20 rows
2025-06-17 18:42:31,499 - DEBUG - Valid area IDs for coupon ID 1278 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,500 - DEBUG - Valid area IDs for coupon ID 1277 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,502 - DEBUG - Valid area IDs for coupon ID 1266 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,502 - DEBUG - Valid area IDs for coupon ID 1257 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,503 - DEBUG - Valid area IDs for coupon ID 1256 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,503 - DEBUG - Valid area IDs for coupon ID 1255 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,504 - DEBUG - Valid area IDs for coupon ID 1254 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,505 - DEBUG - Valid area IDs for coupon ID 1253 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,505 - DEBUG - Valid area IDs for coupon ID 1252 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,506 - DEBUG - Valid area IDs for coupon ID 1251 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,507 - DEBUG - Valid area IDs for coupon ID 1250 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,508 - DEBUG - Valid area IDs for coupon ID 1249 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,511 - DEBUG - Valid area IDs for coupon ID 1248 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,512 - DEBUG - Valid area IDs for coupon ID 1247 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,513 - DEBUG - Valid area IDs for coupon ID 1246 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,513 - DEBUG - Valid area IDs for coupon ID 1244 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,514 - DEBUG - Valid area IDs for coupon ID 1241 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,516 - DEBUG - Valid area IDs for coupon ID 1240 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,516 - DEBUG - Valid area IDs for coupon ID 1238 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,517 - DEBUG - Valid area IDs for coupon ID 1237 (area 1): ['1', '2', '6', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '21', '22', '23', '24', '25', '26', '27', '28', '30', '31', '32', '33']
2025-06-17 18:42:31,518 - DEBUG - Returning 20 coupons for category 'None', location 'Hong Kong'
2025-06-17 18:42:31,518 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,520 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,520 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,521 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,521 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,523 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,524 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,527 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,528 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,530 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,531 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,531 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,532 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,534 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,534 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,535 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,535 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,538 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,538 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,539 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,539 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,541 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,542 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,543 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,543 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,545 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,545 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,546 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,546 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,547 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,548 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,548 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,548 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,550 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,550 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,551 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,551 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,555 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,555 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,555 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,556 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,557 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,557 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,560 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,561 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,562 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,563 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,563 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,564 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,565 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,565 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,565 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,565 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,567 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,567 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,568 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,569 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,570 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,570 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,570 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,571 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,572 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,572 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,573 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,573 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,575 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,576 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,577 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,577 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,578 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,579 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,579 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,579 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,580 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,581 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,581 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,582 - DEBUG - Attempting to resolve selected_area: 33, territory: , location_table: None, coupon_area: 1
2025-06-17 18:42:31,584 - DEBUG - Resolved selected_area 33 to Shek O via hong_kong table
2025-06-17 18:42:31,585 - DEBUG - Attempting to resolve area_id: 1
2025-06-17 18:42:31,585 - DEBUG - Resolved area_id 1 to Hong Kong via area_map
2025-06-17 18:42:31,585 - DEBUG - Added system response. Total messages: 2
2025-06-17 18:42:31,585 - DEBUG - close.started
2025-06-17 18:42:31,586 - DEBUG - close.complete
2025-06-17 18:42:31,587 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:42:31,593 - INFO - Database connection closed
2025-06-17 18:42:31,594 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:31] "[32mPOST / HTTP/1.1[0m" 302 -
2025-06-17 18:42:31,612 - INFO - Connected to database
2025-06-17 18:42:33,165 - DEBUG - Fetched 456 coupons: ['Coupon 9', 'Coupon 201', 'Coupon 210', 'Coupon 211', 'Coupon 220']
2025-06-17 18:42:33,227 - DEBUG - Rendering index with 2 messages
2025-06-17 18:42:33,229 - DEBUG - Using proactor: IocpProactor
2025-06-17 18:42:33,239 - INFO - Database connection closed
2025-06-17 18:42:33,239 - INFO - 127.0.0.1 - - [17/Jun/2025 18:42:33] "GET / HTTP/1.1" 200 -
